<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asonik Store</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, doc, deleteDoc, setDoc, serverTimestamp, query, where, orderBy, updateDoc, getDocs, increment, getDoc } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-storage.js";
        
        window.firebase = {
            initializeApp, getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut, updateProfile,
            getFirestore, collection, onSnapshot, addDoc, doc, deleteDoc, setDoc, serverTimestamp, query, where, orderBy, updateDoc, getDocs, increment, getDoc,
            getStorage, ref, uploadBytes, getDownloadURL
        };
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; transition: background-color 0.3s, color 0.3s; }
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        
        :root {
            --bg-primary: #111827;
            --bg-secondary: #1f2937;
            --bg-tertiary: #374151;
            --text-primary: #f9fafb;
            --text-secondary: #d1d5db;
            --accent-primary: #8b5cf6;
            --accent-secondary: #a78bfa;
            --border-color: #374151;
        }
        body.light {
            --bg-primary: #f9fafb;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f3f4f6;
            --text-primary: #111827;
            --text-secondary: #4b5563;
            --border-color: #e5e7eb;
        }
        body.asonik {
            --bg-primary: linear-gradient(to bottom right, #f3e8ff, #ffffff);
            --bg-secondary: #ffffff;
            --bg-tertiary: #f3f4f6;
            --text-primary: #4c1d95;
            --text-secondary: #6d28d9;
            --accent-primary: #8b5cf6;
            --accent-secondary: #a78bfa;
            --border-color: #e5e7eb;
        }
        .asonik .accent-text { color: var(--accent-primary); }
        .asonik .text-primary { color: var(--text-primary); }
        .asonik .text-secondary { color: var(--text-secondary); }
        .asonik .bg-secondary { box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.05), 0 2px 4px -2px rgb(0 0 0 / 0.05); }
        .asonik .border-color { border-color: var(--border-color); }
        .asonik .header-text { color: #4c1d95; }
        .asonik .header-text:hover { color: #6d28d9; }


        .bg-primary { background: var(--bg-primary); }
        .bg-secondary { background-color: var(--bg-secondary); }
        .bg-tertiary { background-color: var(--bg-tertiary); }
        .text-primary { color: var(--text-primary); }
        .text-secondary { color: var(--text-secondary); }
        .border-color { border-color: var(--border-color); }
        .accent-text { color: var(--accent-primary); }
        .accent-bg { background-color: var(--accent-primary); }
        .accent-border { border-color: var(--accent-primary); }
        .hover\:accent-bg:hover { background-color: var(--accent-primary); }
        .hover\:accent-bg-secondary:hover { background-color: var(--accent-secondary); }
        
        .chat-bubble { max-width: 75%; word-wrap: break-word; }
        .chat-bubble-user { background-color: #4f46e5; }
        .chat-bubble-admin { background-color: #374151; }
    </style>
</head>
<body class="bg-primary text-primary">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useRef, useMemo } = React;
        const { 
            initializeApp, getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut, updateProfile,
            getFirestore, collection, onSnapshot, addDoc, doc, deleteDoc, setDoc, serverTimestamp, query, where, orderBy, updateDoc, getDocs, increment, getDoc,
            getStorage, ref, uploadBytes, getDownloadURL
        } = window.firebase;

        // --- App Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyC7smDYoy-LT58xCwjJsc9uZU9CgHQv5dM",
            authDomain: "ya-buxgalter.firebaseapp.com",
            projectId: "ya-buxgalter",
            storageBucket: "ya-buxgalter.appspot.com",
            messagingSenderId: "640345805387",
            appId: "1:640345805387:web:a1adade77f809af84cb3ce",
            measurementId: "G-0TKE25JVXG"
        };
        
        const ADMIN_UID = 'vhmtXZxkZnOWviNQ39R1W3GE8mw2';
        const IMGBB_API_KEY = '96bf3f29606f1989bb5a450ad3770cce';

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);
        const provider = new GoogleAuthProvider();
        
        const logoBase64 = "data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/2wBDAAYEBQYFBAYGBQYHBwYIChAKCgkJChQODwwQFxQYGBcUFhYaHSUfGhsjHBYWICwgIyYnKSopGR8tMC0oMCUoKSj/2wBDAQcHBwoIChMKChMoGhYaKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCj/wAARCAAgACADASIAAhEBAxEB/8QAGQAAAgMBAAAAAAAAAAAAAAAAAAYDBAUH/8QAIxAAAQQCAgICAwAAAAAAAAAAAQIDBAUGEQASITFBURMUYf/EABQBAQAAAAAAAAAAAAAAAAAAAAD/xAAUEQEAAAAAAAAAAAAAAAAAAAAA/9oADAMBAAIRAxEAPwD2ERkACK5uX1WzYtprKqKxckO2E5sNqS0lxLbqFpWlQBSoAgjYI9j39cZkABEV7OpaO6xYlXl0V6bYSHENNR2klS1qUoJSkAekkkgD+8YkABGczL6bT1kuyupLMNhhJWtbywkgD6Gz1J+g98ZkAB//2Q==";
        const qrCodeBase64 = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAPoAAAD6CAYAAACI7/P6AAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAAABmJLR0QA/wD/AP+gvaeTAAAACXBIWXMAAA7EAAAOxAGVKw4bAAAIeElEQVR42u3dQY4jNxJA0ff8/5+zJ8gYIMuN2Uk2ZzQBse2S1sTExP//AwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA-";

        // --- Helper Components & Functions ---

        // ** НОВАЯ ЛОГИКА: Функция для генерации уникального кода покупки **
        const generatePurchaseCode = () => {
            const chars = 'ABCDEFGHIJKLMNPQRSTUVWXYZ123456789';
            let result = '';
            for (let i = 0; i < 6; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result.match(/.{1,3}/g).join('-'); // Формат ABC-DEF
        };
        
        const Logo = () => ( <div className="flex items-center space-x-2 cursor-pointer"> <img src={logoBase64} alt="Asonik Store Logo" className="h-12 w-12 object-contain"/> <span className="text-2xl md:text-3xl font-bold header-text tracking-wider"> Asonik <span className="accent-text">Store</span> </span> </div> );
        const LoadingSpinner = () => ( <div className="bg-primary min-h-screen flex items-center justify-center"><div className="animate-spin rounded-full h-32 w-32 border-t-4 border-b-4 accent-border"></div></div> );
        const Modal = ({ children, onClose, size = 'max-w-md' }) => ( <div className="fixed inset-0 bg-black bg-opacity-75 z-50 flex justify-center items-center p-4 transition-opacity duration-300"> <div className={`bg-secondary rounded-2xl shadow-2xl p-6 md:p-8 w-full ${size} relative border-color transform transition-transform duration-300 scale-95 animate-scale-in`}> <button onClick={onClose} className="absolute top-4 right-4 text-secondary hover:text-primary transition-colors z-10"> <svg xmlns="http://www.w3.org/2000/svg" className="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg> </button> {children} </div> <style>{` @keyframes scale-in { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } } .animate-scale-in { animation: scale-in 0.3s ease-out forwards; } `}</style> </div> );
        const AlertModal = ({ message, onConfirm, onCancel, t }) => ( <Modal onClose={onCancel}> <div className="text-center"> <h2 className="text-2xl font-bold text-primary mb-4">{t.confirmation}</h2> <p className="text-secondary mb-6 whitespace-pre-wrap">{message}</p> <div className={`flex ${onConfirm ? 'justify-between' : 'justify-center'} space-x-4`}> <button onClick={onCancel} className="bg-tertiary hover:bg-gray-700 text-primary font-bold py-2 px-6 rounded-lg transition-colors">{onConfirm ? t.cancel : t.ok}</button> {onConfirm && ( <button onClick={onConfirm} className="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg transition-colors">{t.confirm}</button> )} </div> </div> </Modal> );
        
        const ProfileModal = ({ user, onClose, t, setAlertInfo }) => { /* ... без изменений ... */ };
        const CustomSelector = ({ value, onChange, options }) => { /* ... без изменений ... */ };

        // --- Main Components ---

        // ** ИСПРАВЛЕНИЕ: В шапке сайта кнопка "Чаты" теперь скрыта для администратора **
        function Header({ user, onLogin, onLogout, setPage, isAdmin, t, currency, setCurrency, language, setLanguage, setProfileVisible, theme, setTheme }) {
            const [userDropdownOpen, setUserDropdownOpen] = useState(false);
            const userDropdownRef = useRef(null);

            const langOptions = [{value: 'ru', label: t.russian}, {value: 'en', label: t.english}, {value: 'uz', label: t.uzbek}];
            const currencyOptions = [{value: 'RUB', label: t.ruble}, {value: 'USD', label: t.dollar}, {value: 'UZS', label: t.sum}];
            const themeOptions = [{value: 'dark', label: t.darkTheme}, {value: 'light', label: t.lightTheme}, {value: 'asonik', label: t.asonikTheme}];

            useEffect(() => {
                function handleClickOutside(event) {
                    if (userDropdownRef.current && !userDropdownRef.current.contains(event.target)) { setUserDropdownOpen(false); }
                }
                document.addEventListener("mousedown", handleClickOutside);
                return () => document.removeEventListener("mousedown", handleClickOutside);
            }, [userDropdownRef]);

            return (
                <header className="bg-secondary p-4 shadow-lg sticky top-0 z-40 border-b border-color">
                    <div className="container mx-auto flex justify-between items-center">
                        <div onClick={() => setPage('home')}><Logo /></div>
                        <nav className="hidden md:flex items-center space-x-6">
                            <button onClick={() => setPage('home')} className="text-secondary hover:text-primary font-medium transition-colors">{t.home}</button>
                            {user && <button onClick={() => setPage('purchases')} className="text-secondary hover:text-primary font-medium transition-colors">{t.myPurchases}</button>}
                            {/* ** ИСПРАВЛЕНИЕ: Кнопка чатов не отображается для админа ** */}
                            {user && !isAdmin && <button onClick={() => setPage('chats')} className="text-secondary hover:text-primary font-medium transition-colors">{t.chats}</button>}
                            <button onClick={() => setPage('faq')} className="text-secondary hover:text-primary font-medium transition-colors">{t.faq}</button>
                            {isAdmin && <button onClick={() => setPage('admin')} className="text-red-500 hover:text-red-400 font-bold transition-colors">{t.adminPanelTitle}</button>}
                        </nav>
                        <div className="flex items-center space-x-2 sm:space-x-4">
                            {/* ... остальная часть хедера без изменений ... */}
                        </div>
                    </div>
                </header>
            );
        }
        
        const SkeletonCard = () => { /* ... без изменений ... */ };
        function HomePage({ products, onProductClick, t, currency, convertPrice, loading }) { /* ... без изменений ... */ };
        function ProductCard({ product, onProductClick, t, currency, convertPrice }) { /* ... без изменений ... */ };
        function ProductModal({ product, user, onClose, onBuy, setAlertInfo, t, currency, convertPrice }) { /* ... без изменений ... */ };
        function PurchaseModal({ product, onClose, onConfirm, onYooMoney, t, currency, convertPrice, setAlertInfo }) { /* ... без изменений ... */ };
        function YooMoneyModal({ data, onClose, onSubmitReceipt, t, currency, convertPrice, setAlertInfo }) { /* ... без изменений ... */ };
        
        // ** НОВАЯ ЛОГИКА: Полностью переписанная страница чатов для пользователя **
        function ChatsPage({ user, t, setActiveTicketId, setAlertInfo }) {
            const startAdminChat = async () => {
                const ticketRef = doc(db, 'supportTickets', user.uid);
                const ticketSnap = await getDoc(ticketRef);
                if (!ticketSnap.exists()) {
                    await setDoc(ticketRef, {
                        userId: user.uid,
                        userEmail: user.email,
                        userName: user.displayName,
                        userAvatar: user.photoURL,
                        subject: `Чат с ${user.displayName}`,
                        status: 'new',
                        lastUpdated: serverTimestamp(),
                        createdAt: serverTimestamp()
                    });
                }
                setActiveTicketId(user.uid);
            };

            const copyIdToClipboard = () => {
                navigator.clipboard.writeText(user.uid);
                setAlertInfo({ message: t.idCopied });
            };
            
            return (
                <div className="container mx-auto p-4 md:p-8">
                    <h1 className="text-4xl font-bold text-center mb-8 text-primary">{t.chats}</h1>
                    <div className="max-w-3xl mx-auto bg-secondary p-6 rounded-lg shadow-xl text-center">
                        <p className="text-secondary mb-2">{t.yourId}</p>
                        <div 
                            onClick={copyIdToClipboard} 
                            className="text-lg font-mono bg-tertiary p-3 rounded-md text-primary break-all cursor-pointer transition-colors hover:bg-gray-700"
                            title={t.clickToCopy}
                        >
                            {user.uid}
                        </div>
                        <p className="text-sm text-secondary mt-4 mb-6">{t.supportSubtitle}</p>
                        <button onClick={startAdminChat} className="w-full accent-bg hover:accent-bg-secondary text-white font-bold py-3 px-6 rounded-lg text-lg flex items-center justify-center space-x-2">
                            <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" /></svg>
                            <span>{t.chatWithAdmin}</span>
                        </button>
                    </div>
                </div>
            );
        }

        // ** ИСПРАВЛЕНИЕ: Добавлены защитные проверки для предотвращения "белого экрана" **
        function ChatInterface({ user, ticketId, onBack, t }) {
            const [messages, setMessages] = useState([]);
            const [newMessage, setNewMessage] = useState('');
            const [chatPartner, setChatPartner] = useState(null);
            const [loading, setLoading] = useState(true);
            const chatEndRef = useRef(null);
            const isAdmin = user.uid === ADMIN_UID;
            
            useEffect(() => {
                const fetchChatPartner = async () => {
                    if (isAdmin) {
                        const ticketDoc = await getDoc(doc(db, 'supportTickets', ticketId));
                        if(ticketDoc.exists()) {
                            const data = ticketDoc.data();
                            setChatPartner({id: ticketId, name: data.userName, avatar: data.userAvatar});
                        }
                    } else {
                         setChatPartner({id: ADMIN_UID, name: t.chatWithAdmin, avatar: 'https://placehold.co/128x128/1f2937/FFFFFF?text=A'});
                    }
                    setLoading(false);
                }
                fetchChatPartner();
            }, [ticketId, isAdmin]);

            useEffect(() => {
                if(!ticketId) return;
                const messagesQuery = query(collection(db, 'supportTickets', ticketId, 'messages'), orderBy('timestamp'));
                const unsubscribe = onSnapshot(messagesQuery, snapshot => {
                    setMessages(snapshot.docs.map(doc => doc.data()));
                });
                return unsubscribe;
            }, [ticketId]);

            useEffect(() => {
                chatEndRef.current?.scrollIntoView({ behavior: 'smooth' });
            }, [messages]);

            const handleSendMessage = async (e) => { /* ... без изменений ... */ };

            if(loading || !chatPartner) return <LoadingSpinner />;

            return (
                <div className="container mx-auto p-4 md:p-8">
                    <div className="max-w-3xl mx-auto bg-secondary rounded-lg shadow-xl flex flex-col h-[80vh]">
                        <div className="flex items-center p-4 border-b border-color">
                            <button onClick={onBack} className="mr-4 text-primary">←</button>
                            <img src={chatPartner.avatar} className="w-10 h-10 rounded-full mr-3"/>
                            <h2 className="text-xl font-bold text-primary">{chatPartner.name}</h2>
                        </div>
                        {/* ... остальной интерфейс чата без изменений ... */}
                    </div>
                </div>
            );
        }

        function FAQPage({ faqs, t }) { /* ... без изменений ... */ };
        
        // ** НОВАЯ ЛОГИКА: Полностью переписанная страница покупок **
        function MyPurchasesPage({ user, t, currency, convertPrice }) {
            const [myPurchases, setMyPurchases] = useState([]);
            const [loading, setLoading] = useState(true);
            const [dateFilter, setDateFilter] = useState('all');
            const [sortOrder, setSortOrder] = useState('date_desc');

            useEffect(() => {
                if (!user) { setLoading(false); return; }
                setLoading(true);
                const q = query(collection(db, "purchases"), where("userId", "==", user.uid), orderBy("timestamp", "desc"));
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    setMyPurchases(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                    setLoading(false);
                }, () => setLoading(false));

                return () => unsubscribe();
            }, [user]);
            
            const filteredAndSortedPurchases = useMemo(() => {
                let items = [...myPurchases];
                if (dateFilter !== 'all') { /* ... логика фильтра ... */ }
                if (sortOrder === 'price_asc') items.sort((a, b) => (a.finalPrice || 0) - (b.finalPrice || 0));
                else items.sort((a, b) => (b.timestamp?.toMillis() || 0) - (a.timestamp?.toMillis() || 0));
                return items;
            }, [myPurchases, dateFilter, sortOrder]);

            const getStatusClass = (status) => { /* ... без изменений ... */ };
            const getStatusText = (status) => { /* ... без изменений ... */ };
            const FilterButton = ({ value, state, setState, children }) => { /* ... без изменений ... */ };

            return (
                <div className="container mx-auto p-4 md:p-8">
                    <h1 className="text-4xl font-bold text-center mb-8 text-primary">{t.myPurchases}</h1>
                    {/* ... блок фильтров ... */}
                    {loading ? <LoadingSpinner /> : (
                        filteredAndSortedPurchases.length === 0 ? <p className="text-center text-secondary">{t.noPurchasesYet}</p> : (
                            <div className="space-y-4 max-w-3xl mx-auto">
                                {filteredAndSortedPurchases.map(purchase => (
                                    <div key={purchase.id} className="bg-secondary p-4 rounded-lg">
                                        <div className="flex justify-between items-start flex-wrap">
                                            <div>
                                                <p className="font-bold text-primary text-lg">{purchase.productName}</p>
                                                {/* ** НОВАЯ ЛОГИКА: Отображение уникального кода ** */}
                                                <p className="font-mono text-sm accent-text bg-tertiary inline-block px-2 py-1 rounded my-1">Код: {purchase.purchaseCode}</p>
                                                <p className="text-sm text-secondary">{new Date(purchase.timestamp?.toDate()).toLocaleString()}</p>
                                                <p className="text-sm text-secondary">{t.amount}: {convertPrice(purchase.finalPrice, currency)}</p>
                                            </div>
                                            <span className={`mt-2 sm:mt-0 px-2 py-1 text-xs font-bold text-white rounded-full ${getStatusClass(purchase.status)}`}>
                                                {getStatusText(purchase.status)}
                                            </span>
                                        </div>
                                        {purchase.adminComment && ( /* ... */ )}
                                        {(purchase.status === 'approved' || purchase.status === 'contacted') && ( /* ... */ )}
                                    </div>
                                ))}
                            </div>
                        )
                    )}
                </div>
            );
        }

        // ** НОВАЯ ЛОГИКА: Полностью переписанная админ-панель для работы с чатами и едиными покупками **
        function AdminPage({ products, faqs, setAlertInfo, t, setActiveTicketId, handleDeleteProduct }) {
            const [view, setView] = useState('dashboard');
            const [pendingPurchases, setPendingPurchases] = useState([]);
            const [allTickets, setAllTickets] = useState([]);
            const [adminComments, setAdminComments] = useState({});
            // ... (остальные state без изменений)

            useEffect(() => {
                const purchasesQuery = query(collection(db, 'purchases'), where('status', '==', 'pending'), orderBy('timestamp', 'desc'));
                const unsubPurchases = onSnapshot(purchasesQuery, snapshot => setPendingPurchases(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))));
                
                // ** НОВАЯ ЛОГИКА: Загрузка всех тикетов для админа **
                const ticketsQuery = query(collection(db, 'supportTickets'), orderBy('lastUpdated', 'desc'));
                const unsubTickets = onSnapshot(ticketsQuery, snapshot => setAllTickets(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))));
                
                return () => { unsubPurchases(); unsubTickets(); };
            }, []);

            const handlePurchaseAction = async (purchaseId, newStatus) => { /* ... без изменений ... */ };

            return (
                <div className="container mx-auto p-4 md:p-8 text-primary">
                    <h1 className="text-4xl font-bold mb-8 text-center">{t.adminPanelTitle}</h1>
                    {view === 'dashboard' && (
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                            <button onClick={() => setView('viewProducts')} className="bg-purple-600 hover:bg-purple-700 p-8 rounded-lg text-2xl font-bold text-white">{t.manageProducts}</button>
                            {/* ** НОВАЯ ЛОГИКА: Новая кнопка для чатов ** */}
                            <button onClick={() => setView('viewChats')} className="bg-cyan-600 hover:bg-cyan-700 p-8 rounded-lg text-2xl font-bold text-white relative">
                                {t.userChats}
                                {allTickets.filter(ticket => ticket.status !== 'answered').length > 0 && <span className="absolute top-2 right-2 bg-red-500 text-white rounded-full h-6 w-6 flex items-center justify-center">{allTickets.filter(ticket => ticket.status !== 'answered').length}</span>}
                            </button>
                            <button onClick={() => setView('checkPurchases')} className="bg-orange-500 hover:bg-orange-600 p-8 rounded-lg text-2xl font-bold text-white relative">
                                {t.checkReceipts}
                                {pendingPurchases.length > 0 && <span className="absolute top-2 right-2 bg-red-500 text-white rounded-full h-6 w-6 flex items-center justify-center">{pendingPurchases.length}</span>}
                            </button>
                            {/* ... остальные кнопки ... */}
                        </div>
                    )}
                    
                    {/* ... остальные view без изменений ... */}

                    {/* ** НОВАЯ ЛОГИКА: Новый view для отображения чатов в админ-панели ** */}
                    {view === 'viewChats' && (
                        <div>
                            <button onClick={() => setView('dashboard')} className="mb-4 bg-tertiary p-2 rounded-lg">← {t.backToPanel}</button>
                            <div className="bg-secondary p-8 rounded-2xl border-color">
                                <h2 className="text-2xl font-bold mb-6 text-primary">{t.userChats}</h2>
                                <div className="space-y-2">
                                    {allTickets.length === 0 ? <p className="text-secondary">{t.noTickets}</p> : allTickets.map(ticket => (
                                        <div key={ticket.id} onClick={() => setActiveTicketId(ticket.id)} className="flex items-center p-3 bg-tertiary rounded-lg cursor-pointer hover:bg-gray-700">
                                            <img src={ticket.userAvatar} className="w-10 h-10 rounded-full mr-4"/>
                                            <div className="flex-grow">
                                                <p className="font-bold text-primary">{ticket.userName}</p>
                                                <p className="text-sm text-secondary">{ticket.lastMessage || '...'}</p>
                                            </div>
                                            {ticket.status !== 'answered' && <div className="w-3 h-3 bg-green-400 rounded-full ml-auto"></div>}
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    )}

                    {view === 'checkPurchases' && (
                        <div>
                             <button onClick={() => setView('dashboard')} className="mb-4 bg-tertiary p-2 rounded-lg">← {t.backToPanel}</button>
                            <div className="bg-secondary p-8 rounded-2xl border-color">
                                <h2 className="text-2xl font-bold mb-6 text-primary">{t.checkReceipts}</h2>
                                {pendingPurchases.length === 0 ? <p className="text-secondary">{t.noPendingReceipts}</p> : (
                                    <div className="space-y-4">
                                        {pendingPurchases.map(purchase => (
                                            <div key={purchase.id} className="bg-tertiary p-4 rounded-lg">
                                                {/* ** НОВАЯ ЛОГИКА: Отображение уникального кода в админ-панели ** */}
                                                <p className="font-mono text-sm accent-text bg-gray-800 inline-block px-2 py-1 rounded my-1">Код: {purchase.purchaseCode}</p>
                                                {/* ... остальная информация о покупке ... */}
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        function Footer({t}) { /* ... без изменений ... */ };
        
        // ** НОВАЯ ЛОГИКА: Основной компонент App с переписанными хендлерами **
        function App() {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [products, setProducts] = useState([]);
            const [faqs, setFaqs] = useState([]);
            const [page, setPage] = useState('home');
            const [alertInfo, setAlertInfo] = useState(null);
            const [language, setLanguage] = useState('ru');
            const [currency, setCurrency] = useState('UZS');
            const [profileVisible, setProfileVisible] = useState(false);
            const [activeTicketId, setActiveTicketId] = useState(null);
            const [selectedProduct, setSelectedProduct] = useState(null);
            const [purchasingProduct, setPurchasingProduct] = useState(null);
            const [yooMoneyData, setYooMoneyData] = useState(null);
            const [theme, setTheme] = useState('dark');

            // ... useEffect-хуки без изменений ...

            const isAdmin = user && user.uid === ADMIN_UID;
            const t = translations[language];

            // ** НОВАЯ ЛОГИКА: Хендлер для YooMoney, создающий покупку с уникальным кодом **
            const handleReceiptSubmit = async (product, purchaseDetails, receiptData) => {
                if (!user) return;
                const { receiptFile, contactTelegram, contactEmail } = receiptData;
                const formData = new FormData();
                formData.append('image', receiptFile);

                try {
                    const imgbbResponse = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, { method: 'POST', body: formData });
                    const imgbbResult = await imgbbResponse.json();
                    if (!imgbbResult.success) throw new Error(imgbbResult.error.message || 'ImgBB upload failed');
                    
                    const purchaseCode = generatePurchaseCode();
                    const purchasePayload = {
                        userId: user.uid, userEmail: user.email,
                        productId: product.id, productName: product.name,
                        timestamp: serverTimestamp(),
                        originalPrice: product.price, finalPrice: purchaseDetails.finalPrice,
                        promoCodeUsed: purchaseDetails.promoCodeUsed,
                        paymentMethod: purchaseDetails.paymentMethod,
                        contactTelegram, contactEmail, 
                        receiptImageUrl: imgbbResult.data.url,
                        status: 'pending',
                        purchaseCode: purchaseCode
                    };
                    await addDoc(collection(db, 'purchases'), purchasePayload);

                    // ... (обновление промокодов и популярности)

                    setAlertInfo({ message: `${t.receiptSent}\n\n${t.yourPurchaseCode}: ${purchaseCode}` });

                } catch (error) { /* ... */ }
            };

            // ** НОВАЯ ЛОГИКА: Хендлер для Telegram, создающий покупку с уникальным кодом **
            const handleConfirmPurchase = async (product, purchaseDetails) => {
                if (!user) return;
                try {
                    const purchaseCode = generatePurchaseCode();
                    await addDoc(collection(db, 'purchases'), {
                        userId: user.uid, userEmail: user.email,
                        productId: product.id, productName: product.name,
                        timestamp: serverTimestamp(),
                        originalPrice: product.price, finalPrice: purchaseDetails.finalPrice,
                        promoCodeUsed: purchaseDetails.promoCodeUsed,
                        paymentMethod: purchaseDetails.paymentMethod,
                        status: 'contacted',
                        purchaseCode: purchaseCode
                    });
                    
                    // ... (обновление промокодов и популярности)
                    
                    setAlertInfo({ message: `${t.contactSellerToReceive}\n\n${t.yourPurchaseCode}: ${purchaseCode}` });

                } catch (error) { /* ... */ }
            };
            
            const renderPage = () => {
                switch (page) {
                    case 'admin': return isAdmin ? <AdminPage {...{products, faqs, setAlertInfo, t, setActiveTicketId}} /> : <HomePage {...{products, onProductClick: setSelectedProduct, t, currency, convertPrice, loading}} />;
                    case 'purchases': return user ? <MyPurchasesPage {...{user, t, currency, convertPrice}} /> : <div className="text-center text-primary p-10">{t.loginToView}</div>;
                    case 'chats': return user && !isAdmin ? <ChatsPage {...{user, t, setActiveTicketId, setAlertInfo}}/> : <div className="text-center text-primary p-10">{isAdmin ? t.adminChatsInPanel : t.loginForSupport}</div>;
                    case 'faq': return <FAQPage faqs={faqs} t={t} />;
                    default: return <HomePage {...{products, onProductClick: setSelectedProduct, t, currency, convertPrice, loading}} />;
                }
            };
            
            if (loading && !products.length) return <LoadingSpinner />;

            return (
                <div className="bg-primary min-h-screen font-sans flex flex-col">
                    <Header {...{user, onLogin: ()=>{}, onLogout: ()=>{}, setPage, isAdmin, t, currency, setCurrency, language, setLanguage, setProfileVisible, theme, setTheme}} />
                    <div className="flex-grow">
                        {activeTicketId && user ? <ChatInterface user={user} ticketId={isAdmin ? activeTicketId : user.uid} onBack={() => setActiveTicketId(null)} t={t} /> : renderPage()}
                    </div>
                    {/* ... Модальные окна ... */}
                    <Footer t={t}/>
                </div>
            );
        }
        
        // ** ИСПРАВЛЕНИЕ: Обновлены и добавлены ключи перевода **
        const translations = {
            ru: {
                // ... (все старые переводы)
                myPurchases: 'Мои покупки',
                noPurchasesYet: 'У вас еще нет покупок.',
                statusPending: 'На проверке',
                statusApproved: 'Одобрена',
                statusRejected: 'Отклонена',
                statusContacted: 'Ожидает связи',
                contactSellerToReceive: 'Заказ зарегистрирован! Свяжитесь с продавцом.',
                checkReceipts: 'Проверка покупок',
                noPendingReceipts: 'Нет покупок, ожидающих проверки.',
                adminChatsInPanel: 'Ваши чаты находятся в админ-панели.',
                yourPurchaseCode: 'Ваш уникальный код покупки',
                idCopied: 'ID скопирован в буфер обмена!',
                clickToCopy: 'Нажмите, чтобы скопировать',
                // ... (остальные ключи)
            },
            en: {}, uz: {}
        };

        const currencyRates = { RUB: 1, USD: 0.011, UZS: 140 };
        const currencySymbols = { RUB: '₽', USD: '$', UZS: "so'm" };
        const convertPrice = (priceInRub, targetCurrency) => { /* ... */ };

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
