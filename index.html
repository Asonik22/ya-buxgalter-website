<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asonik Store</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üõí</text></svg>" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <style>
        :root {
            --bg-light: #f3e5f5;
            --text-light: #1f2937;
            --card-bg-light: #ffffff;
            --primary-light: #9c27b0;
            --primary-hover-light: #7b1fa2;
            --border-light: #e1bee7;
            --logo-text-light: #6a0dad;

            --bg-dark: #12001a;
            --text-dark: #f3e5f5;
            --card-bg-dark: #2c003e;
            --primary-dark: #ba68c8;
            --primary-hover-dark: #ab47bc;
            --border-dark: #4a148c;
            --logo-text-dark: #e1bee7;
        }
        html.dark {
            --bg: var(--bg-dark); --text: var(--text-dark); --card-bg: var(--card-bg-dark);
            --primary: var(--primary-dark); --primary-hover: var(--primary-hover-dark);
            --border: var(--border-dark); --logo-text: var(--logo-text-dark);
        }
        html:not(.dark) {
            --bg: var(--bg-light); --text: var(--text-light); --card-bg: var(--card-bg-light);
            --primary: var(--primary-light); --primary-hover: var(--primary-hover-light);
            --border: var(--border-light); --logo-text: var(--logo-text-light);
        }
        body { font-family: 'Manrope', sans-serif; background-color: var(--bg); color: var(--text); transition: background-color 0.3s, color 0.3s; }
        .logo-text { color: var(--logo-text); }
        .product-card, button, a { transition: all 0.2s ease-in-out; }
        .product-card:hover { transform: translateY(-4px); box-shadow: 0 8px 25px rgba(102, 102, 255, 0.1); }
        html.dark .product-card:hover { box-shadow: 0 8px 25px rgba(0,0,0,0.3); }
        .bg-primary { background-color: var(--primary); }
        .hover\:bg-primary-hover:hover { background-color: var(--primary-hover); }
        .text-primary { color: var(--primary); }
        .border-custom { border-color: var(--border); }
        .card-bg { background-color: var(--card-bg); }
        .input-bg { background-color: var(--bg); border-color: var(--border); }
        .modal-backdrop { background-color: rgba(0, 0, 0, 0.7); }
        [data-page] { display: none; }
        [data-page].active { display: block; }
        .admin-tabs { display: flex; flex-wrap: wrap; border-bottom: 1px solid var(--border); margin-bottom: 1.5rem; }
        .admin-tabs .admin-tab-btn { padding: 0.75rem 1.25rem; border-radius: 0.5rem 0.5rem 0 0; margin-right: 0.5rem; margin-bottom: -1px; background-color: transparent; color: var(--text); font-weight: 600; border: 1px solid transparent; border-bottom: none; }
        .admin-tabs .admin-tab-btn.active { background-color: var(--primary); color: white; border-color: var(--border); border-bottom-color: var(--primary); }
        .admin-tabs .admin-tab-btn:hover:not(.active) { background-color: var(--card-bg); color: var(--primary-hover); }
        #mobile-menu { transition: opacity 0.3s ease-in-out; }
        #mobile-menu-panel { transition: transform 0.3s ease-in-out; }
    </style>
</head>
<body>

    <header class="card-bg shadow-md sticky top-0 z-40 border-b border-custom">
        <div class="container mx-auto px-4">
            <div class="flex justify-between items-center h-16">
                <a href="#main" class="flex items-center gap-3 text-2xl font-bold nav-link">
                    <img id="store-logo" src="" alt="logo" class="h-8 w-8 rounded-full hidden">
                    <span class="logo-text">Asonik Store</span>
                </a>

                <nav class="hidden md:flex items-center space-x-6">
                    <a href="#main" class="nav-link text-gray-600 dark:text-gray-300 hover:text-primary" data-lang-key="nav_main">–ì–ª–∞–≤–Ω–∞—è</a>
                    <a href="#purchases" class="nav-link text-gray-600 dark:text-gray-300 hover:text-primary" data-lang-key="nav_purchases">–ú–æ–∏ –ø–æ–∫—É–ø–∫–∏</a>
                </nav>

                <div class="flex items-center space-x-2 md:space-x-4">
                    <button id="balance-btn" class="hidden items-center gap-2 px-3 py-2 text-sm font-semibold rounded-md bg-primary/20 text-primary hover:bg-primary/30">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M10 4a2 2 0 100 4 2 2 0 000-4zM2 6a8 8 0 1116 0H2zm8 12a2 2 0 100-4 2 2 0 000 4z"></path></svg>
                        <span id="user-balance-display">0</span>
                    </button>
                    <button id="theme-toggle" class="p-2 rounded-full text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700"></button>
                    <div id="auth-container" class="relative"></div>
                    <button id="mobile-menu-btn" class="md:hidden p-2 rounded-md text-gray-500 dark:text-gray-400">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <div id="mobile-menu" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 opacity-0">
        <div id="mobile-menu-panel" class="fixed top-0 right-0 h-full w-64 card-bg shadow-lg p-6 transform translate-x-full">
            <button id="mobile-menu-close-btn" class="absolute top-4 right-4 p-2 text-2xl text-gray-500 dark:text-gray-400">&times;</button>
            <nav id="mobile-nav-links" class="flex flex-col space-y-6 text-xl mt-12 text-center">
                 <a href="#main" class="nav-link hover:text-primary" data-lang-key="nav_main">–ì–ª–∞–≤–Ω–∞—è</a>
                 <a href="#purchases" class="nav-link hover:text-primary" data-lang-key="nav_purchases">–ú–æ–∏ –ø–æ–∫—É–ø–∫–∏</a>
            </nav>
        </div>
    </div>

    <main class="container mx-auto px-4 py-8">
        <div data-page="main" class="active">
            <div id="main-page-content-wrapper">
                <h1 class="text-4xl font-bold text-center mb-8" data-lang-key="catalog_title">–ö–∞—Ç–∞–ª–æ–≥ —Ç–æ–≤–∞—Ä–æ–≤</h1>
                <div class="mb-8 p-4 card-bg rounded-lg shadow-md flex flex-col md:flex-row gap-4 items-center border border-custom">
                    <input id="search-input" type="text" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é..." class="w-full md:flex-grow pl-4 pr-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary input-bg">
                </div>
                <div id="products-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>
            </div>
        </div>
        <div data-page="purchases"><div id="purchases-content"><p class="text-center">–ó–∞–≥—Ä—É–∑–∫–∞ –≤–∞—à–∏—Ö –ø–æ–∫—É–ø–æ–∫...</p></div></div>
        <div data-page="admin"><div id="admin-content"></div></div>
        <div data-page="profile"><div id="profile-content"></div></div>
    </main>

    <div id="modals-container"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, addDoc, collection, getDocs, onSnapshot, updateDoc, deleteDoc, query, where, serverTimestamp, orderBy, increment, writeBatch, arrayUnion, arrayRemove, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDim7T4GqxZK4zM9tBDLkcGTSveVOaUbMY",
            authDomain: "asonikstore-v3.firebaseapp.com",
            projectId: "asonikstore-v3",
            storageBucket: "asonikstore-v3.appspot.com",
            messagingSenderId: "1018442222532",
            appId: "1:1018442222532:web:9b78f7be6c5c02bb327291",
        };
        const IMGBB_API_KEY = '96bf3f29606f1989bb5a450ad3770cce';
        const ADMIN_UID = 'MrjXzJnZYbb6jb65B4f4aYDTVBt2';

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        enableIndexedDbPersistence(db).catch(err => console.warn("Persistence disabled", err.code));

        let currentUser = null;
        let isAdmin = false;
        let allProducts = [];
        const appState = { currency: 'UZS', rates: { UZS: 1, RUB: 0.0073, USD: 0.000078 }, balance: 0, balanceHistory: [] };
        const translations = { RU: { nav_main: '–ì–ª–∞–≤–Ω–∞—è', nav_purchases: '–ú–æ–∏ –ø–æ–∫—É–ø–∫–∏', catalog_title: '–ö–∞—Ç–∞–ª–æ–≥ —Ç–æ–≤–∞—Ä–æ–≤', search_placeholder: '–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é...', purchases_title: '–ú–æ–∏ –ø–æ–∫—É–ø–∫–∏', profile_title: '–ü—Ä–æ—Ñ–∏–ª—å', buy_button: '–ö—É–ø–∏—Ç—å', }, };
        function t(key) { return translations.RU[key] || key; }
        function translatePage() { document.querySelectorAll('[data-lang-key]').forEach(el => { el.textContent = t(el.dataset.langKey); }); }

        document.addEventListener('DOMContentLoaded', () => {
            initTheme();
            setupEventListeners();
            onAuthStateChanged(auth, async (user) => {
                await initializeAppState(user);
            });
        });

        async function initializeAppState(user) {
            currentUser = user;
            isAdmin = user ? user.uid === ADMIN_UID : false;
            if (user) {
                const userRef = doc(db, "users", user.uid);
                onSnapshot(userRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        appState.balance = data.balance || 0;
                        appState.balanceHistory = data.balanceHistory || [];
                        updateBalanceDisplay();
                    }
                });
                await setDoc(userRef, { displayName: user.displayName, email: user.email, photoURL: user.photoURL, lastSeen: serverTimestamp() }, { merge: true });
            } else {
                appState.balance = 0;
                appState.balanceHistory = [];
                updateBalanceDisplay();
            }
            updateAuthUI();
            handleRouting();
        }

        function formatPrice(price, currency = appState.currency) { return new Intl.NumberFormat('ru-RU', { style: 'currency', currency: currency, minimumFractionDigits: 0 }).format(price * (appState.rates[currency] || 1)); }
        function showToast(message, isError = false) { const toast = document.createElement('div'); toast.className = `fixed bottom-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg z-50 ${isError ? 'bg-red-500' : 'bg-green-500'}`; toast.textContent = message; document.body.appendChild(toast); setTimeout(() => toast.remove(), 3000); }
        function showModal(title, content, onSave, saveButtonText = '–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å') { const modal = document.createElement('div'); modal.className = 'fixed inset-0 z-50 flex items-center justify-center modal-backdrop'; modal.innerHTML = `<div class="card-bg rounded-lg shadow-xl w-11/12 md:w-2/3 lg:w-1/2 p-6 max-h-[90vh] overflow-y-auto"><div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-bold">${title}</h2><button class="close-modal-btn text-2xl">&times;</button></div><div>${content}</div>${onSave ? `<div class="mt-6 flex justify-end gap-4"><button class="close-modal-btn px-6 py-2 rounded-lg">–û—Ç–º–µ–Ω–∞</button><button class="save-modal-btn bg-primary text-white px-6 py-2 rounded-lg">${saveButtonText}</button></div>` : ''}</div>`; document.getElementById('modals-container').appendChild(modal); modal.querySelectorAll('.close-modal-btn').forEach(btn => btn.onclick = () => modal.remove()); if (onSave) { const saveBtn = modal.querySelector('.save-modal-btn'); saveBtn.onclick = async () => { const shouldClose = await onSave(modal); if (shouldClose !== false) modal.remove(); }; } return modal; }
        const confirmAction = (message, onConfirm) => showModal('–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ', `<p>${message}</p>`, () => { onConfirm(); return true; }, '–î–∞, —É–≤–µ—Ä–µ–Ω');

        function handleRouting() {
            const hash = window.location.hash || '#main';
            let [page, subpage] = (hash.substring(1) || 'main').split('/');
            document.querySelectorAll('[data-page]').forEach(p => p.classList.remove('active'));
            const activePage = document.querySelector(`[data-page="${page}"]`);
            if (activePage) { activePage.classList.add('active'); loadPageContent(page, subpage); }
            else { document.querySelector(`[data-page="main"]`).classList.add('active'); loadPageContent('main'); }
            translatePage();
        }

        async function loadPageContent(page, subpage) {
            if (['purchases', 'profile', 'admin'].includes(page) && !currentUser) {
                const contentEl = document.querySelector(`[data-page="${page}"] > div`);
                if (contentEl) contentEl.innerHTML = `<h1 class="text-4xl font-bold text-center mb-8">${t(page+'_title')}</h1><p class="text-center">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, <a href="#" id="login-redirect" class="text-primary underline">–≤–æ–π–¥–∏—Ç–µ</a>, —á—Ç–æ–±—ã –ø—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å —ç—Ç—É —Å—Ç—Ä–∞–Ω–∏—Ü—É.</p>`;
                return;
            }
            switch(page) {
                case 'main': await loadMainPage(); break;
                case 'admin': await loadAdminPanel(subpage); break;
                case 'purchases': loadPurchasesPage(); break;
                case 'profile': loadProfilePage(); break;
            }
        }

        async function loadMainPage() {
            loadProducts();
            const settingsDoc = await getDoc(doc(db, "storeSettings", "config"));
            if (settingsDoc.exists()) {
                const { logoUrl } = settingsDoc.data();
                const logoEl = document.getElementById('store-logo');
                if (logoUrl) { logoEl.src = logoUrl; logoEl.classList.remove('hidden'); }
                else { logoEl.classList.add('hidden'); }
            }
        }

        function loadProducts() { onSnapshot(query(collection(db, "products")), (snapshot) => { allProducts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); applyFiltersAndSort(); }); }
        function applyFiltersAndSort() { let filtered = [...allProducts]; const searchTerm = document.getElementById('search-input').value.toLowerCase(); if (searchTerm) filtered = filtered.filter(p => p.name.toLowerCase().includes(searchTerm)); filtered.sort((a, b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0)); const productsGrid = document.getElementById('products-grid'); if (!productsGrid) return; productsGrid.innerHTML = ''; if (filtered.length === 0) { productsGrid.innerHTML = `<p class="col-span-full text-center">–¢–æ–≤–∞—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.</p>`; return; } filtered.forEach(product => productsGrid.appendChild(renderProductCard(product))); translatePage(); }

        function renderProductCard(product) {
            const card = document.createElement('div');
            card.className = "card-bg product-card rounded-lg shadow-lg flex flex-col justify-between border border-custom overflow-hidden";
            card.dataset.productId = product.id;
            const privateSellerBadge = product.isPrivateSeller ? `<div class="absolute top-2 left-2 bg-yellow-500 text-white w-8 h-8 rounded-full flex items-center justify-center" title="–ß–∞—Å—Ç–Ω–æ–µ –ª–∏—Ü–æ"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"></path></svg></div>` : '';
            card.innerHTML = `
                <div class="relative">
                    <img src="${product.imageUrl || 'https://placehold.co/600x400/9c27b0/ffffff?text=No+Image'}" onerror="this.onerror=null; this.src='https://placehold.co/600x400/9c27b0/ffffff?text=${encodeURIComponent(product.name)}';" class="w-full h-48 object-cover">
                    ${privateSellerBadge}
                </div>
                <div class="p-4 flex-grow">
                    <h3 class="text-lg font-semibold truncate">${product.name}</h3>
                    <p class="text-gray-600 dark:text-gray-400 mt-1 text-sm h-10 overflow-hidden">${product.description}</p>
                    <p class="text-2xl font-bold text-primary mt-2">${formatPrice(product.price || 0)}</p>
                </div>
                <div class="p-4 pt-2 border-t border-custom flex items-center gap-2">
                    <button class="buy-now-btn flex-grow bg-primary text-white py-2 px-4 rounded-lg hover:bg-primary-hover font-semibold" data-product-id="${product.id}" data-lang-key="buy_button">–ö—É–ø–∏—Ç—å</button>
                </div>`;
            return card;
        }

        function loadProfilePage() { const contentEl = document.getElementById('profile-content'); if (!contentEl || !currentUser) return; contentEl.innerHTML = `<h1 class="text-4xl font-bold text-center mb-8" data-lang-key="profile_title">–ü—Ä–æ—Ñ–∏–ª—å</h1> <div class="max-w-3xl mx-auto card-bg p-8 rounded-2xl shadow-lg border border-custom"> <div class="flex flex-col md:flex-row items-center md:items-start gap-8"> <div class="flex flex-col items-center"> <img id="profile-avatar" src="${currentUser.photoURL || 'https://placehold.co/128x128'}" alt="avatar" class="w-32 h-32 rounded-full mb-4 object-cover border-4 border-primary/50" onerror="this.onerror=null; this.src='https://placehold.co/128x128/ab47bc/ffffff?text=User';"> <input type="file" id="avatar-upload" class="hidden" accept="image/*"> <button id="change-avatar-btn" class="text-sm text-primary hover:underline">–°–º–µ–Ω–∏—Ç—å –∞–≤–∞—Ç–∞—Ä</button> </div><div class="flex-grow w-full"> <h2 class="text-3xl font-bold mb-6">${currentUser.displayName || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'}</h2> <div class="space-y-4"> <div class="flex items-center gap-3"> <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-primary"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg> <input id="profile-name" class="w-full p-2 border-b-2 border-custom bg-transparent focus:outline-none focus:border-primary" value="${currentUser.displayName || ''}"> </div><div class="flex items-center gap-3"> <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-primary"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg> <input class="w-full p-2 border-b-2 border-custom bg-transparent" value="${currentUser.email}" disabled> </div></div><div class="mt-8 flex gap-4"> <button id="save-profile-btn" class="flex-grow bg-primary text-white px-6 py-3 rounded-lg hover:bg-primary-hover font-semibold">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button> <button id="logout-btn-profile" class="flex-grow bg-red-500 text-white px-6 py-3 rounded-lg hover:bg-red-600 font-semibold">–í—ã–π—Ç–∏</button> </div></div></div></div>`; }
        function loadPurchasesPage() {
            const contentEl = document.getElementById('purchases-content');
            if (!currentUser) return;
            contentEl.innerHTML = `<h1 class="text-4xl font-bold text-center mb-8" data-lang-key="purchases_title">–ú–æ–∏ –ø–æ–∫—É–ø–∫–∏</h1><div id="purchases-list" class="space-y-6"></div>`;
            const listEl = document.getElementById('purchases-list');
            const q = query(collection(db, "purchases"), where("userId", "==", currentUser.uid), orderBy("createdAt", "desc"));
            onSnapshot(q, (snapshot) => {
                if (snapshot.empty) { listEl.innerHTML = '<div class="text-center card-bg p-8 rounded-lg shadow-md"><p>–£ –≤–∞—Å –µ—â–µ –Ω–µ—Ç –ø–æ–∫—É–ø–æ–∫.</p></div>'; return; }
                listEl.innerHTML = '';
                snapshot.forEach(doc => {
                    const purchase = doc.data();
                    const item = document.createElement('div');
                    item.className = 'card-bg p-4 sm:p-6 rounded-lg shadow-md border border-custom flex flex-col sm:flex-row gap-6';
                    item.innerHTML = `
                        <div class="w-full sm:w-32 h-32 sm:h-auto flex-shrink-0">
                            <img src="${purchase.items[0].imageUrl}" class="w-full h-full object-cover rounded-md" onerror="this.onerror=null; this.src='https://placehold.co/128x128/ab47bc/ffffff?text=...';">
                        </div>
                        <div class="flex-grow">
                            <h3 class="text-xl font-bold">${purchase.productName}</h3>
                            <div class="text-sm text-gray-600 dark:text-gray-400 space-y-2 mt-2">
                                <p><strong>–î–∞—Ç–∞:</strong> ${new Date(purchase.createdAt.seconds * 1000).toLocaleString()}</p>
                                <p><strong>–û–ø–ª–∞—á–µ–Ω–æ —Å:</strong> ${purchase.paymentMethod}</p>
                            </div>
                        </div>
                    `;
                    listEl.appendChild(item);
                });
            });
        }

        async function showCheckoutModal(product) {
            if (!currentUser) { showModal('–¢—Ä–µ–±—É–µ—Ç—Å—è –≤—Ö–æ–¥', '<p>–î–ª—è —Å–æ–≤–µ—Ä—à–µ–Ω–∏—è –ø–æ–∫—É–ø–∫–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–æ–π—Ç–∏.</p>', () => signInWithGoogle(), '–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Google'); return; }

            const canPayWithBalance = appState.balance >= product.price;
            let paymentOptionsHTML = `
                <button class="payment-option w-full p-4 border rounded-lg flex items-center justify-center gap-3 ${canPayWithBalance ? 'cursor-pointer hover:border-primary' : 'opacity-50 cursor-not-allowed'}" data-method="balance" ${!canPayWithBalance ? 'disabled' : ''}>
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M10 4a2 2 0 100 4 2 2 0 000-4zM2 6a8 8 0 1116 0H2zm8 12a2 2 0 100-4 2 2 0 000 4z"></path></svg>
                    <span>–û–ø–ª–∞—Ç–∏—Ç—å —Å –±–∞–ª–∞–Ω—Å–∞ (${formatPrice(appState.balance)})</span>
                </button>
                <p class="text-center text-gray-500 my-2">–∏–ª–∏</p>
                <button class="payment-option w-full p-4 border rounded-lg cursor-pointer hover:border-primary flex items-center justify-center gap-3" data-method="topup">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"></path></svg>
                    <span>–ü–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å –∏ –∫—É–ø–∏—Ç—å</span>
                </button>
            `;

            const onSave = async () => {
                const userRef = doc(db, "users", currentUser.uid);
                await updateDoc(userRef, { balance: increment(-product.price), balanceHistory: arrayUnion({ type: 'purchase', amount: -product.price, product: product.name, date: new Date().toISOString() }) });
                const purchaseData = { userId: currentUser.uid, userEmail: currentUser.email, items: [{ productId: product.id, name: product.name, price: product.price, imageUrl: product.imageUrl }], productName: product.name, paymentMethod: '–ë–∞–ª–∞–Ω—Å', finalPrice: product.price, createdAt: serverTimestamp() };
                await addDoc(collection(db, "purchases"), purchaseData);
                showToast('–ü–æ–∫—É–ø–∫–∞ —Å–æ–≤–µ—Ä—à–µ–Ω–∞!');
                window.location.hash = '#purchases';
                return true;
            };

            const modal = showModal(`–ü–æ–∫—É–ø–∫–∞: ${product.name}`, `<div class="space-y-2">${paymentOptionsHTML}</div>`, onSave, '–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –ø–æ–∫—É–ø–∫—É');
            const saveBtn = modal.querySelector('.save-modal-btn');
            saveBtn.classList.add('hidden'); // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é

            modal.querySelectorAll('.payment-option').forEach(btn => {
                btn.onclick = () => {
                    const method = btn.dataset.method;
                    if (method === 'balance') {
                        modal.querySelectorAll('.payment-option').forEach(b => b.classList.remove('border-primary', 'ring-2', 'ring-primary'));
                        btn.classList.add('border-primary', 'ring-2', 'ring-primary');
                        saveBtn.classList.remove('hidden');
                    } else if (method === 'topup') {
                        modal.remove();
                        showBalanceModal(true, product.price - appState.balance);
                    }
                }
            });
        }

        function showBalanceModal(isPurchase = false, requiredAmount = 0) {
            let historyHTML = appState.balanceHistory.map(item => `
                <li class="flex justify-between items-center p-2 rounded ${item.type === 'topup' ? 'bg-green-500/10' : 'bg-red-500/10'}">
                    <span>${item.type === 'topup' ? '–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ' : `–ü–æ–∫—É–ø–∫–∞: ${item.product}`}</span>
                    <span class="font-semibold ${item.type === 'topup' ? 'text-green-500' : 'text-red-500'}">${formatPrice(item.amount)}</span>
                </li>
            `).join('');
            if (!historyHTML) historyHTML = `<p class="text-center text-gray-500">–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞.</p>`;

            const modalContent = `
                <div class="text-center mb-4">
                    <p class="text-lg">–¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å</p>
                    <p class="text-4xl font-bold">${formatPrice(appState.balance)}</p>
                    ${isPurchase ? `<p class="text-yellow-500 mt-2">–î–ª—è –ø–æ–∫—É–ø–∫–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø–æ–ø–æ–ª–Ω–∏—Ç—å –Ω–∞ ${formatPrice(requiredAmount)}</p>` : ''}
                </div>
                <div class="space-y-4">
                    <div>
                        <label class="font-semibold">–°—É–º–º–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è</label>
                        <input id="topup-amount" type="number" class="w-full p-2 border rounded input-bg mt-1" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É" value="${requiredAmount > 0 ? requiredAmount : ''}">
                    </div>
                    <div>
                        <h3 class="font-semibold mb-2">–ò—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π</h3>
                        <ul class="space-y-2 max-h-48 overflow-y-auto">${historyHTML}</ul>
                    </div>
                </div>
            `;

            showModal('–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–æ–º', modalContent, async (m) => {
                const amount = parseFloat(m.querySelector('#topup-amount').value);
                if (!amount || amount <= 0) { alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É.'); return false; }

                const userRef = doc(db, "users", currentUser.uid);
                await updateDoc(userRef, { balance: increment(amount), balanceHistory: arrayUnion({ type: 'topup', amount: amount, date: new Date().toISOString() }) });
                showToast(`–ë–∞–ª–∞–Ω—Å –ø–æ–ø–æ–ª–Ω–µ–Ω –Ω–∞ ${formatPrice(amount)}`);
                if (isPurchase) handleRouting(); // –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –ø–æ–ø—ã—Ç–∫–∏ –ø–æ–∫—É–ø–∫–∏
                return true;
            }, '–ü–æ–ø–æ–ª–Ω–∏—Ç—å');
        }

        async function loadAdminPanel(subpage = 'products') {
            if (!isAdmin) return;
            const adminContent = document.getElementById('admin-content');
            const tabs = [ { id: 'products', name: '–¢–æ–≤–∞—Ä—ã' }, { id: 'customization', name: '–ö–∞—Å—Ç–æ–º–∏–∑–∞—Ü–∏—è' }, ];
            adminContent.innerHTML = `<h2 class="text-3xl font-bold mb-6">–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h2> <nav class="admin-tabs mb-6">${tabs.map(tab => `<a href="#admin/${tab.id}" class="admin-tab-btn ${subpage === tab.id ? 'active' : ''}" data-tab="${tab.id}">${tab.name}</a>`).join('')}</nav> <div id="admin-tab-content" class="card-bg p-6 rounded-lg shadow-lg border border-custom min-h-[60vh]"></div>`;
            await loadAdminTab(subpage);
        }

        async function loadAdminTab(tab) {
            if (tab === 'products') loadAdminList('products', '–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞–º–∏', renderAdminProductItem, `<button id="add-product-btn" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600">–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä</button>`);
            if (tab === 'customization') await loadCustomizationPage();
        }

        function loadAdminList(collectionName, title, renderFunction, buttonHtml = '') { const contentEl = document.getElementById('admin-tab-content'); contentEl.innerHTML = `<div class="flex justify-between items-center mb-6"><h3 class="text-2xl font-bold">${title}</h3><div>${buttonHtml}</div></div><div id="admin-list-container" class="space-y-3"></div>`; const listEl = document.getElementById('admin-list-container'); onSnapshot(query(collection(db, collectionName)), (snapshot) => { if(!listEl) return; listEl.innerHTML = snapshot.empty ? '<p>–ó–¥–µ—Å—å –ø–æ–∫–∞ –ø—É—Å—Ç–æ.</p>' : ''; snapshot.forEach(doc => listEl.appendChild(renderFunction(doc.id, doc.data()))); }); }
        async function loadCustomizationPage() {
            const contentEl = document.getElementById('admin-tab-content');
            contentEl.innerHTML = `
                <h3 class="text-2xl font-bold mb-6">–ö–∞—Å—Ç–æ–º–∏–∑–∞—Ü–∏—è –º–∞–≥–∞–∑–∏–Ω–∞</h3>
                <div class="space-y-8">
                    <div class="card-bg p-6 rounded-lg shadow border border-custom">
                        <h4 class="font-bold text-lg mb-4">–õ–æ–≥–æ—Ç–∏–ø –º–∞–≥–∞–∑–∏–Ω–∞</h4>
                        <input type="file" id="logo-upload-input" class="w-full text-sm file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-primary/10 dark:file:bg-violet-900/50 file:text-primary hover:file:bg-primary/20"/>
                        <img id="logo-preview" src="" class="w-24 h-24 object-contain mt-2 p-2 border border-dashed border-custom rounded-lg hidden">
                        <button id="save-customization-btn" class="mt-4 px-6 py-2 bg-primary text-white rounded-lg hover:bg-primary-hover">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                    </div>
                </div>
            `;
            const settingsDoc = await getDoc(doc(db, "storeSettings", "config"));
            if (settingsDoc.exists()) {
                const { logoUrl } = settingsDoc.data();
                if (logoUrl) { const preview = document.getElementById('logo-preview'); preview.src = logoUrl; preview.classList.remove('hidden'); }
            }
        }

        function renderAdminProductItem(id, data) { const item = document.createElement('div'); item.className = 'card-bg p-4 rounded-lg shadow flex justify-between items-center border border-custom'; item.innerHTML = ` <div class="flex items-center gap-4"> <img src="${data.imageUrl || 'https://placehold.co/64x64'}" class="w-12 h-12 rounded-md object-cover"> <div> <p class="font-semibold">${data.name}</p> <p class="text-sm text-gray-400">${formatPrice(data.price)}</p> </div></div><div> <button class="edit-btn text-blue-400 hover:text-blue-300 font-semibold mr-4" data-id="${id}" data-type="product">–†–µ–¥.</button> <button class="delete-btn text-red-500 hover:text-red-400 font-semibold" data-collection="products" data-id="${id}">–£–¥–ª.</button> </div>`; return item; }

        async function showProductForm(productId) {
            let p = { name: '', description: '', price: 0, imageUrl: '', isPrivateSeller: false };
            if (productId) { const docSnap = await getDoc(doc(db, 'products', productId)); if (docSnap.exists()) p = { id: docSnap.id, ...docSnap.data() }; }
            const onSave = async (m) => { const imageFile = m.querySelector('#p-image-file').files[0]; let imageUrl = p.imageUrl; if(imageFile) imageUrl = await uploadImage(imageFile); if(imageFile && !imageUrl) return false; const data = { name: m.querySelector('#p-name').value, description: m.querySelector('#p-desc').value, price: parseFloat(m.querySelector('#p-price').value) || 0, imageUrl, isPrivateSeller: m.querySelector('#p-private').checked, createdAt: p.createdAt || serverTimestamp() }; await (productId ? setDoc(doc(db, 'products', productId), data) : addDoc(collection(db, 'products'), data)); return true; };
            showModal(productId ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–≤–∞—Ä' : '–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä', `<div class="space-y-4"> <input id="p-name" class="w-full p-2 border rounded input-bg" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" value="${p.name}"> <textarea id="p-desc" class="w-full p-2 border rounded input-bg" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ">${p.description}</textarea> <input id="p-price" type="number" class="w-full p-2 border rounded input-bg" placeholder="–¶–µ–Ω–∞ (UZS)" value="${p.price}"> <label>–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ:</label><input type="file" id="p-image-file" class="w-full p-2 border rounded input-bg"> <img id="p-image-preview" src="${p.imageUrl}" class="w-32 h-32 object-cover ${p.imageUrl ? '' : 'hidden'}"> <label class="flex items-center gap-2"><input type="checkbox" id="p-private" ${p.isPrivateSeller ? 'checked' : ''}> –ß–∞—Å—Ç–Ω–æ–µ –ª–∏—Ü–æ</label></div>`, onSave);
        }

        async function uploadImage(file) { const formData = new FormData(); formData.append('image', file); try { const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, { method: 'POST', body: formData }); const result = await response.json(); if (result.success) return result.data.url; else throw new Error(result.error.message); } catch (error) { alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: ' + error.message); return null; } }

        function setupEventListeners() {
            window.addEventListener('hashchange', handleRouting);
            document.body.addEventListener('click', async e => {
                const target = e.target;
                if (target.closest('.nav-link')) { e.preventDefault(); window.location.hash = new URL(target.closest('.nav-link').href).hash; return; }
                if (target.closest('.admin-tab-btn')) { e.preventDefault(); window.location.hash = `admin/${target.closest('.admin-tab-btn').dataset.tab}`; return; }
                if (target.id === 'login-redirect') signInWithGoogle();
                if (target.id === 'google-login-btn') signInWithGoogle();
                if (target.id === 'logout-btn' || target.id === 'logout-btn-profile') signOut(auth).then(() => showToast('–í—ã –≤—ã—à–ª–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞.'));
                if (target.matches('.buy-now-btn')) await showCheckoutModal(allProducts.find(p => p.id === target.dataset.productId));
                if (target.id === 'balance-btn') showBalanceModal();
                if (target.id === 'add-product-btn') await showProductForm();
                if (target.closest('.edit-btn')) await showProductForm(target.closest('.edit-btn').dataset.id);
                if (target.closest('.delete-btn')) confirmAction('–í—ã —É–≤–µ—Ä–µ–Ω—ã?', async () => { await deleteDoc(doc(db, target.dataset.collection, target.dataset.id)); showToast('–£–¥–∞–ª–µ–Ω–æ!'); });
                if (target.id === 'save-profile-btn') { const newName = document.getElementById('profile-name').value; await updateProfile(currentUser, { displayName: newName }); await setDoc(doc(db, "users", currentUser.uid), { displayName: newName }, { merge: true }); showToast('–ü—Ä–æ—Ñ–∏–ª—å –æ–±–Ω–æ–≤–ª–µ–Ω!'); }
                if (target.id === 'change-avatar-btn') document.getElementById('avatar-upload').click();
                if (target.id === 'save-customization-btn') {
                    const logoFile = document.getElementById('logo-upload-input').files[0];
                    let logoUrl = (await getDoc(doc(db, "storeSettings", "config"))).data()?.logoUrl || '';
                    if (logoFile) { const uploadedUrl = await uploadImage(logoFile); if (uploadedUrl) logoUrl = uploadedUrl; else return; }
                    await setDoc(doc(db, "storeSettings", "config"), { logoUrl }, { merge: true });
                    showToast('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!');
                    loadMainPage();
                }
            });

            document.getElementById('search-input').addEventListener('input', applyFiltersAndSort);

            const mobileMenu = document.getElementById('mobile-menu');
            const mobileMenuPanel = document.getElementById('mobile-menu-panel');
            document.getElementById('mobile-menu-btn').addEventListener('click', () => { mobileMenu.classList.remove('hidden'); setTimeout(() => { mobileMenu.classList.remove('opacity-0'); mobileMenuPanel.classList.remove('translate-x-full'); }, 10); });
            const closeMobileMenu = () => { mobileMenu.classList.add('opacity-0'); mobileMenuPanel.classList.add('translate-x-full'); setTimeout(() => mobileMenu.classList.add('hidden'), 300); }
            document.getElementById('mobile-menu-close-btn').addEventListener('click', closeMobileMenu);
            document.getElementById('mobile-nav-links').addEventListener('click', (e) => { if(e.target.classList.contains('nav-link')) closeMobileMenu(); });
        }

        function initTheme() {
            const themeToggleBtn = document.getElementById('theme-toggle');
            if (!themeToggleBtn) return;
            const moonIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>`;
            const sunIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>`;
            const applyTheme = (theme) => { if (theme === 'dark') { document.documentElement.classList.add('dark'); themeToggleBtn.innerHTML = sunIcon; } else { document.documentElement.classList.remove('dark'); themeToggleBtn.innerHTML = moonIcon; } };
            const savedTheme = localStorage.getItem('color-theme');
            const currentTheme = savedTheme || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
            applyTheme(currentTheme);
            themeToggleBtn.onclick = () => { const newTheme = document.documentElement.classList.contains('dark') ? 'light' : 'dark'; localStorage.setItem('color-theme', newTheme); applyTheme(newTheme); };
        }

        function updateAuthUI() {
            const container = document.getElementById('auth-container');
            if(!container) return;
            if (currentUser) {
                container.innerHTML = `<div class="relative"><button id="profile-btn" class="flex items-center gap-2"><img src="${currentUser.photoURL || 'https://placehold.co/32x32'}" alt="–ü—Ä–æ—Ñ–∏–ª—å" class="w-8 h-8 rounded-full" onerror="this.onerror=null; this.src='https://placehold.co/32x32/ab47bc/ffffff?text=${currentUser.displayName?.charAt(0) || 'U'}';"></button><div id="profile-menu" class="hidden absolute right-0 mt-2 w-52 card-bg rounded-md shadow-lg border border-custom z-10"><div class="px-4 py-2 border-b border-custom"><p class="font-semibold truncate">${currentUser.displayName}</p><p class="text-sm text-gray-400 truncate">${currentUser.email}</p></div><a href="#profile" class="nav-link block px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-700">–ü—Ä–æ—Ñ–∏–ª—å</a>${isAdmin ? `<a href="#admin" class="nav-link block px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-700">–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</a>` : ''}<div class="border-t border-custom"></div><a href="#" id="logout-btn" class="block px-4 py-2 text-sm text-red-500 hover:bg-gray-100 dark:hover:bg-gray-700">–í—ã–π—Ç–∏</a></div></div>`;
                document.getElementById('profile-btn').addEventListener('click', (e) => { e.stopPropagation(); document.getElementById('profile-menu')?.classList.toggle('hidden'); });
            } else {
                container.innerHTML = `<button id="google-login-btn" class="px-4 py-2 bg-primary text-white rounded-md hover:bg-primary-hover font-semibold flex items-center gap-2"><svg class="w-5 h-5" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611 20.083H42V20H24v8h11.303c-1.649 4.657-6.08 8-11.303 8c-6.627 0-12-5.373-12-12s5.373-12 12-12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4C12.955 4 4 12.955 4 24s8.955 20 20 20s20-8.955 20-20c0-1.341-.138-2.65-.389-3.917z"></path><path fill="#FF3D00" d="M6.306 14.691l6.571 4.819C14.655 15.108 18.961 12 24 12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4C16.318 4 9.656 8.337 6.306 14.691z"></path><path fill="#4CAF50" d="M24 44c5.166 0 9.86-1.977 13.409-5.192l-6.19-5.238C29.211 35.091 26.715 36 24 36c-5.202 0-9.619-3.317-11.283-7.946l-6.522 5.025C9.505 39.556 16.227 44 24 44z"></path><path fill="#1976D2" d="M43.611 20.083H42V20H24v8h11.303c-.792 2.237-2.231 4.166-4.087 5.571l6.19 5.238C44.572 34.043 46 29.392 46 24c0-1.341-.138-2.65-.389-3.917z"></path></svg>–í–æ–π—Ç–∏</button>`;
            }
        }
        function signInWithGoogle() { const provider = new GoogleAuthProvider(); signInWithPopup(auth, provider).catch((error) => { console.error("Google Sign-In Error: ", error); showToast("–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: " + error.message, true); }); }
        function updateBalanceDisplay() {
            const balanceBtn = document.getElementById('balance-btn');
            const balanceDisplay = document.getElementById('user-balance-display');
            if (currentUser) {
                balanceBtn.classList.remove('hidden');
                balanceBtn.classList.add('flex');
                balanceDisplay.textContent = formatPrice(appState.balance);
            } else {
                balanceBtn.classList.add('hidden');
                balanceBtn.classList.remove('flex');
            }
        }
    </script>
</body>
</html>
