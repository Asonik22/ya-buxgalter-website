<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asonik Store</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, doc, deleteDoc, setDoc, serverTimestamp, query, where, orderBy, updateDoc, getDocs, increment, getDoc, runTransaction } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-storage.js";
        
        // Make Firebase services globally available
        window.firebase = {
            initializeApp, getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut, updateProfile,
            getFirestore, collection, onSnapshot, addDoc, doc, deleteDoc, setDoc, serverTimestamp, query, where, orderBy, updateDoc, getDocs, increment, getDoc, runTransaction,
            getStorage, ref, uploadBytes, getDownloadURL, deleteObject
        };
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; transition: background-color 0.3s, color 0.3s; }
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap');
        
        /* --- THEMES --- */
        :root, body.firm-dark {
            --bg-primary: #111827; --bg-secondary: #1f2937; --bg-tertiary: #374151;
            --text-primary: #f9fafb; --text-secondary: #d1d5db;
            --accent-primary: #8b5cf6; --accent-secondary: #a78bfa;
            --border-color: #374151;
            --modal-overlay: rgba(17, 24, 39, 0.8);
        }
        body.firm-light {
            --bg-primary: #f3e8ff; --bg-secondary: #ffffff; --bg-tertiary: #f3f4f6;
            --text-primary: #4c1d95; --text-secondary: #6d28d9;
            --accent-primary: #8b5cf6; --accent-secondary: #a78bfa; --border-color: #e5e7eb;
            --modal-overlay: rgba(243, 232, 255, 0.8);
        }
        
        /* --- Additional Styles --- */
        .firm-light .bg-secondary { box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.05), 0 2px 4px -2px rgb(0 0 0 / 0.05); }
        .firm-light .header-text { color: #4c1d95; }
        .firm-light .header-text:hover { color: #6d28d9; }
        .accent-text { color: var(--accent-primary); }
        .accent-bg { background-color: var(--accent-primary); }
        .accent-bg-secondary { background-color: var(--accent-secondary); }

        .mobile-menu-container {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--bg-primary); z-index: 50;
            display: flex; flex-direction: column; padding: 1rem; transform: translateX(100%); transition: transform 0.3s ease-out;
        }
        .mobile-menu-container.open { transform: translateX(0%); }
        .admin-sidebar a.active { background-color: var(--accent-primary); color: white; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useRef, useMemo, createContext, useContext } = React;
        const { 
            initializeApp, getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut, updateProfile,
            getFirestore, collection, onSnapshot, addDoc, doc, deleteDoc, setDoc, serverTimestamp, query, where, orderBy, updateDoc, getDocs, increment, getDoc, runTransaction,
            getStorage, ref, uploadBytes, getDownloadURL
        } = window.firebase;

        // --- App Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyC7smDYoy-LT58xCwjJsc9uZU9CgHQv5dM",
            authDomain: "ya-buxgalter.firebaseapp.com",
            projectId: "ya-buxgalter",
            storageBucket: "ya-buxgalter.appspot.com",
            messagingSenderId: "640345805387",
            appId: "1:640345805387:web:a1adade77f809af84cb3ce",
            measurementId: "G-0TKE25JVXG"
        };
        
        const ADMIN_UID = 'vhmtXZxkZnOWviNQ39R1W3GE8mw2';
        const ADMIN_PIN = '300414';
        const IMGBB_API_KEY = '96bf3f29606f1989bb5a450ad3770cce';

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);
        const provider = new GoogleAuthProvider();
        
        const logoBase64 = "data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/2wBDAAYEBQYFBAYGBQYHBwYIChAKCgkJChQODwwQFxQYGBcUFhYaHSUfGhsjHBYWICwgIyYnKSopGR8tMC0oMCUoKSj/2wBDAQcHBwoIChMKChMoGhYaKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCj/wAARCAAgACADASIAAhEBARAf/8QAGQAAAgMBAAAAAAAAAAAAAAAAAAYDBAUH/8QAIxAAAQQCAgICAwAAAAAAAAAAAQIDBAUGEQASITFBURMUYf/EABQBAQAAAAAAAAAAAAAAAAAAAAD/xAAUEQEAAAAAAAAAAAAAAAAAAAAA/9oADAMBAAIREAPwD2ERkACK5uX1WzYtprKqKxckO2E5sNqS0lxLbqFpWlQBSoAgjYI9j39cZkABEV7OpaO6xYlXl0V6bYSHENNR2klS1qUoJSkAekkkgD+8YkABGczL6bT1kuyupLMNhhJWtbywkgD6Gz1J+g98ZkAB//2Q==";

        // --- Router ---
        const useHashRouter = () => {
            const [hash, setHash] = useState(window.location.hash);
            const handleHashChange = useCallback(() => setHash(window.location.hash), []);
            useEffect(() => {
                window.addEventListener('hashchange', handleHashChange);
                return () => window.removeEventListener('hashchange', handleHashChange);
            }, []);
            const navigate = (to) => window.location.hash = to;
            return { path: hash || '#/', navigate };
        };
        const Link = ({ to, children, className }) => <a href={to} className={className}>{children}</a>;

        // --- Cart Context ---
        const CartContext = createContext();
        const CartProvider = ({ children }) => {
            const [cartItems, setCartItems] = useState(() => {
                try {
                    const localData = localStorage.getItem('asonikCart');
                    return localData ? JSON.parse(localData) : [];
                } catch (error) { return []; }
            });
            useEffect(() => { localStorage.setItem('asonikCart', JSON.stringify(cartItems)); }, [cartItems]);

            const addToCart = (product, selectedVariant) => {
                setCartItems(prevItems => {
                    const itemInCart = prevItems.find(item => item.id === product.id && item.variant.nominal.ru === selectedVariant.nominal.ru);
                    if (itemInCart) {
                        return prevItems.map(item =>
                            item.id === product.id && item.variant.nominal.ru === selectedVariant.nominal.ru
                                ? { ...item, quantity: item.quantity + 1 } : item
                        );
                    } else {
                        return [...prevItems, { ...product, variant: selectedVariant, quantity: 1 }];
                    }
                });
            };
            const removeFromCart = (productId, variantNominalRu) => {
                setCartItems(prevItems => prevItems.filter(item => !(item.id === productId && item.variant.nominal.ru === variantNominalRu)));
            };
            const updateQuantity = (productId, variantNominalRu, quantity) => {
                if (quantity <= 0) {
                    removeFromCart(productId, variantNominalRu);
                } else {
                    setCartItems(prevItems =>
                        prevItems.map(item =>
                            item.id === productId && item.variant.nominal.ru === variantNominalRu
                                ? { ...item, quantity } : item
                        )
                    );
                }
            };
            const clearCart = () => setCartItems([]);
            const cartTotal = useMemo(() => cartItems.reduce((total, item) => total + item.variant.price * item.quantity, 0), [cartItems]);

            return (
                <CartContext.Provider value={{ cartItems, addToCart, removeFromCart, updateQuantity, clearCart, cartTotal }}>
                    {children}
                </CartContext.Provider>
            );
        };
        const useCart = () => useContext(CartContext);

        // --- Helper Components & Functions ---
        const generatePurchaseCode = () => 'A' + Math.random().toString(36).substr(2, 8).toUpperCase();
        const Logo = ({t}) => ( <Link to="#/" className="flex items-center space-x-2 cursor-pointer"> <img src={logoBase64} alt="Asonik Store Logo" className="h-12 w-12 object-contain"/> <span className="text-2xl md:text-3xl font-bold text-primary tracking-wider"> Asonik <span className="accent-text">Store</span> </span> </Link> );
        const LoadingSpinner = () => ( <div className="bg-primary min-h-screen flex items-center justify-center"><div className="animate-spin rounded-full h-32 w-32 border-t-4 border-b-4 border-purple-500"></div></div> );
        const Modal = ({ children, onClose, size = 'max-w-md' }) => ( <div className="fixed inset-0 z-50 flex justify-center items-center p-4 transition-opacity duration-300 backdrop-blur-sm" style={{backgroundColor: 'var(--modal-overlay)'}}> <div className={`bg-secondary rounded-2xl shadow-2xl p-6 md:p-8 w-full ${size} relative border-color transform transition-transform duration-300 scale-95 animate-scale-in`}> <button onClick={onClose} className="absolute top-4 right-4 text-secondary hover:text-primary transition-colors z-10"> <svg xmlns="http://www.w3.org/2000/svg" className="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg> </button> {children} </div> <style>{` @keyframes scale-in { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } } .animate-scale-in { animation: scale-in 0.2s ease-out forwards; } `}</style> </div> );
        const AlertModal = ({ message, onConfirm, onCancel, t }) => ( <Modal onClose={onCancel}> <div className="text-center"> <h2 className="text-2xl font-bold text-primary mb-4">{t.confirmation}</h2> <p className="text-secondary mb-6 whitespace-pre-wrap">{message}</p> <div className={`flex ${onConfirm ? 'justify-between' : 'justify-center'} space-x-4`}> <button onClick={onCancel} className="bg-tertiary hover:bg-gray-700 text-primary font-bold py-2 px-6 rounded-lg transition-colors">{onConfirm ? t.cancel : t.ok}</button> {onConfirm && ( <button onClick={onConfirm} className="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg transition-colors">{t.confirm}</button> )} </div> </div> </Modal> );
        const PinModal = ({ onSubmit, onClose, error, t }) => {
            const [pin, setPin] = useState('');
            const [remember, setRemember] = useState(false);
            const handleSubmit = (e) => { e.preventDefault(); onSubmit(pin, remember); };
            return (
                <Modal onClose={onClose} size="max-w-sm">
                    <form onSubmit={handleSubmit} className="text-center">
                        <h2 className="text-2xl font-bold text-primary mb-4">{t.adminAccess}</h2>
                        <p className="text-secondary mb-6">{t.enterPin}</p>
                        <input type="password" value={pin} onChange={(e) => setPin(e.target.value)} className="w-full p-3 bg-tertiary rounded-lg border-color text-primary text-center text-2xl tracking-[.5em]" maxLength="6" autoFocus />
                        {error && <p className="text-red-500 text-sm mt-2">{error}</p>}
                        <div className="flex items-center justify-center mt-4">
                            <input type="checkbox" id="rememberMe" checked={remember} onChange={(e) => setRemember(e.target.checked)} className="h-4 w-4 accent-purple-600"/>
                            <label htmlFor="rememberMe" className="ml-2 text-secondary">{t.rememberMe15min}</label>
                        </div>
                        <button type="submit" className="w-full mt-6 accent-bg hover:accent-bg-secondary text-white font-bold py-3 px-4 rounded-lg transition-colors">{t.enter}</button>
                    </form>
                </Modal>
            );
        };
        const ProfileModal = ({ user, onClose, t, setAlertInfo, onLogout }) => {
            const [isUploading, setIsUploading] = useState(false);
            const fileInputRef = useRef(null);
            const [firstName, setFirstName] = useState('');
            const [lastName, setLastName] = useState('');
            
            useEffect(() => {
                const currentDisplayName = user.displayName || '';
                const parts = currentDisplayName.split(' ');
                setFirstName(parts[0] || '');
                setLastName(parts.slice(1).join(' ') || '');
            }, [user]);

            const handleUpdateProfile = async (e) => {
                e.preventDefault();
                setIsUploading(true);
                try {
                    const newDisplayName = `${firstName} ${lastName}`.trim();
                    await updateProfile(auth.currentUser, { displayName: newDisplayName });
                    setAlertInfo({ message: t.profileUpdated || 'Профиль обновлен!' });
                    setTimeout(() => auth.updateCurrentUser(auth.currentUser), 500); 
                } catch (error) {
                    setAlertInfo({ message: `${t.errorOccurred}: ${error.message}` });
                } finally {
                    setIsUploading(false);
                    onClose();
                }
            };
            
            const handleImageUpload = async (file) => {
                if (!file) return;
                if (!IMGBB_API_KEY) { setAlertInfo({ message: t.noApiKey }); return; }
                setIsUploading(true);
                const formData = new FormData();
                formData.append('image', file);

                try {
                    const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, { method: 'POST', body: formData });
                    const result = await response.json();
                    if (result.success) {
                        await updateProfile(auth.currentUser, { photoURL: result.data.url });
                        setAlertInfo({ message: t.avatarUpdated });
                        setTimeout(() => { auth.updateCurrentUser(auth.currentUser); }, 500);
                    } else { throw new Error(result.error.message); }
                } catch (error) { setAlertInfo({ message: `${t.errorOccurred}: ${error.message}` }); } 
                finally { setIsUploading(false); onClose(); }
            };

            return (
                <Modal onClose={onClose}>
                    <div className="text-center text-primary">
                        <h2 className="text-3xl font-bold mb-4">{t.profile}</h2>
                        <div className="relative mx-auto mb-4 w-24 h-24">
                             <img src={user.photoURL} alt={user.displayName} className={`w-full h-full rounded-full mx-auto border-4 object-cover`} style={{ borderColor: 'var(--accent-primary)' }}/>
                             <button onClick={() => fileInputRef.current.click()} className="absolute bottom-0 right-0 bg-gray-700 p-2 rounded-full border border-color">
                                 <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 text-white" viewBox="0 0 20 20" fill="currentColor"><path d="M13.586 3.586a2 2 0 112.828 2.828l-7.293 7.293A1 1 0 018.657 14H5a1 1 0 01-1-1v-3.657a1 1 0 01.293-.707l7.293-7.293zM10 2a1 1 0 00-1 1v2a1 1 0 102 0V3a1 1 0 00-1-1z" /></svg>
                             </button>
                        </div>
                        <p className="text-xl mb-2">{user.displayName}</p>
                        <p className="text-secondary mb-6">{user.email}</p>
                        
                        <form onSubmit={handleUpdateProfile} className="space-y-4 mb-6">
                            <div>
                                <label className="block text-secondary text-sm font-bold mb-1 text-left">{t.firstName || 'Имя'}</label>
                                <input type="text" value={firstName} onChange={e => setFirstName(e.target.value)} className="w-full p-2 bg-tertiary rounded-lg border-color text-primary"/>
                            </div>
                            <div>
                                <label className="block text-secondary text-sm font-bold mb-1 text-left">{t.lastName || 'Фамилия'}</label>
                                <input type="text" value={lastName} onChange={e => setLastName(e.target.value)} className="w-full p-2 bg-tertiary rounded-lg border-color text-primary"/>
                            </div>
                            <button type="submit" className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-colors" disabled={isUploading}>
                                {isUploading ? t.sending : t.updateProfile || 'Обновить профиль'}
                            </button>
                        </form>
                        <button onClick={onLogout} className="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition-colors mt-4">{t.logout}</button>
                        <input type="file" ref={fileInputRef} onChange={(e) => handleImageUpload(e.target.files[0])} accept="image/*" className="hidden"/>
                    </div>
                </Modal>
            );
        };
        const CustomSelector = ({ value, onChange, options }) => {
            const [isOpen, setIsOpen] = useState(false);
            const wrapperRef = useRef(null);

            useEffect(() => {
                function handleClickOutside(event) {
                    if (wrapperRef.current && !wrapperRef.current.contains(event.target)) { setIsOpen(false); }
                }
                document.addEventListener("mousedown", handleClickOutside);
                return () => document.removeEventListener("mousedown", handleClickOutside);
            }, [wrapperRef]);

            const handleSelect = (newValue) => {
                onChange({ target: { value: newValue } });
                setIsOpen(false);
            };

            const selectedOption = options.find(o => o.value === value);

            return (
                <div className="relative" ref={wrapperRef}>
                    <button onClick={() => setIsOpen(!isOpen)} className="flex items-center justify-between w-full bg-tertiary hover:bg-gray-700 text-primary font-semibold py-2 px-4 rounded-lg transition-colors">
                        <span>{selectedOption ? selectedOption.label : value}</span>
                        <svg className={`w-4 h-4 transition-transform ${isOpen ? 'transform rotate-180' : ''}`} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    {isOpen && (
                        <div className="absolute right-0 mt-2 w-full bg-tertiary rounded-md shadow-lg py-1 z-50 border-color">
                            {options.map(opt => (
                                <a href="#" key={opt.value} onClick={(e) => { e.preventDefault(); handleSelect(opt.value); }}
                                    className={`block px-4 py-2 text-sm text-secondary hover:text-primary hover:bg-purple-600 ${value === opt.value ? 'bg-purple-600 text-white' : ''}`}>
                                    {opt.label}
                                </a>
                            ))}
                        </div>
                    )}
                </div>
            );
        };

        // --- Cart Components ---
        function CartModal({ onClose, onCheckout, t, currency, convertPrice, language }) {
            const { cartItems, removeFromCart, updateQuantity, cartTotal } = useCart();
            return (
                <Modal onClose={onClose} size="max-w-2xl">
                    <h2 className="text-3xl font-bold text-primary mb-6 text-center">{t.cart || 'Корзина'}</h2>
                    {cartItems.length === 0 ? (
                        <p className="text-center text-secondary">{t.cartIsEmpty || 'Ваша корзина пуста'}</p>
                    ) : (
                        <>
                            <div className="space-y-4 max-h-[60vh] overflow-y-auto pr-2">
                                {cartItems.map(item => (
                                    <div key={`${item.id}-${item.variant.nominal.ru}`} className="flex items-center justify-between bg-tertiary p-3 rounded-lg">
                                        <div className="flex items-center space-x-4">
                                            <img src={item.imageUrls?.[0] || item.imageUrl} alt={item.name[language] || item.name.ru} className="w-16 h-16 rounded-md object-cover"/>
                                            <div>
                                                <p className="font-bold text-primary">{item.name[language] || item.name.ru}</p>
                                                <p className="text-sm text-secondary">{item.variant.nominal[language] || item.variant.nominal.ru}</p>
                                            </div>
                                        </div>
                                        <div className="flex items-center space-x-4">
                                            <div className="flex items-center space-x-2">
                                                <button onClick={() => updateQuantity(item.id, item.variant.nominal.ru, item.quantity - 1)} className="px-2 py-1 bg-primary rounded-md">-</button>
                                                <span>{item.quantity}</span>
                                                <button onClick={() => updateQuantity(item.id, item.variant.nominal.ru, item.quantity + 1)} className="px-2 py-1 bg-primary rounded-md">+</button>
                                            </div>
                                            <p className="font-bold w-24 text-right">{convertPrice(item.variant.price * item.quantity, currency)}</p>
                                            <button onClick={() => removeFromCart(item.id, item.variant.nominal.ru)} className="text-red-500 hover:text-red-400">
                                                <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                                            </button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                            <div className="border-t border-color mt-6 pt-4 flex justify-between items-center">
                                <p className="text-xl font-bold text-primary">{t.total || 'Итого'}:</p>
                                <p className="text-2xl font-bold accent-text">{convertPrice(cartTotal, currency)}</p>
                            </div>
                            <button onClick={onCheckout} className="w-full mt-6 accent-bg hover:accent-bg-secondary text-white font-bold py-3 px-4 rounded-lg transition-colors">
                                {t.proceedToCheckout || 'Перейти к оформлению'}
                            </button>
                        </>
                    )}
                </Modal>
            );
        }
        function CheckoutModal({ onClose, onConfirm, t, currency, convertPrice, setAlertInfo }) {
            const { cartItems, cartTotal } = useCart();
            const [promoCode, setPromoCode] = useState('');
            const [appliedPromo, setAppliedPromo] = useState(null);
            const [error, setError] = useState('');

            const finalPrice = useMemo(() => {
                if (!appliedPromo) return cartTotal;
                return cartTotal * (1 - appliedPromo.discount / 100);
            }, [cartTotal, appliedPromo]);

            const handleApplyPromo = async () => {
                setError('');
                if (!promoCode.trim()) return;
                const promoRef = doc(db, 'promoCodes', promoCode);
                const promoSnap = await getDoc(promoRef);
                if (promoSnap.exists()) {
                    const promoData = promoSnap.data();
                    if (promoData.timesUsed >= promoData.usageLimit) {
                        setError(t.promoLimitReached); setAppliedPromo(null);
                    } else {
                        setAppliedPromo(promoData); setAlertInfo({ message: t.promoApplied });
                    }
                } else {
                    setAppliedPromo(null); setError(t.promoNotFound);
                }
            };

            const handleConfirmPurchase = () => {
                const purchaseDetails = {
                    finalPrice,
                    promoCodeUsed: appliedPromo ? appliedPromo.code : null,
                };
                onConfirm(purchaseDetails);
            };

            return (
                <Modal onClose={onClose}>
                    <div className="text-center">
                        <h2 className="text-3xl font-bold text-primary mb-2">{t.checkout}</h2>
                        <p className="text-secondary mb-4">{t.youAreBuying} {cartItems.length} {t.productsCount || 'товар(а/ов)'}</p>
                        <div className="my-4">
                            {appliedPromo ? (
                                <div>
                                    <span className="text-2xl text-secondary line-through">{convertPrice(cartTotal, currency)}</span>
                                    <span className="text-4xl font-bold accent-text ml-2">{convertPrice(finalPrice, currency)}</span>
                                </div>
                            ) : (
                                <span className="text-4xl font-bold accent-text">{convertPrice(finalPrice, currency)}</span>
                            )}
                        </div>
                        <div className="bg-tertiary p-4 rounded-lg my-4">
                            <label className="block text-secondary text-sm font-bold mb-2 text-left">{t.payWithPromo}</label>
                            <div className="flex space-x-2">
                                <input type="text" value={promoCode} onChange={(e) => setPromoCode(e.target.value.toUpperCase())} placeholder={t.promoCodeName} className="w-full p-2 bg-primary rounded-lg border-color text-primary"/>
                                <button onClick={handleApplyPromo} className="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">{t.apply}</button>
                            </div>
                            {error && <p className="text-red-500 text-sm mt-2">{error}</p>}
                            {appliedPromo && <p className="text-green-500 text-sm mt-2">{t.promoApplied}: {appliedPromo.discount}%</p>}
                        </div>
                        <button onClick={handleConfirmPurchase} className="w-full bg-teal-500 hover:bg-teal-600 text-white font-bold py-3 px-4 rounded-lg transition-transform transform hover:scale-105">{t.confirmAndPay || 'Подтвердить и оплатить'}</button>
                    </div>
                </Modal>
            );
        }

        // --- Main User-Facing Components ---
        function Header({ user, onLogin, onLogout, isAdmin, t, currency, setCurrency, language, setLanguage, setProfileVisible, onCartClick }) {
            const { cartItems } = useCart();
            const { path } = useHashRouter();
            const [userDropdownOpen, setUserDropdownOpen] = useState(false);
            const userDropdownRef = useRef(null);
            
            const langOptions = [{value: 'ru', label: t.russian}, {value: 'uz', label: t.uzbek}];
            const currencyOptions = [{value: 'USD', label: t.dollar}, {value: 'UZS', label: t.sum}];

            useEffect(() => {
                function handleClickOutside(event) {
                    if (userDropdownRef.current && !userDropdownRef.current.contains(event.target)) { setUserDropdownOpen(false); }
                }
                document.addEventListener("mousedown", handleClickOutside);
                return () => document.removeEventListener("mousedown", handleClickOutside);
            }, [userDropdownRef]);

            return (
                <header className="bg-secondary p-4 shadow-lg sticky top-0 z-40 border-b border-color">
                    <div className="container mx-auto flex justify-between items-center">
                        <Logo t={t} />
                        <nav className="hidden md:flex items-center space-x-6">
                            <Link to="#/" className={`text-secondary hover:text-primary font-medium transition-colors ${path === '#/' && 'text-primary'}`}>{t.home}</Link>
                            {user && <Link to="#/purchases" className={`text-secondary hover:text-primary font-medium transition-colors ${path === '#/purchases' && 'text-primary'}`}>{t.myPurchases}</Link>}
                            <Link to="#/faq" className={`text-secondary hover:text-primary font-medium transition-colors ${path === '#/faq' && 'text-primary'}`}>{t.faq}</Link>
                            {isAdmin && <Link to="#/admin/dashboard" className="text-red-500 hover:text-red-400 font-medium transition-colors">{t.adminPanelTitle}</Link>}
                        </nav>
                        <div className="flex items-center space-x-2 sm:space-x-4">
                            <div className="hidden md:block w-28 min-w-max"><CustomSelector value={currency} onChange={e => setCurrency(e.target.value)} options={currencyOptions} /></div>
                            <div className="hidden md:block w-28 min-w-max"><CustomSelector value={language} onChange={e => setLanguage(e.target.value)} options={langOptions} /></div>

                            <button onClick={onCartClick} className="relative p-2 rounded-full text-primary hover:bg-tertiary transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" /></svg>
                                {cartItems.length > 0 && <span className="absolute -top-1 -right-1 flex h-5 w-5 items-center justify-center rounded-full bg-red-600 text-xs font-bold text-white">{cartItems.reduce((acc, item) => acc + item.quantity, 0)}</span>}
                            </button>
                            {user ? (
                                <div className="relative" ref={userDropdownRef}>
                                    <button onClick={() => setUserDropdownOpen(!userDropdownOpen)} className="flex items-center space-x-2">
                                        <img src={user.photoURL} alt={user.displayName} className="h-10 w-10 rounded-full border-2 border-purple-500 object-cover" />
                                    </button>
                                    {userDropdownOpen && (
                                        <div className={`absolute right-0 mt-2 w-48 bg-secondary rounded-md shadow-lg py-1 z-50 border-color`}>
                                            <a href="#" onClick={(e) => { e.preventDefault(); setProfileVisible(true); setUserDropdownOpen(false); }} className="block px-4 py-2 text-sm text-secondary hover:text-primary hover:bg-purple-600">{t.profile}</a>
                                            <a href="#" onClick={(e) => { e.preventDefault(); onLogout(); setUserDropdownOpen(false); }} className="block px-4 py-2 text-sm text-secondary hover:text-primary hover:bg-purple-600">{t.logout}</a>
                                        </div>
                                    )}
                                </div>
                            ) : (
                                <button onClick={onLogin} className="accent-bg hover:accent-bg-secondary text-white font-bold py-2 px-4 rounded-lg transition-transform transform hover:scale-105 flex items-center space-x-2">
                                    <span>{t.login}</span>
                                </button>
                            )}
                        </div>
                    </div>
                </header>
            );
        }
        function HomePage({ products, onProductClick, t, currency, convertPrice, loading, language }) {
            const [searchTerm, setSearchTerm] = useState('');
            const [filterCategory, setFilterCategory] = useState('all');
            const [sortBy, setSortBy] = useState('new');

            const filteredAndSortedProducts = useMemo(() => {
                if (!products) return [];
                return products
                    .filter(p => p && p.name && (p.isOnSale === undefined || p.isOnSale !== false))
                    .filter(p => (p.name[language] || p.name.ru).toLowerCase().includes(searchTerm.toLowerCase()))
                    .filter(p => filterCategory === 'all' || p.category === filterCategory)
                    .sort((a, b) => {
                        if (a.pinned && !b.pinned) return -1;
                        if (!a.pinned && b.pinned) return 1;
                        if (sortBy === 'popular') return (b.popularity || 0) - (a.popularity || 0);
                        if (a.createdAt && b.createdAt) return b.createdAt.toMillis() - a.createdAt.toMillis();
                        return 0;
                    });
            }, [products, searchTerm, filterCategory, sortBy, language]);

            const FilterButton = ({ value, state, setState, children }) => (
                <button onClick={() => setState(value)} className={`px-4 py-2 rounded-lg text-sm transition-colors ${state === value ? 'accent-bg text-white' : 'bg-tertiary text-primary hover:bg-gray-600'}`}>
                    {children}
                </button>
            );

            const categories = useMemo(() => {
                const cats = { all: t.all };
                products.forEach(p => { if (p && p.category) cats[p.category] = p.category; });
                return Object.keys(cats).map(key => ({ value: key, label: t[key.toLowerCase()] || key }));
            }, [products, t]);

            return (
                <main className="container mx-auto p-4 md:p-8">
                    <h1 className="text-4xl md:text-5xl font-black text-primary text-center mb-4 tracking-wide">{t.catalogTitle}</h1>
                    <p className="accent-text text-center mb-8 text-lg">{t.catalogSubtitle}</p>
                    
                    <div className="bg-secondary p-4 rounded-xl mb-8 flex flex-col md:flex-row gap-4 items-center">
                        <input type="text" placeholder={t.searchPlaceholder} value={searchTerm} onChange={e => setSearchTerm(e.target.value)} className="w-full md:w-1/3 p-3 bg-tertiary rounded-lg border-color focus:outline-none focus:ring-2 focus:ring-purple-500 text-primary" />
                        <div className="flex items-center gap-2">
                            <span className="text-secondary font-semibold">{t.category}:</span>
                            <div className="w-40"><CustomSelector value={filterCategory} onChange={e => setFilterCategory(e.target.value)} options={categories} /></div>
                        </div>
                        <div className="flex items-center gap-2 ml-auto">
                            <span className="text-secondary font-semibold">{t.sortBy}:</span>
                            <FilterButton value="new" state={sortBy} setState={setSortBy}>{t.newSort}</FilterButton>
                            <FilterButton value="popular" state={sortBy} setState={setSortBy}>{t.popularSort}</FilterButton>
                        </div>
                    </div>
                    
                    {loading ? (
                         <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                            {[...Array(6)].map((_, i) => <div key={i} className="bg-secondary rounded-2xl overflow-hidden shadow-lg border-color animate-pulse"><div className="w-full h-56 bg-tertiary"></div><div className="p-6"><div className="h-8 bg-tertiary rounded w-3/4 mb-2"></div><div className="h-6 bg-tertiary rounded w-1/2 mb-4"></div><div className="h-10 bg-tertiary rounded w-1/3"></div></div></div>)}
                        </div>
                    ) : filteredAndSortedProducts.length === 0 ? (
                         <p className="text-center text-secondary text-xl mt-12">{t.productsNotFound}</p>
                    ) : (
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                            {filteredAndSortedProducts.map(product => (
                                <ProductCard key={product.id} {...{product, onProductClick, t, currency, convertPrice, language}} />
                            ))}
                        </div>
                    )}
                </main>
            );
        }
        function ProductCard({ product, onProductClick, t, currency, convertPrice, language }) {
            const imageUrl = (product.imageUrls && product.imageUrls.length > 0) ? product.imageUrls[0] : (product.imageUrl || '');
            const displayPrice = useMemo(() => {
                if (product.variants && product.variants.length > 0) {
                    const minPrice = Math.min(...product.variants.map(v => v.price));
                    return convertPrice(minPrice, currency);
                }
                return convertPrice(product.price || 0, currency);
            }, [product.variants, product.price, currency]);
            
            const displayStock = useMemo(() => {
                if (product.variants && product.variants.length > 0) {
                    const totalStock = product.variants.reduce((sum, v) => sum + (parseInt(v.stockQuantity) || 0), 0);
                    return totalStock;
                }
                return (product.stockQuantity !== undefined ? product.stockQuantity : -1);
            }, [product.variants, product.stockQuantity]);

            return (
                <div onClick={() => onProductClick(product)} className="bg-secondary rounded-2xl overflow-hidden shadow-lg border-color transform hover:-translate-y-2 transition-transform duration-300 flex flex-col cursor-pointer relative">
                    {product.pinned && <div className="absolute top-0 right-0 bg-yellow-400 text-black text-xs font-bold px-3 py-1 rounded-bl-lg z-10">{t.pinned}</div>}
                    {product.isOnSale === false && <span className="absolute top-2 left-2 bg-gray-500 text-white text-xs font-bold px-2 py-1 rounded-full">{t.removedFromSale || 'Снято с продажи'}</span>}
                    <img className="w-full h-56 object-cover" src={imageUrl} alt={product.name[language] || product.name.ru} onError={(e) => { e.target.onerror = null; e.target.src=`https://placehold.co/600x400/1f2937/374151?text=${encodeURIComponent(t.imageNotFound)}`; }}/>
                    <div className="p-6 flex flex-col flex-grow">
                        <h3 className="text-2xl font-bold text-primary mb-1">{product.name[language] || product.name.ru}</h3>
                        <div className="flex-grow"></div>
                        <div className="flex justify-between items-center mt-4">
                            <span className="text-3xl font-bold accent-text">{displayPrice}</span>
                            {displayStock !== -1 && displayStock <= 0 && (
                                <span className="bg-red-500 text-white text-xs font-bold px-2 py-1 rounded-full">{t.outOfStock || 'Нет в наличии'}</span>
                            )}
                        </div>
                    </div>
                </div>
            );
        }
        function ProductModal({ product, user, onClose, setAlertInfo, t, currency, convertPrice, language }) {
            const [currentImageIndex, setCurrentImageIndex] = useState(0);
            const imageUrls = (product.imageUrls && product.imageUrls.length > 0) ? product.imageUrls : [product.imageUrl || ''];
            const [selectedVariantIndex, setSelectedVariantIndex] = useState(0);
            const { addToCart } = useCart();

            useEffect(() => { setSelectedVariantIndex(0); }, [product]);

            const currentVariant = product.variants && product.variants.length > 0 ? product.variants[selectedVariantIndex] : {};

            const handleAddToCart = () => {
                addToCart(product, currentVariant);
                setAlertInfo({ message: t.productAddedToCart || 'Товар добавлен в корзину!' });
                onClose();
            };
            
            const variantDescription = currentVariant.description ? (currentVariant.description[language] || currentVariant.description.ru) : (product.description[language] || product.description.ru);

            return (
                <Modal onClose={onClose} size="max-w-4xl">
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div> {/* Image viewer */}
                           <img src={imageUrls[currentImageIndex]} alt={product.name[language] || product.name.ru} className="w-full h-auto object-cover rounded-lg"/>
                        </div>
                        <div className="flex flex-col">
                            <h2 className="text-4xl font-bold text-primary mb-2">{product.name[language] || product.name.ru}</h2>
                            {product.variants && product.variants.length > 0 && (
                                <div className="my-4 space-y-2">
                                    <p className="text-lg font-semibold text-primary">{t.chooseOption || 'Выберите вариант:'}</p>
                                    <div className="flex flex-wrap gap-2">
                                        {product.variants.map((variant, index) => (
                                            <button key={index} onClick={() => setSelectedVariantIndex(index)}
                                                className={`px-4 py-2 rounded-lg text-sm font-semibold transition-colors ${selectedVariantIndex === index ? 'accent-bg text-white' : 'bg-tertiary text-primary hover:bg-gray-600'}`}>
                                                {(variant.nominal[language] || variant.nominal.ru)} - {convertPrice(variant.price, currency)}
                                            </button>
                                        ))}
                                    </div>
                                    {currentVariant.stockQuantity !== undefined && currentVariant.stockQuantity <= 0 && (
                                        <p className="text-red-500 text-sm">{t.outOfStockMessage}</p>
                                    )}
                                </div>
                            )}
                            <p className="text-secondary mb-6 flex-grow">{variantDescription}</p>
                            <div className="flex justify-between items-center">
                                <span className="text-5xl font-bold accent-text">{convertPrice(currentVariant.price || product.price, currency)}</span>
                                <button onClick={handleAddToCart} className="accent-bg hover:accent-bg-secondary text-white font-bold py-4 px-8 rounded-lg text-lg" disabled={currentVariant.stockQuantity !== undefined && currentVariant.stockQuantity <= 0}>
                                    {currentVariant.stockQuantity !== undefined && currentVariant.stockQuantity <= 0 ? t.outOfStock : t.addToCart || 'В корзину'}
                                </button>
                            </div>
                        </div>
                    </div>
                </Modal>
            );
        }
        function MyPurchasesPage({ user, t, currency, convertPrice, setAlertInfo, language }) {
            const [myPurchases, setMyPurchases] = useState([]);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                if (!user) { setLoading(false); return; }
                const q = query(collection(db, "purchases"), where("userId", "==", user.uid));
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const purchasesData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    purchasesData.sort((a, b) => (b.timestamp?.toMillis() || 0) - (a.timestamp?.toMillis() || 0));
                    setMyPurchases(purchasesData);
                    setLoading(false);
                }, (error) => {
                    console.error("Error fetching purchases:", error);
                    setLoading(false);
                });
                return () => unsubscribe();
            }, [user]);
            
            const getStatusClass = (status) => ({ approved: 'bg-green-500', rejected: 'bg-red-500', contacted: 'bg-blue-500', cancelled: 'bg-gray-500' }[status] || 'bg-yellow-500');
            const getStatusText = (status) => ({ approved: t.statusApproved, rejected: t.statusRejected, contacted: t.statusContacted, cancelled: t.statusCancelled }[status] || t.statusPending);

            if (loading) return <LoadingSpinner />;

            return (
                <div className="container mx-auto p-4 md:p-8">
                    <h1 className="text-4xl font-bold text-center mb-8 text-primary">{t.myPurchases}</h1>
                    {myPurchases.length === 0 ? <p className="text-center text-secondary">{t.noPurchasesYet}</p> : (
                        <div className="space-y-4 max-w-3xl mx-auto">
                            {myPurchases.map(p => (
                                <div key={p.id} className="bg-secondary p-4 rounded-lg">
                                    <div className="flex justify-between items-start flex-wrap">
                                        <div>
                                            <p className="font-mono text-sm accent-text bg-tertiary inline-block px-2 py-1 rounded my-1">Код: {p.purchaseCode}</p>
                                            <p className="text-sm text-secondary">{p.timestamp?.toDate ? new Date(p.timestamp.toDate()).toLocaleString() : '...'}</p>
                                            <p className="text-sm text-secondary">{t.amount}: {convertPrice(p.totalPrice, currency)}</p>
                                        </div>
                                        <span className={`mt-2 sm:mt-0 px-2 py-1 text-xs font-bold text-white rounded-full ${getStatusClass(p.status)}`}>{getStatusText(p.status)}</span>
                                    </div>
                                    <div className="mt-2 border-t border-gray-700 pt-2">
                                        {p.items && p.items.map((item, index) => <p key={index} className="text-primary">{(item.name[language] || item.name.ru)} ({(item.variant.nominal[language] || item.variant.nominal.ru)}) x {item.quantity}</p>)}
                                    </div>
                                    {p.adminComment && <div className="mt-2 p-2 bg-tertiary rounded-md"><p className="text-sm text-secondary"><b>{t.adminComment}:</b> {p.adminComment}</p></div>}
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        }
        function FAQPage({ faqs, t }) {
            const [openIndex, setOpenIndex] = useState(null);
            return (
                <div className="container mx-auto p-4 md:p-8">
                    <h1 className="text-4xl font-bold text-center mb-8 text-primary">{t.faqTitle}</h1>
                    <div className="space-y-4 max-w-3xl mx-auto">
                        {faqs.map((faq, index) => (
                            <div key={faq.id} className="bg-secondary rounded-lg">
                                <button onClick={() => setOpenIndex(openIndex === index ? null : index)} className="w-full text-left p-4 flex justify-between items-center">
                                    <span className="font-semibold text-primary">{faq.question}</span>
                                    <svg className={`w-6 h-6 transform transition-transform text-primary ${openIndex === index ? 'rotate-180' : ''}`} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 9l-7 7-7-7"></path></svg>
                                </button>
                                {openIndex === index && ( <div className="p-4 border-t border-color text-secondary" dangerouslySetInnerHTML={{ __html: faq.answer.replace(/\n/g, '<br />') }}></div> )}
                            </div>
                        ))}
                    </div>
                </div>
            );
        }
        function Footer({t}) {
            return (
                <footer className="bg-secondary text-secondary p-6 mt-12 border-t border-color">
                    <div className="container mx-auto text-center">
                        <p>&copy; {new Date().getFullYear()} Asonik Store. {t.rightsReserved}</p>
                        <p className="text-sm mt-2">{t.developedWithLove}</p>
                    </div>
                </footer>
            );
        };

        // --- Admin Components ---
        const AdminLayout = ({ children, t }) => {
            const { path } = useHashRouter();
            const NavLink = ({ to, children }) => <Link to={to} className={`block px-4 py-2 rounded-lg transition-colors hover:bg-purple-700 ${path.startsWith(to) ? 'bg-purple-600 text-white' : 'text-gray-300'}`}>{children}</Link>;
            return (
                <div className="container mx-auto p-4 md:p-8 flex flex-col md:flex-row gap-8">
                    <aside className="w-full md:w-1/5 bg-secondary p-4 rounded-lg self-start">
                        <h2 className="text-xl font-bold text-primary mb-4">{t.adminMenu || 'Меню'}</h2>
                        <nav className="space-y-2 admin-sidebar">
                            <NavLink to="#/admin/dashboard">{t.dashboard || 'Обзор'}</NavLink>
                            <NavLink to="#/admin/products">{t.manageProducts || 'Товары'}</NavLink>
                            <NavLink to="#/admin/purchases">{t.managePurchases || 'Заказы'}</NavLink>
                            <NavLink to="#/admin/faq">{t.manageFaq || 'FAQ'}</NavLink>
                            <NavLink to="#/admin/promo">{t.managePromoCodes || 'Промокоды'}</NavLink>
                        </nav>
                    </aside>
                    <main className="w-full md:w-4/5">{children}</main>
                </div>
            );
        };
        const AdminDashboard = ({t, purchases, products, currency, convertPrice}) => {
             const totalRevenue = useMemo(() => purchases.reduce((sum, p) => sum + (p.status === 'approved' ? p.totalPrice : 0), 0), [purchases]);
             return (
                <div>
                    <h1 className="text-3xl font-bold text-primary">{t.dashboard}</h1>
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mt-6">
                        <div className="bg-secondary p-4 rounded-lg"><p className="text-sm text-secondary">{t.totalProducts || 'Всего товаров'}</p><p className="text-2xl font-bold text-primary">{products.length}</p></div>
                        <div className="bg-secondary p-4 rounded-lg"><p className="text-sm text-secondary">{t.totalPurchases || 'Всего заказов'}</p><p className="text-2xl font-bold text-primary">{purchases.length}</p></div>
                        <div className="bg-secondary p-4 rounded-lg"><p className="text-sm text-secondary">{t.totalRevenue || 'Общая выручка'}</p><p className="text-2xl font-bold text-primary">{convertPrice(totalRevenue, 'RUB')}</p></div>
                    </div>
                </div>
            );
        };
        const ProductEditModal = ({ product, onClose, t, setAlertInfo }) => {
            const [formData, setFormData] = useState({
                name: { ru: '', uz: '' },
                description: { ru: '', uz: '' },
                category: 'games', imageUrls: [''], pinned: false, isOnSale: true,
                variants: [{ nominal: { ru: '', uz: '' }, description: { ru: '', uz: '' }, price: 0, stockQuantity: 0, priceCurrency: 'UZS' }],
                ...product,
                name: product.name || { ru: '', uz: '' },
                description: product.description || { ru: '', uz: '' },
                imageUrls: product.imageUrls && product.imageUrls.length > 0 ? product.imageUrls : [''],
                variants: product.variants && product.variants.length > 0 ? product.variants.map(v => ({...v, priceCurrency: v.priceCurrency || 'UZS'})) : [{ nominal: { ru: '', uz: '' }, description: { ru: '', uz: '' }, price: 0, stockQuantity: 0, priceCurrency: 'UZS' }],
            });
            const [isUploading, setIsUploading] = useState(false);

            const handleChange = (e) => {
                const { name, value, type, checked } = e.target;
                if (name === 'name.ru' || name === 'name.uz' || name === 'description.ru' || name === 'description.uz') {
                    const [field, lang] = name.split('.');
                    setFormData(prev => ({ ...prev, [field]: { ...prev[field], [lang]: value } }));
                } else {
                    setFormData(prev => ({ ...prev, [name]: type === 'checkbox' ? checked : value }));
                }
            };
            
            const handleVariantChange = (index, e) => {
                const { name, value } = e.target;
                const newVariants = [...formData.variants];
                if (name.includes('.')) {
                    const [field, lang] = name.split('.');
                    newVariants[index][field] = { ...newVariants[index][field], [lang]: value };
                } else {
                    newVariants[index][name] = (name === 'price' || name === 'stockQuantity') ? Number(value) : value;
                }
                setFormData(prev => ({ ...prev, variants: newVariants }));
            };

            const addVariant = () => {
                setFormData(prev => ({ ...prev, variants: [...prev.variants, { nominal: { ru: '', uz: '' }, description: { ru: '', uz: '' }, price: 0, stockQuantity: 0, priceCurrency: 'UZS' }] }));
            };
            
            const removeVariant = (index) => {
                if (formData.variants.length <= 1) return;
                const newVariants = formData.variants.filter((_, i) => i !== index);
                setFormData(prev => ({ ...prev, variants: newVariants }));
            };

            const handleImageUrlChange = (index, value) => {
                const newImageUrls = [...formData.imageUrls];
                newImageUrls[index] = value;
                setFormData(prev => ({ ...prev, imageUrls: newImageUrls }));
            };

            const addImageUrl = () => {
                setFormData(prev => ({ ...prev, imageUrls: [...prev.imageUrls, ''] }));
            };

            const removeImageUrl = (index) => {
                if (formData.imageUrls.length <= 1) return;
                const newImageUrls = formData.imageUrls.filter((_, i) => i !== index);
                setFormData(prev => ({ ...prev, imageUrls: newImageUrls }));
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                setIsUploading(true);
                try {
                    const payload = { 
                        ...formData, 
                        variants: formData.variants.map(v => {
                            const priceInRub = v.price / (currencyRates[v.priceCurrency] || 1);
                            return { ...v, price: priceInRub };
                        }),
                        createdAt: formData.createdAt || serverTimestamp() 
                    };
                    if (product.id) {
                        await setDoc(doc(db, "products", product.id), payload);
                        setAlertInfo({ message: t.productUpdated });
                    } else {
                        await addDoc(collection(db, "products"), payload);
                        setAlertInfo({ message: t.productAdded });
                    }
                    onClose();
                } catch (err) {
                    setAlertInfo({ message: `${t.errorOccurred}: ${err.message}` });
                } finally {
                    setIsUploading(false);
                }
            };

            return (
                <Modal onClose={onClose} size="max-w-3xl">
                    <h2 className="text-2xl font-bold mb-4">{product.id ? t.editProduct : t.addProduct}</h2>
                    <form onSubmit={handleSubmit} className="space-y-4 max-h-[80vh] overflow-y-auto p-2">
                        <input name="name.ru" value={formData.name.ru} onChange={handleChange} placeholder={t.productName + " (RU)"} className="w-full p-2 bg-tertiary rounded" required />
                        <input name="name.uz" value={formData.name.uz} onChange={handleChange} placeholder={t.productName + " (UZ)"} className="w-full p-2 bg-tertiary rounded" required />
                        
                        <textarea name="description.ru" value={formData.description.ru} onChange={handleChange} placeholder={t.description + " (RU)"} className="w-full p-2 bg-tertiary rounded h-24" required />
                        <textarea name="description.uz" value={formData.description.uz} onChange={handleChange} placeholder={t.description + " (UZ)"} className="w-full p-2 bg-tertiary rounded h-24" required />

                        <select name="category" value={formData.category} onChange={handleChange} className="w-full p-2 bg-tertiary rounded">
                            <option value="games">{t.games}</option>
                            <option value="apps">{t.apps}</option>
                        </select>
                        
                        <div>
                            <h3 className="font-bold mb-2">{t.productImages}</h3>
                            {formData.imageUrls.map((url, index) => (
                                <div key={index} className="flex items-center space-x-2 mb-2">
                                    <input value={url} onChange={(e) => handleImageUrlChange(index, e.target.value)} placeholder={t.imageUrl} className="w-full p-2 bg-tertiary rounded" required />
                                    {formData.imageUrls.length > 1 && <button type="button" onClick={() => removeImageUrl(index)} className="bg-red-600 text-white px-3 py-1 rounded">-</button>}
                                </div>
                            ))}
                            <button type="button" onClick={addImageUrl} className="bg-blue-600 text-white px-3 py-1 rounded">{t.addImage}</button>
                        </div>
                        
                        <div>
                            <h3 className="font-bold mb-2">{t.variants || 'Варианты'}</h3>
                            {formData.variants.map((variant, index) => (
                                <div key={index} className="p-2 border border-color rounded space-y-2 mb-2">
                                    <input name="nominal.ru" value={variant.nominal.ru} onChange={(e) => handleVariantChange(index, e)} placeholder={t.productNominal + " (RU)"} className="w-full p-2 bg-tertiary rounded" required />
                                    <input name="nominal.uz" value={variant.nominal.uz} onChange={(e) => handleVariantChange(index, e)} placeholder={t.productNominal + " (UZ)"} className="w-full p-2 bg-tertiary rounded" required />
                                    <textarea name="description.ru" value={variant.description.ru} onChange={(e) => handleVariantChange(index, e)} placeholder={t.description + " (RU)"} className="w-full p-2 bg-tertiary rounded h-16" />
                                    <textarea name="description.uz" value={variant.description.uz} onChange={(e) => handleVariantChange(index, e)} placeholder={t.description + " (UZ)"} className="w-full p-2 bg-tertiary rounded h-16" />
                                    <div className="flex gap-2">
                                        <input type="number" name="price" value={variant.price} onChange={(e) => handleVariantChange(index, e)} placeholder={t.price} className="w-full p-2 bg-tertiary rounded" required />
                                        <select name="priceCurrency" value={variant.priceCurrency} onChange={(e) => handleVariantChange(index, e)} className="p-2 bg-tertiary rounded">
                                            <option value="UZS">UZS</option>
                                            <option value="USD">USD</option>
                                        </select>
                                    </div>
                                    <input type="number" name="stockQuantity" value={variant.stockQuantity} onChange={(e) => handleVariantChange(index, e)} placeholder={t.stock} className="w-full p-2 bg-tertiary rounded" required />
                                    {formData.variants.length > 1 && <button type="button" onClick={() => removeVariant(index)} className="bg-red-600 text-white px-3 py-1 rounded">{t.delete}</button>}
                                </div>
                            ))}
                            <button type="button" onClick={addVariant} className="bg-blue-600 text-white px-3 py-1 rounded">{t.addVariant || 'Добавить вариант'}</button>
                        </div>

                        <div className="flex items-center space-x-2">
                            <input type="checkbox" name="pinned" checked={formData.pinned} onChange={handleChange} id="pinnedCheck" />
                            <label htmlFor="pinnedCheck">{t.pinProduct}</label>
                        </div>
                        <div className="flex items-center space-x-2">
                            <input type="checkbox" name="isOnSale" checked={formData.isOnSale} onChange={handleChange} id="saleCheck" />
                            <label htmlFor="saleCheck">{t.onSale || 'В продаже'}</label>
                        </div>

                        <button type="submit" disabled={isUploading} className="w-full accent-bg hover:accent-bg-secondary text-white font-bold py-2 px-4 rounded-lg">
                            {isUploading ? t.sending : (product.id ? t.updateProduct : t.addProductBtn)}
                        </button>
                    </form>
                </Modal>
            );
        };
        const AdminProducts = ({ t, products, setAlertInfo, language }) => {
            const [editingProduct, setEditingProduct] = useState(null);

            const handleDelete = (id) => {
                setAlertInfo({
                    message: t.confirmDelete,
                    onConfirm: async () => {
                        try {
                            await deleteDoc(doc(db, "products", id));
                            setAlertInfo({ message: t.productDeleted });
                        } catch (e) {
                            setAlertInfo({ message: `${t.errorOccurred}: ${e.message}` });
                        }
                    }
                });
            };

            return (
                <div>
                    <div className="flex justify-between items-center mb-6">
                        <h1 className="text-3xl font-bold text-primary">{t.manageProducts}</h1>
                        <button onClick={() => setEditingProduct({})} className="accent-bg hover:accent-bg-secondary text-white font-bold py-2 px-4 rounded-lg">{t.addProduct}</button>
                    </div>

                    <div className="bg-secondary rounded-lg overflow-x-auto">
                        <table className="w-full text-left">
                           <thead className="bg-tertiary">
                                <tr>
                                    <th className="p-3">{t.productName}</th>
                                    <th className="p-3">{t.category}</th>
                                    <th className="p-3">{t.price}</th>
                                    <th className="p-3">{t.stock}</th>
                                    <th className="p-3">{t.actions}</th>
                                </tr>
                           </thead>
                           <tbody>
                                {products.map(p => (
                                    <tr key={p.id} className="border-b border-color">
                                        <td className="p-3">{p.name[language] || p.name.ru}</td>
                                        <td className="p-3">{p.category}</td>
                                        <td className="p-3">{p.variants?.[0]?.price || p.price} RUB</td>
                                        <td className="p-3">{p.variants?.reduce((s, v) => s + v.stockQuantity, 0) || 0}</td>
                                        <td className="p-3 flex space-x-2">
                                            <button onClick={() => setEditingProduct(p)} className="bg-blue-600 text-white px-3 py-1 rounded">{t.edit}</button>
                                            <button onClick={() => handleDelete(p.id)} className="bg-red-600 text-white px-3 py-1 rounded">{t.delete}</button>
                                        </td>
                                    </tr>
                                ))}
                           </tbody>
                        </table>
                    </div>
                    {editingProduct && <ProductEditModal product={editingProduct} onClose={() => setEditingProduct(null)} t={t} setAlertInfo={setAlertInfo} />}
                </div>
            );
        };
        const AdminPurchases = ({ t, purchases, setAlertInfo, convertPrice, currency, language }) => {
            const [searchTerm, setSearchTerm] = useState('');

            const filteredPurchases = useMemo(() => {
                return purchases.filter(p => p.purchaseCode?.toLowerCase().includes(searchTerm.toLowerCase()) || p.userEmail?.toLowerCase().includes(searchTerm.toLowerCase()));
            }, [purchases, searchTerm]);
            
            const handleStatusChange = async (purchaseId, newStatus) => {
                try {
                    await updateDoc(doc(db, "purchases", purchaseId), { status: newStatus });
                    setAlertInfo({ message: t.statusUpdated });
                } catch(e) {
                    setAlertInfo({ message: `${t.errorOccurred}: ${e.message}` });
                }
            };

            return (
                <div>
                    <h1 className="text-3xl font-bold text-primary mb-6">{t.managePurchases}</h1>
                    <input type="text" value={searchTerm} onChange={e => setSearchTerm(e.target.value)} placeholder={t.searchByCodeOrEmail || 'Поиск по коду или Email...'} className="w-full p-2 bg-tertiary rounded mb-4" />
                    
                    <div className="bg-secondary rounded-lg overflow-x-auto">
                        <table className="w-full text-left">
                           <thead className="bg-tertiary">
                                <tr>
                                    <th className="p-3">{t.date}</th>
                                    <th className="p-3">{t.user}</th>
                                    <th className="p-3">{t.items}</th>
                                    <th className="p-3">{t.amount}</th>
                                    <th className="p-3">{t.status}</th>
                                </tr>
                           </thead>
                           <tbody>
                                {filteredPurchases.map(p => (
                                    <tr key={p.id} className="border-b border-color">
                                        <td className="p-3 whitespace-nowrap">{p.timestamp?.toDate().toLocaleDateString()}</td>
                                        <td className="p-3">{p.userEmail}</td>
                                        <td className="p-3">{p.items.map(i => `${i.name[language] || i.name.ru} x${i.quantity}`).join(', ')}</td>
                                        <td className="p-3">{convertPrice(p.totalPrice, currency)}</td>
                                        <td className="p-3">
                                            <select value={p.status} onChange={(e) => handleStatusChange(p.id, e.target.value)} className="bg-primary p-1 rounded">
                                                <option value="contacted">{t.statusContacted}</option>
                                                <option value="approved">{t.statusApproved}</option>
                                                <option value="rejected">{t.statusRejected}</option>
                                                <option value="cancelled">{t.statusCancelled}</option>
                                            </select>
                                        </td>
                                    </tr>
                                ))}
                           </tbody>
                        </table>
                    </div>
                </div>
            );
        };
        const AdminFaq = ({ t, faqs, setAlertInfo }) => {
            const [editingFaq, setEditingFaq] = useState(null);
            
            const handleDelete = async (id) => {
                await deleteDoc(doc(db, "faq", id));
                setAlertInfo({ message: "FAQ удален" });
            };

            const FaqEditModal = ({faq, onClose}) => {
                const [data, setData] = useState(faq || {question: '', answer: ''});
                const handleSubmit = async (e) => {
                    e.preventDefault();
                    if (data.id) {
                        await setDoc(doc(db, "faq", data.id), data);
                    } else {
                        await addDoc(collection(db, "faq"), data);
                    }
                    setAlertInfo({ message: "FAQ сохранен" });
                    onClose();
                }
                return (
                    <Modal onClose={onClose}>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <input value={data.question} onChange={e => setData({...data, question: e.target.value})} placeholder="Вопрос" className="w-full p-2 bg-tertiary rounded" />
                            <textarea value={data.answer} onChange={e => setData({...data, answer: e.target.value})} placeholder="Ответ" className="w-full p-2 bg-tertiary rounded h-32" />
                            <button type="submit" className="w-full accent-bg text-white py-2 rounded">Сохранить</button>
                        </form>
                    </Modal>
                )
            };

            return (
                <div>
                    <div className="flex justify-between items-center mb-6">
                        <h1 className="text-3xl font-bold text-primary">{t.manageFaq}</h1>
                        <button onClick={() => setEditingFaq({})} className="accent-bg text-white font-bold py-2 px-4 rounded-lg">Добавить FAQ</button>
                    </div>
                    <div className="space-y-2">
                        {faqs.map(f => (
                            <div key={f.id} className="bg-secondary p-3 rounded flex justify-between items-center">
                                <p>{f.question}</p>
                                <div className="space-x-2">
                                    <button onClick={() => setEditingFaq(f)} className="bg-blue-600 text-white px-3 py-1 rounded">{t.edit}</button>
                                    <button onClick={() => handleDelete(f.id)} className="bg-red-600 text-white px-3 py-1 rounded">{t.delete}</button>
                                </div>
                            </div>
                        ))}
                    </div>
                    {editingFaq && <FaqEditModal faq={editingFaq} onClose={() => setEditingFaq(null)} />}
                </div>
            );
        };
        const AdminPromo = ({ t, promoCodes, setAlertInfo }) => {
            const [code, setCode] = useState('');
            const [discount, setDiscount] = useState(10);
            const [usageLimit, setUsageLimit] = useState(1);

            const handleAdd = async (e) => {
                e.preventDefault();
                await setDoc(doc(db, "promoCodes", code.toUpperCase()), { code: code.toUpperCase(), discount, usageLimit, timesUsed: 0 });
                setAlertInfo({ message: "Промокод добавлен" });
                setCode('');
            };

            const handleDelete = async (id) => {
                await deleteDoc(doc(db, "promoCodes", id));
                setAlertInfo({ message: "Промокод удален" });
            };

            return (
                <div>
                    <h1 className="text-3xl font-bold text-primary mb-6">{t.managePromoCodes}</h1>
                    <form onSubmit={handleAdd} className="bg-secondary p-4 rounded-lg mb-6 grid grid-cols-1 md:grid-cols-4 gap-4">
                        <input value={code} onChange={e => setCode(e.target.value)} placeholder={t.promoCodeName} className="p-2 bg-tertiary rounded" />
                        <input type="number" value={discount} onChange={e => setDiscount(Number(e.target.value))} placeholder={t.discountPercentage} className="p-2 bg-tertiary rounded" />
                        <input type="number" value={usageLimit} onChange={e => setUsageLimit(Number(e.target.value))} placeholder={t.usageLimit} className="p-2 bg-tertiary rounded" />
                        <button type="submit" className="accent-bg text-white py-2 rounded">{t.addPromoCode}</button>
                    </form>
                    <div className="space-y-2">
                        {promoCodes.map(p => (
                            <div key={p.id} className="bg-secondary p-3 rounded flex justify-between items-center">
                                <div>
                                    <p className="font-bold">{p.id}</p>
                                    <p className="text-sm text-secondary">Скидка: {p.discount}%, Использовано: {p.timesUsed}/{p.usageLimit}</p>
                                </div>
                                <button onClick={() => handleDelete(p.id)} className="bg-red-600 text-white px-3 py-1 rounded">{t.delete}</button>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        function App() {
            const [user, setUser] = useState(undefined);
            const [products, setProducts] = useState([]);
            const [purchases, setPurchases] = useState([]);
            const [faqs, setFaqs] = useState([]);
            const [promoCodes, setPromoCodes] = useState([]);
            const [alertInfo, setAlertInfo] = useState(null);
            
            const [language, setLanguage] = useState(() => localStorage.getItem('asonikLang') || 'ru');
            const [currency, setCurrency] = useState(() => localStorage.getItem('asonikCurrency') || 'UZS');
            
            const [profileVisible, setProfileVisible] = useState(false);
            const [selectedProduct, setSelectedProduct] = useState(null);
            const [isCartVisible, setIsCartVisible] = useState(false);
            const [isCheckoutVisible, setIsCheckoutVisible] = useState(false);
            const [isAdminAuthenticated, setIsAdminAuthenticated] = useState(false);
            const [isPinModalVisible, setIsPinModalVisible] = useState(false);
            const [pinError, setPinError] = useState('');
            const [authReady, setAuthReady] = useState(false);

            const { path, navigate } = useHashRouter();
            const { cartItems, clearCart } = useCart();
            const isAdmin = user && user.uid === ADMIN_UID;
            const t = translations[language] || translations.ru;
            
            useEffect(() => { localStorage.setItem('asonikLang', language); }, [language]);
            useEffect(() => { localStorage.setItem('asonikCurrency', currency); }, [currency]);

            useEffect(() => {
                const unsubscribe = onAuthStateChanged(auth, (currentUser) => {
                    setUser(currentUser);
                    setAuthReady(true);
                });
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                if (!authReady) return; // Wait for auth to be ready

                // Public listeners
                const unsubProducts = onSnapshot(query(collection(db, "products")), 
                    (snapshot) => {
                        const productsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        productsData.sort((a,b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0));
                        setProducts(productsData);
                    },
                    (error) => console.error("Firebase product listener error:", error)
                );
                const unsubFaqs = onSnapshot(query(collection(db, "faq")), 
                    (snapshot) => {
                        const faqsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        faqsData.sort((a,b) => a.question.localeCompare(b.question));
                        setFaqs(faqsData);
                    },
                    (error) => console.error("Firebase FAQ listener error:", error)
                );

                let unsubPurchases = () => {};
                let unsubPromo = () => {};

                // Admin-only listeners
                if (isAdmin) {
                    unsubPurchases = onSnapshot(query(collection(db, "purchases")), 
                        (snapshot) => {
                            const purchasesData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                            purchasesData.sort((a,b) => (b.timestamp?.toMillis() || 0) - (a.timestamp?.toMillis() || 0));
                            setPurchases(purchasesData);
                        },
                        (error) => console.error("Firebase admin purchases listener error:", error)
                    );
                    unsubPromo = onSnapshot(collection(db, "promoCodes"), 
                        (snapshot) => setPromoCodes(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))),
                        (error) => console.error("Firebase admin promo listener error:", error)
                    );
                } else {
                    // If user is not admin, clear any potential leftover admin data
                    setPurchases([]);
                    setPromoCodes([]);
                }

                return () => { 
                    unsubProducts(); 
                    unsubFaqs(); 
                    unsubPurchases(); 
                    unsubPromo(); 
                };
            }, [authReady, isAdmin]);

            const handleLogin = async () => { await signInWithPopup(auth, provider); };
            const handleLogout = async () => { await signOut(auth); setIsAdminAuthenticated(false); navigate('#/'); };

            const handlePinSubmit = (pin) => {
                if (pin === ADMIN_PIN) {
                    setIsAdminAuthenticated(true);
                    setIsPinModalVisible(false);
                    setPinError('');
                } else {
                    setPinError(t.wrongPin || 'Неверный ПИН-код');
                }
            };

            const handleCheckout = () => {
                if (!user) { setAlertInfo({ message: t.loginToBuy }); return; }
                if (cartItems.length === 0) return;
                setIsCartVisible(false);
                setIsCheckoutVisible(true);
            };

            const handleConfirmPurchase = async (purchaseDetails) => {
                const purchaseCode = generatePurchaseCode();
                try {
                    await runTransaction(db, async (transaction) => {
                        for (const item of cartItems) {
                            const productRef = doc(db, "products", item.id);
                            const productDoc = await transaction.get(productRef);
                            if (!productDoc.exists()) throw new Error(`Product ${item.name.ru} not found`);
                            
                            const variants = productDoc.data().variants;
                            const variantIndex = variants.findIndex(v => v.nominal.ru === item.variant.nominal.ru);
                            if (variantIndex === -1) throw new Error(`Variant ${item.variant.nominal.ru} not found`);
                            
                            const currentStock = variants[variantIndex].stockQuantity;
                            if (currentStock < item.quantity) throw new Error(`${t.notEnoughStock || 'Недостаточно товара на складе для'} ${item.name.ru} (${item.variant.nominal.ru})`);
                            
                            variants[variantIndex].stockQuantity -= item.quantity;
                            transaction.update(productRef, { variants });
                        }

                        const purchasePayload = {
                            userId: user.uid, userEmail: user.email,
                            items: cartItems.map(i => ({ id: i.id, name: i.name, quantity: i.quantity, variant: i.variant })),
                            timestamp: serverTimestamp(),
                            totalPrice: purchaseDetails.finalPrice,
                            promoCodeUsed: purchaseDetails.promoCodeUsed,
                            status: 'contacted',
                            purchaseCode
                        };
                        const purchaseRef = doc(collection(db, 'purchases'));
                        transaction.set(purchaseRef, purchasePayload);
                    });

                    clearCart();
                    setIsCheckoutVisible(false);
                    setAlertInfo({ message: `${t.purchaseSuccessful || 'Заказ успешно оформлен! Ваш код:'} ${purchaseCode}` });
                    navigate('#/purchases');
                } catch (error) {
                    console.error("Purchase failed:", error);
                    setAlertInfo({ message: `${t.errorOccurred}: ${error.message}` });
                }
            };
            
            const renderContent = () => {
                if (path.startsWith('#/admin')) {
                    if (!isAdmin) { navigate('#/'); return null; }
                    if (!isAdminAuthenticated) {
                        if (!isPinModalVisible) setIsPinModalVisible(true);
                        return null;
                    }
                    const adminRoute = path.split('/')[2] || 'dashboard';
                    return (
                        <AdminLayout t={t}>
                            {adminRoute === 'dashboard' && <AdminDashboard t={t} purchases={purchases} products={products} currency={currency} convertPrice={convertPrice} />}
                            {adminRoute === 'products' && <AdminProducts t={t} products={products} setAlertInfo={setAlertInfo} language={language} />}
                            {adminRoute === 'purchases' && <AdminPurchases t={t} setAlertInfo={setAlertInfo} purchases={purchases} convertPrice={convertPrice} currency={currency} language={language} />}
                            {adminRoute === 'faq' && <AdminFaq t={t} faqs={faqs} setAlertInfo={setAlertInfo} />}
                            {adminRoute === 'promo' && <AdminPromo t={t} promoCodes={promoCodes} setAlertInfo={setAlertInfo} />}
                        </AdminLayout>
                    );
                }
                switch (path) {
                    case '#/purchases': return user ? <MyPurchasesPage {...{user, t, currency, convertPrice, setAlertInfo, language}} /> : <div className="text-center text-primary p-10">{t.loginToView}</div>;
                    case '#/faq': return <FAQPage faqs={faqs} t={t} />;
                    default: return <HomePage {...{products, onProductClick: setSelectedProduct, t, currency, convertPrice, loading: products.length === 0, language}} />;
                }
            };
            
            if (!authReady) return <LoadingSpinner />;
            
            return (
                <div className="bg-primary min-h-screen font-sans flex flex-col">
                    <Header {...{user, onLogin: handleLogin, onLogout: handleLogout, isAdmin, t, currency, setCurrency, language, setLanguage, setProfileVisible, onCartClick: () => setIsCartVisible(true)}} />
                    <div className="flex-grow">
                        {renderContent()}
                    </div>
                    
                    {selectedProduct && <ProductModal product={selectedProduct} user={user} onClose={() => setSelectedProduct(null)} setAlertInfo={setAlertInfo} t={t} currency={currency} convertPrice={convertPrice} language={language} />}
                    {isCartVisible && <CartModal onClose={() => setIsCartVisible(false)} onCheckout={handleCheckout} t={t} currency={currency} convertPrice={convertPrice} language={language} />}
                    {isCheckoutVisible && <CheckoutModal onClose={() => setIsCheckoutVisible(false)} onConfirm={handleConfirmPurchase} t={t} currency={currency} convertPrice={convertPrice} setAlertInfo={setAlertInfo} />}
                    {alertInfo && <AlertModal message={alertInfo.message} onConfirm={alertInfo.onConfirm} onCancel={() => setAlertInfo(null)} t={t} />}
                    {profileVisible && user && <ProfileModal user={user} onClose={() => setProfileVisible(false)} t={t} setAlertInfo={setAlertInfo} onLogout={handleLogout} />}
                    {isPinModalVisible && <PinModal onSubmit={handlePinSubmit} error={pinError} onClose={() => { setIsPinModalVisible(false); navigate('#/'); }} t={t} />}
                    
                    <Footer t={t}/>
                </div>
            );
        }
        
        const translations = {
            ru: {
                home: 'Главная', faq: 'FAQ', adminPanelTitle: 'Админ-панель', profile: 'Профиль', logout: 'Выйти', login: 'Войти',
                confirmation: 'Подтверждение', cancel: 'Отмена', ok: 'OK', confirm: 'Подтвердить',
                loginToView: 'Пожалуйста, войдите, чтобы просмотреть.',
                loginToBuy: 'Пожалуйста, войдите, чтобы совершить покупку.',
                imageNotFound: 'Изображение не найдено',
                catalogTitle: 'КАТАЛОГ ТОВАРОВ', catalogSubtitle: 'Лучшие предложения только для вас',
                addProduct: 'Добавить товар', editProduct: 'Редактировать товар', edit: 'Ред.', delete: 'Удал.',
                productName: 'Название товара', productNominal: 'Номинал (н-р: 100 гемов)', description: 'Описание', priceInRub: 'Цена (в RUB)', imageUrl: 'URL изображения', productImages: 'URL изображений товара', addImage: 'Добавить фото',
                addProductBtn: 'Добавить товар', updateProduct: 'Обновить товар',
                productAdded: 'Товар успешно добавлен!', productUpdated: 'Товар успешно обновлен!', errorOccurred: 'Произошла ошибка.',
                confirmDelete: 'Вы уверены, что хотите удалить этот товар?', productDeleted: 'Товар удален.',
                avatarUpdated: 'Аватар успешно обновлен!',
                checkout: 'Оформление заказа', youAreBuying: 'Вы покупаете',
                rightsReserved: 'Все права защищены.', developedWithLove: 'Дизайн и разработка с ❤️',
                russian: 'Русский', uzbek: 'O\'zbekcha',
                dollar: 'Доллар', sum: "So'm",
                all: 'Все',
                searchPlaceholder: 'Поиск по названию...', category: 'Категория', games: 'Игры', apps: 'Приложения', sortBy: 'Сортировка', newSort: 'Новые', popularSort: 'Популярные', productsNotFound: 'Товары не найдены',
                pinProduct: 'Закрепить товар', pinned: 'Закреплено',
                noApiKey: 'Ключ API для ImgBB не установлен!',
                darkTheme: 'Фирменная (темная)', lightTheme: 'Фирменная (светлая)',
                manageFaq: 'Управление FAQ', faqTitle: 'Часто задаваемые вопросы',
                managePromoCodes: 'Промокоды', promoCode: 'Промокод', discount: 'Скидка', addPromoCode: 'Добавить промокод',
                promoCodeName: 'Название промокода', discountPercentage: 'Размер скидки',
                payWithPromo: 'Применить промокод', apply: 'Применить', promoNotFound: 'Промокод не найден или недействителен.', promoApplied: 'Промокод применен',
                usageLimit: 'Лимит использований', promoLimitReached: 'Лимит использования этого промокода исчерпан.',
                myPurchases: 'Мои покупки',
                noPurchasesYet: 'У вас еще нет покупок.',
                statusPending: 'На проверке', statusApproved: 'Одобрена', statusRejected: 'Отклонена', statusContacted: 'Ожидает связи', statusCancelled: 'Отменен',
                adminComment: 'Комментарий администратора',
                amount: 'Сумма',
                adminAccess: 'Доступ для администратора', enterPin: 'Введите ПИН-код', enter: 'Войти',
                productAddedToCart: 'Товар добавлен в корзину!', addToCart: 'В корзину', cart: 'Корзина', cartIsEmpty: 'Ваша корзина пуста', total: 'Итого', proceedToCheckout: 'Перейти к оформлению',
                productsCount: 'товар(а/ов)', confirmAndPay: 'Подтвердить и оплатить', purchaseSuccessful: 'Заказ успешно оформлен! Ваш код:',
                notEnoughStock: 'Недостаточно товара на складе для',
                adminMenu: 'Меню', dashboard: 'Обзор', managePurchases: 'Заказы',
                totalProducts: 'Всего товаров', totalPurchases: 'Всего заказов', totalRevenue: 'Общая выручка',
                items: 'Товары', status: 'Статус', actions: 'Действия',
                price: 'Цена', stock: 'Остаток', variants: 'Варианты', addVariant: 'Добавить вариант', onSale: 'В продаже',
                statusUpdated: 'Статус обновлен', searchByCodeOrEmail: 'Поиск по коду или Email...',
                wrongPin: 'Неверный ПИН-код',
                firstName: 'Имя', lastName: 'Фамилия', updateProfile: 'Обновить профиль', profileUpdated: 'Профиль обновлен', sending: 'Отправка...'
            },
            uz: {
                home: 'Bosh sahifa', faq: 'FAQ', adminPanelTitle: 'Admin Paneli', profile: 'Profil', logout: 'Chiqish', login: 'Kirish',
                confirmation: 'Tasdiqlash', cancel: 'Bekor qilish', ok: 'OK', confirm: 'Tasdiqlash',
                loginToView: 'Ko\'rish uchun tizimga kiring.',
                loginToBuy: 'Xarid qilish uchun tizimga kiring.',
                imageNotFound: 'Rasm topilmadi',
                catalogTitle: 'MAHSULOTLAR KATALOGI', catalogSubtitle: 'Faqat siz uchun eng yaxshi takliflar',
                addProduct: 'Mahsulot qo\'shish', editProduct: 'Mahsulotni tahrirlash', edit: 'Tahr.', delete: 'O\'chirish',
                productName: 'Mahsulot nomi', productNominal: 'Nominal (masalan: 100 gem)', description: 'Tavsif', priceInRub: 'Narx (RUBda)', imageUrl: 'Rasm URL', productImages: 'Mahsulot rasmlari URL', addImage: 'Rasm qo\'shish',
                addProductBtn: 'Mahsulot qo\'shish', updateProduct: 'Mahsulotni yangilash',
                productAdded: 'Mahsulot muvaffaqiyatli qo\'shildi!', productUpdated: 'Mahsulot muvaffaqiyatli yangilandi!', errorOccurred: 'Xatolik yuz berdi.',
                confirmDelete: 'Haqiqatan ham bu mahsulotni oʻchirib tashlamoqchimisiz?', productDeleted: 'Mahsulot oʻchirildi.',
                avatarUpdated: 'Avatar muvaffaqiyatli yangilandi!',
                checkout: 'Buyurtmani rasmiylashtirish', youAreBuying: 'Siz sotib olyapsiz',
                rightsReserved: 'Barcha huquqlar himoyalangan.', developedWithLove: '❤️ bilan ishlab chiqilgan',
                russian: 'Русский', uzbek: 'O\'zbekcha',
                dollar: 'Dollar', sum: "So'm",
                all: 'Barchasi',
                searchPlaceholder: 'Nom bo\'yicha qidirish...', category: 'Kategoriya', games: 'O\'yinlar', apps: 'Ilovalar', sortBy: 'Saralash', newSort: 'Yangilari', popularSort: 'Ommaboplari', productsNotFound: 'Mahsulotlar topilmadi',
                pinProduct: 'Mahsulotni mahkamlash', pinned: 'Mahkamlangan',
                noApiKey: 'ImgBB uchun API kaliti o\'rnatilmagan!',
                darkTheme: 'Firmali (qorong\'u)', lightTheme: 'Firmali (yorug\')',
                manageFaq: 'FAQ boshqaruvi', faqTitle: 'Tez-tez so\'raladigan savollar',
                managePromoCodes: 'Promokodlar', promoCode: 'Promokod', discount: 'Chegirma', addPromoCode: 'Promokod qo\'shish',
                promoCodeName: 'Promokod nomi', discountPercentage: 'Chegirma foizi',
                payWithPromo: 'Promokodni qo\'llash', apply: 'Qo\'llash', promoNotFound: 'Promokod topilmadi yoki yaroqsiz.', promoApplied: 'Promokod qo\'llanildi',
                usageLimit: 'Foydalanish chegarasi', promoLimitReached: 'Ushbu promokodning foydalanish chegarasi tugadi.',
                myPurchases: 'Mening xaridlarim',
                noPurchasesYet: 'Sizda hali xaridlar yo\'q.',
                statusPending: 'Tekshirilmoqda', statusApproved: 'Tasdiqlandi', statusRejected: 'Rad etildi', statusContacted: 'Aloqani kutmoqda', statusCancelled: 'Bekor qilingan',
                adminComment: 'Administrator izohi',
                amount: 'Summa',
                adminAccess: 'Admin Kirish', enterPin: 'PIN-kodni kiriting', enter: 'Kirish',
                productAddedToCart: 'Mahsulot savatga qo\'shildi!', addToCart: 'Savatga qo\'shish', cart: 'Savat', cartIsEmpty: 'Sizning savatingiz bo\'sh', total: 'Jami', proceedToCheckout: 'Rasmiylashtirishga o\'tish',
                productsCount: 'mahsulot', confirmAndPay: 'Tasdiqlash va to\'lash', purchaseSuccessful: 'Buyurtma muvaffaqiyatli rasmiylashtirildi! Sizning kodingiz:',
                notEnoughStock: 'Uchun omborda mahsulot yetarli emas',
                adminMenu: 'Menyu', dashboard: 'Ko\'rib chiqish', managePurchases: 'Buyurtmalar',
                totalProducts: 'Jami mahsulotlar', totalPurchases: 'Jami buyurtmalar', totalRevenue: 'Jami daromad',
                items: 'Mahsulotlar', status: 'Holat', actions: 'Harakatlar',
                price: 'Narx', stock: 'Qoldiq', variants: 'Variantlar', addVariant: 'Variant qo\'shish', onSale: 'Sotuvda',
                statusUpdated: 'Holat yangilandi', searchByCodeOrEmail: 'Kod yoki Email bo\'yicha qidirish...',
                wrongPin: 'Noto\'g\'ri PIN-kod',
                firstName: 'Ism', lastName: 'Familiya', updateProfile: 'Profilni yangilash', profileUpdated: 'Profil yangilandi', sending: 'Yuborilmoqda...'
            }
        };
        const currencyRates = { RUB: 1, USD: 0.011, UZS: 140 };
        const currencySymbols = { USD: '$', UZS: "so'm" };
        const convertPrice = (priceInRub, targetCurrency) => {
            const rate = currencyRates[targetCurrency];
            const symbol = currencySymbols[targetCurrency];
            if (!rate || !priceInRub) return `0 ${symbol}`;
            return `${(priceInRub * rate).toLocaleString('ru-RU', { maximumFractionDigits: 2 })} ${symbol}`;
        };

        ReactDOM.render(
            <CartProvider>
                <App />
            </CartProvider>, 
            document.getElementById('root')
        );
    </script>
</body>
</html>
