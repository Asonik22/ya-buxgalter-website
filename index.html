<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–î–ï–ú–û-–í–ï–†–°–ò–Ø | Asonik Store</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üõí</text></svg>" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-light-start: #ede9fe; --bg-light-end: #f5f3ff; --text-light: #1e1b4b; --card-bg-light: #ffffff; --primary-light: #7c3aed; --primary-hover-light: #6d28d9; --border-light: #ddd6fe; --logo-text-light: #5b21b6; --nav-hover-bg-light: #e0e7ff; --nav-hover-text-light: #1e1b4b; --nav-active-bg-light: #7c3aed; --nav-active-text-light: #ffffff;
            --bg-dark-start: #1e1b4b; --bg-dark-end: #17133a; --text-dark: #e0e7ff; --card-bg-dark: #282454; --primary-dark: #a78bfa; --primary-hover-dark: #c4b5fd; --border-dark: #4338ca; --logo-text-dark: #c7d2fe; --nav-hover-bg-dark: #312e74; --nav-hover-text-dark: #e0e7ff; --nav-active-bg-dark: #a78bfa; --nav-active-text-dark: #1e1b4b;
        }
        html.dark { 
            --bg-start: var(--bg-dark-start); --bg-end: var(--bg-dark-end); --text: var(--text-dark); --card-bg: var(--card-bg-dark); --primary: var(--primary-dark); --primary-hover: var(--primary-hover-dark); --border: var(--border-dark); --logo-text: var(--logo-text-dark); --nav-hover-bg: var(--nav-hover-bg-dark); --nav-hover-text: var(--nav-hover-text-dark); --nav-active-bg: var(--nav-active-bg-dark); --nav-active-text: var(--nav-active-text-dark);
        }
        html:not(.dark) { 
            --bg-start: var(--bg-light-start); --bg-end: var(--bg-light-end); --text: var(--text-light); --card-bg: var(--card-bg-light); --primary: var(--primary-light); --primary-hover: var(--primary-hover-light); --border: var(--border-light); --logo-text: var(--logo-text-light); --nav-hover-bg: var(--nav-hover-bg-light); --nav-hover-text: var(--nav-hover-text-light); --nav-active-bg: var(--nav-active-bg-light); --nav-active-text: var(--nav-active-text-light);
        }
        body { font-family: 'Manrope', sans-serif; background-image: linear-gradient(120deg, var(--bg-start), var(--bg-end)); color: var(--text); transition: background-color 0.3s, color 0.3s; }
        .logo-text { color: var(--logo-text); } .bg-primary { background-color: var(--primary); } .hover\:bg-primary-hover:hover { background-color: var(--primary-hover); } .text-primary { color: var(--primary); } .border-custom { border-color: var(--border); } .card-bg { background-color: var(--card-bg); } .input-bg { background-color: var(--card-bg); border-color: var(--border); color: var(--text); } .modal-backdrop { background-color: rgba(0, 0, 0, 0.7); }
        [data-page] { display: none; } [data-page].active { display: block; }
        .main-nav-link:hover { background-color: var(--nav-hover-bg); color: var(--nav-hover-text) !important; }
        .main-nav-link.active { background-color: var(--nav-active-bg); color: var(--nav-active-text) !important; }
        .btn { display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; padding: 0.75rem 1.25rem; border-radius: 0.5rem; font-weight: 600; transition: all 0.2s; cursor: pointer; border: none; }
        .btn-primary { background-color: var(--primary); color: white; } .btn-primary:hover { background-color: var(--primary-hover); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .btn-danger { background-color: #ef4444; color: white; } .btn-danger:hover { background-color: #dc2626; }
        .modern-input { background-color: var(--card-bg); border: 1px solid var(--border); border-radius: 0.5rem; padding: 0.75rem; width: 100%; transition: border-color 0.2s, box-shadow 0.2s; color: var(--text); }
        .modern-input::placeholder { color: color-mix(in srgb, var(--text) 50%, transparent); }
        .modern-input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px color-mix(in srgb, var(--primary) 25%, transparent); }
        #loading-overlay { position: fixed; inset: 0; background-image: linear-gradient(120deg, var(--bg-start), var(--bg-end)); z-index: 100; display: flex; align-items: center; justify-content: center; transition: opacity 0.5s ease-out; opacity: 1; }
        .spinner { width: 56px; height: 56px; border-radius: 50%; border: 8px solid; border-color: var(--border); border-right-color: var(--primary); animation: spinner-d3wgkg 1s infinite linear; }
        @keyframes spinner-d3wgkg { to { transform: rotate(1turn); } }
        #store-logo, .product-card-img, #main-product-image, #profile-avatar { object-fit: cover; }
        .variation-option.selected, .payment-option.selected { border-color: var(--primary) !important; box-shadow: 0 0 0 3px color-mix(in srgb, var(--primary) 40%, transparent); border-width: 2px; }
        .variation-option.disabled { opacity: 0.5; cursor: not-allowed; background-color: color-mix(in srgb, var(--card-bg) 50%, #888); }
        .hit-badge { position: absolute; top: 8px; right: 8px; background-color: #ef4444; color: white; padding: 2px 8px; border-radius: 9999px; font-size: 0.8rem; font-weight: 800; z-index: 10; text-transform: uppercase; }
        .payment-card-option { transition: all 0.2s ease-in-out; }
        .payment-card-option.selected { transform: scale(1.05); border-color: var(--primary); box-shadow: 0 0 15px color-mix(in srgb, var(--primary) 20%, transparent); }
    </style>
</head>
<body class="antialiased opacity-0 transition-opacity duration-500">

    <div id="loading-overlay"><div class="spinner"></div></div>

    <header class="sticky top-0 z-40">
        <div class="container mx-auto px-4">
            <div class="mt-4 card-bg shadow-lg rounded-xl border border-custom/50 flex justify-between items-center h-16 px-4">
                <a href="#main" class="flex items-center gap-3 text-2xl font-bold nav-link rounded-lg">
                    <img id="store-logo" src="https://i.ibb.co/mS6Habd/1712683935639.jpg" alt="logo" class="h-8 w-8 rounded-full">
                    <span id="site-name-display" class="logo-text hidden sm:inline">Asonik | Store</span>
                </a>
                <nav class="hidden md:flex items-center space-x-2 bg-white/10 dark:bg-black/10 p-1 rounded-full">
                    <a href="#main" class="main-nav-link nav-link flex items-center gap-2 px-3 py-1.5 rounded-full transition-colors active" data-nav-key="main">–ì–ª–∞–≤–Ω–∞—è</a>
                    <a href="#" class="main-nav-link nav-link flex items-center gap-2 px-3 py-1.5 rounded-full transition-colors">–ü–æ–¥–¥–µ—Ä–∂–∫–∞</a>
                    <a href="#" class="main-nav-link nav-link flex items-center gap-2 px-3 py-1.5 rounded-full transition-colors">FAQ</a>
                    <a href="#" class="main-nav-link nav-link flex items-center gap-2 px-3 py-1.5 rounded-full transition-colors">–ú–æ–∏ –ø–æ–∫—É–ø–∫–∏</a>
                </nav>
                <div class="flex items-center space-x-1 sm:space-x-2">
                    <button id="balance-btn" class="btn bg-primary/10 hover:bg-primary/20 border border-custom/50">
                        <svg class="h-5 w-5 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H4a3 3 0 00-3 3v8a3 3 0 003 3z"></path></svg>
                        <span id="balance-amount" class="font-semibold text-sm">0</span>
                        <svg class="w-4 h-4 opacity-70" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
                    </button>
                    <button id="theme-toggle" class="p-2 rounded-full hover:bg-black/10 dark:hover:bg-white/10">üåô</button>
                    <div id="auth-container" class="relative"></div>
                </div>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 py-8">
        <div data-page="main" class="active"><div id="main-page-content-wrapper"></div></div>
        <div data-page="product"><div id="product-detail-content"></div></div>
        <div data-page="admin"><div id="admin-content"></div></div>
    </main>
    
    <footer class="text-center text-sm text-gray-500 py-4 mt-8 border-t border-custom">¬© Asonik | Store (–î–ï–ú–û) 2025</footer>
    
    <div id="modals-container"></div>

    <script>
        // --- MOCK DATA (FOR DEMO PURPOSES) ---
        let currentUser = {
            displayName: '–¢–µ—Å—Ç–æ–≤—ã–π –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å',
            photoURL: 'https://i.pravatar.cc/150?u=a042581f4e29026704d',
            uid: 'MrjXzJnZYbb6jb65B4f4aYDTVBt2' // Simulating admin UID
        };
        let isAdmin = true;
        let appState = {
            balance: 543210,
            withdrawalCommission: 2.5, // 2.5% commission
            currency: 'UZS',
            rates: { UZS: 1 }
        };
        let allProducts = [
            {
                id: 'prod_1',
                name: '–ü—Ä–µ–º–∏—É–º –ê–∫–∫–∞—É–Ω—Ç "–õ–µ–≥–µ–Ω–¥–∞"',
                description: '–ü–æ–ª—É—á–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ —ç–∫—Å–∫–ª—é–∑–∏–≤–Ω—ã–º —Ñ—É–Ω–∫—Ü–∏—è–º, —É–Ω–∏–∫–∞–ª—å–Ω—ã–º –ø—Ä–µ–¥–º–µ—Ç–∞–º –∏ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–º –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—è–º –Ω–∞ —Ü–µ–ª—ã–π –≥–æ–¥.',
                imageUrl: 'https://images.unsplash.com/photo-1593344484962-796b99420a26?q=80&w=1920&auto=format&fit=crop',
                price: 150000,
                isPinned: true,
                variations: [
                    { name: '–°—Ç–∞–Ω–¥–∞—Ä—Ç (1 –º–µ—Å—è—Ü)', price: 25000 },
                    { 
                        name: '–•–ò–¢! –ó–æ–ª–æ—Ç–æ–π (6 –º–µ—Å—è—Ü–µ–≤)', 
                        price: 120000,
                        specialOffer: { isEnabled: true, limit: 5, sold: 1 } 
                    },
                    { name: '–ü–ª–∞—Ç–∏–Ω–∞ (1 –≥–æ–¥)', price: 200000, isOutOfStock: true },
                ]
            },
            {
                id: 'prod_2',
                name: '–°—Ç–∞—Ä—Ç–æ–≤—ã–π –Ω–∞–±–æ—Ä "–ù–æ–≤–∏—á–æ–∫"',
                description: '–í—Å–µ —á—Ç–æ –Ω—É–∂–Ω–æ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ —Å—Ç–∞—Ä—Ç–∞: –±–∞–∑–æ–≤–∞—è —ç–∫–∏–ø–∏—Ä–æ–≤–∫–∞, –Ω–µ–º–Ω–æ–≥–æ –≤–∞–ª—é—Ç—ã –∏ –±—É—Å—Ç–µ—Ä—ã –æ–ø—ã—Ç–∞.',
                imageUrl: 'https://images.unsplash.com/photo-1612287230202-95a041628d26?q=80&w=1920&auto=format&fit=crop',
                price: 50000,
            }
        ];

        // --- CORE UI FUNCTIONS ---
        const formatPrice = (price, currency = appState.currency) => new Intl.NumberFormat('ru-RU', { style: 'currency', currency, minimumFractionDigits: 0 }).format(price);
        const showToast = (message, isError = false) => { const el = document.createElement('div'); el.className = `fixed bottom-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg z-50 ${isError ? 'bg-red-500' : 'bg-green-500'}`; el.textContent = message; document.body.appendChild(el); setTimeout(() => el.remove(), 3000); };
        const showModal = (title, content, onSave, btnText = '–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å') => { const modal = document.createElement('div'); modal.id = 'modal-backdrop'; modal.className = 'fixed inset-0 z-50 flex items-center justify-center modal-backdrop'; modal.innerHTML = `<div class="card-bg rounded-lg shadow-xl w-11/12 md:max-w-xl p-6 max-h-[90vh] overflow-y-auto"><div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-bold">${title}</h2><button class="close-modal-btn text-2xl">&times;</button></div><div>${content}</div>${onSave ? `<div class="mt-6 flex justify-end gap-4"><button class="close-modal-btn btn">–û—Ç–º–µ–Ω–∞</button><button class="save-modal-btn btn btn-primary">${btnText}</button></div>` : ''}</div>`; document.getElementById('modals-container').appendChild(modal); modal.querySelectorAll('.close-modal-btn').forEach(b => b.onclick = () => modal.remove()); if (onSave) modal.querySelector('.save-modal-btn').onclick = async () => { if (await onSave(modal) !== false) modal.remove(); }; return modal; };
        
        // --- NEW WITHDRAWAL MODAL ---
        function showWithdrawModal() {
            let step = 1;
            let amount = 0;
            let cardNumber = '';

            const render = () => {
                if (step === 1) {
                    const content = `
                        <p class="text-sm text-gray-400 mb-4">–î–æ—Å—Ç—É–ø–Ω–æ –¥–ª—è –≤—ã–≤–æ–¥–∞: ${formatPrice(appState.balance)}</p>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium mb-1">–°—É–º–º–∞ –≤—ã–≤–æ–¥–∞ (UZS)</label>
                                <div class="relative">
                                    <input id="withdraw-amount" type="number" class="modern-input pr-10" placeholder="0">
                                    <button id="fill-max-amount" class="absolute inset-y-0 right-0 flex items-center px-3 text-gray-400 hover:text-primary" title="–í—ã–≤–µ—Å—Ç–∏ –≤—Å—é —Å—É–º–º—É">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6"><path d="M17 4H7V2h10v2Zm0 16H7v-2h10v2Zm-5-4a4 4 0 0 1-4-4V8h2v6a2 2 0 0 0 2 2h2v2H12ZM7 8H5V6h2v2Zm12 0h-2V6h2v2Z"></path><path d="M7 16h2v-2H7v2Zm10-2h-2v-2h2v2Z"></path></svg>
                                    </button>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">–ù–æ–º–µ—Ä –∫–∞—Ä—Ç—ã</label>
                                <input id="withdraw-card" type="text" class="modern-input" placeholder="8600 0000 0000 0000">
                            </div>
                        </div>
                    `;
                    const modal = showModal('–í—ã–≤–æ–¥ —Å—Ä–µ–¥—Å—Ç–≤ (–®–∞–≥ 1 –∏–∑ 2)', content, () => {
                        amount = parseFloat(document.getElementById('withdraw-amount').value);
                        cardNumber = document.getElementById('withdraw-card').value;
                        if (!amount || amount <= 0) { showToast('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É', true); return false; }
                        if (amount > appState.balance) { showToast('–°—É–º–º–∞ –≤—ã–≤–æ–¥–∞ –ø—Ä–µ–≤—ã—à–∞–µ—Ç –±–∞–ª–∞–Ω—Å', true); return false; }
                        if (!cardNumber.replace(/\s/g, '').match(/^\d{16}$/)) { showToast('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä –∫–∞—Ä—Ç—ã (16 —Ü–∏—Ñ—Ä)', true); return false; }
                        step = 2;
                        modal.remove();
                        render();
                    }, '–î–∞–ª–µ–µ');
                    document.getElementById('fill-max-amount').onclick = () => document.getElementById('withdraw-amount').value = appState.balance;

                } else if (step === 2) {
                    const commission = amount * (appState.withdrawalCommission / 100);
                    const totalDeducted = amount;
                    const amountToReceive = amount - commission;

                    const content = `
                        <div class="space-y-3 mb-6">
                            <div class="flex justify-between text-lg"><span class="text-gray-400">–°—É–º–º–∞ –≤—ã–≤–æ–¥–∞:</span> <strong>${formatPrice(amount)}</strong></div>
                            <div class="flex justify-between text-lg"><span class="text-gray-400">–ö–æ–º–∏—Å—Å–∏—è (${appState.withdrawalCommission}%):</span> <strong class="text-red-500">-${formatPrice(commission)}</strong></div>
                            <hr class="border-custom">
                            <div class="flex justify-between text-xl font-bold"><span class="text-gray-400">–ö –∑–∞—á–∏—Å–ª–µ–Ω–∏—é:</span> <span class="text-green-500">${formatPrice(amountToReceive)}</span></div>
                        </div>
                        <h3 class="font-bold text-center mb-4">–í—ã–±–µ—Ä–∏—Ç–µ –ø–ª–∞—Ç–µ–∂–Ω—É—é —Å–∏—Å—Ç–µ–º—É –≤–∞—à–µ–π –∫–∞—Ä—Ç—ã</h3>
                        <div class="grid grid-cols-3 gap-4" id="payment-system-selector">
                            <div data-system="HUMO" class="payment-card-option cursor-pointer p-4 border-2 border-custom rounded-lg flex flex-col items-center justify-center gap-2">
                                <img src="https://www.kapital.uz/upload/media/icons/humo_logo.png" class="h-10 object-contain">
                                <span class="font-semibold">HUMO</span>
                            </div>
                            <div data-system="UzCard" class="payment-card-option cursor-pointer p-4 border-2 border-custom rounded-lg flex flex-col items-center justify-center gap-2">
                                <img src="https://uzcard.uz/img/logos/8600.png" class="h-10 object-contain">
                                <span class="font-semibold">UzCard</span>
                            </div>
                             <div data-system="Visa" class="payment-card-option cursor-pointer p-4 border-2 border-custom rounded-lg flex flex-col items-center justify-center gap-2">
                                <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/5/5e/Visa_Inc._logo.svg/1280px-Visa_Inc._logo.svg.png" class="h-10 object-contain">
                                <span class="font-semibold">Visa</span>
                            </div>
                        </div>
                    `;
                    const modal = showModal('–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ (–®–∞–≥ 2 –∏–∑ 2)', content, () => {
                        const selectedSystem = document.querySelector('.payment-card-option.selected')?.dataset.system;
                        if (!selectedSystem) {
                            showToast('–í—ã–±–µ—Ä–∏—Ç–µ –ø–ª–∞—Ç–µ–∂–Ω—É—é —Å–∏—Å—Ç–µ–º—É', true);
                            return false;
                        }
                        showToast(`–ó–∞—è–≤–∫–∞ –Ω–∞ –≤—ã–≤–æ–¥ ${formatPrice(amount)} –Ω–∞ –∫–∞—Ä—Ç—É ${selectedSystem} —Å–æ–∑–¥–∞–Ω–∞!`);
                        // In a real app, you would deduct the balance here
                        // appState.balance -= totalDeducted;
                        // updateBalanceUI();
                        return true;
                    }, '–°–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É');
                    
                    document.getElementById('payment-system-selector').onclick = (e) => {
                        const target = e.target.closest('.payment-card-option');
                        if (target) {
                            document.querySelectorAll('.payment-card-option').forEach(el => el.classList.remove('selected'));
                            target.classList.add('selected');
                        }
                    };
                }
            };
            render();
        }

        // --- PAGE RENDERING ---
        function handleRouting() {
            const hash = window.location.hash || '#main';
            let [page, subpage] = (hash.substring(1) || 'main').split('/');
            document.querySelectorAll('[data-page]').forEach(p => p.classList.remove('active'));
            document.querySelector(`[data-page="${page}"]`)?.classList.add('active');
            
            document.querySelectorAll('.main-nav-link').forEach(link => {
                link.classList.toggle('active', link.dataset.navKey === page);
            });

            switch(page) {
                case 'main': loadMainPage(); break; 
                case 'product': loadProductDetailPage(subpage); break;
                case 'admin': loadAdminPanel(subpage || 'products'); break; 
            }
        }

        function loadMainPage() {
            const grid = document.getElementById('main-page-content-wrapper');
            grid.innerHTML = `<h1 class="text-4xl font-bold text-center mb-8">–ö–∞—Ç–∞–ª–æ–≥ —Ç–æ–≤–∞—Ä–æ–≤</h1>
                              <div id="products-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>`;
            document.getElementById('products-grid').innerHTML = allProducts.map(p => renderProductCard(p)).join('');
        }

        function renderProductCard(p) {
            const hasSpecialOffer = p.variations?.some(v => v.specialOffer?.isEnabled);
            const hitBadgeHTML = hasSpecialOffer ? `<div class="hit-badge">–•–∏—Ç</div>` : '';
            
            return `<div class="card-bg rounded-lg shadow-lg flex flex-col justify-between border border-custom overflow-hidden transition-all duration-300 hover:shadow-2xl hover:-translate-y-1">
                <div class="relative">
                    ${hitBadgeHTML}
                    <a href="#product/${p.id}" class="nav-link block">
                        <img src="${p.imageUrl}" class="w-full h-48 product-card-img">
                    </a>
                </div>
                <div class="p-4 flex-grow">
                    <h3 class="text-lg font-semibold truncate">${p.name}</h3>
                    <p class="text-gray-600 dark:text-gray-400 mt-1 text-sm h-10 overflow-hidden">${p.description}</p>
                    <p class="text-2xl font-bold text-primary mt-4">${formatPrice(p.price || 0)}</p>
                </div>
                <div class="p-4 pt-2 border-t border-custom">
                     <a href="#product/${p.id}" class="nav-link w-full btn btn-primary text-center">–ü–æ–¥—Ä–æ–±–Ω–µ–µ</a>
                </div>
            </div>`;
        }
        
        function loadProductDetailPage(productId) {
            const contentContainer = document.getElementById('product-detail-content');
            const product = allProducts.find(p => p.id === productId);
            if (!product) { contentContainer.innerHTML = '–¢–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω'; return; }

            const variationsHTML = (product.variations || []).map((v, index) => {
                const remaining = v.specialOffer?.limit - v.specialOffer?.sold;
                const isOutOfStock = v.isOutOfStock || (v.specialOffer?.isEnabled && remaining <= 0);
                const disabledClass = isOutOfStock ? 'disabled' : '';
                const hitBadgeHTML = v.specialOffer?.isEnabled ? `<span class="px-2 py-0.5 text-xs rounded-full bg-red-500 text-white font-bold">–•–ò–¢</span>` : '';
                const stockHTML = v.specialOffer?.isEnabled ? `<span class="text-sm font-semibold ${remaining > 0 ? 'text-green-500' : 'text-red-500'}">–û—Å—Ç–∞–ª–æ—Å—å: ${remaining} —à—Ç.</span>` : '';

                return `<div class="variation-option p-4 border rounded-lg cursor-pointer transition-all ${disabledClass}" data-index="${index}">
                    <div class="flex justify-between items-center">
                        <div>
                            <h4 class="font-bold text-lg flex items-center gap-2">${v.name} ${hitBadgeHTML}</h4>
                            <p class="text-sm text-gray-500">${v.description || ''}</p>
                        </div>
                        <div class="text-right">
                           <p class="text-xl font-bold text-primary">${formatPrice(v.price)}</p>
                           ${stockHTML}
                        </div>
                    </div>
                </div>`;
            }).join('');

            contentContainer.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 lg:gap-12">
                    <div><img id="main-product-image" src="${product.imageUrl}" class="w-full rounded-lg shadow-lg"></div>
                    <div>
                        <h1 class="text-4xl font-extrabold mb-4">${product.name}</h1>
                        <div class="space-y-4">${variationsHTML}</div>
                        <div class="mt-8">
                            <button id="detail-buy-btn" class="w-full btn btn-primary text-lg">–ö—É–ø–∏—Ç—å (–î–µ–º–æ)</button>
                        </div>
                    </div>
                </div>`;

            contentContainer.querySelectorAll('.variation-option').forEach(option => {
                option.addEventListener('click', () => {
                    if(option.classList.contains('disabled')) return;
                    contentContainer.querySelectorAll('.variation-option').forEach(el => el.classList.remove('selected'));
                    option.classList.add('selected');
                });
            });
            
            document.getElementById('detail-buy-btn').onclick = () => showToast('–≠—Ç–æ –¥–µ–º–æ-–≤–µ—Ä—Å–∏—è, –ø–æ–∫—É–ø–∫–∞ –æ—Ç–∫–ª—é—á–µ–Ω–∞.');
        }

        // --- ADMIN PANEL DEMO ---
        function loadAdminPanel(subpage) {
            const el = document.getElementById('admin-content');
            const tabs = [
                { id: 'products', name: '–¢–æ–≤–∞—Ä—ã' }, 
                { id: 'customization', name: '–ö–∞—Å—Ç–æ–º–∏–∑–∞—Ü–∏—è' }
            ];
            el.innerHTML = `<h2 class="text-3xl font-bold mb-6">–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å (–î–µ–º–æ)</h2>
                <nav class="flex border-b border-custom mb-6">${tabs.map(t => `<a href="#admin/${t.id}" class="admin-tab-btn py-3 px-5 font-semibold border-b-2 ${subpage === t.id ? 'text-primary border-primary' : 'border-transparent'}" data-tab="${t.id}">${t.name}</a>`).join('')}</nav>
                <div id="admin-tab-content" class="card-bg p-6 rounded-lg min-h-[60vh] shadow-inner"></div>`;
            
            if (subpage === 'products') loadAdminProducts();
            if (subpage === 'customization') loadAdminCustomization();
        }

        function loadAdminProducts() {
            const container = document.getElementById('admin-tab-content');
            container.innerHTML = `
                <div class="space-y-4">
                    ${allProducts.map(p => `
                        <div class="card-bg p-4 rounded flex justify-between items-center border border-custom">
                            <p class="font-semibold">${p.name}</p>
                            <button class="edit-btn btn bg-blue-500 text-white text-sm" data-id="${p.id}">–†–µ–¥.</button>
                        </div>
                    `).join('')}
                </div>`;
             container.querySelector('.edit-btn')?.addEventListener('click', e => showProductForm(e.target.dataset.id));
        }
        
        function loadAdminCustomization() {
            const container = document.getElementById('admin-tab-content');
            container.innerHTML = `<div class="space-y-4 max-w-md">
                <div>
                    <label class="block text-sm font-medium mb-1">–ö–æ–º–∏—Å—Å–∏—è –Ω–∞ –≤—ã–≤–æ–¥ (%)</label>
                    <input id="commission-input" type="number" class="modern-input" value="${appState.withdrawalCommission}">
                </div>
                <button id="save-commission-btn" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å (–î–µ–º–æ)</button>
            </div>`;
            document.getElementById('save-commission-btn').onclick = () => {
                const newCommission = parseFloat(document.getElementById('commission-input').value);
                appState.withdrawalCommission = newCommission;
                showToast(`–ö–æ–º–∏—Å—Å–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞ –¥–æ ${newCommission}%`);
            };
        }

        function showProductForm(productId) {
            const p = allProducts.find(prod => prod.id === productId);
            if (!p) return;

            const renderVariationForm = (v, index) => {
                const offer = v.specialOffer || { isEnabled: false, limit: 0 };
                return `
                <div class="variation-item border-2 p-4 rounded-lg space-y-3 mt-4">
                    <input class="v-name w-full modern-input" value="${v.name || ''}" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –≤–∞—Ä–∏–∞—Ü–∏–∏">
                    <hr class="border-custom my-4">
                    <div class="p-3 bg-red-500/10 rounded-lg space-y-3">
                         <h5 class="font-bold text-red-400">–ê–∫—Ü–∏—è "–•–∏—Ç –ø—Ä–æ–¥–∞–∂"</h5>
                         <div class="flex items-center gap-2">
                            <input type="checkbox" id="v-offer-enabled-${index}" class="v-offer-enabled h-4 w-4 rounded text-primary" ${offer.isEnabled ? 'checked' : ''}>
                            <label for="v-offer-enabled-${index}" class="text-sm font-semibold">–í–∫–ª—é—á–∏—Ç—å –∞–∫—Ü–∏—é –¥–ª—è —ç—Ç–æ–π –≤–∞—Ä–∏–∞—Ü–∏–∏</label>
                        </div>
                        <div class="space-y-1">
                           <label class="text-sm">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–∞ –ø–æ –∞–∫—Ü–∏–∏</label>
                           <input type="number" class="v-offer-limit w-full modern-input" value="${offer.limit || 5}" placeholder="–ù–∞–ø—Ä. 5">
                        </div>
                    </div>
                </div>`;
            };

            const formHTML = `<div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-1">–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞</label>
                    <input id="p-name" value="${p.name || ''}" class="w-full modern-input">
                </div>
                <hr class="border-custom">
                <h4 class="font-bold">–í–∞—Ä–∏–∞—Ü–∏–∏ —Ç–æ–≤–∞—Ä–∞</h4>
                <div id="variations-container" class="space-y-4">${(p.variations || []).map(renderVariationForm).join('')}</div>
            </div>`;
            
            showModal('–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–≤–∞—Ä (–î–µ–º–æ)', formHTML, () => {
                 showToast('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã (–≤ –¥–µ–º–æ-—Ä–µ–∂–∏–º–µ)');
            }, '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å (–î–µ–º–æ)');
        }


        // --- INITIALIZATION ---
        function init() {
            document.getElementById('loading-overlay').style.display = 'none';
            document.body.classList.remove('opacity-0');
            
            initTheme();
            updateAuthUI();
            updateBalanceUI();
            handleRouting();
            setupEventListeners();
        }

        function initTheme() { 
            const btn = document.getElementById('theme-toggle'); 
            const apply = t => { 
                document.documentElement.classList.toggle('dark', t === 'dark'); 
                btn.innerHTML = t === 'dark' ? '‚òÄÔ∏è' : 'üåô';
            }; 
            apply(localStorage.getItem('color-theme') || 'dark'); 
            btn.onclick = () => {
                const n = document.documentElement.classList.contains('dark') ? 'light' : 'dark'; 
                localStorage.setItem('color-theme', n); 
                apply(n);
            };
        }

        function updateAuthUI() {
            const c = document.getElementById('auth-container'); 
            c.innerHTML = `<div class="relative">
                <button id="profile-btn" class="flex items-center gap-2 p-1 pr-2 rounded-full hover:bg-black/10 dark:hover:bg-white/10">
                    <img src="${currentUser.photoURL}" class="w-8 h-8 rounded-full object-cover">
                    <span class="hidden md:inline font-semibold">${currentUser.displayName}</span>
                </button>
                <div id="profile-menu" class="hidden absolute right-0 mt-2 w-60 card-bg rounded-md shadow-lg z-10 border border-custom">
                    ${isAdmin ? `<a href="#admin" class="nav-link block px-4 py-2 hover:bg-primary/10">–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</a>` : ''}
                    <a href="#" id="logout-btn" class="block px-4 py-2 text-red-500 hover:bg-red-500/10">–í—ã–π—Ç–∏ (–î–µ–º–æ)</a>
                </div>
            </div>`;
        }

        function updateBalanceUI() {
            const balanceAmountEl = document.getElementById('balance-amount');
            if (balanceAmountEl) balanceAmountEl.textContent = formatPrice(appState.balance);
        }
        
        function setupEventListeners() {
            window.addEventListener('hashchange', handleRouting);
            document.body.addEventListener('click', e => {
                const { target } = e;
                const closest = sel => target.closest(sel);

                if (closest('.nav-link')) { e.preventDefault(); window.location.hash = new URL(closest('.nav-link').href).hash; }
                if (closest('.admin-tab-btn')) { e.preventDefault(); window.location.hash = `admin/${closest('.admin-tab-btn').dataset.tab}`; }
                if (target.id === 'balance-btn') showModal('–ë–∞–ª–∞–Ω—Å (–î–µ–º–æ)', `<p>–í–∞—à —Ç–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å: <strong>${formatPrice(appState.balance)}</strong></p>`, showWithdrawModal, "–í—ã–≤–µ—Å—Ç–∏");
                if (closest('#profile-btn')) document.getElementById('profile-menu')?.classList.toggle('hidden');
                if (!closest('#profile-btn') && !closest('#profile-menu')) document.getElementById('profile-menu')?.classList.add('hidden');
            });
        }

        // --- LET'S GO ---
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
