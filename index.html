<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title id="site-title">Asonik | Store</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üõí</text></svg>" />
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<style>:root{--bg-light-start:#ede9fe;--bg-light-end:#f5f3ff;--text-light:#1e1b4b;--card-bg-light:#ffffff;--primary-light:#7c3aed;--primary-hover-light:#6d28d9;--border-light:#ddd6fe;--logo-text-light:#5b21b6;--nav-hover-bg-light:#e0e7ff;--nav-hover-text-light:#1e1b4b;--nav-active-bg-light:#7c3aed;--nav-active-text-light:#ffffff;--bg-dark-start:#1e1b4b;--bg-dark-end:#17133a;--text-dark:#e0e7ff;--card-bg-dark:#282454;--primary-dark:#a78bfa;--primary-hover-dark:#c4b5fd;--border-dark:#4338ca;--logo-text-dark:#c7d2fe;--nav-hover-bg-dark:#312e74;--nav-hover-text-dark:#e0e7ff;--nav-active-bg-dark:#a78bfa;--nav-active-text-dark:#1e1b4b}html.dark{--bg-start:var(--bg-dark-start);--bg-end:var(--bg-dark-end);--text:var(--text-dark);--card-bg:var(--card-bg-dark);--primary:var(--primary-dark);--primary-hover:var(--primary-hover-dark);--border:var(--border-dark);--logo-text:var(--logo-text-dark);--nav-hover-bg:var(--nav-hover-bg-dark);--nav-hover-text:var(--nav-hover-text-dark);--nav-active-bg:var(--nav-active-bg-dark);--nav-active-text:var(--nav-active-text-dark)}html:not(.dark){--bg-start:var(--bg-light-start);--bg-end:var(--bg-light-end);--text:var(--text-light);--card-bg:var(--card-bg-light);--primary:var(--primary-light);--primary-hover:var(--primary-hover-light);--border:var(--border-light);--logo-text:var(--logo-text-light);--nav-hover-bg:var(--nav-hover-bg-light);--nav-hover-text:var(--nav-hover-text-light);--nav-active-bg:var(--nav-active-bg-light);--nav-active-text:var(--nav-active-text-light)}body{font-family:'Manrope',sans-serif;background-image:linear-gradient(120deg,var(--bg-start),var(--bg-end));color:var(--text);transition:background-color .3s,color .3s}.logo-text{color:var(--logo-text)}.bg-primary{background-color:var(--primary)}.hover\:bg-primary-hover:hover{background-color:var(--primary-hover)}.text-primary{color:var(--primary)}.border-custom{border-color:var(--border)}.card-bg{background-color:var(--card-bg)}.input-bg{background-color:var(--card-bg);border-color:var(--border)}.modal-backdrop{background-color:rgba(0,0,0,.7)}[data-page]{display:none}[data-page].active{display:block}.main-nav-link:hover{background-color:var(--nav-hover-bg);color:var(--nav-hover-text) !important}.main-nav-link.active{background-color:var(--nav-active-bg);color:var(--nav-active-text) !important}.btn{display:inline-flex;align-items:center;justify-content:center;gap:.5rem;padding:.75rem 1.25rem;border-radius:.5rem;font-weight:600;transition:all .2s;cursor:pointer;border:none}.btn-primary{background-color:var(--primary);color:#fff}.btn-primary:hover{background-color:var(--primary-hover);transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,.15)}.modern-input{background-color:var(--card-bg);border:1px solid var(--border);border-radius:.5rem;padding:.75rem;transition:border-color .2s,box-shadow .2s}.modern-input:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px color-mix(in srgb,var(--primary) 25%,transparent)}#loading-overlay{position:fixed;inset:0;background-image:linear-gradient(120deg,var(--bg-start),var(--bg-end));z-index:100;display:flex;align-items:center;justify-content:center;transition:opacity .5s ease-out;opacity:1}.spinner{width:56px;height:56px;border-radius:50%;border:8px solid;border-color:var(--border);border-right-color:var(--primary);animation:spinner-d3wgkg 1s infinite linear}@keyframes spinner-d3wgkg{to{transform:rotate(1turn)}}.tooltip{position:relative;display:inline-flex;align-items:center}.tooltip .tooltiptext{visibility:hidden;width:220px;background-color:#333;color:#fff;text-align:center;border-radius:6px;padding:8px;position:absolute;z-index:1;bottom:140%;left:50%;margin-left:-110px;opacity:0;transition:opacity .3s;font-size:.8rem}.tooltip:hover .tooltiptext{visibility:visible;opacity:1}.status-badge{padding:.25rem .75rem;border-radius:9999px;font-size:.8rem;font-weight:600;display:inline-flex;align-items:center;gap:.3rem;color:#fff}.status-badge.pending{background-color:#f59e0b}.status-badge.completed,.status-badge.finished{background-color:#10b981}.status-badge.rejected,.status-badge.cancelled{background-color:#ef4444}.status-badge.processing{background-color:#3b82f6}#store-logo,.product-card-img,#main-product-image,#profile-avatar{object-fit:cover}.variation-option.selected,.payment-option.selected{border-color:var(--primary) !important;box-shadow:0 0 0 3px color-mix(in srgb,var(--primary) 40%,transparent);border-width:2px}.variation-option.disabled{opacity:.5;cursor:not-allowed;background-color:color-mix(in srgb,var(--card-bg) 50%,#888)}</style>
</head>
<body class="antialiased opacity-0 transition-opacity duration-500">
<div id="loading-overlay"><div class="spinner"></div></div>
<header class="sticky top-0 z-40"><div class="container mx-auto px-4"><div class="mt-4 card-bg shadow-lg rounded-xl border border-custom/50 flex justify-between items-center h-16 px-4"><a href="#main" class="flex items-center gap-3 text-2xl font-bold nav-link rounded-lg"><img id="store-logo" src="" alt="logo" class="h-8 w-8 rounded-full hidden"><span id="site-name-display" class="logo-text hidden sm:inline">Asonik | Store</span></a><nav class="hidden md:flex items-center space-x-2 bg-white/10 dark:bg-black/10 p-1 rounded-full"><a href="#main" class="main-nav-link nav-link flex items-center gap-2 px-3 py-1.5 rounded-full transition-colors" data-nav-key="main" data-lang-key="nav_main"></a><a href="#chats" class="main-nav-link nav-link flex items-center gap-2 px-3 py-1.5 rounded-full transition-colors" data-nav-key="chats" data-lang-key="nav_chats"></a><a href="#faq" class="main-nav-link nav-link flex items-center gap-2 px-3 py-1.5 rounded-full transition-colors" data-nav-key="faq" data-lang-key="nav_faq"></a><a href="#purchases" class="main-nav-link nav-link flex items-center gap-2 px-3 py-1.5 rounded-full transition-colors" data-nav-key="purchases" data-lang-key="nav_purchases"></a><a href="#download" class="main-nav-link nav-link flex items-center gap-2 px-3 py-1.5 rounded-full transition-colors" data-nav-key="download" data-lang-key="nav_download"></a></nav><div class="flex items-center space-x-1 sm:space-x-2"><button id="balance-btn" class="hidden btn bg-primary/10 hover:bg-primary/20 border border-custom/50"><svg class="h-5 w-5 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H4a3 3 0 00-3 3v8a3 3 0 003 3z"></path></svg><span id="balance-amount" class="font-semibold text-sm">0</span><svg class="w-4 h-4 opacity-70" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg></button><button id="theme-toggle" class="p-2 rounded-full hover:bg-black/10 dark:hover:bg-white/10"></button><a href="#cart" class="relative p-2 nav-link rounded-full"><svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path></svg><span id="cart-count" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full h-4 w-4 flex items-center justify-center hidden">0</span></a><div id="auth-container" class="relative"></div><button id="mobile-menu-btn" class="md:hidden p-2"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg></button></div></div></div></header>
<div id="mobile-menu" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 opacity-0"><div id="mobile-menu-panel" class="fixed top-0 right-0 h-full w-64 card-bg shadow-lg p-6 transform translate-x-full"><button id="mobile-menu-close-btn" class="absolute top-4 right-4 p-2 text-2xl">&times;</button><nav id="mobile-nav-links" class="flex flex-col space-y-6 text-xl mt-12 text-center"></nav></div></div>
<main class="container mx-auto px-4 py-8"><div data-page="main" class="active"><div id="main-page-content-wrapper"></div></div><div data-page="product"><div id="product-detail-content"></div></div><div data-page="chats"><div id="chats-content"></div></div><div data-page="faq"><div id="faq-content"></div></div><div data-page="purchases"><div id="purchases-content"></div></div><div data-page="wishlist"><div id="wishlist-content"></div></div><div data-page="admin"><div id="admin-content"></div></div><div data-page="cart"><div id="cart-content"></div></div><div data-page="profile"><div id="profile-content"></div></div><div data-page="download"><div id="download-content"></div></div><div data-page="settings"><div id="settings-content"></div></div></main>
<footer class="container mx-auto px-4 py-6 mt-8 border-t border-custom"><div id="social-links-container" class="flex justify-center items-center gap-6"></div></footer><div class="text-center text-sm text-gray-500 py-4">¬© <span id="footer-site-name">Asonik | Store</span> 2025</div>
<div id="modals-container"></div>
<script type="module">import {initializeApp} from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";import {getAuth,onAuthStateChanged,GoogleAuthProvider,signInWithPopup,signOut,updateProfile} from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";import {getFirestore,doc,getDoc,setDoc,addDoc,collection,getDocs,onSnapshot,updateDoc,deleteDoc,query,where,serverTimestamp,orderBy,increment,writeBatch,arrayUnion,arrayRemove,enableIndexedDbPersistence} from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";import {getStorage,ref,uploadBytes,getDownloadURL} from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";const firebaseConfig={apiKey:"AIzaSyDim7T4GqxZK4zM9tBDLkcGTSveVOaUbMY",authDomain:"asonikstore-v3.firebaseapp.com",projectId:"asonikstore-v3",storageBucket:"asonikstore-v3.appspot.com",messagingSenderId:"1018442222532",appId:"1:1018442222532:web:9b78f7be6c5c02bb327291"},IMGBB_API_KEY="96bf3f29606f1989bb5a450ad3770cce",ADMIN_UID="MrjXzJnZYbb6jb65B4f4aYDTVBt2",TELEGRAM_USERNAME="asonikofficial",app=initializeApp(firebaseConfig),auth=getAuth(app),db=getFirestore(app),storage=getStorage(app);enableIndexedDbPersistence(db).catch(e=>{"failed-precondition"==e.code?console.warn("Firestore persistence failed: Multiple tabs open."):"unimplemented"==e.code&&console.warn("Firestore persistence failed: Browser does not support it.")});let currentUser=null,isAdmin=!1,allProducts=[],paymentMethods=[],userWishlist=[],cart=JSON.parse(localStorage.getItem("asonik_cart"))||[];let allUsers=[],balanceHistoryFiltered=[];const appState={currency:localStorage.getItem("asonik_currency")||"UZS",lang:localStorage.getItem("asonik_lang")||"RU",rates:{UZS:1,RUB:.0073,USD:78e-6},balance:0,balanceHistory:[],guestPromptMessage:"–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫–æ –≤—Å–µ–º —Ñ—É–Ω–∫—Ü–∏—è–º.",minimumTopUpAmount:1e3},translations={RU:{nav_main:"–ì–ª–∞–≤–Ω–∞—è",nav_chats:"–ß–∞—Ç—ã",nav_faq:"FAQ",nav_purchases:"–ú–æ–∏ –ø–æ–∫—É–ø–∫–∏",nav_download:"–°–∫–∞—á–∞—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ",catalog_title:"–ö–∞—Ç–∞–ª–æ–≥ —Ç–æ–≤–∞—Ä–æ–≤",search_placeholder:"–ü–æ–∏—Å–∫...",faq_title:"–ß–∞—Å—Ç–æ –∑–∞–¥–∞–≤–∞–µ–º—ã–µ –≤–æ–ø—Ä–æ—Å—ã",purchases_title:"–ú–æ–∏ –ø–æ–∫—É–ø–∫–∏",cart_title:"–ö–æ—Ä–∑–∏–Ω–∞",profile_title:"–ü—Ä–æ—Ñ–∏–ª—å",buy_button:"–ö—É–ø–∏—Ç—å"},UZ:{nav_main:"Asosiy",nav_chats:"Chatlar",nav_faq:"FAQ",nav_purchases:"Xaridlarim",nav_download:"Ilovani yuklab olish",catalog_title:"Mahsulotlar",search_placeholder:"Qidirish...",faq_title:"Ko'p so'raladigan savollar",purchases_title:"Xaridlarim",cart_title:"Savatcha",profile_title:"Profil",buy_button:"Sotib olish"}},t=e=>translations[appState.lang]?.[e]||e,translatePage=()=>{document.querySelectorAll("[data-lang-key]").forEach(e=>e.textContent=t(e.dataset.langKey)),document.querySelectorAll("[data-lang-placeholder]").forEach(e=>e.placeholder=t(e.dataset.langPlaceholder))},formatPrice=(e,a=appState.currency)=>new Intl.NumberFormat("ru-RU",{style:"currency",currency:a,minimumFractionDigits:0}).format((e="number"!=typeof e?0:e)*(appState.rates[a]||1)),generateCode=()=>"A"+Math.random().toString(36).substring(2,9).toUpperCase(),showToast=(e,a=!1)=>{const o=document.createElement("div");o.className=`fixed bottom-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg z-50 ${a?"bg-red-500":"bg-green-500"}`,o.textContent=e,document.body.appendChild(o),setTimeout(()=>o.remove(),3e3)},showModal=(e,a,o,n="–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å")=>{const s=document.createElement("div");return s.className="fixed inset-0 z-50 flex items-center justify-center modal-backdrop",s.innerHTML=`<div class="card-bg rounded-lg shadow-xl w-11/12 md:w-2/3 lg:w-1/2 p-6 max-h-[90vh] overflow-y-auto"><div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-bold">${e}</h2><button class="close-modal-btn text-2xl">&times;</button></div><div>${a}</div>${o?`<div class="mt-6 flex justify-end gap-4"><button class="close-modal-btn btn">–û—Ç–º–µ–Ω–∞</button><button class="save-modal-btn btn btn-primary">${n}</button></div>`:""}</div>`,document.getElementById("modals-container").appendChild(s),s.querySelectorAll(".close-modal-btn").forEach(e=>e.onclick=()=>s.remove()),o&&(s.querySelector(".save-modal-btn").onclick=async()=>{!1!==await o(s)&&s.remove()}),s},confirmAction=(e,a)=>showModal("–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ",`<p>${e}</p>`,()=>{a(),!0},"–î–∞, —É–≤–µ—Ä–µ–Ω");function renderSocialLinks(e){const a=document.getElementById("social-links-container");a&&(a.innerHTML=(e||[]).map(e=>`<a href="${e.url}" target="_blank" class="text-gray-400 hover:text-primary"><svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">${e.icon}</svg></a>`).join(""))}async function loadStoreSettings(){try{const e=await getDoc(doc(db,"storeSettings","config"));if(e.exists()){const{logoUrl:a,socialLinks:o,appDownload:n,themeColors:s,siteName:r,adBanners:l,guestPromptMessage:c,minimumTopUpAmount:i,announcement:d}=e.data(),p=document.getElementById("store-logo");a?(p.src=a,p.classList.remove("hidden")):(p.classList.add("hidden"),a),r&&(document.title=r,document.getElementById("site-name-display").textContent=r,document.getElementById("footer-site-name").textContent=r),o&&renderSocialLinks(o),s&&applyCustomTheme(s),appState.appDownload=n||{},appState.adBanners=l||[],appState.guestPromptMessage=c||"–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫–æ –≤—Å–µ–º —Ñ—É–Ω–∫—Ü–∏—è–º.",appState.minimumTopUpAmount=i||1e3,appState.announcement=d||{}}}catch(e){console.error("Error loading store settings:",e)}}function loadPaymentMethods(){return new Promise((e,a)=>{onSnapshot(query(collection(db,"paymentMethods"),orderBy("order","asc")),a=>{paymentMethods=a.docs.map(e=>({id:e.id,...e.data()})),e()},(e=>{console.error(e),e()}))})}function handleRouting(){const e=window.location.hash||"#main";let[a,o]=(e.substring(1)||"main").split("/");document.querySelectorAll("[data-page]").forEach(e=>e.classList.remove("active"));const n=document.querySelector(`[data-page="${a}"]`);n?(n.classList.add("active"),loadPageContent(a,o)):(document.querySelector('[data-page="main"]')?.classList.add("active"),loadPageContent("main")),document.querySelectorAll(".main-nav-link").forEach(e=>{e.classList.remove("active"),e.dataset.navKey===a&&e.classList.add("active")}),translatePage()}function loadPageContent(e,a){const o=["purchases","chats","profile","admin","wishlist","settings"],n=document.querySelector(`[data-page="${e}"] > div`);if(n){if(o.includes(e)&&!currentUser)return void(n.innerHTML=`<h1 class="text-4xl font-bold text-center mb-8">${t(e+"_title")||"–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω"}</h1><p class="text-center">${appState.guestPromptMessage} <a href="#" id="login-redirect" class="text-primary underline">–í–æ–π—Ç–∏</a></p>`);switch(e){case"main":loadMainPage();break;case"product":loadProductDetailPage(a);break;case"faq":loadFaq();break;case"admin":loadAdminPanel(a||"users");break;case"cart":renderCartPage();break;case"chats":loadChatsPage(a);break;case"purchases":loadPurchasesPage();break;case"wishlist":loadWishlistPage();break;case"profile":loadProfilePage();break;case"download":loadDownloadPage();break;case"settings":loadSettingsPage();break;default:loadMainPage()}}else console.error(`Content container for page "${e}" not found.`)}function loadMainPage(){const e=document.getElementById("main-page-content-wrapper");if(e){const a=(appState.adBanners||[]).map(e=>e&&e.imageUrl&&e.linkUrl?`<a href="${e.linkUrl}" target="_blank" class="block mb-8 rounded-lg shadow-lg overflow-hidden"><img src="${e.imageUrl}" class="w-full object-cover"></a>`:"").join(""),o=appState.announcement,n=o&&o.enabled&&o.message?`<div class="p-4 mb-8 rounded-lg bg-primary/10 border border-primary text-primary">${o.message}</div>`:"";e.innerHTML=`${n}${a}
                <h1 class="text-4xl font-bold text-center mb-8" data-lang-key="catalog_title"></h1>
                <div class="mb-8 p-4 card-bg rounded-lg shadow-md flex flex-col md:flex-row items-center gap-4 border border-custom">
                    <input id="search-input" type="text" data-lang-placeholder="search_placeholder" class="w-full md:w-1/2 modern-input">
                    <select id="category-filter" class="w-full md:w-1/4 modern-input">
                        <option value="all">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
                        <option value="–∏–≥—Ä–∞">–ò–≥—Ä—ã</option>
                        <option value="–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ">–ü—Ä–∏–ª–æ–∂–µ–Ω–∏—è</option>
                        <option value="–¥—Ä—É–≥–æ–µ">–î—Ä—É–≥–æ–µ</option>
                    </select>
                    <select id="sort-select" class="w-full md:w-1/4 modern-input">
                        <option value="order">–ü–æ –ø–æ—Ä—è–¥–∫—É</option>
                        <option value="newest">–°–Ω–∞—á–∞–ª–∞ –Ω–æ–≤—ã–µ</option>
                        <option value="price_asc">–¶–µ–Ω–∞: –ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é</option>
                        <option value="price_desc">–¶–µ–Ω–∞: –ø–æ —É–±—ã–≤–∞–Ω–∏—é</option>
                        <option value="popular">–ü–æ–ø—É–ª—è—Ä–Ω—ã–µ</option>
                    </select>
                </div>
                <div id="products-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>`,document.getElementById("search-input").addEventListener("input",applyFiltersAndSort),document.getElementById("category-filter").addEventListener("change",applyFiltersAndSort),document.getElementById("sort-select").addEventListener("change",applyFiltersAndSort),loadProducts()}}function loadProducts(){onSnapshot(query(collection(db,"products")),e=>{allProducts=e.docs.map(e=>({id:e.id,...e.data()})),applyFiltersAndSort()})}function applyFiltersAndSort(){let e=[...allProducts];const a=document.getElementById("search-input");if(a){const o=a.value.toLowerCase();o&&(e=e.filter(e=>e.name.toLowerCase().includes(o)))}const o=document.getElementById("category-filter");if(o){const a=o.value;"all"!==a&&(e=e.filter(e=>e.category===a))}const n=document.getElementById("sort-select");if(n)switch(n.value){case"price_asc":e.sort((e,a)=>(e.price||0)-(a.price||0));break;case"price_desc":e.sort((e,a)=>(b.price||0)-(a.price||0));break;case"popular":e.sort((e,a)=>(b.purchaseCount||0)-(a.purchaseCount||0));break;case"newest":e.sort((e,a)=>(b.createdAt?.toMillis()||0)-(a.createdAt?.toMillis()||0));break;case"order":e.sort((e,a)=>(a.order||999)-(e.order||999));break;default:e.sort((e,a)=>(a.order||999)-(e.order||999))}e.sort((e,a)=>(a.isPinned?1:0)-(e.isPinned?1:0));const s=document.getElementById("products-grid");s&&(s.innerHTML=e.length?e.map(e=>renderProductCard(e)).join(""):`<p class="col-span-full text-center">–¢–æ–≤–∞—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.</p>`,translatePage())}function renderProductCard(e){let a;const o="–ù–∞ —ç—Ç–æ—Ç —Ç–æ–≤–∞—Ä —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω—è–µ—Ç—Å—è –≥–∞—Ä–∞–Ω—Ç–∏—è –æ—Ç –Ω–∞—à–µ–≥–æ –º–∞–≥–∞–∑–∏–Ω–∞.",n=`–¢–æ–≤–∞—Ä –≤—ã—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è –Ω–∞ –ø—Ä–æ–¥–∞–∂—É —Å—Ç–æ—Ä–æ–Ω–Ω–∏–º –ª–∏—Ü–æ–º. –ú–∞–≥–∞–∑–∏–Ω –≤—ã—Å—Ç—É–ø–∞–µ—Ç –≤ —Ä–æ–ª–∏ –ø–ª–æ—â–∞–¥–∫–∏ –∏ –Ω–µ –Ω–µ—Å–µ—Ç –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ –∑–∞ –¥–∞–Ω–Ω—ã–π —Ç–æ–≤–∞—Ä.`;a="official"===e.productStatus?`<div class="mt-2 text-sm text-green-600 flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>
                                <span>–ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–æ–≤–∞—Ä</span>
                                <div class="tooltip">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" /></svg>
                                    <span class="tooltiptext">${o}</span>
                                </div>
                              </div>`:`<div class="mt-2 text-sm text-orange-500 flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" /></svg>
                                <span>–ß–∞—Å—Ç–Ω–æ–µ –ª–∏—Ü–æ</span>
                                <div class="tooltip">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" /></svg>
                                    <span class="tooltiptext">${n}</span>
                                </div>
                              </div>`;const s=e.variations&&e.variations.length>0?`<a href="#product/${e.id}" class="nav-link flex-grow btn btn-primary text-center">–í—ã–±—Ä–∞—Ç—å –æ–ø—Ü–∏—é</a>`:`<button class="buy-now-btn flex-grow btn btn-primary" data-product-id="${e.id}" data-lang-key="buy_button"></button>`;return`<div class="card-bg rounded-lg shadow-lg flex flex-col justify-between border border-custom overflow-hidden transition-all duration-300 hover:shadow-2xl hover:-translate-y-1" data-product-id="${e.id}">
                <div class="relative">
                    <a href="#product/${e.id}" class="nav-link block">
                        <img src="${e.imageUrl||"https://placehold.co/600x400/7c3aed/ffffff?text=No+Image"}" class="w-full h-48 product-card-img">
                    </a>
                </div>
                <div class="p-4 flex-grow">
                    <h3 class="text-lg font-semibold truncate">${e.name}</h3>
                    <p class="text-gray-600 dark:text-gray-400 mt-1 text-sm h-10 overflow-hidden">${e.description}</p>
                    ${a}
                    <p class="text-2xl font-bold text-primary mt-2">${formatPrice(e.price||0)}</p>
                </div>
                <div class="p-4 pt-2 border-t border-custom flex items-center gap-2">
                     <button class="wishlist-btn p-2 rounded-md hover:bg-red-500/10 text-gray-500 hover:text-red-500" data-product-id="${e.id}" title="–í –∏–∑–±—Ä–∞–Ω–Ω–æ–µ">
                        <svg class="w-6 h-6 pointer-events-none" fill="${userWishlist.includes(e.id)?"currentColor":"none"}" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 016.364 0L12 7.636l1.318-1.318a4.5 4.5 0 016.364 6.364L12 20.364l-7.682-7.682a4.5 4.5 0 010-6.364z"></path></svg>
                    </button>
                    <button class="add-to-cart-btn p-2 rounded-md hover:bg-primary/10 text-gray-500 hover:text-primary" data-product-id="${e.id}" title="–í –∫–æ—Ä–∑–∏–Ω—É">
                        <svg class="w-6 h-6 pointer-events-none" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                    </button>
                    ${s}
                </div>
            </div>`}async function loadProductDetailPage(e){const a=document.getElementById("product-detail-content");if(!e)return void(a.innerHTML='<p class="text-center">–¢–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω.</p>');try{const o=await getDoc(doc(db,"products",e));if(!o.exists())return void(a.innerHTML='<p class="text-center">–¢–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω.</p>');const n={id:o.id,...o.data()};let s="";n.variations&&n.variations.length>0&&(s=`
                        <div class="mt-6">
                            <h3 class="text-xl font-semibold mb-4">–í—ã–±–µ—Ä–∏—Ç–µ –æ–ø—Ü–∏—é:</h3>
                            <div class="space-y-4">
                                ${n.variations.map((e,a)=>{const o=e.isOutOfStock?"disabled":"";return`<div class="variation-option p-4 border rounded-lg cursor-pointer transition-all ${o}" data-index="${a}">
                                        <div class="flex justify-between items-center">
                                            <div class="flex items-center gap-4">
                                                ${e.imageUrl?`<img src="${e.imageUrl}" class="w-16 h-16 rounded-md object-cover">`:""}
                                                <div>
                                                    <h4 class="font-bold text-lg">${e.name}</h4>
                                                    <p class="text-sm text-gray-500">${e.description||""}</p>
                                                </div>
                                            </div>
                                            <p class="text-xl font-bold text-primary">${formatPrice(e.price)}</p>
                                        </div>
                                    </div>`}).join("")}
                            </div>
                        </div>
                    `),a.innerHTML=`
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 lg:gap-12">
                        <div>
                            <img id="main-product-image" src="${n.imageUrl||"https://placehold.co/600x600"}" class="w-full rounded-lg shadow-lg">
                        </div>
                        <div>
                            <h1 id="main-product-name" class="text-4xl font-extrabold mb-2">${n.name}</h1>
                            <p id="main-product-price" class="text-3xl font-bold text-primary mb-4">${formatPrice(n.price)}</p>
                            <p id="main-product-desc" class="text-gray-600 dark:text-gray-400 mb-6">${n.description}</p>
                            ${s}
                            <div class="mt-8">
                                <button id="detail-buy-btn" class="w-full btn btn-primary text-lg">–ö—É–ø–∏—Ç—å</button>
                            </div>
                        </div>
                    </div>
                `;let r=null;n.variations&&n.variations.length>0&&(document.getElementById("main-product-price").classList.add("hidden"),a.querySelectorAll(".variation-option").forEach(e=>{e.addEventListener("click",()=>{e.classList.contains("disabled")||(a.querySelectorAll(".variation-option").forEach(e=>e.classList.remove("selected")),e.classList.add("selected"),r=n.variations[parseInt(e.dataset.index)],document.getElementById("main-product-name").textContent=`${n.name} - ${r.name}`,document.getElementById("main-product-price").textContent=formatPrice(r.price),document.getElementById("main-product-price").classList.remove("hidden"),r.imageUrl&&r.updateMainImage&&(document.getElementById("main-product-image").src=r.imageUrl),r.description&&(document.getElementById("main-product-desc").textContent=r.description))})})),document.getElementById("detail-buy-btn").addEventListener("click",()=>{n.variations&&n.variations.length>0?r?showCheckoutModal([{...n,...r,name:`${n.name} - ${r.name}`,id:n.id}],r.price):showToast("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –æ–ø—Ü–∏—é",!0):showCheckoutModal([n],n.price)})}catch(e){console.error("Error loading product detail:",e),a.innerHTML='<p class="text-center text-red-500">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–≤–∞—Ä–∞.</p>'}}async function showCheckoutModal(e,a){if(!currentUser)return void showModal("–í—Ö–æ–¥","<p>–î–ª—è –ø–æ–∫—É–ø–∫–∏ –≤–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç.</p>",()=>signInWithGoogle(),"–í–æ–π—Ç–∏");const o=await getDoc(doc(db,"users",currentUser.uid));if(o.exists()&&o.data().isBanned)return void showModal("–ê–∫–∫–∞—É–Ω—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω","<p>–í–∞—à –∞–∫–∫–∞—É–Ω—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º. –°–æ–≤–µ—Ä—à–µ–Ω–∏–µ –ø–æ–∫—É–ø–æ–∫ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ.</p>");if(appState.balance<0)return void showModal("–û—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å","<p>–£ –≤–∞—Å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø–æ–ª–Ω–∏—Ç–µ —Å—á–µ—Ç –ø–µ—Ä–µ–¥ —Å–æ–≤–µ—Ä—à–µ–Ω–∏–µ–º –ø–æ–∫—É–ø–æ–∫.</p>");if(!e.length)return void showToast("–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞",!0);let n=a,s=null;const r=n-appState.balance;let l="";appState.balance>=n?l+='<button class="payment-option w-full p-4 border rounded-lg text-left" data-method="balance"><strong>–°–ø–∏—Å–∞—Ç—å —Å –±–∞–ª–∞–Ω—Å–∞</strong><br><span class="text-sm">–î–æ—Å—Ç—É–ø–Ω–æ: '+formatPrice(appState.balance)+"</span></button>":appState.balance>0&&(l+='<button class="payment-option w-full p-4 border rounded-lg text-left" data-method="topup"><strong>–ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –æ–ø–ª–∞—Ç–∞</strong><br><span class="text-sm">–°–ø–∏—Å–∞—Ç—å '+formatPrice(appState.balance)+" –∏ –ø–æ–ø–æ–ª–Ω–∏—Ç—å –Ω–∞ "+formatPrice(r)+"</span></button>"),l+='<button class="payment-option w-full p-4 border rounded-lg text-left" data-method="external"><strong>–û–ø–ª–∞—Ç–∏—Ç—å –Ω–∞–ø—Ä—è–º—É—é</strong><br><span class="text-sm">–ü–æ–ª–Ω–∞—è —Å—É–º–º–∞: '+formatPrice(n)+"</span></button>",l+='<button class="payment-option w-full p-4 border rounded-lg text-left" data-method="topup_custom"><strong>–ü–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å –∏ –æ–ø–ª–∞—Ç–∏—Ç—å</strong><br><span class="text-sm">–í—ã —Å–∞–º–∏ –≤—ã–±–∏—Ä–∞–µ—Ç–µ —Å—É–º–º—É –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è</span></button>';const c=async o=>{const r=o.querySelector("#promo-input").value.toUpperCase().trim();if(!r)return!1;const l=await getDoc(doc(db,"promocodes",r));return l.exists()?(()=>{const c=l.data(),i=e.map(e=>e.id),d=!c.productId||i.includes(c.productId);(c.uses||0)<c.limit&&d?(n=a*(1-c.discount/100),s={code:r,...c},o.querySelector("#total-price-display").textContent=formatPrice(n),showToast("–ü—Ä–æ–º–æ–∫–æ–¥ –ø—Ä–∏–º–µ–Ω–µ–Ω!")):showToast("–ü—Ä–æ–º–æ–∫–æ–¥ –Ω–µ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω –∏–ª–∏ –Ω–µ –ø—Ä–∏–º–µ–Ω–∏–º –∫ —ç—Ç–∏–º —Ç–æ–≤–∞—Ä–∞–º",!0)})():showToast("–ù–µ–≤–µ—Ä–Ω—ã–π –ø—Ä–æ–º–æ–∫–æ–¥",!0),!1},i=showModal("–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞",`<p>–¢–æ–≤–∞—Ä: <strong>${e.length>1?`${e.length} —Ç–æ–≤–∞—Ä–æ–≤`:e[0].name}</strong></p><p>–°—É–º–º–∞: <strong id="total-price-display">${formatPrice(n)}</strong></p>
                <div class="space-y-2 mt-4">${l}</div>
                <div class="mt-4 flex gap-2"><input id="promo-input" class="w-full modern-input" placeholder="–ü—Ä–æ–º–æ–∫–æ–¥..."><button id="apply-promo-btn" class="btn bg-gray-500 text-white">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button></div>`,c,"–ü—Ä–∏–º–µ–Ω–∏—Ç—å");i.querySelector(".save-modal-btn").classList.add("hidden"),i.querySelector("#apply-promo-btn").onclick=()=>c(i),i.querySelectorAll(".payment-option").forEach(o=>o.onclick=async()=>{const r=o.dataset.method;i.remove(),"balance"===r?await processBalancePurchase(e,n,s):"topup"===r?showBalanceTopUpPaymentModal(r,()=>showCheckoutModal(e,a)):"topup_custom"===r?showModal("–ü–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å",`<p>–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É, –Ω–∞ –∫–æ—Ç–æ—Ä—É—é —Ö–æ—Ç–∏—Ç–µ –ø–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å. –ï—Å–ª–∏ —Å—É–º–º–∞ –±—É–¥–µ—Ç –±–æ–ª—å—à–µ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ —Ç–æ–≤–∞—Ä–∞ (${formatPrice(n)}), –æ—Å—Ç–∞—Ç–æ–∫ –±—É–¥–µ—Ç –∑–∞—á–∏—Å–ª–µ–Ω –Ω–∞ –≤–∞—à —Å—á–µ—Ç.</p><input type="number" id="custom-topup-amount" class="w-full modern-input mt-2" placeholder="–°—É–º–º–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è">`,e=>{const a=parseFloat(e.querySelector("#custom-topup-amount").value);a>0?(e.remove(),showBalanceTopUpPaymentModal(a,()=>showCheckoutModal(items,total))):showToast("–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É",!0)},"–î–∞–ª–µ–µ"):await showExternalPaymentModal(e,n,s)})}async function processBalancePurchase(e,a,o){const n=writeBatch(db),s=doc(db,"users",currentUser.uid);n.update(s,{balance:increment(-a),balanceHistory:arrayUnion({type:"purchase",amount:-a,product:e[0].name,date:(new Date).toISOString()})});const r=doc(collection(db,"purchases"));n.set(r,{userId:currentUser.uid,userEmail:currentUser.email,orderId:generateCode(),items:e,productName:e.length>1?`${e.length} —Ç–æ–≤–∞—Ä–æ–≤`:e[0].name,status:"–í—ã–ø–æ–ª–Ω–µ–Ω",paymentMethod:"–ë–∞–ª–∞–Ω—Å",finalPrice:a,promoCode:o?.code||null,createdAt:serverTimestamp(),review:null}),e.forEach(e=>{const a=doc(db,"products",e.id);n.update(a,{purchaseCount:increment(1)})}),await n.commit(),e.length>1&&(cart=[],localStorage.setItem("asonik_cart","[]"),updateCartCount()),showToast("–ü–æ–∫—É–ø–∫–∞ —Å–æ–≤–µ—Ä—à–µ–Ω–∞!"),window.location.hash="#purchases"}async function showExternalPaymentModal(e,a,o){const n=paymentMethods.filter(e=>e.isEnabled&&"card"===e.type),s=paymentMethods.filter(e=>e.isEnabled&&"ewallet"===e.type);if(!n.length&&!s.length)return void showModal("–û—à–∏–±–∫–∞","<p>–°–ø–æ—Å–æ–±—ã –æ–ø–ª–∞—Ç—ã –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã.</p>");const r=async n=>{const s=n.querySelector(".payment-option.selected");if(!s)return showToast("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã.",!0),!1;const r=(await addDoc(collection(db,"purchases"),{userId:currentUser.uid,orderId:generateCode(),items:e,productName:e.length>1?`${e.length} —Ç–æ–≤–∞—Ä–æ–≤`:e[0].name,status:"–û–∂–∏–¥–∞–µ—Ç –æ–ø–ª–∞—Ç—ã",paymentMethodId:s.dataset.methodId,finalPrice:a,promoCode:o?.code||null,createdAt:serverTimestamp(),review:null})).id;return e.length>1&&(cart=[],localStorage.setItem("asonik_cart","[]"),updateCartCount()),window.location.hash="#purchases",showProofUploadModal(r),!0},l=showModal("–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–±",`<div class="space-y-4">${n.length?`<div><h3 class="font-bold mb-2 border-b pb-1">–ë–∞–Ω–∫–æ–≤—Å–∫–∏–µ –∫–∞—Ä—Ç—ã</h3><div class="grid grid-cols-2 gap-4">${n.map(e=>`<button data-method-id="${e.id}" class="payment-option flex flex-col items-center p-2 border-2 rounded-lg h-24 transition-all"><img src="${e.logoUrl}" class="h-12 object-contain"><span class="text-sm">${e.name}</span></button>`).join("")}</div></div>`:""}${s.length?`<div><h3 class="font-bold mb-2 border-b pb-1">–≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã–µ –∫–æ—à–µ–ª—å–∫–∏</h3><div class="grid grid-cols-2 gap-4">${s.map(e=>`<button data-method-id="${e.id}" class="payment-option flex flex-col items-center p-2 border-2 rounded-lg h-24 transition-all"><img src="${e.logoUrl}" class="h-12 object-contain"><span class="text-sm">${e.name}</span></button>`).join("")}</div></div>`:""}</div>`,r,"–ö –æ–ø–ª–∞—Ç–µ");l.querySelectorAll(".payment-option").forEach(e=>e.onclick=()=>{l.querySelectorAll(".payment-option").forEach(e=>e.classList.remove("selected")),e.classList.add("selected")})}function loadPurchasesPage(){const e=document.getElementById("purchases-content");currentUser&&(e.innerHTML='<h1 class="text-4xl font-bold text-center mb-8" data-lang-key="purchases_title"></h1><div id="purchases-list" class="space-y-6"></div>',onSnapshot(query(collection(db,"purchases"),where("userId","==",currentUser.uid),orderBy("createdAt","desc")),e=>{const a=document.getElementById("purchases-list");a&&(a.innerHTML=e.docs.map(e=>renderPurchaseItem(e.id,e.data())).join("")||'<p class="text-center">–ó–¥–µ—Å—å –±—É–¥—É—Ç –≤–∞—à–∏ –ø–æ–∫—É–ø–∫–∏.</p>')}))}function renderPurchaseItem(e,a){const o={"–í—ã–ø–æ–ª–Ω–µ–Ω":{class:"completed",text:"–í—ã–ø–æ–ª–Ω–µ–Ω",icon:"M5 13l4 4L19 7"},"–ó–∞–≤–µ—Ä—à–µ–Ω":{class:"finished",text:"–ó–∞–≤–µ—Ä—à–µ–Ω",icon:"M5 13l4 4L19 7"},"–û–∂–∏–¥–∞–µ—Ç –æ–ø–ª–∞—Ç—ã":{class:"pending",text:"–û–∂–∏–¥–∞–µ—Ç –æ–ø–ª–∞—Ç—ã",icon:"M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"},"–û–∂–∏–¥–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è":{class:"pending",text:"–û–∂–∏–¥–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è",icon:"M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"},"–û—Ç–∫–ª–æ–Ω–µ–Ω":{class:"rejected",text:"–û—Ç–∫–ª–æ–Ω–µ–Ω",icon:"M6 18L18 6M6 6l12 12"},"–û—Ç–º–µ–Ω–µ–Ω":{class:"cancelled",text:"–û—Ç–º–µ–Ω–µ–Ω",icon:"M6 18L18 6M6 6l12 12"},"–í –æ–±—Ä–∞–±–æ—Ç–∫–µ":{class:"processing",text:"–í –æ–±—Ä–∞–±–æ—Ç–∫–µ",icon:"M4 4v5h5"}},n=o[a.status]||{class:"pending",text:a.status,icon:"M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"};let s="";return"–û–∂–∏–¥–∞–µ—Ç –æ–ø–ª–∞—Ç—ã"===a.status&&(s+=`<button class="upload-proof-btn btn btn-primary text-sm" data-id="${e}">–ó–∞–≥—Ä—É–∑–∏—Ç—å —á–µ–∫</button><button class="cancel-purchase-btn btn btn-danger text-sm ml-2" data-id="${e}">–û—Ç–º–µ–Ω–∏—Ç—å</button>`),"–í—ã–ø–æ–ª–Ω–µ–Ω"===a.status&&!a.isTopUp&&(s+=`<button class="get-item-btn btn btn-primary text-sm ml-2" data-purchase-id="${e}">–ü–æ–ª—É—á–∏—Ç—å —Ç–æ–≤–∞—Ä</button>`),"–ó–∞–≤–µ—Ä—à–µ–Ω"===a.status&&!a.isTopUp&&!a.review&&(s+=`<button class="leave-review-btn btn btn-primary text-sm ml-2" data-id="${e}" data-product-id="${a.items[0].id}">–û—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤</button>`),`<div class="card-bg p-4 sm:p-6 rounded-lg border border-custom flex flex-col sm:flex-row gap-4 items-start shadow-md">
                <img src="${a.items[0].imageUrl||"https://placehold.co/128x128"}" class="w-full sm:w-32 h-32 sm:h-auto flex-shrink-0 object-cover rounded-md">
                <div class="flex-grow">
                    <div class="flex justify-between items-start">
                        <h3 class="font-bold text-lg">${a.productName}</h3>
                        <span class="status-badge ${n.class}"><svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${n.icon}"></path></svg>${n.text}</span>
                    </div>
                    <p class="text-sm text-gray-500">–ö–æ–¥ –∑–∞–∫–∞–∑–∞: ${a.orderId}</p>
                    <p class="text-sm text-gray-500">–î–∞—Ç–∞: ${a.createdAt?new Date(1e3*a.createdAt.seconds).toLocaleString():"N/A"}</p>
                    <p class="text-lg font-semibold mt-1">–°—É–º–º–∞: ${formatPrice(a.finalPrice)}</p>
                    ${a.fulfillmentData?`<p class="mt-2 p-2 rounded-md bg-blue-500/10 text-blue-700 dark:text-blue-300 text-sm"><strong>–ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:</strong> ${a.fulfillmentData}</p>`:""}
                    ${a.rejectionReason?`<p class="mt-2 p-2 rounded-md bg-red-500/10 text-red-700 dark:text-red-300 text-sm"><strong>–ü—Ä–∏—á–∏–Ω–∞ –æ—Ç–∫–∞–∑–∞:</strong> ${a.rejectionReason}</p>`:""}
                    <div class="mt-4 flex gap-2">${s}</div>
                </div>
            </div>`}function showContactModal(e){const a=`<p>–î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–≤—è–∂–∏—Ç–µ—Å—å —Å –Ω–∞–º–∏ –≤ Telegram –∏ —Å–æ–æ–±—â–∏—Ç–µ —ç—Ç–æ—Ç –∫–æ–¥ –∑–∞–∫–∞–∑–∞:</p>
            <div class="my-4 relative text-center font-mono p-2 bg-gray-200 dark:bg-gray-700 rounded-md text-lg">
                <span id="order-code-to-copy">${e}</span>
                <button id="copy-code-btn" class="absolute top-1/2 right-2 -translate-y-1/2 p-1 hover:bg-gray-300 dark:hover:bg-gray-600 rounded-md">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M7 3a1 1 0 000 2h6a1 1 0 100-2H7zM4 7a1 1 0 011-1h10a1 1 0 110 2H5a1 1 0 01-1-1zM5 11a1 1 0 100 2h4a1 1 0 100-2H5z"></path></svg>
                </button>
            </div>`,o=showModal("–°–≤—è–∑—å —Å –ø—Ä–æ–¥–∞–≤—Ü–æ–º",a,()=>(window.open(`https://t.me/${TELEGRAM_USERNAME}?text=–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ, –º–æ–π –∑–∞–∫–∞–∑ ${e}`,"_blank"),!0),"–ü–µ—Ä–µ–π—Ç–∏ –≤ Telegram");o.querySelector("#copy-code-btn").onclick=()=>{navigator.clipboard.writeText(e),showToast("–ö–æ–¥ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!")}}function showBalanceModal(){const e=async a=>{const o=parseFloat(a.querySelector("#topup-amount").value);return o&&o>0?o<appState.minimumTopUpAmount?(showToast(`–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è: ${formatPrice(appState.minimumTopUpAmount)}`,!0),!1):(a.remove(),showBalanceTopUpPaymentModal(o),!1):(showToast("–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É",!0),!1)},a=`
                <div class="text-center mb-6">
                    <p class="text-gray-400">–¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å</p>
                    <p id="modal-balance-display" class="text-4xl font-bold">${formatPrice(appState.balance)}</p>
                </div>
                <div class="flex gap-2">
                    <input id="topup-amount" type="number" class="w-full modern-input" placeholder="–°—É–º–º–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è (UZS)">
                    <button id="topup-btn" class="btn btn-primary">–ü–æ–ø–æ–ª–Ω–∏—Ç—å</button>
                    <button id="withdraw-btn" class="btn bg-red-600 text-white">–í—ã–≤–µ—Å—Ç–∏</button>
                </div>
                <hr class="border-custom my-6">
                <div>
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-semibold text-lg">–ò—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π</h3>
                        <input id="history-filter" class="modern-input text-sm w-1/2" placeholder="–§–∏–ª—å—Ç—Ä (–ø–æ–∫—É–ø–∫–∞, –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ...)">
                    </div>
                    <ul id="balance-history-list" class="space-y-2 max-h-60 overflow-y-auto pr-2"></ul>
                </div>`,o=showModal("–ë–∞–ª–∞–Ω—Å",a,null);document.getElementById("topup-btn").onclick=()=>e(o),document.getElementById("withdraw-btn").onclick=showWithdrawModal,document.getElementById("history-filter").oninput=e=>{const a=e.target.value.toLowerCase();balanceHistoryFiltered=appState.balanceHistory.filter(e=>getBalanceHistoryText(e).toLowerCase().includes(a)),document.getElementById("balance-history-list").innerHTML=renderBalanceHistory(balanceHistoryFiltered)},onSnapshot(doc(db,"users",currentUser.uid),e=>{const a=document.getElementById("modal-balance-display");if(a){const o=e.data();appState.balance=o.balance||0,appState.balanceHistory=(o.balanceHistory||[]).sort((e,a)=>new Date(a.date)-new Date(e.date)),a.textContent=formatPrice(appState.balance),document.getElementById("balance-history-list").innerHTML=renderBalanceHistory(appState.balanceHistory)}})}function getBalanceHistoryText(e)
{return"topup"===e.type?"–ê–¥–º–∏–Ω"===e.reason?"–ù–∞—á–∏—Å–ª–µ–Ω–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏–µ–π":`–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ (${e.method||"..."})`:"purchase"===e.type?`–ü–æ–∫—É–ø–∫–∞: ${e.product}`:"deduction"===e.type?"–ê–¥–º–∏–Ω"===e.reason?"–°–Ω—è—Ç–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏–µ–π":"–°–ø–∏—Å–∞–Ω–∏–µ":e.type}function renderBalanceHistory(e){if(!e.length)return'<p class="text-center text-gray-500">–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞.</p>';let a="";return e.map(e=>{let o="";"purchase"===e.type&&(o=`<button class="go-to-purchase-btn text-xs text-primary underline" data-product-name="${e.product}">–ö –ø–æ–∫—É–ø–∫–µ</button>`);const n=getBalanceHistoryText(e);return`<li class="flex justify-between items-center p-3 rounded-lg ${e.amount>0?"bg-green-500/10":"bg-red-500/10"}">
                    <div>
                        <span class="font-medium">${n}</span>
                        <div class="flex items-center gap-2">
                           <p class="text-xs text-gray-400">${new Date(e.date).toLocaleString()}</p>
                           ${o}
                        </div>
                    </div>
                    <span class="${e.amount>0?"text-green-500":"text-red-500"} font-semibold text-lg">${formatPrice(e.amount)}</span>
                </li>`}).join("")}function showWithdrawModal(){const e=async e=>(showToast("–§—É–Ω–∫—Ü–∏—è –≤—ã–≤–æ–¥–∞ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ",!0),!1),a=`
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm">–°—É–º–º–∞ –≤—ã–≤–æ–¥–∞ (UZS)</label>
                        <input type="number" class="w-full modern-input" placeholder="0">
                    </div>
                    <div>
                        <label class="block text-sm">–ù–æ–º–µ—Ä –∫–∞—Ä—Ç—ã</label>
                        <input type="text" class="w-full modern-input" placeholder="8600 0000 0000 0000">
                    </div>
                    <div>
                        <label class="block text-sm">–ü–ª–∞—Ç–µ–∂–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞</label>
                        <select class="w-full modern-input">
                            <option>HUMO</option>
                            <option>UzCard</option>
                            <option>Visa</option>
                        </select>
                    </div>
                </div>
            `;showModal("–í—ã–≤–æ–¥ —Å—Ä–µ–¥—Å—Ç–≤",a,e,"–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É")}async function showBalanceTopUpPaymentModal(e,a){const o=paymentMethods.filter(e=>e.isEnabled);if(o.length){const n=async o=>{const n=o.querySelector(".payment-option.selected");if(!n)return showToast("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã.",!0),!1;const s=(await addDoc(collection(db,"purchases"),{userId:currentUser.uid,userEmail:currentUser.email,orderId:generateCode(),items:[{name:`–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –Ω–∞ ${formatPrice(e)}`,imageUrl:""}],productName:"–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞",status:"–û–∂–∏–¥–∞–µ—Ç –æ–ø–ª–∞—Ç—ã",paymentMethodId:n.dataset.methodId,finalPrice:e,createdAt:serverTimestamp(),isTopUp:!0})).id;return window.location.hash="#purchases",showProofUploadModal(s),a&&a(),!0},s=showModal(`–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –Ω–∞ ${formatPrice(e)}`,`<div class="grid grid-cols-2 gap-4">${o.map(e=>`<button data-method-id="${e.id}" class="payment-option flex flex-col items-center p-2 border-2 rounded-lg h-24 transition-all"><img src="${e.logoUrl}" class="h-12 object-contain"><span class="text-sm">${e.name}</span></button>`).join("")}</div>`,n,"–ö –æ–ø–ª–∞—Ç–µ");s.querySelectorAll(".payment-option").forEach(e=>e.onclick=()=>{s.querySelectorAll(".payment-option").forEach(e=>e.classList.remove("selected")),e.classList.add("selected")})}}async function loadAdminPanel(e){if(isAdmin){const a=document.getElementById("admin-content"),o=[{id:"users",name:"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏",icon:'<svg class="w-5 h-5" viewBox="0 0 20 20" fill="currentColor"><path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z" /></svg>'},{id:"products",name:"–¢–æ–≤–∞—Ä—ã",icon:'<svg class="w-5 h-5" viewBox="0 0 20 20" fill="currentColor"><path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v2a2 2 0 01-2 2H7a2 2 0 01-2-2V4zM5 12a2 2 0 012-2h6a2 2 0 012 2v2a2 2 0 01-2 2H7a2 2 0 01-2-2v-2z" /></svg>'},{id:"purchases",name:"–ü–æ–∫—É–ø–∫–∏",icon:'<svg class="w-5 h-5" viewBox="0 0 20 20" fill="currentColor"><path d="M3 1a1 1 0 000 2h1.22l.305 1.222a.997.997 0 00.01.042l1.358 5.43-.893.892C3.74 11.846 4.632 14 6.414 14H15a1 1 0 000-2H6.414l1-1H14a1 1 0 00.894-.553l3-6A1 1 0 0017 3H6.28l-.31-1.243A1 1 0 005 1H3zM16 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0zM6.5 18a1.5 1.5 0 100-3 1.5 1.5 0 000 3z" /></svg>'},{id:"reviews",name:"–û—Ç–∑—ã–≤—ã",icon:'<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" /></svg>'},{id:"payment",name:"–û–ø–ª–∞—Ç–∞",icon:'<svg class="w-5 h-5" viewBox="0 0 20 20" fill="currentColor"><path d="M4 4a2 2 0 00-2 2v1h16V6a2 2 0 00-2-2H4z" /><path fill-rule="evenodd" d="M18 9H2v5a2 2 0 002 2h12a2 2 0 002-2V9zM4 13a1 1 0 011-1h1a1 1 0 110 2H5a1 1 0 01-1-1zm5-1a1 1 0 100 2h1a1 1 0 100-2H9z" clip-rule="evenodd" /></svg>'},{id:"customization",name:"–ö–∞—Å—Ç–æ–º–∏–∑–∞—Ü–∏—è",icon:'<svg class="w-5 h-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-1.57 1.996A1.532 1.532 0 013.17 8.51c-1.56.38-1.56 2.6 0 2.98a1.532 1.532 0 01.948 2.286c-.836 1.372.734 2.942 1.996 1.57a1.532 1.532 0 012.286.948c.38 1.56 2.6 1.56 2.98 0a1.532 1.532 0 012.286-.948c1.372.836 2.942-.734 1.57-1.996A1.532 1.532 0 0116.83 11.49c1.56-.38 1.56-2.6 0-2.98a1.532 1.532 0 01-.948-2.286c.836-1.372-.734-2.942-1.996-1.57A1.532 1.532 0 0111.49 3.17zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd" /></svg>'},{id:"faq",name:"FAQ",icon:'<svg class="w-5 h-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" /></svg>'},{id:"promocodes",name:"–ü—Ä–æ–º–æ–∫–æ–¥—ã",icon:'<svg class="w-5 h-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M17.707 9.293a1 1 0 010 1.414l-7 7a1 1 0 01-1.414 0l-7-7A.997.997 0 012 10V5a3 3 0 013-3h5a3 3 0 013 3v2.586l4.707 4.707zM5 6a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" /></svg>'},{id:"chats",name:"–ß–∞—Ç—ã",icon:'<svg class="w-5 h-5" viewBox="0 0 20 20" fill="currentColor"><path d="M2 5a2 2 0 012-2h7a2 2 0 012 2v4a2 2 0 01-2 2H9l-3 3v-3H4a2 2 0 01-2-2V5z" /><path d="M15 7v2a4 4 0 01-4 4H9.828l-1.766 1.767c.28.149.599.233.938.233h7a2 2 0 002-2v-4a2 2 0 00-2-2h-1.172a4 4 0 01-3.535-1.464L12 4.343V7z" /></svg>'},{id:"download",name:"–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ",icon:'<svg class="w-5 h-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg>'},{id:"announcement",name:"–û–±—ä—è–≤–ª–µ–Ω–∏—è",icon:'<svg class="w-5 h-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10 2a6 6 0 00-6 6v3.586l-1.707 1.707A1 1 0 003 15h14a1 1 0 00.707-1.707L16 11.586V8a6 6 0 00-6-6zM10 18a3 3 0 01-3-3h6a3 3 0 01-3 3z" /></svg>'}];a.innerHTML=`<h2 class="text-3xl font-bold mb-6">–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h2><nav class="admin-tabs flex flex-wrap border-b border-custom mb-6">${o.map(a=>`<a href="#admin/${a.id}" class="admin-tab-btn flex items-center gap-2 py-3 px-5 rounded-t-lg mr-2 mb-[-1px] bg-transparent font-semibold border border-transparent border-b-0 ${e===a.id?"active":""}" data-tab="${a.id}">${a.icon}<span>${a.name}</span></a>`).join("")}</nav><div id="admin-tab-content" class="card-bg p-6 rounded-lg min-h-[60vh] shadow-inner"></div>`,loadAdminTab(e)}}function loadAdminTab(e){const a=document.getElementById("admin-tab-content");a&&("users"===e?loadAdminUsers():"products"===e?loadAdminList("products","–¢–æ–≤–∞—Ä—ã",renderAdminProductItem,'<button id="add-product-btn" class="btn btn-primary">–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä</button>'):"faq"===e?loadAdminList("faq","FAQ",renderAdminFaqItem,'<button id="add-faq-btn" class="btn btn-primary">–î–æ–±–∞–≤–∏—Ç—å</button>'):"purchases"===e?loadAdminPurchases():"reviews"===e?loadAdminReviews():"payment"===e?loadAdminList("paymentMethods","–°–ø–æ—Å–æ–±—ã –æ–ø–ª–∞—Ç—ã",renderAdminPaymentItem,'<button id="add-payment-btn" class="btn btn-primary">–î–æ–±–∞–≤–∏—Ç—å</button>'):"promocodes"===e?loadAdminList("promocodes","–ü—Ä–æ–º–æ–∫–æ–¥—ã",renderAdminPromoItem,'<button id="add-promo-btn" class="btn btn-primary">–î–æ–±–∞–≤–∏—Ç—å</button>'):"customization"===e?loadCustomizationPage():"chats"===e?loadAdminChatsList(window.location.hash.split("/")[2]):"download"===e?loadAdminDownloadPage():"announcement"===e&&loadAdminAnnouncementPage())}function renderAdminPurchaseItem(e,a){let o="";return"–û–∂–∏–¥–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è"===a.status?o=`<button class="approve-purchase-btn bg-green-500 hover:bg-green-600 text-white px-3 py-1 text-sm rounded-md" data-id="${e}">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
                           <button class="reject-purchase-btn bg-red-500 hover:bg-red-600 text-white px-3 py-1 text-sm rounded-md ml-2" data-id="${e}">–û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>`:"–í—ã–ø–æ–ª–Ω–µ–Ω"===a.status&&!a.isTopUp?o=`<button class="finish-purchase-btn bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 text-sm rounded-md" data-id="${e}">–ó–∞–≤–µ—Ä—à–∏—Ç—å</button>`:"–í –æ–±—Ä–∞–±–æ—Ç–∫–µ"===a.status&&(o=`<button class="view-fulfillment-btn bg-indigo-500 hover:bg-indigo-600 text-white px-3 py-1 text-sm rounded-md" data-id="${e}">–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –¥–∞–Ω–Ω—ã–µ</button>`),`<div class="card-bg p-4 rounded-lg flex flex-col md:flex-row justify-between items-start md:items-center border border-custom gap-4">
                <img src="${a.items[0].imageUrl||"https://placehold.co/64x64"}" class="w-16 h-16 object-cover rounded-md flex-shrink-0">
                <div class="flex-grow">
                    <p class="font-bold">${a.productName}</p>
                    <p class="text-sm text-gray-400">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${a.userEmail||"N/A"}</p>
                    <p class="text-sm text-gray-400">–ö–æ–¥: ${a.orderId}</p>
                </div>
                <div class="flex-shrink-0">
                    <p class="font-semibold">${formatPrice(a.finalPrice)}</p>
                    <p class="text-sm text-center">${a.status}</p>
                </div>
                <div class="flex-shrink-0 flex items-center gap-2">
                    ${a.paymentProofUrl?`<a href="${a.paymentProofUrl}" target="_blank" class="text-blue-500 hover:underline text-sm">–ß–µ–∫</a>`:""}
                    ${o}
                </div>
            </div>`}async function showProductForm(e){let a={name:"",description:"",price:0,imageUrl:"",productStatus:"official",isPinned:!1,variations:[],category:"–¥—Ä—É–≥–æ–µ",order:Date.now()};if(e){const o=await getDoc(doc(db,"products",e));o.exists()&&(a={...a,...o.data(),id:o.id})}const o=async o=>{showToast("–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞...");const n=o.querySelector("#p-image-file").files[0];let s=a.imageUrl;n&&(s=await uploadImage(n));const r=[];for(const e of o.querySelectorAll(".variation-item")){const a=e.querySelector(".v-image").files[0];let o=e.dataset.imgurl||"";a&&(o=await uploadImage(a)),r.push({name:e.querySelector(".v-name").value,price:parseFloat(e.querySelector(".v-price").value),description:e.querySelector(".v-desc").value,imageUrl:o,updateMainImage:e.querySelector(".v-update-main-image").checked,fulfillmentPrompt:e.querySelector(".v-fulfillment-prompt").value,isAutomationEnabled:e.querySelector(".v-automation-enabled").checked,isOutOfStock:e.querySelector(".v-out-of-stock").checked})}const l={name:o.querySelector("#p-name").value,description:o.querySelector("#p-desc").value,price:parseFloat(o.querySelector("#p-price").value)||0,imageUrl:s,productStatus:o.querySelector('input[name="product-status"]:checked').value,isPinned:o.querySelector("#p-pinned").checked,variations:r,category:o.querySelector("#p-category").value,order:parseInt(o.querySelector("#p-order").value)||Date.now(),createdAt:a.createdAt||serverTimestamp(),updatedAt:serverTimestamp()};return e?await setDoc(doc(db,"products",e),l,{merge:!0}):await addDoc(collection(db,"products"),l),showToast("–¢–æ–≤–∞—Ä —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω!"),!0},n=`
                <div class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="p-name" class="block text-sm font-medium mb-1">–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞</label>
                            <input id="p-name" value="${a.name||""}" class="w-full modern-input" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, '–ò–≥—Ä–æ–≤–æ–π –∞–∫–∫–∞—É–Ω—Ç'">
                        </div>
                        <div>
                            <label for="p-category" class="block text-sm font-medium mb-1">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                            <select id="p-category" class="w-full modern-input">
                                <option value="–∏–≥—Ä–∞" ${"–∏–≥—Ä–∞"===a.category?"selected":""}>–ò–≥—Ä–∞</option>
                                <option value="–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ" ${"–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ"===a.category?"selected":""}>–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</option>
                                <option value="–¥—Ä—É–≥–æ–µ" ${"–¥—Ä—É–≥–æ–µ"===a.category?"selected":""}>–î—Ä—É–≥–æ–µ</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label for="p-desc" class="block text-sm font-medium mb-1">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                        <textarea id="p-desc" class="w-full modern-input" rows="4" placeholder="–ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞...">${a.description||""}</textarea>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="p-price" class="block text-sm font-medium mb-1">–ë–∞–∑–æ–≤–∞—è —Ü–µ–Ω–∞ (–≤ UZS)</label>
                            <input id="p-price" type="number" value="${a.price||0}" class="w-full modern-input" placeholder="0">
                        </div>
                        <div>
                            <label for="p-order" class="block text-sm font-medium mb-1">–ü–æ—Ä—è–¥–æ–∫ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏</label>
                            <input id="p-order" type="number" value="${a.order||""}" class="w-full modern-input" placeholder="–ß–µ–º –º–µ–Ω—å—à–µ, —Ç–µ–º –≤—ã—à–µ">
                        </div>
                    </div>
                    <div>
                        <label for="p-image-file" class="block text-sm font-medium mb-1">–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞</label>
                        <input type="file" id="p-image-file" class="w-full text-sm file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-primary/10 file:text-primary hover:file:bg-primary/20">
                        ${a.imageUrl?`<img src="${a.imageUrl}" class="mt-2 w-24 h-24 object-cover rounded-md">`:""}
                    </div>
                     <div>
                        <label class="block text-sm font-medium mb-2">–°—Ç–∞—Ç—É—Å —Ç–æ–≤–∞—Ä–∞</label>
                        <div class="flex gap-4">
                            <label class="flex items-center">
                                <input type="radio" name="product-status" value="official" ${"official"===a.productStatus?"checked":""} class="h-4 w-4 text-primary focus:ring-primary border-gray-300">
                                <span class="ml-2">–ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–æ–≤–∞—Ä</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="product-status" value="private" ${"private"===a.productStatus||!a.productStatus?"checked":""} class="h-4 w-4 text-primary focus:ring-primary border-gray-300">
                                <span class="ml-2">–ß–∞—Å—Ç–Ω—ã–π –ø—Ä–æ–¥–∞–≤–µ—Ü</span>
                            </label>
                        </div>
                    </div>
                    <div class="flex items-center">
                        <input type="checkbox" id="p-pinned" ${a.isPinned?"checked":""} class="h-4 w-4 rounded border-gray-300 text-primary focus:ring-primary">
                        <label for="p-pinned" class="ml-2 block text-sm">–ó–∞–∫—Ä–µ–ø–∏—Ç—å —Ç–æ–≤–∞—Ä (–±—É–¥–µ—Ç –ø–µ—Ä–≤—ã–º –≤ —Å–ø–∏—Å–∫–µ)</label>
                    </div>
                    <hr class="border-custom">
                    <h4 class="font-bold">–í–∞—Ä–∏–∞—Ü–∏–∏ —Ç–æ–≤–∞—Ä–∞</h4>
                    <div id="variations-container" class="space-y-4"></div>
                    <button type="button" id="add-variation-btn" class="mt-2 btn bg-gray-500 text-white text-sm">+ –î–æ–±–∞–≤–∏—Ç—å –≤–∞—Ä–∏–∞—Ü–∏—é</button>
                </div>`,s=showModal(e?"–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–≤–∞—Ä":"–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä",n,o,"–°–æ—Ö—Ä–∞–Ω–∏—Ç—å"),r=e=>{const a=document.createElement("div");a.className="variation-item border-2 p-4 rounded-lg space-y-3",a.dataset.imgurl=e.imageUrl||"",a.innerHTML=`
                    <input class="v-name w-full modern-input" value="${e.name||""}" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –≤–∞—Ä–∏–∞—Ü–∏–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 50 –≥–µ–º–æ–≤)">
                    <input type="number" class="v-price w-full modern-input" value="${e.price||0}" placeholder="–¶–µ–Ω–∞ –≤–∞—Ä–∏–∞—Ü–∏–∏">
                    <textarea class="v-desc w-full modern-input" placeholder="–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –≤–∞—Ä–∏–∞—Ü–∏–∏">${e.description||""}</textarea>
                    <input type="file" class="v-image text-xs w-full file:mr-2 file:py-1 file:px-2 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-primary/10 file:text-primary hover:file:bg-primary/20">
                    ${e.imageUrl?`<img src="${e.imageUrl}" class="mt-2 w-16 h-16 object-cover rounded-md">`:""}
                    <hr class="border-custom">
                    <div class="p-2 bg-primary/10 rounded-lg space-y-2">
                         <div class="flex items-center gap-2">
                            <input type="checkbox" class="v-automation-enabled h-4 w-4 rounded border-gray-300 text-primary" ${e.isAutomationEnabled?"checked":""}>
                            <label class="text-sm font-semibold">–í–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—é</label>
                        </div>
                        <input class="v-fulfillment-prompt w-full modern-input" value="${e.fulfillmentPrompt||""}" placeholder="–¢–µ–∫—Å—Ç –∑–∞–ø—Ä–æ—Å–∞ (–Ω–∞–ø—Ä. –í–≤–µ–¥–∏—Ç–µ –≤–∞—à ID)">
                    </div>
                     <hr class="border-custom">
                    <div class="flex items-center gap-2">
                        <input type="checkbox" class="v-update-main-image h-4 w-4 rounded border-gray-300 text-primary" ${e.updateMainImage?"checked":""}>
                        <label class="text-sm">–ú–µ–Ω—è—Ç—å –≥–ª–∞–≤–Ω–æ–µ —Ñ–æ—Ç–æ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ</label>
                    </div>
                     <div class="flex items-center gap-2">
                        <input type="checkbox" class="v-out-of-stock h-4 w-4 rounded border-gray-300 text-primary" ${e.isOutOfStock?"checked":""}>
                        <label class="text-sm">–ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏</label>
                    </div>

                    <div class="text-right"><button type="button" class="remove-variation-btn btn btn-danger px-3 py-1 text-sm">–£–¥–∞–ª–∏—Ç—å</button></div>
                `,s.querySelector("#variations-container").appendChild(a)};(a.variations||[]).forEach(r),s.querySelector("#add-variation-btn").onclick=()=>r(),s.onclick=e=>{e.target.classList.contains("remove-variation-btn")&&e.target.closest(".variation-item").remove()}}async function loadCustomizationPage(){const e=document.getElementById("admin-tab-content"),a=(await getDoc(doc(db,"storeSettings","config"))).data()||{};e.innerHTML=`<div class="space-y-8">
                <div>
                    <h3 class="text-xl font-bold mb-2">–û–±—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
                    <label class="block text-sm">–ù–∞–∑–≤–∞–Ω–∏–µ —Å–∞–π—Ç–∞</label>
                    <input id="site-name-input" class="w-full modern-input mt-1" value="${a.siteName||"Asonik | Store"}">
                    <label class="block text-sm mt-2">–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è (–≤ UZS)</label>
                    <input id="min-topup-input" type="number" class="w-full modern-input mt-1" value="${a.minimumTopUpAmount||1e3}">
                    <label class="block text-sm mt-2">–°–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –≥–æ—Å—Ç–µ–π</label>
                    <textarea id="guest-prompt-input" class="w-full modern-input mt-1" rows="3">${a.guestPromptMessage||""}</textarea>
                    <button id="save-general-settings-btn" class="btn btn-primary mt-2">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
                <hr class="border-custom">
                <div>
                     <div class="flex justify-between items-center mb-2">
                        <h3 class="text-xl font-bold">–†–µ–∫–ª–∞–º–Ω—ã–µ –±–∞–Ω–Ω–µ—Ä—ã</h3>
                        <button id="clear-banners-btn" class="btn bg-red-600 text-white text-sm">–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ</button>
                    </div>
                    <div id="banners-list" class="space-y-2"></div>
                    <button id="add-banner-btn" class="btn btn-primary mt-2">–î–æ–±–∞–≤–∏—Ç—å –±–∞–Ω–Ω–µ—Ä</button>
                </div>
                <hr class="border-custom">
                <div>
                    <h3 class="text-xl font-bold mb-2">–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ç–µ–º—ã</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="p-4 card-bg rounded-lg border border-custom">
                            <h4 class="font-semibold mb-2">–°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞</h4>
                            <label class="block text-sm">–û—Å–Ω–æ–≤–Ω–æ–π —Ü–≤–µ—Ç</label>
                            <input type="color" id="primary-light-picker" value="${a.themeColors?.primaryLight||"#673ab7"}">
                            <label class="block text-sm mt-2">–¶–≤–µ—Ç —Ñ–æ–Ω–∞</label>
                            <input type="color" id="bg-light-picker" value="${a.themeColors?.bgLight||"#f3e5f5"}">
                        </div>
                        <div class="p-4 card-bg rounded-lg border border-custom">
                            <h4 class="font-semibold mb-2">–¢–µ–º–Ω–∞—è —Ç–µ–º–∞</h4>
                            <label class="block text-sm">–û—Å–Ω–æ–≤–Ω–æ–π —Ü–≤–µ—Ç</label>
                            <input type="color" id="primary-dark-picker" value="${a.themeColors?.primaryDark||"#9575cd"}">
                            <label class="block text-sm mt-2">–¶–≤–µ—Ç —Ñ–æ–Ω–∞</label>
                            <input type="color" id="bg-dark-picker" value="${a.themeColors?.bgDark||"#1a102c"}">
                        </div>
                    </div>
                    <button id="save-theme-btn" class="btn btn-primary mt-4">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–µ–º—É</button>
                    <button id="reset-theme-btn" class="btn bg-gray-500 text-white mt-4 ml-2">–°–±—Ä–æ—Å–∏—Ç—å</button>
                </div>
                <hr class="border-custom">
                <div>
                    <h3 class="text-xl font-bold">–õ–æ–≥–æ—Ç–∏–ø</h3>
                    <input type="file" id="logo-upload-input" class="mt-2"><button id="save-logo-btn" class="btn btn-primary ml-2">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ª–æ–≥–æ</button>
                </div>
                <hr class="border-custom">
                <div>
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-xl font-bold">–°–æ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–µ—Ç–∏</h3>
                        <button id="clear-social-links-btn" class="btn bg-red-600 text-white text-sm">–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ</button>
                    </div>
                    <div id="social-links-admin" class="space-y-2 mt-2"></div>
                    <button id="add-social-link-btn" class="btn bg-green-500 text-white mt-2">–î–æ–±–∞–≤–∏—Ç—å —Å—Å—ã–ª–∫—É</button>
                </div>
            </div>`,renderAdminSocialLinks(a.socialLinks),renderAdminBanners(a.adBanners)}function applyCustomTheme(e){const a=document.documentElement;e.primaryLight&&a.style.setProperty("--primary-light",e.primaryLight),e.bgLight&&a.style.setProperty("--bg-light",e.bgLight),e.primaryDark&&a.style.setProperty("--primary-dark",e.primaryDark),e.bgDark&&a.style.setProperty("--bg-dark",e.bgDark)}function initTheme(){const e=document.getElementById("theme-toggle");if(e){const a=e=>{e.innerHTML="dark"===(e=>{document.documentElement.classList.contains("dark")?document.documentElement.classList.remove("dark"):document.documentElement.classList.add("dark")})?"‚òÄÔ∏è":"üåô"};a(localStorage.getItem("color-theme")||"light"),e.onclick=()=>{const e=document.documentElement.classList.contains("dark")?"light":"dark";localStorage.setItem("color-theme",e),a(e)}}}async function updateAuthUI(){const e=document.getElementById("auth-container");if(e)if(currentUser){const a=await getDoc(doc(db,"users",currentUser.uid)),o=a.data()||{};e.innerHTML=`
                    <div class="relative">
                        <button id="profile-btn" class="flex items-center gap-2 p-1 pr-2 rounded-full hover:bg-black/10 dark:hover:bg-white/10">
                            <img src="${currentUser.photoURL||"https://placehold.co/32x32"}" class="w-8 h-8 rounded-full object-cover">
                            <span class="hidden md:inline font-semibold">${o.nickname||currentUser.displayName}</span>
                            <svg class="w-4 h-4 opacity-70" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
                        </button>
                        <div id="profile-menu" class="hidden absolute right-0 mt-2 w-60 card-bg rounded-md shadow-lg z-10 border border-custom">
                            <div class="p-4 border-b border-custom">
                                <p class="font-bold truncate">${currentUser.displayName}</p>
                            </div>
                            <a href="#profile" class="nav-link block px-4 py-2 hover:bg-primary/10">–ü—Ä–æ—Ñ–∏–ª—å</a>
                            <a href="#settings" class="nav-link block px-4 py-2 hover:bg-primary/10">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</a>
                            ${isAdmin?`<a href="#admin" class="nav-link block px-4 py-2 hover:bg-primary/10">–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</a>`:""}
                            <a href="#" id="logout-btn" class="block px-4 py-2 text-red-500 hover:bg-red-500/10">–í—ã–π—Ç–∏</a>
                        </div>
                    </div>`}else e.innerHTML='<button id="google-login-btn" class="btn btn-primary">–í–æ–π—Ç–∏</button>'}function signInWithGoogle(){const e=new GoogleAuthProvider;signInWithPopup(auth,e).catch(e=>showToast("–û—à–∏–±–∫–∞: "+e.message,!0))}function setupEventListeners(){window.addEventListener("hashchange",handleRouting),document.body.addEventListener("click",async e=>{const{target:a}=e,o=e=>a.closest(e);"mobile-menu-btn"===a.id?(document.getElementById("mobile-menu").classList.remove("hidden"),setTimeout(()=>document.getElementById("mobile-menu").classList.remove("opacity-0"),10)):"mobile-menu-close-btn"===a.id||o("#mobile-menu-panel")||(document.getElementById("mobile-menu").classList.add("opacity-0"),setTimeout(()=>document.getElementById("mobile-menu").classList.add("hidden"),300)),o("#profile-btn")||o("#profile-menu")||document.getElementById("profile-menu")?.classList.add("hidden"),o("#notifications-btn")||o("#notifications-dropdown")||document.getElementById("notifications-dropdown")?.classList.add("hidden"),o(".nav-link")&&(e.preventDefault(),window.location.hash=(new URL(o(".nav-link").href)).hash),o(".admin-tab-btn")&&(e.preventDefault(),window.location.hash=`admin/${o(".admin-tab-btn").dataset.tab}`),"google-login-btn"===a.id||"login-redirect"===a.id?signInWithGoogle():"logout-btn"===a.id||"logout-btn-profile"===a.id?signOut(auth):"balance-btn"===a.id?showBalanceModal():o(".buy-now-btn")?(()=>{const e=allProducts.find(e=>e.id===o(".buy-now-btn").dataset.productId);e&&showCheckoutModal([e],e.price||0)})():o(".add-to-cart-btn")?addToCart(o(".add-to-cart-btn").dataset.productId):o(".remove-from-cart-btn")?(cart.splice(o(".remove-from-cart-btn").dataset.index,1),localStorage.setItem("asonik_cart",JSON.stringify(cart)),renderCartPage(),updateCartCount()):"checkout-cart-btn"===a.id?showCheckoutModal(cart,cart.reduce((e,a)=>e+(a.price||0),0)):o(".faq-question")?o(".faq-question").classList.toggle("open"):o(".get-item-btn")?(async()=>{const e=o(".get-item-btn").dataset.purchaseId,a=await getDoc(doc(db,"purchases",e));if(a.exists()){const e=a.data(),o=e.items[0];o.isAutomationEnabled&&o.fulfillmentPrompt?showFulfillmentModal(e,o.fulfillmentPrompt):showContactModal(e.orderId)}})():o(".cancel-purchase-btn")?confirmAction("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–º–µ–Ω–∏—Ç—å –∑–∞–∫–∞–∑?",async()=>await updateDoc(doc(db,"purchases",o(".cancel-purchase-btn").dataset.id),{status:"–û—Ç–º–µ–Ω–µ–Ω"})):o(".upload-proof-btn")?showProofUploadModal(o(".upload-proof-btn").dataset.id):o("#profile-btn")?(e.stopPropagation(),document.getElementById("profile-menu")?.classList.toggle("hidden")):o(".wishlist-btn")||o(".wishlist-remove-btn-icon")?(async()=>{if(!currentUser)return void showToast("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–ª—è—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ.");const e=o(".wishlist-btn")||o(".wishlist-remove-btn-icon"),a=e.dataset.productId,n=doc(db,"users",currentUser.uid);await updateDoc(n,{wishlist:userWishlist.includes(a)?arrayRemove(a):arrayUnion(a)})})():"add-product-btn"===a.id?showProductForm():"add-promo-btn"===a.id?showPromoForm():o(".edit-btn")?(()=>{const{id:e,type:a}=o(".edit-btn").dataset;"product"===a?showProductForm(e):"promocode"===a&&showPromoForm(e)})():o(".delete-btn")?confirmAction("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —ç–ª–µ–º–µ–Ω—Ç?",async()=>await deleteDoc(doc(db,o(".delete-btn").dataset.collection,o(".delete-btn").dataset.id))):o(".leave-review-btn")?showReviewForm(o(".leave-review-btn").dataset.id,o(".leave-review-btn").dataset.productId):o(".approve-purchase-btn")?(async()=>{const{id:e}=o(".approve-purchase-btn").dataset;await updateDoc(doc(db,"purchases",e),{status:"–í—ã–ø–æ–ª–Ω–µ–Ω"}),showToast("–ó–∞–∫–∞–∑ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω!")})():o(".view-fulfillment-btn")?(async()=>{const e=o(".view-fulfillment-btn").dataset.id,a=await getDoc(doc(db,"purchases",e));a.exists()&&showFulfillmentDataModal(e,a.data().fulfillmentData)})():o(".finish-purchase-btn")?(async()=>{const{id:e}=o(".finish-purchase-btn").dataset;await updateDoc(doc(db,"purchases",e),{status:"–ó–∞–≤–µ—Ä—à–µ–Ω"}),showToast("–ó–∞–∫–∞–∑ –∑–∞–≤–µ—Ä—à–µ–Ω!")})():o(".reject-purchase-btn")?(()=>{const e=o(".reject-purchase-btn").dataset.id;showModal("–£–∫–∞–∂–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –æ—Ç–∫–∞–∑–∞ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)",'<input id="rejection-reason" class="w-full modern-input" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, –Ω–µ–≤–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —á–µ–∫–∞">',async a=>{const o=a.querySelector("input").value;return await updateDoc(doc(db,"purchases",e),{status:"–û—Ç–∫–ª–æ–Ω–µ–Ω",rejectionReason:o||"–ü—Ä–∏—á–∏–Ω–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞"}),showToast("–ó–∞–∫–∞–∑ –æ—Ç–∫–ª–æ–Ω–µ–Ω."),!0},"–û—Ç–∫–ª–æ–Ω–∏—Ç—å")})():o(".ban-user-btn")?(async()=>{const e=o(".ban-user-btn").dataset.uid,a=doc(db,"users",e),n=(await getDoc(a)).data().isBanned||!1;confirmAction(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ ${n?"—Ä–∞–∑–±–∞–Ω–∏—Ç—å":"–∑–∞–±–∞–Ω–∏—Ç—å"} —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?`,async()=>{await updateDoc(a,{isBanned:!n}),showToast(`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${n?"—Ä–∞–∑–±–∞–Ω–µ–Ω":"–∑–∞–±–∞–Ω–µ–Ω"}`)})})():o(".add-balance-btn")||o(".remove-balance-btn")||o(".annul-balance-btn")?(()=>{const e=o("button"),a=e.dataset.uid,n=e.parentElement.querySelector(".user-balance-input");if(e.classList.contains("annul-balance-btn"))return void confirmAction("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ–±–Ω—É–ª–∏—Ç—å –±–∞–ª–∞–Ω—Å —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?",async()=>{const e=(await getDoc(doc(db,"users",a))).data().balance||0;await updateDoc(doc(db,"users",a),{balance:0,balanceHistory:arrayUnion({type:"deduction",amount:-e,date:(new Date).toISOString(),reason:"–ê–¥–º–∏–Ω (–û–±–Ω—É–ª–µ–Ω–∏–µ)"})}),showToast("–ë–∞–ª–∞–Ω—Å –æ–±–Ω—É–ª–µ–Ω")});const s=e.classList.contains("add-balance-btn"),r=parseFloat(n.value);isNaN(r)||r<=0?showToast("–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É",!0):confirmAction(`${s?"–î–æ–±–∞–≤–∏—Ç—å":"–°–Ω—è—Ç—å"} ${formatPrice(r)} —Å –±–∞–ª–∞–Ω—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?`,async()=>{await updateDoc(doc(db,"users",a),{balance:increment(s?r:-r),balanceHistory:arrayUnion({type:s?"topup":"deduction",amount:s?r:-r,date:(new Date).toISOString(),reason:"–ê–¥–º–∏–Ω"})}),showToast("–ë–∞–ª–∞–Ω—Å –∏–∑–º–µ–Ω–µ–Ω"),n.value=""})})():"save-theme-btn"===a.id?(async()=>{const e={primaryLight:document.getElementById("primary-light-picker").value,bgLight:document.getElementById("bg-light-picker").value,primaryDark:document.getElementById("primary-dark-picker").value,bgDark:document.getElementById("bg-dark-picker").value};await setDoc(doc(db,"storeSettings","config"),{themeColors:e},{merge:!0}),applyCustomTheme(e),showToast("–¢–µ–º–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!")})():"reset-theme-btn"===a.id?confirmAction("–°–±—Ä–æ—Å–∏—Ç—å —Ü–≤–µ—Ç–∞ —Ç–µ–º—ã –∫ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–º?",async()=>{const e={primaryLight:"#673ab7",bgLight:"#f3e5f5",primaryDark:"#9575cd",bgDark:"#1a102c"};await setDoc(doc(db,"storeSettings","config"),{themeColors:e},{merge:!0}),applyCustomTheme(e),loadCustomizationPage(),showToast("–¢–µ–º–∞ —Å–±—Ä–æ—à–µ–Ω–∞!")}):"save-general-settings-btn"===a.id?(async()=>{const e=document.getElementById("site-name-input").value,a=parseFloat(document.getElementById("min-topup-input").value),o=document.getElementById("guest-prompt-input").value;e&&a>0?(await setDoc(doc(db,"storeSettings","config"),{siteName:e,minimumTopUpAmount:a,guestPromptMessage:o},{merge:!0}),showToast("–û–±—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!"),loadStoreSettings(),updateAuthUI()):showToast("–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤–≤–µ–¥–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ",!0)})():"add-banner-btn"===a.id?showBannerForm():"clear-banners-btn"===a.id?confirmAction("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –≤—Å–µ –±–∞–Ω–Ω–µ—Ä—ã?",async()=>{await setDoc(doc(db,"storeSettings","config"),{adBanners:[]},{merge:!0}),showToast("–í—Å–µ –±–∞–Ω–Ω–µ—Ä—ã —É–¥–∞–ª–µ–Ω—ã"),loadCustomizationPage()}):o(".delete-banner-btn")?(async()=>{const e=o(".delete-banner-btn").dataset.index,a=(await getDoc(doc(db,"storeSettings","config"))).data()||{};let n=a.adBanners||[];n.splice(e,1),await setDoc(doc(db,"storeSettings","config"),{adBanners:n},{merge:!0}),showToast("–ë–∞–Ω–Ω–µ—Ä —É–¥–∞–ª–µ–Ω"),loadCustomizationPage()})():"add-social-link-btn"===a.id?showSocialLinkForm():"clear-social-links-btn"===a.id?confirmAction("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –≤—Å–µ —Å–æ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–µ—Ç–∏?",async()=>{await setDoc(doc(db,"storeSettings","config"),{socialLinks:[]},{merge:!0}),showToast("–í—Å–µ —Å–æ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–µ—Ç–∏ —É–¥–∞–ª–µ–Ω—ã"),loadCustomizationPage()}):o(".delete-social-link-btn")?(async()=>{const e=o(".delete-social-link-btn").dataset.id,a=(await getDoc(doc(db,"storeSettings","config"))).data()||{};let n=(a.socialLinks||[]).filter(a=>a.id!==e);await setDoc(doc(db,"storeSettings","config"),{socialLinks:n},{merge:!0}),showToast("–°—Å—ã–ª–∫–∞ —É–¥–∞–ª–µ–Ω–∞"),loadCustomizationPage()})():"save-announcement-btn"===a.id&&(async()=>{const e=document.getElementById("announcement-message").value,a=document.getElementById("announcement-enabled").checked;await setDoc(doc(db,"storeSettings","config"),{announcement:{message:e,enabled:a}},{merge:!0}),showToast("–û–±—ä—è–≤–ª–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ!"),appState.announcement={message:e,enabled:a}})})}function showFulfillmentDataModal(e,a){const o=`<p class="mb-2">–î–∞–Ω–Ω—ã–µ, –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç–æ–º:</p>
            <div class="p-4 bg-gray-200 dark:bg-gray-700 rounded-lg font-mono">${a}</div>`;showModal("–î–∞–Ω–Ω—ã–µ –∑–∞–∫–∞–∑–∞",o,async()=>(await updateDoc(doc(db,"purchases",e),{status:"–ó–∞–≤–µ—Ä—à–µ–Ω"}),showToast("–ó–∞–∫–∞–∑ –∑–∞–≤–µ—Ä—à–µ–Ω!"),!0),"–ó–∞–≤–µ—Ä—à–∏—Ç—å –∑–∞–∫–∞–∑")}function showFulfillmentModal(e,a){const o=async a=>{const o=a.querySelector("#fulfillment-input").value;return o.trim()?(await updateDoc(doc(db,"purchases",e),{status:"–í –æ–±—Ä–∞–±–æ—Ç–∫–µ",fulfillmentData:o}),showToast("–î–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É!"),!0):(showToast("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ",!0),!1)},n=`
                <p class="mb-4">${a}</p>
                <input id="fulfillment-input" class="w-full modern-input" placeholder="–í–∞—à–∏ –¥–∞–Ω–Ω—ã–µ...">
            `;showModal("–ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞",n,o,"–û—Ç–ø—Ä–∞–≤–∏—Ç—å")}async function showProofUploadModal(e){const a=doc(db,"purchases",e),o=await getDoc(a);if(!o.exists())return void showToast("–ó–∞–∫–∞–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω",!0);const n=o.data(),s=paymentMethods.find(e=>e.id===n.paymentMethodId);if(!s)return void showToast("–°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω",!0);let r=`<p class="my-2 p-2 bg-gray-200 dark:bg-gray-700 rounded font-mono">${s.requisites}</p>`;s.name.toLowerCase().includes("yoomoney")&&s.qrCodeUrl&&(r+=`<div class="mt-4 flex justify-center"><img src="${s.qrCodeUrl}" alt="YooMoney QR Code" class="w-48 h-48"></div>`);const l=async o=>{const s=o.querySelector("#proof-file-input"),r=s.files[0];if(!r)return showToast("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª",!0),!1;showToast("–ó–∞–≥—Ä—É–∑–∫–∞ —á–µ–∫–∞...");const l=await uploadImage(r);return l?(await updateDoc(a,{paymentProofUrl:l,status:"–û–∂–∏–¥–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è"}),showToast("–ß–µ–∫ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω!"),!0):(showToast("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è",!0),!1)},c=`
                <div>
                    <p>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–µ—Ä–µ–≤–µ–¥–∏—Ç–µ <strong>${formatPrice(n.finalPrice)}</strong> –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–µ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã:</p>
                    <p class="font-semibold">${s.name}</p>
                    ${r}
                    <p class="mt-4">–ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã, –∑–∞–≥—Ä—É–∑–∏—Ç–µ —á–µ–∫ (—Å–∫—Ä–∏–Ω—à–æ—Ç) –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é—â–∏–π –ø–µ—Ä–µ–≤–æ–¥.</p>
                    <input type="file" id="proof-file-input" class="w-full modern-input mt-2" accept="image/*">
                </div>
            `;showModal("–ó–∞–≥—Ä—É–∑–∫–∞ —á–µ–∫–∞",c,l,"–û—Ç–ø—Ä–∞–≤–∏—Ç—å —á–µ–∫")}function renderAdminPaymentItem(e,a){return`<div class="card-bg p-4 rounded flex justify-between items-center border border-custom"><div><img src="${a.logoUrl}" class="h-8 inline-block mr-4"><p class="inline-block">${a.name}</p></div><div class="flex items-center gap-4"><input type="checkbox" class="toggle-payment-btn" data-id="${e}" ${a.isEnabled?"checked":""}><button class="edit-btn" data-id="${e}" data-type="payment">–†–µ–¥.</button><button class="delete-btn text-red-500" data-collection="paymentMethods" data-id="${e}">–£–¥–ª.</button></div></div>`}function renderAdminSocialLinks(e){const a=document.getElementById("social-links-admin");a&&(a.innerHTML=(e||[]).map(e=>`<div class="flex items-center justify-between gap-2 p-2 card-bg rounded"><span>${e.name} (${e.url})</span><button class="delete-social-link-btn btn btn-danger text-sm" data-id="${e.id}">–£–¥–∞–ª–∏—Ç—å</button></div>`).join(""))}function renderAdminFaqItem(e,a){return`<div class="card-bg p-4 rounded flex justify-between items-center border border-custom"><div><p>${a.question}</p></div><div><button class="edit-btn text-blue-400 mr-4" data-id="${e}" data-type="faq">–†–µ–¥.</button><button class="delete-btn text-red-500" data-collection="faq" data-id="${e}">–£–¥–ª.</button></div></div>`}function renderAdminPromoItem(e,a){const o=a.productId?allProducts.find(e=>e.id===a.productId):null;return`<div class="card-bg p-4 rounded border border-custom">
                –ö–æ–¥: <strong>${a.code}</strong>, –°–∫–∏–¥–∫–∞: ${a.discount}%, –ò—Å–ø: ${a.uses||0}/${a.limit}, ${o?`–î–ª—è: <strong>${o.name}</strong>`:"–î–ª—è –≤—Å–µ—Ö —Ç–æ–≤–∞—Ä–æ–≤"}
                <div class="float-right">
                    <button class="edit-btn text-blue-400 mr-4" data-id="${e}" data-type="promocode">–†–µ–¥.</button>
                    <button class="delete-btn text-red-500" data-collection="promocodes" data-id="${e}">–£–¥–ª.</button>
                </div>
            </div>`}async function loadAdminDownloadPage(){const e=document.getElementById("admin-tab-content"),a=(await getDoc(doc(db,"storeSettings","config"))).data()?.appDownload||{};e.innerHTML=`<h3>–°—Ç—Ä–∞–Ω–∏—Ü–∞ "–°–∫–∞—á–∞—Ç—å"</h3><div class="max-w-xl space-y-4"><div><label>–û–ø–∏—Å–∞–Ω–∏–µ</label><textarea id="download-description" class="w-full p-2 border rounded input-bg">${a.description||""}</textarea></div><div><label>–°—Å—ã–ª–∫–∞ .exe</label><input id="download-exe-link" class="w-full p-2 border rounded" value="${a.exeLink||""}"></div><div><label>–°—Å—ã–ª–∫–∞ .apk</label><input id="download-apk-link" class="w-full p-2 border rounded" value="${a.apkLink||""}"></div><button id="save-download-settings-btn" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button></div>`}async function loadAdminAnnouncementPage(){const e=document.getElementById("admin-tab-content"),a=(await getDoc(doc(db,"storeSettings","config"))).data()||{},o=a.announcement||{message:"",enabled:!1};e.innerHTML=`<h3 class="text-2xl font-bold mb-4">–û–±—ä—è–≤–ª–µ–Ω–∏–µ –¥–ª—è –≤—Å–µ—Ö</h3><div class="space-y-4 max-w-xl"><div><label for="announcement-message" class="block text-sm font-medium mb-1">–¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è</label><textarea id="announcement-message" class="w-full modern-input" rows="4">${o.message}</textarea></div><div class="flex items-center"><input type="checkbox" id="announcement-enabled" ${o.enabled?"checked":""} class="h-4 w-4 rounded border-gray-300 text-primary focus:ring-primary"><label for="announcement-enabled" class="ml-2 block text-sm">–í–∫–ª—é—á–∏—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ</label></div><button id="save-announcement-btn" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button></div>`}function loadFaq(){const e=document.getElementById("faq-content");if(e){e.innerHTML='<div class="max-w-4xl mx-auto"><h1 class="text-4xl font-bold text-center mb-12" data-lang-key="faq_title"></h1><div id="faq-list" class="space-y-4"></div></div>';const a=document.getElementById("faq-list");onSnapshot(collection(db,"faq"),e=>{a.innerHTML=e.docs.map(e=>{const a=e.data();return`<div class="card-bg rounded-lg shadow border border-custom"><button class="faq-question w-full text-left p-6 font-bold flex justify-between items-center text-lg"><span>${a.question}</span><svg class="faq-icon w-6 h-6 text-primary" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg></button><div class="faq-answer"><p class="p-6 pt-0">${a.answer}</p></div></div>`}).join("")})}}async function loadProfilePage(){const e=document.getElementById("profile-content");if(e&&currentUser){const a=await getDoc(doc(db,"users",currentUser.uid)),o=a.data()||{},n=await getDocs(query(collection(db,"purchases"),where("userId","==",currentUser.uid),orderBy("createdAt","desc"))),s=n.docs.map(e=>renderPurchaseItem(e.id,e.data())).join("")||'<p class="text-center text-gray-500 mt-4">–£ –≤–∞—Å –µ—â–µ –Ω–µ—Ç –ø–æ–∫—É–ø–æ–∫.</p>';e.innerHTML=`
                <h1 class="text-4xl font-bold text-center mb-8" data-lang-key="profile_title"></h1>
                <div class="max-w-4xl mx-auto card-bg p-8 rounded-2xl shadow-lg space-y-8">
                    <div class="flex flex-col md:flex-row items-center gap-8">
                        <div class="flex flex-col items-center">
                            <img id="profile-avatar" src="${currentUser.photoURL||"https://placehold.co/128x128"}" class="w-32 h-32 rounded-full mb-4 shadow-md">
                            <input type="file" id="avatar-upload" class="hidden" accept="image/*">
                            <button id="change-avatar-btn" class="text-sm text-primary hover:underline">–°–º–µ–Ω–∏—Ç—å —Ñ–æ—Ç–æ</button>
                        </div>
                        <div class="flex-grow w-full space-y-4">
                             <div>
                                <label for="profile-firstname" class="block text-sm font-medium text-gray-400">–ò–º—è</label>
                                <input id="profile-firstname" class="w-full p-2 border-b-2 bg-transparent focus:outline-none focus:border-primary text-xl" value="${o.firstName||""}">
                            </div>
                             <div>
                                <label for="profile-lastname" class="block text-sm font-medium text-gray-400">–§–∞–º–∏–ª–∏—è</label>
                                <input id="profile-lastname" class="w-full p-2 border-b-2 bg-transparent focus:outline-none focus:border-primary text-xl" value="${o.lastName||""}">
                            </div>
                            <div>
                                <label for="profile-nickname" class="block text-sm font-medium text-gray-400">–ù–∏–∫–Ω–µ–π–º</label>
                                <input id="profile-nickname" class="w-full p-2 border-b-2 bg-transparent focus:outline-none focus:border-primary text-xl" value="${o.nickname||""}">
                            </div>
                        </div>
                    </div>
                    <div class="mt-8 flex gap-4">
                        <button id="save-profile-btn" class="flex-grow btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                        <button id="reset-profile-btn" class="btn bg-yellow-500 text-white">–°–±—Ä–æ—Å–∏—Ç—å</button>
                        <button id="logout-btn-profile" class="flex-grow btn btn-danger">–í—ã–π—Ç–∏</button>
                    </div>
                    <div>
                        <h2 class="text-2xl font-bold mt-12 mb-6 border-b pb-2">–ò—Å—Ç–æ—Ä–∏—è –ø–æ–∫—É–ø–æ–∫</h2>
                        <div class="space-y-6">${s}</div>
                    </div>
                </div>`,document.getElementById("change-avatar-btn").onclick=()=>document.getElementById("avatar-upload").click(),document.getElementById("avatar-upload").onchange=async e=>{const a=e.target.files[0];if(a){showToast("–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ...");const e=await uploadImage(a,`avatars/${currentUser.uid}`);e?(await updateProfile(auth.currentUser,{photoURL:e}),await updateDoc(doc(db,"users",currentUser.uid),{photoURL:e}),showToast("–ê–≤–∞—Ç–∞—Ä –æ–±–Ω–æ–≤–ª–µ–Ω!"),document.getElementById("profile-avatar").src=e,await updateAuthUI()):showToast("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ",!0)}},document.getElementById("save-profile-btn").onclick=async()=>{const e=document.getElementById("profile-firstname").value,a=document.getElementById("profile-lastname").value,o=document.getElementById("profile-nickname").value;await updateDoc(doc(db,"users",currentUser.uid),{firstName:e,lastName:a,nickname:o}),showToast("–ü—Ä–æ—Ñ–∏–ª—å –æ–±–Ω–æ–≤–ª–µ–Ω!"),updateAuthUI()},document.getElementById("reset-profile-btn").onclick=()=>{confirmAction("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–±—Ä–æ—Å–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å? –ò–º—è, —Ñ–∞–º–∏–ª–∏—è, –Ω–∏–∫–Ω–µ–π–º –∏ —Ñ–æ—Ç–æ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã.",async()=>{const e=`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å${currentUser.uid.substring(0,5)}`;await updateDoc(doc(db,"users",currentUser.uid),{firstName:"",lastName:"",nickname:e,photoURL:""}),await updateProfile(auth.currentUser,{photoURL:""}),showToast("–ü—Ä–æ—Ñ–∏–ª—å —Å–±—Ä–æ—à–µ–Ω!"),loadProfilePage()})}}}function loadDownloadPage(){const e=document.getElementById("download-content"),a=appState.appDownload||{};e.innerHTML=`<div class="max-w-xl mx-auto card-bg p-8 rounded-lg text-center"><h1 class="text-4xl font-bold mb-4" data-lang-key="download_title"></h1><p class="mb-6">${a.description||"–°—Å—ã–ª–∫–∏ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã"}</p><div class="flex flex-col gap-4">${a.exeLink?`<a href="${a.exeLink}" class="w-full btn btn-primary">Windows (.exe)</a>`:""}${a.apkLink?`<a href="${a.apkLink}" class="w-full btn btn-primary">Android (.apk)</a>`:""}</div></div>`,translatePage()}async function loadChatsPage(e){const a=document.getElementById("chats-content");if(a&&currentUser){if(isAdmin)return void loadAdminChatsList(e);const o=`${currentUser.uid}_${ADMIN_UID}`,n=doc(db,"userChats",currentUser.uid);await setDoc(n,{lastActivity:serverTimestamp(),partnerId:ADMIN_UID,partnerName:"–ü–æ–¥–¥–µ—Ä–∂–∫–∞",userName:currentUser.displayName,userId:currentUser.uid},{merge:!0}),a.innerHTML='<h1 class="text-4xl font-bold text-center mb-8" data-lang-key="nav_chats"></h1>',renderChatInterface(a,o,"–ß–∞—Ç —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π",currentUser.uid)}}function loadWishlistPage(){const e=document.getElementById("wishlist-content"),a=allProducts.filter(e=>userWishlist.includes(e.id));e.innerHTML=`<h1 class="text-4xl font-bold text-center mb-8">–ò–∑–±—Ä–∞–Ω–Ω–æ–µ</h1>${a.length?`<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">${a.map(e=>`<div class="relative group">
                                ${renderProductCard(e)}
                            </div>`).join("")}</div>`:'<p class="text-center">–ó–¥–µ—Å—å –±—É–¥—É—Ç —Ç–æ–≤–∞—Ä—ã, –∫–æ—Ç–æ—Ä—ã–µ –≤—ã –¥–æ–±–∞–≤–∏–ª–∏ –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ.</p>'}`}function addToCart(e){const a=allProducts.find(a=>a.id===e);a&&(cart.push({id:a.id,name:a.name,price:a.price,imageUrl:a.imageUrl}),localStorage.setItem("asonik_cart",JSON.stringify(cart)),updateCartCount(),showToast("–î–æ–±–∞–≤–ª–µ–Ω–æ –≤ –∫–æ—Ä–∑–∏–Ω—É"))}function updateCartCount(){const e=document.getElementById("cart-count");e&&(e.textContent=cart.length,e.classList.toggle("hidden",0===cart.length))}function renderCartPage(){const e=document.getElementById("cart-content");if(e.innerHTML='<h1 class="text-4xl font-bold text-center mb-8" data-lang-key="cart_title"></h1>',0===cart.length)return void(e.innerHTML+='<p class="text-center">–í–∞—à–∞ –∫–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞.</p>');let a=cart.reduce((e,a)=>e+(a.price||0),0);e.innerHTML+=`<div class="space-y-4">${cart.map((e,a)=>`<div class="card-bg p-4 rounded-lg flex justify-between items-center"><div class="flex items-center gap-4"><img src="${e.imageUrl||""}" class="w-16 h-16 rounded object-cover"><p>${e.name}</p></div><div class="flex items-center gap-4"><span>${formatPrice(e.price)}</span><button class="remove-from-cart-btn text-red-500 font-bold text-xl" data-index="${a}">&times;</button></div></div>`).join("")}</div><div class="mt-6 pt-4 border-t border-custom flex justify-end items-center gap-4"><span class="text-2xl font-bold">–ò—Ç–æ–≥–æ: ${formatPrice(a)}</span><button id="checkout-cart-btn" class="btn btn-primary">–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</button></div>`}function loadAdminUsers(){const e=document.getElementById("admin-tab-content");if(e){e.innerHTML=`<h3 class="text-2xl font-bold mb-4">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h3>
                <div class="flex justify-between items-center mb-4">
                    <input id="user-search-input" class="modern-input w-1/2" placeholder="–ü–æ–∏—Å–∫ –ø–æ email –∏–ª–∏ –∏–º–µ–Ω–∏...">
                    <span id="user-stats" class="font-semibold"></span>
                </div>
                <div id="users-list" class="space-y-3 mt-4"></div>`;const a=document.getElementById("user-search-input");a.addEventListener("input",()=>renderUsersList(a.value)),onSnapshot(query(collection(db,"users")),e=>{allUsers=e.docs.map(e=>e.data()),renderUsersList()})}}function renderUsersList(e=""){const a=document.getElementById("users-list"),o=document.getElementById("user-stats");if(a&&o){const n=e.toLowerCase();let s=e?allUsers.filter(e=>e.displayName.toLowerCase().includes(n)||e.email.toLowerCase().includes(n)):allUsers;o.textContent=`–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: ${allUsers.length}`,a.innerHTML=s.map(e=>renderAdminUserItem(e)).join("")||"<p>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.</p>"}}function renderAdminUserItem(e){const a=e.isBanned||!1;return`<div class="card-bg p-4 rounded flex flex-col md:flex-row justify-between items-start md:items-center border border-custom gap-4"><div><p>${e.displayName} (${e.email})</p><p class="text-xs text-gray-400">UID: ${e.uid}</p><p>–ë–∞–ª–∞–Ω—Å: ${formatPrice(e.balance||0)}</p></div><div class="flex items-center gap-2 flex-wrap"><input type="number" class="user-balance-input w-24 p-2 rounded bg-transparent border" placeholder="–°—É–º–º–∞"><button class="add-balance-btn bg-green-500 text-white p-2 rounded-md" data-uid="${e.uid}">‚ûï</button><button class="remove-balance-btn bg-yellow-500 text-white p-2 rounded-md" data-uid="${e.uid}">‚ûñ</button><button class="annul-balance-btn bg-red-500 text-white p-2 rounded-md" data-uid="${e.uid}">–û–±–Ω—É–ª–∏—Ç—å</button><button class="ban-user-btn ${a?"bg-blue-500":"bg-red-700"} text-white p-2 rounded-md" data-uid="${e.uid}">${a?"–†–∞–∑–±–∞–Ω–∏—Ç—å":"–ó–∞–±–∞–Ω–∏—Ç—å"}</button></div></div>`}async function uploadImage(e,a="images"){const o=ref(storage,`${a}/${Date.now()}_${e.name}`);try{return await getDownloadURL((await uploadBytes(o,e)).ref)}catch(a){console.error("Firebase Storage Upload Error: ",a);const o=new FormData;o.append("image",e);try{const e=await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`,{method:"POST",body:o}),a=await e.json();if(a.success)return a.data.url;throw new Error(a.error.message)}catch(e){return alert("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: "+e.message),null}}}function loadAdminList(e,a,o,n){const s=document.getElementById("admin-tab-content");s&&(s.innerHTML=`<div class="flex justify-between items-center mb-6"><h3 class="text-2xl font-bold">${a}</h3><div>${n||""}</div></div><div id="admin-list-container" class="space-y-3"></div>`,onSnapshot(query(collection(db,e)),e=>{const a=document.getElementById("admin-list-container");a&&(a.innerHTML=e.docs.map(e=>o(e.id,e.data())).join("")||"<p>–ü—É—Å—Ç–æ</p>")}))}function loadAdminPurchases(){const e=document.getElementById("admin-tab-content");e&&(e.innerHTML='<h3 class="text-2xl font-bold">–ü–æ–∫—É–ø–∫–∏</h3><div id="admin-list-container" class="space-y-3 mt-4"></div>',onSnapshot(query(collection(db,"purchases"),orderBy("createdAt","desc")),e=>{const a=document.getElementById("admin-list-container");a&&(a.innerHTML=e.docs.map(e=>renderAdminPurchaseItem(e.id,e.data())).join(""))}))}function renderAdminProductItem(e,a){return`
            <div class="card-bg p-4 rounded flex justify-between items-center border border-custom">
                <div class="flex items-center gap-4">
                    <img src="${a.imageUrl||"https://placehold.co/64x64"}" class="w-16 h-16 object-cover rounded-md">
                    <p class="font-semibold">${a.name}</p>
                </div>
                <div class="flex items-center gap-2">
                    <button class="edit-btn btn bg-blue-500 text-white text-sm" data-id="${e}" data-type="product">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                        <span>–†–µ–¥.</span>
                    </button>
                    <button class="delete-btn btn btn-danger text-sm" data-collection="products" data-id="${e}">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        <span>–£–¥–∞–ª–∏—Ç—å</span>
                    </button>
                </div>
            </div>`}async function showPromoForm(e){let a={code:"",discount:0,limit:1,uses:0,productId:""};if(e){const o=await getDoc(doc(db,"promocodes",e));o.exists()&&(a={id:o.id,...o.data()})}const o=async o=>{const n={code:o.querySelector("#promo-code").value.toUpperCase(),discount:parseFloat(o.querySelector("#promo-discount").value),limit:parseInt(o.querySelector("#promo-limit").value),uses:a.uses,productId:o.querySelector("#promo-product").value||null};return n.code&&n.discount&&n.limit?(a.id?await setDoc(doc(db,"promocodes",a.id),n,{merge:!0}):await setDoc(doc(db,"promocodes",n.code),n),showToast("–ü—Ä–æ–º–æ–∫–æ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω!"),!0):(showToast("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è",!0),!1)},n=allProducts.map(e=>`<option value="${e.id}" ${a.productId===e.id?"selected":""}>${e.name}</option>`).join("");showModal(a.id?"–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥":"–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥",`<div class="space-y-4">
                <div><label>–ö–æ–¥</label><input id="promo-code" class="w-full modern-input" value="${a.code}" ${a.id?"readonly":""}></div>
                <div><label>–°–∫–∏–¥–∫–∞ (%)</label><input type="number" id="promo-discount" class="w-full modern-input" value="${a.discount}"></div>
                <div><label>–õ–∏–º–∏—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π</label><input type="number" id="promo-limit" class="w-full modern-input" value="${a.limit}"></div>
                <div><label>–ü—Ä–∏–º–µ–Ω–∏—Ç—å –∫ —Ç–æ–≤–∞—Ä—É (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label><select id="promo-product" class="w-full modern-input"><option value="">–î–ª—è –≤—Å–µ—Ö —Ç–æ–≤–∞—Ä–æ–≤</option>${n}</select></div>
            </div>`,o,"–°–æ—Ö—Ä–∞–Ω–∏—Ç—å")}function showBannerForm(){const e=async e=>{const a=e.querySelector("#banner-image-url").value,o=e.querySelector("#banner-link-url").value;return a&&o?(await setDoc(doc(db,"storeSettings","config"),{adBanners:arrayUnion({imageUrl:a,linkUrl:o})},{merge:!0}),showToast("–ë–∞–Ω–Ω–µ—Ä –¥–æ–±–∞–≤–ª–µ–Ω!"),loadCustomizationPage(),!0):(showToast("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è",!0),!1)},a=`<div class="space-y-4">
                <div><label>URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</label><input id="banner-image-url" class="w-full modern-input" placeholder="https://example.com/image.png"></div>
                <div><label>URL —Å—Å—ã–ª–∫–∏</label><input id="banner-link-url" class="w-full modern-input" placeholder="https://example.com/product"></div>
            </div>`;showModal("–î–æ–±–∞–≤–∏—Ç—å –±–∞–Ω–Ω–µ—Ä",a,e,"–î–æ–±–∞–≤–∏—Ç—å")}function renderAdminBanners(e){const a=document.getElementById("banners-list");a&&(a.innerHTML=(e||[]).map((e,a)=>`<div class="flex items-center justify-between gap-2 p-2 card-bg rounded"><span>${e.linkUrl}</span><button class="delete-banner-btn btn btn-danger text-sm" data-index="${a}">–£–¥–∞–ª–∏—Ç—å</button></div>`).join(""))}function showSocialLinkForm(){const e=async e=>{const a=e.querySelector("#social-name").value,o=e.querySelector("#social-url").value,n=e.querySelector("#social-icon").value;return a&&o&&n?(await setDoc(doc(db,"storeSettings","config"),{socialLinks:arrayUnion({id:`link_${Date.now()}`,name:a,url:o,icon:n})},{merge:!0}),showToast("–°—Å—ã–ª–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞!"),loadCustomizationPage(),!0):(showToast("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è",!0),!1)},a=`<div class="space-y-4">
                <div><label>–ù–∞–∑–≤–∞–Ω–∏–µ</label><input id="social-name" class="w-full modern-input" placeholder="Telegram"></div>
                <div><label>URL</label><input id="social-url" class="w-full modern-input" placeholder="https://t.me/username"></div>
                <div><label>SVG –∏–∫–æ–Ω–∫–∞</label><textarea id="social-icon" class="w-full modern-input" rows="3" placeholder='<path d="..."/>'></textarea></div>
            </div>`;showModal("–î–æ–±–∞–≤–∏—Ç—å —Å–æ—Ü.—Å–µ—Ç—å",a,e,"–î–æ–±–∞–≤–∏—Ç—å")}function loadAdminChatsList(e){const a=document.getElementById("admin-tab-content");if(a){a.innerHTML='<div class="flex gap-4 h-[75vh]"><div id="chat-list-sidebar" class="w-1/3 border-r pr-2 overflow-y-auto"></div><div id="chat-view" class="w-2/3 flex flex-col"></div></div>';const o=document.getElementById("chat-list-sidebar");onSnapshot(query(collection(db,"userChats"),orderBy("lastActivity","desc")),a=>{o&&(o.innerHTML=a.docs.filter(e=>e.id!==ADMIN_UID).map(a=>{const o=a.data();return`<a href="#admin/chats/${a.id}" class="block p-3 rounded-lg transition-colors ${e===a.id?"bg-primary text-white":"hover:bg-primary/10"}">${o.userName||"User"}</a>`}).join(""))}),e?(()=>{const o=document.getElementById("chat-view");if(o){const a=`${e}_${ADMIN_UID}`,n=`–ß–∞—Ç —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º (ID: ${e})`;renderChatInterface(o,a,n,ADMIN_UID)}})():(()=>{const e=document.getElementById("chat-view");e&&(e.innerHTML='<div class="flex-grow flex items-center justify-center text-gray-500"><p>–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞</p></div>')})()}}function renderChatInterface(e,a,o,n){e.innerHTML=`
                <div class="p-4 font-bold border-b">${o}</div>
                <div id="messages-container" class="p-4 flex-grow overflow-y-auto flex flex-col space-y-4"></div>
                <div class="p-4 border-t flex gap-2">
                    <input id="chat-message-input" class="flex-grow modern-input">
                    <button id="send-chat-message" class="btn btn-primary">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                </div>`;const s=document.getElementById("messages-container"),r=document.getElementById("send-chat-message"),l=document.getElementById("chat-message-input"),c=async()=>{const e=l.value.trim();if(e){const[o,s]=a.split("_");await addDoc(collection(db,`chats/${a}/messages`),{text:e,senderId:n,createdAt:serverTimestamp()}),await setDoc(doc(db,"userChats",o),{lastActivity:serverTimestamp()},{merge:!0}),l.value=""}};r.onclick=c,l.onkeyup=e=>{"Enter"===e.key&&c()},onSnapshot(query(collection(db,`chats/${a}/messages`),orderBy("createdAt","asc")),e=>{s&&(s.innerHTML=e.docs.map(e=>`<div class="flex items-end gap-2 ${e.data().senderId===n?"self-end":"self-start"}"><div class="px-4 py-2 rounded-lg ${e.data().senderId===n?"bg-primary text-white":"bg-gray-200 dark:bg-gray-700"}">${e.data().text}</div></div>`).join(""),s.scrollTop=s.scrollHeight)})}function loadAdminReviews(){const e=document.getElementById("admin-tab-content");e&&(e.innerHTML='<div class="flex justify-between items-center mb-6"><h3 class="text-2xl font-bold">–û—Ç–∑—ã–≤—ã</h3><button id="add-review-btn" class="btn btn-primary">–î–æ–±–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤</button></div><div id="reviews-list" class="space-y-4"></div>',document.getElementById("add-review-btn").onclick=()=>showAdminReviewForm(),onSnapshot(query(collection(db,"reviews"),orderBy("createdAt","desc")),e=>{const a=document.getElementById("reviews-list");a&&(a.innerHTML=e.docs.map(e=>renderAdminReviewItem(e.id,e.data())).join("")||"<p>–û—Ç–∑—ã–≤–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç.</p>")}
))}function renderAdminReviewItem(e,a){return`<div class="card-bg p-4 rounded border border-custom">
                <div class="flex justify-between">
                    <p><strong>${a.productName}</strong> - ${"‚≠ê".repeat(a.rating)}</p>
                    <button class="delete-btn text-red-500" data-collection="reviews" data-id="${e}">–£–¥–∞–ª–∏—Ç—å</button>
                </div>
                <p class="mt-2 italic">"${a.text}"</p>
                <p class="text-sm text-gray-400 mt-1">–û—Ç: ${a.userName} (${new Date(1e3*a.createdAt.seconds).toLocaleDateString()})</p>
            </div>`}async function showAdminReviewForm(){const e=allProducts.map(e=>`<option value="${e.id}">${e.name}</option>`).join(""),a=async a=>{const o=a.querySelector("#review-product-select").value,n=a.querySelector('input[name="admin-rating"]:checked')?.value,s=a.querySelector("#review-text").value,r=a.querySelector("#review-user-name").value;if(!o||!n||!r)return showToast("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è",!0),!1;const l=allProducts.find(e=>e.id===o);return await addDoc(collection(db,"reviews"),{productId:o,productName:l.name,rating:parseInt(n),text:s,userId:"admin",userName:r,createdAt:serverTimestamp()}),showToast("–û—Ç–∑—ã–≤ –¥–æ–±–∞–≤–ª–µ–Ω!"),!0},o=`<div class="space-y-4">
                <div>
                    <label class="block text-sm">–¢–æ–≤–∞—Ä</label>
                    <select id="review-product-select" class="w-full modern-input">${e}</select>
                </div>
                 <div>
                    <label class="block text-sm">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label>
                    <input id="review-user-name" class="w-full modern-input" value="–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä">
                </div>
                <div>
                    <label class="block text-sm">–û—Ü–µ–Ω–∫–∞</label>
                    <div class="star-rating">
                        <input type="radio" id="admin-star5" name="admin-rating" value="5" /><label for="admin-star5" title="5 –∑–≤–µ–∑–¥">‚òÖ</label>
                        <input type="radio" id="admin-star4" name="admin-rating" value="4" /><label for="admin-star4" title="4 –∑–≤–µ–∑–¥—ã">‚òÖ</label>
                        <input type="radio" id="admin-star3" name="admin-rating" value="3" /><label for="admin-star3" title="3 –∑–≤–µ–∑–¥—ã">‚òÖ</label>
                        <input type="radio" id="admin-star2" name="admin-rating" value="2" /><label for="admin-star2" title="2 –∑–≤–µ–∑–¥—ã">‚òÖ</label>
                        <input type="radio" id="admin-star1" name="admin-rating" value="1" /><label for="admin-star1" title="1 –∑–≤–µ–∑–¥–∞">‚òÖ</label>
                    </div>
                </div>
                <div>
                    <label class="block text-sm">–¢–µ–∫—Å—Ç –æ—Ç–∑—ã–≤–∞</label>
                    <textarea id="review-text" class="w-full modern-input" rows="3"></textarea>
                </div>
            </div>`;showModal("–î–æ–±–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤",o,a,"–î–æ–±–∞–≤–∏—Ç—å")}function showReviewForm(e,a){const o=async o=>{const n=o.querySelector('input[name="rating"]:checked')?.value,s=o.querySelector("#review-text").value;if(!n)return showToast("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ—Å—Ç–∞–≤—å—Ç–µ –æ—Ü–µ–Ω–∫—É",!0),!1;const r=allProducts.find(e=>e.id===a);return await addDoc(collection(db,"reviews"),{productId:a,productName:r.name,rating:parseInt(n),text:s,userId:currentUser.uid,userName:currentUser.displayName,createdAt:serverTimestamp()}),await updateDoc(doc(db,"purchases",e),{review:{rating:parseInt(n),text:s}}),showToast("–°–ø–∞—Å–∏–±–æ –∑–∞ –≤–∞—à –æ—Ç–∑—ã–≤!"),!0},n=`<div class="space-y-4">
                <p>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ü–µ–Ω–∏—Ç–µ –≤–∞—à—É –ø–æ–∫—É–ø–∫—É.</p>
                <div class="star-rating">
                    <input type="radio" id="star5" name="rating" value="5" /><label for="star5" title="5 –∑–≤–µ–∑–¥">‚òÖ</label>
                    <input type="radio" id="star4" name="rating" value="4" /><label for="star4" title="4 –∑–≤–µ–∑–¥—ã">‚òÖ</label>
                    <input type="radio" id="star3" name="rating" value="3" /><label for="star3" title="3 –∑–≤–µ–∑–¥—ã">‚òÖ</label>
                    <input type="radio" id="star2" name="rating" value="2" /><label for="star2" title="2 –∑–≤–µ–∑–¥—ã">‚òÖ</label>
                    <input type="radio" id="star1" name="rating" value="1" /><label for="star1" title="1 –∑–≤–µ–∑–¥–∞">‚òÖ</label>
                </div>
                <textarea id="review-text" class="w-full modern-input" rows="3" placeholder="–í–∞—à –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)"></textarea>
            </div>`;showModal("–û—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤",n,o,"–û—Ç–ø—Ä–∞–≤–∏—Ç—å")}document.addEventListener("DOMContentLoaded",()=>{try{initTheme(),setupEventListeners(),updateCartCount(),onAuthStateChanged(auth,async e=>{try{await Promise.all([loadPaymentMethods(),loadStoreSettings()]),await initializeAppState(e)}catch(e){console.error("Error during auth state change handling:",e)}finally{document.getElementById("loading-overlay").style.opacity="0",setTimeout(()=>{document.getElementById("loading-overlay").style.display="none",document.body.classList.remove("opacity-0")},500)}})}catch(e){console.error("Critical error on DOMContentLoaded:",e),document.body.innerHTML='<div style="text-align: center; padding-top: 50px; font-family: sans-serif;"><h1>–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞</h1><p>–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–∞–π—Ç. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É.</p></div>',document.body.classList.remove("opacity-0");const a=document.getElementById("loading-overlay");a&&(a.style.display="none")}});async function initializeAppState(e){currentUser=e,isAdmin=e?.uid===ADMIN_UID;const a=document.getElementById("balance-btn"),o=document.querySelector("#mobile-nav-links"),n=document.querySelectorAll("nav.hidden.md\\:flex a.main-nav-link");if(o.innerHTML="",n.forEach(e=>{const a=e.cloneNode(!0);a.classList.remove("px-3","py-1.5","rounded-full"),a.classList.add("p-4","text-lg"),o.appendChild(a)}),e){a?.classList.remove("hidden");const o=doc(db,"users",e.uid);onSnapshot(o,e=>{if(e.exists()){const a=e.data();appState.balance=a.balance||0,appState.balanceHistory=(a.balanceHistory||[]).sort((e,a)=>new Date(a.date)-new Date(e.date));const o=document.getElementById("balance-amount");o&&(o.textContent=formatPrice(appState.balance))}});const n=(await getDoc(o));n.exists()&&n.data().nickname||await setDoc(o,{displayName:e.displayName,email:e.email,photoURL:e.photoURL,lastSeen:serverTimestamp(),uid:e.uid,nickname:`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å${e.uid.substring(0,5)}`},{merge:!0})}else{a&&a.classList.add("hidden");const e=document.getElementById("notifications-container");e&&(e.innerHTML=""),userWishlist=[],appState.balance=0}await updateAuthUI(),handleRouting()}function loadSettingsPage(){const e=document.getElementById("settings-content");e.innerHTML=`
                <div class="max-w-2xl mx-auto card-bg p-8 rounded-lg shadow-lg">
                    <h1 class="text-3xl font-bold mb-6">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h1>
                    <div class="space-y-6">
                        <div>
                            <label class="block text-lg font-medium">–Ø–∑—ã–∫</label>
                            <select id="language-select" class="w-full modern-input mt-2">
                                <option value="RU" ${"RU"===appState.lang?"selected":""}>–†—É—Å—Å–∫–∏–π</option>
                                <option value="UZ" ${"UZ"===appState.lang?"selected":""}>O'zbekcha</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-lg font-medium">–í–∞–ª—é—Ç–∞</label>
                            <select id="currency-select" class="w-full modern-input mt-2">
                                <option value="UZS" ${"UZS"===appState.currency?"selected":""}>–£–∑–±–µ–∫—Å–∫–∏–π —Å—É–º (UZS)</option>
                                <option value="RUB" ${"RUB"===appState.currency?"selected":""}>–†–æ—Å—Å–∏–π—Å–∫–∏–π —Ä—É–±–ª—å (RUB)</option>
                                <option value="USD" ${"USD"===appState.currency?"selected":""}>–î–æ–ª–ª–∞—Ä –°–®–ê (USD)</option>
                            </select>
                        </div>
                    </div>
                </div>`,document.getElementById("language-select").addEventListener("change",e=>{appState.lang=e.target.value,localStorage.setItem("asonik_lang",appState.lang),translatePage()}),document.getElementById("currency-select").addEventListener("change",e=>{appState.currency=e.target.value,localStorage.setItem("asonik_currency",appState.currency),handleRouting()})}</script>
</body>
</html>
