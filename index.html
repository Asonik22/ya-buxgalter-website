<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asonik Store</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React -->
    <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
    <!-- Babel to transpile JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, doc, deleteDoc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";
        
        window.firebase = {
            initializeApp,
            getAuth,
            signInWithPopup,
            GoogleAuthProvider,
            onAuthStateChanged,
            signOut,
            getFirestore,
            collection,
            onSnapshot,
            addDoc,
            doc,
            deleteDoc,
            setDoc,
            serverTimestamp
        };
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
    </style>
</head>
<body class="bg-gray-900">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback } = React;
        const { 
            initializeApp, getAuth, signInWithPopup, GoogleAuthProvider, 
            onAuthStateChanged, signOut, getFirestore, collection, onSnapshot, 
            addDoc, doc, deleteDoc, setDoc, serverTimestamp 
        } = window.firebase;

        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyC7smDYoy-LT58xCwjJsc9uZU9CgHQv5dM",
            authDomain: "ya-buxgalter.firebaseapp.com",
            projectId: "ya-buxgalter",
            storageBucket: "ya-buxgalter.appspot.com",
            messagingSenderId: "640345805387",
            appId: "1:640345805387:web:a1adade77f809af84cb3ce",
            measurementId: "G-0TKE25JVXG"
        };

        // --- Initialize Firebase ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        // --- Admin Configuration ---
        const ADMIN_UID = 'vhmtXZxkZnOWviNQ39R1W3GE8mw2'; // ЗАМЕНИТЕ ЭТО НА ВАШ UID

        // --- Helper Components ---

        const Logo = () => (
            <div className="flex items-center space-x-2 cursor-pointer">
                <img 
                    src="http://googleusercontent.com/file_content/0" 
                    alt="Asonik Store Logo" 
                    className="h-12 w-12 object-contain"
                />
                <span className="text-2xl md:text-3xl font-bold text-white tracking-wider">
                    Asonik <span className="text-purple-300">Store</span>
                </span>
            </div>
        );

        const LoadingSpinner = () => (
            <div className="flex justify-center items-center h-full">
                <div className="animate-spin rounded-full h-32 w-32 border-t-4 border-b-4 border-purple-400"></div>
            </div>
        );

        const Modal = ({ children, onClose }) => (
            <div className="fixed inset-0 bg-black bg-opacity-75 z-50 flex justify-center items-center p-4 transition-opacity duration-300">
                <div className="bg-gray-800 rounded-2xl shadow-2xl p-6 md:p-8 w-full max-w-md relative border border-purple-700 transform transition-transform duration-300 scale-95 animate-scale-in">
                    <button
                        onClick={onClose}
                        className="absolute top-4 right-4 text-gray-400 hover:text-white transition-colors"
                    >
                        <svg xmlns="http://www.w3.org/2000/svg" className="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                    {children}
                </div>
                <style>{`
                    @keyframes scale-in {
                        from { transform: scale(0.9); opacity: 0; }
                        to { transform: scale(1); opacity: 1; }
                    }
                    .animate-scale-in { animation: scale-in 0.3s ease-out forwards; }
                `}</style>
            </div>
        );

        const AlertModal = ({ message, onConfirm, onCancel }) => (
            <Modal onClose={onCancel}>
                <div className="text-center">
                    <h2 className="text-2xl font-bold text-white mb-4">Подтверждение</h2>
                    <p className="text-gray-300 mb-6">{message}</p>
                    <div className={`flex ${onConfirm ? 'justify-between' : 'justify-center'} space-x-4`}>
                        <button
                            onClick={onCancel}
                            className="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-lg transition-colors"
                        >
                            {onConfirm ? 'Отмена' : 'OK'}
                        </button>
                        {onConfirm && (
                            <button
                                onClick={onConfirm}
                                className="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg transition-colors"
                            >
                                Подтвердить
                            </button>
                        )}
                    </div>
                </div>
            </Modal>
        );

        // --- Main Components ---

        function Header({ user, onLogin, onLogout, setPage, isAdmin }) {
            return (
                <header className="bg-gray-900 bg-opacity-80 backdrop-blur-md p-4 shadow-lg sticky top-0 z-40 border-b border-purple-800">
                    <div className="container mx-auto flex justify-between items-center">
                        <div onClick={() => setPage('home')}>
                            <Logo />
                        </div>
                        <nav className="hidden md:flex items-center space-x-6">
                            <button onClick={() => setPage('home')} className="text-gray-300 hover:text-white font-medium transition-colors">Главная</button>
                            <button onClick={() => setPage('support')} className="text-gray-300 hover:text-white font-medium transition-colors">Поддержка</button>
                            {isAdmin && (
                                <button onClick={() => setPage('admin')} className="text-purple-400 hover:text-purple-300 font-bold transition-colors">Админ</button>
                            )}
                        </nav>
                        <div className="flex items-center">
                            {user ? (
                                <div className="flex items-center space-x-4">
                                    <img src={user.photoURL} alt={user.displayName} className="h-10 w-10 rounded-full border-2 border-purple-500" />
                                    <button
                                        onClick={onLogout}
                                        className="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition-transform transform hover:scale-105"
                                    >
                                        Выйти
                                    </button>
                                </div>
                            ) : (
                                <button
                                    onClick={onLogin}
                                    className="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg transition-transform transform hover:scale-105 flex items-center space-x-2"
                                >
                                    <svg className="h-5 w-5" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm6.36 14.83c-1.43-1.74-4.9-2.33-6.36-2.33s-4.93.59-6.36 2.33C4.62 15.49 4 13.82 4 12c0-4.41 3.59-8 8-8s8 3.59 8 8c0 1.82-.62 3.49-1.64 4.83zM12 6c-1.94 0-3.5 1.56-3.5 3.5S10.06 13 12 13s3.5-1.56 3.5-3.5S13.94 6 12 6z"></path></svg>
                                    <span>Войти с Google</span>
                                </button>
                            )}
                        </div>
                    </div>
                </header>
            );
        }

        function ProductCard({ product, onBuy, user, setAlertInfo }) {
            const handleBuyClick = () => {
                if (user) {
                    onBuy(product);
                } else {
                    setAlertInfo({ message: 'Пожалуйста, войдите в аккаунт, чтобы совершить покупку.' });
                }
            };
            return (
                <div className="bg-gray-800 rounded-2xl overflow-hidden shadow-lg border border-gray-700 transform hover:-translate-y-2 transition-transform duration-300 flex flex-col">
                    <img className="w-full h-56 object-cover" src={product.imageUrl} alt={product.name} onError={(e) => { e.target.onerror = null; e.target.src='https://placehold.co/600x400/1f2937/374151?text=Image+Not+Found'; }}/>
                    <div className="p-6 flex flex-col flex-grow">
                        <h3 className="text-2xl font-bold text-white mb-2">{product.name}</h3>
                        <p className="text-gray-400 text-base mb-4 flex-grow">{product.description}</p>
                        <div className="flex justify-between items-center">
                            <span className="text-3xl font-bold text-purple-400">{product.price} ₽</span>
                            <button
                                onClick={handleBuyClick}
                                className={`font-bold py-2 px-6 rounded-lg transition-all duration-300 ${
                                    user 
                                    ? 'bg-purple-600 hover:bg-purple-700 text-white shadow-md hover:shadow-lg' 
                                    : 'bg-gray-600 text-gray-400 cursor-not-allowed'
                                }`}
                            >
                                Купить
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        function PurchaseModal({ product, onClose, onConfirm }) {
            const handleContactSeller = async () => {
                await onConfirm(product);
                window.open('https://t.me/asonikofficial', '_blank');
                onClose();
            };

            return (
                <Modal onClose={onClose}>
                    <div className="text-center">
                        <h2 className="text-3xl font-bold text-white mb-2">Оформление заказа</h2>
                        <p className="text-gray-400 mb-6">Вы покупаете: <span className="font-bold text-purple-300">{product.name}</span></p>
                        <div className="space-y-4">
                            <h3 className="text-xl text-white">Выберите способ оплаты:</h3>
                            <button onClick={handleContactSeller} className="w-full bg-teal-500 hover:bg-teal-600 text-white font-bold py-3 px-4 rounded-lg transition-transform transform hover:scale-105 flex items-center justify-center space-x-3">
                                <span>Связаться с продавцом (Telegram)</span>
                            </button>
                            <button disabled className="w-full bg-gray-600 text-gray-400 font-bold py-3 px-4 rounded-lg cursor-not-allowed">YooMoney (Недоступно)</button>
                            <button disabled className="w-full bg-gray-600 text-gray-400 font-bold py-3 px-4 rounded-lg cursor-not-allowed">Оплата картой (Недоступно)</button>
                            <button disabled className="w-full bg-gray-600 text-gray-400 font-bold py-3 px-4 rounded-lg cursor-not-allowed">Безналичный расчет (Недоступно)</button>
                        </div>
                    </div>
                </Modal>
            );
        }

        function HomePage({ products, onBuy, user, setAlertInfo }) {
            return (
                <main className="container mx-auto p-4 md:p-8">
                    <h1 className="text-4xl md:text-5xl font-black text-white text-center mb-4 tracking-wide">КАТАЛОГ ТОВАРОВ</h1>
                    <p className="text-purple-300 text-center mb-12 text-lg">Лучшие предложения только для вас</p>
                    {products.length === 0 ? (
                         <p className="text-center text-gray-400 text-xl">Товары скоро появятся...</p>
                    ) : (
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                            {products.map(product => (
                                <ProductCard key={product.id} product={product} onBuy={onBuy} user={user} setAlertInfo={setAlertInfo} />
                            ))}
                        </div>
                    )}
                </main>
            );
        }

        function AdminPage({ products, orders, tickets, setAlertInfo }) {
            const [name, setName] = useState('');
            const [description, setDescription] = useState('');
            const [price, setPrice] = useState('');
            const [imageUrl, setImageUrl] = useState('');
            const [editingProduct, setEditingProduct] = useState(null);

            const resetForm = () => {
                setName('');
                setDescription('');
                setPrice('');
                setImageUrl('');
                setEditingProduct(null);
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!name || !description || !price || !imageUrl) {
                    setAlertInfo({ message: "Пожалуйста, заполните все поля." });
                    return;
                }
                const productData = { name, description, price: Number(price), imageUrl };
                try {
                    if (editingProduct) {
                        const productRef = doc(db, 'products', editingProduct.id);
                        await setDoc(productRef, productData);
                        setAlertInfo({ message: 'Товар успешно обновлен!' });
                    } else {
                        await addDoc(collection(db, 'products'), productData);
                        setAlertInfo({ message: 'Товар успешно добавлен!' });
                    }
                    resetForm();
                } catch (error) {
                    console.error("Ошибка при добавлении/обновлении товара: ", error);
                    setAlertInfo({ message: "Произошла ошибка. Попробуйте снова." });
                }
            };

            const handleDelete = (productId) => {
                setAlertInfo({
                    message: "Вы уверены, что хотите удалить этот товар?",
                    onConfirm: async () => {
                        try {
                            await deleteDoc(doc(db, 'products', productId));
                            setAlertInfo({ message: 'Товар удален.' });
                        } catch (error) {
                            console.error("Ошибка при удалении товара: ", error);
                            setAlertInfo({ message: "Произошла ошибка при удалении." });
                        }
                    }
                });
            };
            
            const handleEdit = (product) => {
                setEditingProduct(product);
                setName(product.name);
                setDescription(product.description);
                setPrice(product.price);
                setImageUrl(product.imageUrl);
                window.scrollTo({ top: 0, behavior: 'smooth' });
            };

            return (
                <div className="container mx-auto p-4 md:p-8 text-white">
                    <h1 className="text-4xl font-bold mb-8 text-center">Панель администратора</h1>
                    <div className="bg-gray-800 p-8 rounded-2xl mb-12 border border-purple-700">
                        <h2 className="text-2xl font-bold mb-6">{editingProduct ? 'Редактировать товар' : 'Добавить новый товар'}</h2>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <input type="text" placeholder="Название товара" value={name} onChange={e => setName(e.target.value)} className="w-full p-3 bg-gray-700 rounded-lg border border-gray-600 focus:outline-none focus:ring-2 focus:ring-purple-500" />
                            <textarea placeholder="Описание" value={description} onChange={e => setDescription(e.target.value)} className="w-full p-3 bg-gray-700 rounded-lg border border-gray-600 focus:outline-none focus:ring-2 focus:ring-purple-500 h-32"></textarea>
                            <input type="number" placeholder="Цена (в рублях)" value={price} onChange={e => setPrice(e.target.value)} className="w-full p-3 bg-gray-700 rounded-lg border border-gray-600 focus:outline-none focus:ring-2 focus:ring-purple-500" />
                            <input type="text" placeholder="URL изображения" value={imageUrl} onChange={e => setImageUrl(e.target.value)} className="w-full p-3 bg-gray-700 rounded-lg border border-gray-600 focus:outline-none focus:ring-2 focus:ring-purple-500" />
                            <div className="flex space-x-4">
                                <button type="submit" className="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-4 rounded-lg transition-colors">{editingProduct ? 'Обновить товар' : 'Добавить товар'}</button>
                                {editingProduct && <button type="button" onClick={resetForm} className="w-full bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-lg transition-colors">Отмена</button>}
                            </div>
                        </form>
                    </div>
                    <div className="bg-gray-800 p-8 rounded-2xl mb-12 border border-purple-700">
                        <h2 className="text-2xl font-bold mb-6">Список товаров</h2>
                        <div className="space-y-4">
                            {products.map(p => (
                                <div key={p.id} className="bg-gray-700 p-4 rounded-lg flex justify-between items-center">
                                    <div>
                                        <p className="font-bold">{p.name} - {p.price}₽</p>
                                        <p className="text-sm text-gray-400">{p.id}</p>
                                    </div>
                                    <div className="flex space-x-2">
                                        <button onClick={() => handleEdit(p)} className="bg-blue-500 hover:bg-blue-600 text-white py-1 px-3 rounded">Редакт.</button>
                                        <button onClick={() => handleDelete(p.id)} className="bg-red-500 hover:bg-red-600 text-white py-1 px-3 rounded">Удалить</button>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                    <div className="bg-gray-800 p-8 rounded-2xl mb-12 border border-purple-700">
                        <h2 className="text-2xl font-bold mb-6">Заявки на покупку</h2>
                        <div className="space-y-4">
                            {orders.length > 0 ? orders.map(o => (
                                <div key={o.id} className="bg-gray-700 p-4 rounded-lg">
                                    <p>Товар: <span className="font-semibold">{o.productName}</span></p>
                                    <p>Пользователь: <span className="font-semibold">{o.userEmail}</span></p>
                                    <p>Время: <span className="font-semibold">{new Date(o.timestamp?.toDate()).toLocaleString()}</span></p>
                                </div>
                            )) : <p>Новых заявок нет.</p>}
                        </div>
                    </div>
                    <div className="bg-gray-800 p-8 rounded-2xl border border-purple-700">
                        <h2 className="text-2xl font-bold mb-6">Обращения в поддержку</h2>
                        <div className="space-y-4">
                            {tickets.length > 0 ? tickets.map(t => (
                                <div key={t.id} className="bg-gray-700 p-4 rounded-lg">
                                    <p>От: <span className="font-semibold">{t.userEmail || 'Аноним'}</span></p>
                                    <p>Время: <span className="font-semibold">{new Date(t.timestamp?.toDate()).toLocaleString()}</span></p>
                                    <p className="bg-gray-600 p-3 rounded mt-2">{t.message}</p>
                                </div>
                            )) : <p>Новых обращений нет.</p>}
                        </div>
                    </div>
                </div>
            );
        }

        function SupportPage({ user, setAlertInfo }) {
            const [message, setMessage] = useState('');
            const [isSent, setIsSent] = useState(false);

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!message.trim()) {
                    setAlertInfo({ message: "Пожалуйста, введите ваше сообщение." });
                    return;
                }
                try {
                    await addDoc(collection(db, 'supportTickets'), {
                        message: message,
                        userId: user ? user.uid : 'anonymous',
                        userEmail: user ? user.email : 'anonymous',
                        timestamp: serverTimestamp()
                    });
                    setMessage('');
                    setIsSent(true);
                    setTimeout(() => setIsSent(false), 5000);
                } catch (error) {
                    console.error("Ошибка при отправке сообщения: ", error);
                    setAlertInfo({ message: "Произошла ошибка. Попробуйте еще раз." });
                }
            };

            return (
                <div className="container mx-auto p-4 md:p-8 text-white flex-grow flex flex-col items-center justify-center">
                    <div className="w-full max-w-2xl bg-gray-800 p-8 rounded-2xl border border-purple-700">
                        <h1 className="text-4xl font-bold mb-6 text-center">Служба поддержки</h1>
                        <p className="text-center text-gray-400 mb-8">Есть вопросы или предложения? Напишите нам!</p>
                        {isSent ? (
                            <div className="bg-green-500 text-white text-center p-4 rounded-lg">Ваше сообщение успешно отправлено!</div>
                        ) : (
                            <form onSubmit={handleSubmit} className="space-y-6">
                                <textarea value={message} onChange={(e) => setMessage(e.target.value)} placeholder="Введите ваше сообщение здесь..." className="w-full p-4 bg-gray-700 rounded-lg border border-gray-600 focus:outline-none focus:ring-2 focus:ring-purple-500 h-48 resize-none"></textarea>
                                <button type="submit" className="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-4 rounded-lg transition-transform transform hover:scale-105">Отправить</button>
                            </form>
                        )}
                    </div>
                </div>
            );
        }

        function Footer() {
            return (
                <footer className="bg-gray-900 text-gray-400 p-6 mt-12 border-t border-purple-800">
                    <div className="container mx-auto text-center">
                        <p>&copy; {new Date().getFullYear()} Asonik Store. Все права защищены.</p>
                        <p className="text-sm mt-2">Дизайн и разработка с ❤️</p>
                    </div>
                </footer>
            );
        }

        function App() {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [products, setProducts] = useState([]);
            const [orders, setOrders] = useState([]);
            const [tickets, setTickets] = useState([]);
            const [selectedProduct, setSelectedProduct] = useState(null);
            const [page, setPage] = useState('home');
            const [alertInfo, setAlertInfo] = useState(null);
            
            const isAdmin = user && user.uid === ADMIN_UID;

            useEffect(() => {
                const unsubscribe = onAuthStateChanged(auth, (currentUser) => {
                    setUser(currentUser);
                    if (currentUser) console.log("Ваш UID для админки:", currentUser.uid);
                    setLoading(false);
                });
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                const unsubProducts = onSnapshot(collection(db, "products"), (snapshot) => {
                    setProducts(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                });
                let unsubOrders = () => {};
                let unsubTickets = () => {};
                if (isAdmin) {
                    unsubOrders = onSnapshot(collection(db, "orders"), (snapshot) => {
                        setOrders(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                    });
                    unsubTickets = onSnapshot(collection(db, "supportTickets"), (snapshot) => {
                        setTickets(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                    });
                }
                return () => { unsubProducts(); unsubOrders(); unsubTickets(); };
            }, [isAdmin]);

            const handleLogin = async () => {
                try {
                    await signInWithPopup(auth, provider);
                } catch (error) { console.error("Ошибка входа:", error); }
            };

            const handleLogout = async () => {
                try {
                    await signOut(auth);
                    setPage('home');
                } catch (error) { console.error("Ошибка выхода:", error); }
            };

            const handleBuy = (product) => setSelectedProduct(product);

            const handleConfirmPurchase = async (product) => {
                if (!user) return;
                try {
                    await addDoc(collection(db, 'orders'), {
                        userId: user.uid, userEmail: user.email,
                        productId: product.id, productName: product.name,
                        timestamp: serverTimestamp()
                    });
                } catch (error) { console.error("Ошибка при создании заявки: ", error); }
            };
            
            const handleAlertClose = () => {
                if (alertInfo && alertInfo.onConfirm) {
                    alertInfo.onConfirm();
                }
                setAlertInfo(null);
            };

            const renderPage = () => {
                switch (page) {
                    case 'admin':
                        return isAdmin ? <AdminPage products={products} orders={orders} tickets={tickets} setAlertInfo={setAlertInfo} /> : <HomePage products={products} onBuy={handleBuy} user={user} setAlertInfo={setAlertInfo} />;
                    case 'support':
                        return <SupportPage user={user} setAlertInfo={setAlertInfo}/>;
                    default:
                        return <HomePage products={products} onBuy={handleBuy} user={user} setAlertInfo={setAlertInfo} />;
                }
            };

            if (loading) {
                return <div className="bg-gray-900 min-h-screen flex items-center justify-center"><LoadingSpinner /></div>;
            }

            return (
                <div className="bg-gray-900 min-h-screen font-sans bg-gradient-to-br from-gray-900 via-purple-900 to-gray-900 flex flex-col">
                    <Header user={user} onLogin={handleLogin} onLogout={handleLogout} setPage={setPage} isAdmin={isAdmin} />
                    <div className="flex-grow">{renderPage()}</div>
                    {selectedProduct && <PurchaseModal product={selectedProduct} onClose={() => setSelectedProduct(null)} onConfirm={handleConfirmPurchase} />}
                    {alertInfo && <AlertModal message={alertInfo.message} onConfirm={alertInfo.onConfirm ? handleAlertClose : null} onCancel={() => setAlertInfo(null)} />}
                    <Footer />
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
