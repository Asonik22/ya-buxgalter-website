<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title id="site-title">Asonik | Store</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>🛒</text></svg>" />
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<style>:root{--bg-light-start:#ede9fe;--bg-light-end:#f5f3ff;--text-light:#1e1b4b;--card-bg-light:#ffffff;--primary-light:#7c3aed;--primary-hover-light:#6d28d9;--border-light:#ddd6fe;--logo-text-light:#5b21b6;--nav-hover-bg-light:#e0e7ff;--nav-hover-text-light:#1e1b4b;--nav-active-bg-light:#7c3aed;--nav-active-text-light:#ffffff;--bg-dark-start:#1e1b4b;--bg-dark-end:#17133a;--text-dark:#e0e7ff;--card-bg-dark:#282454;--primary-dark:#a78bfa;--primary-hover-dark:#c4b5fd;--border-dark:#4338ca;--logo-text-dark:#c7d2fe;--nav-hover-bg-dark:#312e74;--nav-hover-text-dark:#e0e7ff;--nav-active-bg-dark:#a78bfa;--nav-active-text-dark:#1e1b4b}html.dark{--bg-start:var(--bg-dark-start);--bg-end:var(--bg-dark-end);--text:var(--text-dark);--card-bg:var(--card-bg-dark);--primary:var(--primary-dark);--primary-hover:var(--primary-hover-dark);--border:var(--border-dark);--logo-text:var(--logo-text-dark);--nav-hover-bg:var(--nav-hover-bg-dark);--nav-hover-text:var(--nav-hover-text-dark);--nav-active-bg:var(--nav-active-bg-dark);--nav-active-text:var(--nav-active-text-dark)}html:not(.dark){--bg-start:var(--bg-light-start);--bg-end:var(--bg-light-end);--text:var(--text-light);--card-bg:var(--card-bg-light);--primary:var(--primary-light);--primary-hover:var(--primary-hover-light);--border:var(--border-light);--logo-text:var(--logo-text-light);--nav-hover-bg:var(--nav-hover-bg-light);--nav-hover-text:var(--nav-hover-text-light);--nav-active-bg:var(--nav-active-bg-light);--nav-active-text:var(--nav-active-text-light)}body{font-family:'Manrope',sans-serif;background-image:linear-gradient(120deg,var(--bg-start),var(--bg-end));color:var(--text);transition:background-color .3s,color .3s}.logo-text{color:var(--logo-text)}.bg-primary{background-color:var(--primary)}.hover\:bg-primary-hover:hover{background-color:var(--primary-hover)}.text-primary{color:var(--primary)}.border-custom{border-color:var(--border)}.card-bg{background-color:var(--card-bg)}.input-bg{background-color:var(--card-bg);border-color:var(--border)}.modal-backdrop{background-color:rgba(0,0,0,.7)}[data-page]{display:none}[data-page].active{display:block}.main-nav-link:hover{background-color:var(--nav-hover-bg);color:var(--nav-hover-text) !important}.main-nav-link.active{background-color:var(--nav-active-bg);color:var(--nav-active-text) !important}.btn{display:inline-flex;align-items:center;justify-content:center;gap:.5rem;padding:.75rem 1.25rem;border-radius:.5rem;font-weight:600;transition:all .2s;cursor:pointer;border:none}.btn-primary{background-color:var(--primary);color:#fff}.btn-primary:hover{background-color:var(--primary-hover);transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,.15)}.modern-input{background-color:var(--card-bg);border:1px solid var(--border);border-radius:.5rem;padding:.75rem;transition:border-color .2s,box-shadow .2s}.modern-input:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px color-mix(in srgb,var(--primary) 25%,transparent)}#loading-overlay{position:fixed;inset:0;background-image:linear-gradient(120deg,var(--bg-start),var(--bg-end));z-index:100;display:flex;align-items:center;justify-content:center;transition:opacity .5s ease-out;opacity:1}.spinner{width:56px;height:56px;border-radius:50%;border:8px solid;border-color:var(--border);border-right-color:var(--primary);animation:spinner-d3wgkg 1s infinite linear}@keyframes spinner-d3wgkg{to{transform:rotate(1turn)}}.tooltip{position:relative;display:inline-flex;align-items:center}.tooltip .tooltiptext{visibility:hidden;width:220px;background-color:#333;color:#fff;text-align:center;border-radius:6px;padding:8px;position:absolute;z-index:1;bottom:140%;left:50%;margin-left:-110px;opacity:0;transition:opacity .3s;font-size:.8rem}.tooltip:hover .tooltiptext{visibility:visible;opacity:1}.status-badge{padding:.25rem .75rem;border-radius:9999px;font-size:.8rem;font-weight:600;display:inline-flex;align-items:center;gap:.3rem;color:#fff}.status-badge.pending{background-color:#f59e0b}.status-badge.completed,.status-badge.finished{background-color:#10b981}.status-badge.rejected,.status-badge.cancelled{background-color:#ef4444}.status-badge.processing{background-color:#3b82f6}#store-logo,.product-card-img,#main-product-image,#profile-avatar{object-fit:cover}.variation-option.selected,.payment-option.selected{border-color:var(--primary) !important;box-shadow:0 0 0 3px color-mix(in srgb,var(--primary) 40%,transparent);border-width:2px}.variation-option.disabled{opacity:.5;cursor:not-allowed;background-color:color-mix(in srgb,var(--card-bg) 50%,#888)}</style>
</head>
<body class="antialiased opacity-0 transition-opacity duration-500">
<div id="loading-overlay"><div class="spinner"></div></div>
<header class="sticky top-0 z-40"><div class="container mx-auto px-4"><div class="mt-4 card-bg shadow-lg rounded-xl border border-custom/50 flex justify-between items-center h-16 px-4"><a href="#main" class="flex items-center gap-3 text-2xl font-bold nav-link rounded-lg"><img id="store-logo" src="" alt="logo" class="h-8 w-8 rounded-full hidden"><span id="site-name-display" class="logo-text hidden sm:inline">Asonik | Store</span></a><nav class="hidden md:flex items-center space-x-2 bg-white/10 dark:bg-black/10 p-1 rounded-full"><a href="#main" class="main-nav-link nav-link flex items-center gap-2 px-3 py-1.5 rounded-full transition-colors" data-nav-key="main" data-lang-key="nav_main"></a><a href="#chats" class="main-nav-link nav-link flex items-center gap-2 px-3 py-1.5 rounded-full transition-colors" data-nav-key="chats" data-lang-key="nav_chats"></a><a href="#faq" class="main-nav-link nav-link flex items-center gap-2 px-3 py-1.5 rounded-full transition-colors" data-nav-key="faq" data-lang-key="nav_faq"></a><a href="#purchases" class="main-nav-link nav-link flex items-center gap-2 px-3 py-1.5 rounded-full transition-colors" data-nav-key="purchases" data-lang-key="nav_purchases"></a><a href="#download" class="main-nav-link nav-link flex items-center gap-2 px-3 py-1.5 rounded-full transition-colors" data-nav-key="download" data-lang-key="nav_download"></a></nav><div class="flex items-center space-x-1 sm:space-x-2"><button id="balance-btn" class="hidden btn bg-primary/10 hover:bg-primary/20 border border-custom/50"><svg class="h-5 w-5 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H4a3 3 0 00-3 3v8a3 3 0 003 3z"></path></svg><span id="balance-amount" class="font-semibold text-sm">0</span><svg class="w-4 h-4 opacity-70" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg></button><button id="theme-toggle" class="p-2 rounded-full hover:bg-black/10 dark:hover:bg-white/10"></button><a href="#cart" class="relative p-2 nav-link rounded-full"><svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path></svg><span id="cart-count" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full h-4 w-4 flex items-center justify-center hidden">0</span></a><div id="auth-container" class="relative"></div><button id="mobile-menu-btn" class="md:hidden p-2"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg></button></div></div></div></header>
<div id="mobile-menu" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 opacity-0"><div id="mobile-menu-panel" class="fixed top-0 right-0 h-full w-64 card-bg shadow-lg p-6 transform translate-x-full"><button id="mobile-menu-close-btn" class="absolute top-4 right-4 p-2 text-2xl">&times;</button><nav id="mobile-nav-links" class="flex flex-col space-y-6 text-xl mt-12 text-center"></nav></div></div>
<main class="container mx-auto px-4 py-8"><div data-page="main" class="active"><div id="main-page-content-wrapper"></div></div><div data-page="product"><div id="product-detail-content"></div></div><div data-page="chats"><div id="chats-content"></div></div><div data-page="faq"><div id="faq-content"></div></div><div data-page="purchases"><div id="purchases-content"></div></div><div data-page="wishlist"><div id="wishlist-content"></div></div><div data-page="admin"><div id="admin-content"></div></div><div data-page="cart"><div id="cart-content"></div></div><div data-page="profile"><div id="profile-content"></div></div><div data-page="download"><div id="download-content"></div></div><div data-page="settings"><div id="settings-content"></div></div></main>
<footer class="container mx-auto px-4 py-6 mt-8 border-t border-custom"><div id="social-links-container" class="flex justify-center items-center gap-6"></div></footer><div class="text-center text-sm text-gray-500 py-4">© <span id="footer-site-name">Asonik | Store</span> 2025</div>
<div id="modals-container"></div>
<script type="module">import {initializeApp} from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";import {getAuth,onAuthStateChanged,GoogleAuthProvider,signInWithPopup,signOut,updateProfile} from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";import {getFirestore,doc,getDoc,setDoc,addDoc,collection,getDocs,onSnapshot,updateDoc,deleteDoc,query,where,serverTimestamp,orderBy,increment,writeBatch,arrayUnion,arrayRemove,enableIndexedDbPersistence} from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";import {getStorage,ref,uploadBytes,getDownloadURL} from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";const firebaseConfig={apiKey:"AIzaSyDim7T4GqxZK4zM9tBDLkcGTSveVOaUbMY",authDomain:"asonikstore-v3.firebaseapp.com",projectId:"asonikstore-v3",storageBucket:"asonikstore-v3.appspot.com",messagingSenderId:"1018442222532",appId:"1:1018442222532:web:9b78f7be6c5c02bb327291"},IMGBB_API_KEY="96bf3f29606f1989bb5a450ad3770cce",ADMIN_UID="MrjXzJnZYbb6jb65B4f4aYDTVBt2",TELEGRAM_USERNAME="asonikofficial",app=initializeApp(firebaseConfig),auth=getAuth(app),db=getFirestore(app),storage=getStorage(app);enableIndexedDbPersistence(db).catch(e=>{"failed-precondition"==e.code?console.warn("Firestore persistence failed: Multiple tabs open."):"unimplemented"==e.code&&console.warn("Firestore persistence failed: Browser does not support it.")});let currentUser=null,isAdmin=!1,allProducts=[],paymentMethods=[],userWishlist=[],cart=JSON.parse(localStorage.getItem("asonik_cart"))||[];let allUsers=[],balanceHistoryFiltered=[];const appState={currency:localStorage.getItem("asonik_currency")||"UZS",lang:localStorage.getItem("asonik_lang")||"RU",rates:{UZS:1,RUB:.0073,USD:78e-6},balance:0,balanceHistory:[],guestPromptMessage:"Пожалуйста, войдите, чтобы получить доступ ко всем функциям.",minimumTopUpAmount:1e3},translations={RU:{nav_main:"Главная",nav_chats:"Чаты",nav_faq:"FAQ",nav_purchases:"Мои покупки",nav_download:"Скачать приложение",catalog_title:"Каталог товаров",search_placeholder:"Поиск...",faq_title:"Часто задаваемые вопросы",purchases_title:"Мои покупки",cart_title:"Корзина",profile_title:"Профиль",buy_button:"Купить"},UZ:{nav_main:"Asosiy",nav_chats:"Chatlar",nav_faq:"FAQ",nav_purchases:"Xaridlarim",nav_download:"Ilovani yuklab olish",catalog_title:"Mahsulotlar",search_placeholder:"Qidirish...",faq_title:"Ko'p so'raladigan savollar",purchases_title:"Xaridlarim",cart_title:"Savatcha",profile_title:"Profil",buy_button:"Sotib olish"}},t=e=>translations[appState.lang]?.[e]||e,translatePage=()=>{document.querySelectorAll("[data-lang-key]").forEach(e=>e.textContent=t(e.dataset.langKey)),document.querySelectorAll("[data-lang-placeholder]").forEach(e=>e.placeholder=t(e.dataset.langPlaceholder))},formatPrice=(e,a=appState.currency)=>new Intl.NumberFormat("ru-RU",{style:"currency",currency:a,minimumFractionDigits:0}).format((e="number"!=typeof e?0:e)*(appState.rates[a]||1)),generateCode=()=>"A"+Math.random().toString(36).substring(2,9).toUpperCase(),showToast=(e,a=!1)=>{const o=document.createElement("div");o.className=`fixed bottom-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg z-50 ${a?"bg-red-500":"bg-green-500"}`,o.textContent=e,document.body.appendChild(o),setTimeout(()=>o.remove(),3e3)},showModal=(e,a,o,n="Подтвердить")=>{const s=document.createElement("div");return s.className="fixed inset-0 z-50 flex items-center justify-center modal-backdrop",s.innerHTML=`<div class="card-bg rounded-lg shadow-xl w-11/12 md:w-2/3 lg:w-1/2 p-6 max-h-[90vh] overflow-y-auto"><div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-bold">${e}</h2><button class="close-modal-btn text-2xl">&times;</button></div><div>${a}</div>${o?`<div class="mt-6 flex justify-end gap-4"><button class="close-modal-btn btn">Отмена</button><button class="save-modal-btn btn btn-primary">${n}</button></div>`:""}</div>`,document.getElementById("modals-container").appendChild(s),s.querySelectorAll(".close-modal-btn").forEach(e=>e.onclick=()=>s.remove()),o&&(s.querySelector(".save-modal-btn").onclick=async()=>{!1!==await o(s)&&s.remove()}),s},confirmAction=(e,a)=>showModal("Подтвердите",`<p>${e}</p>`,()=>{a(),!0},"Да, уверен");function renderSocialLinks(e){const a=document.getElementById("social-links-container");a&&(a.innerHTML=(e||[]).map(e=>`<a href="${e.url}" target="_blank" class="text-gray-400 hover:text-primary"><svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">${e.icon}</svg></a>`).join(""))}async function loadStoreSettings(){try{const e=await getDoc(doc(db,"storeSettings","config"));if(e.exists()){const{logoUrl:a,socialLinks:o,appDownload:n,themeColors:s,siteName:r,adBanners:l,guestPromptMessage:c,minimumTopUpAmount:i,announcement:d}=e.data(),p=document.getElementById("store-logo");a?(p.src=a,p.classList.remove("hidden")):(p.classList.add("hidden"),a),r&&(document.title=r,document.getElementById("site-name-display").textContent=r,document.getElementById("footer-site-name").textContent=r),o&&renderSocialLinks(o),s&&applyCustomTheme(s),appState.appDownload=n||{},appState.adBanners=l||[],appState.guestPromptMessage=c||"Пожалуйста, войдите, чтобы получить доступ ко всем функциям.",appState.minimumTopUpAmount=i||1e3,appState.announcement=d||{}}}catch(e){console.error("Error loading store settings:",e)}}function loadPaymentMethods(){return new Promise((e,a)=>{onSnapshot(query(collection(db,"paymentMethods"),orderBy("order","asc")),a=>{paymentMethods=a.docs.map(e=>({id:e.id,...e.data()})),e()},(e=>{console.error(e),e()}))})}function handleRouting(){const e=window.location.hash||"#main";let[a,o]=(e.substring(1)||"main").split("/");document.querySelectorAll("[data-page]").forEach(e=>e.classList.remove("active"));const n=document.querySelector(`[data-page="${a}"]`);n?(n.classList.add("active"),loadPageContent(a,o)):(document.querySelector('[data-page="main"]')?.classList.add("active"),loadPageContent("main")),document.querySelectorAll(".main-nav-link").forEach(e=>{e.classList.remove("active"),e.dataset.navKey===a&&e.classList.add("active")}),translatePage()}function loadPageContent(e,a){const o=["purchases","chats","profile","admin","wishlist","settings"],n=document.querySelector(`[data-page="${e}"] > div`);if(n){if(o.includes(e)&&!currentUser)return void(n.innerHTML=`<h1 class="text-4xl font-bold text-center mb-8">${t(e+"_title")||"Доступ запрещен"}</h1><p class="text-center">${appState.guestPromptMessage} <a href="#" id="login-redirect" class="text-primary underline">Войти</a></p>`);switch(e){case"main":loadMainPage();break;case"product":loadProductDetailPage(a);break;case"faq":loadFaq();break;case"admin":loadAdminPanel(a||"users");break;case"cart":renderCartPage();break;case"chats":loadChatsPage(a);break;case"purchases":loadPurchasesPage();break;case"wishlist":loadWishlistPage();break;case"profile":loadProfilePage();break;case"download":loadDownloadPage();break;case"settings":loadSettingsPage();break;default:loadMainPage()}}else console.error(`Content container for page "${e}" not found.`)}function loadMainPage(){const e=document.getElementById("main-page-content-wrapper");if(e){const a=(appState.adBanners||[]).map(e=>e&&e.imageUrl&&e.linkUrl?`<a href="${e.linkUrl}" target="_blank" class="block mb-8 rounded-lg shadow-lg overflow-hidden"><img src="${e.imageUrl}" class="w-full object-cover"></a>`:"").join(""),o=appState.announcement,n=o&&o.enabled&&o.message?`<div class="p-4 mb-8 rounded-lg bg-primary/10 border border-primary text-primary">${o.message}</div>`:"";e.innerHTML=`${n}${a}
                <h1 class="text-4xl font-bold text-center mb-8" data-lang-key="catalog_title"></h1>
                <div class="mb-8 p-4 card-bg rounded-lg shadow-md flex flex-col md:flex-row items-center gap-4 border border-custom">
                    <input id="search-input" type="text" data-lang-placeholder="search_placeholder" class="w-full md:w-1/2 modern-input">
                    <select id="category-filter" class="w-full md:w-1/4 modern-input">
                        <option value="all">Все категории</option>
                        <option value="игра">Игры</option>
                        <option value="приложение">Приложения</option>
                        <option value="другое">Другое</option>
                    </select>
                    <select id="sort-select" class="w-full md:w-1/4 modern-input">
                        <option value="order">По порядку</option>
                        <option value="newest">Сначала новые</option>
                        <option value="price_asc">Цена: по возрастанию</option>
                        <option value="price_desc">Цена: по убыванию</option>
                        <option value="popular">Популярные</option>
                    </select>
                </div>
                <div id="products-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>`,document.getElementById("search-input").addEventListener("input",applyFiltersAndSort),document.getElementById("category-filter").addEventListener("change",applyFiltersAndSort),document.getElementById("sort-select").addEventListener("change",applyFiltersAndSort),loadProducts()}}function loadProducts(){onSnapshot(query(collection(db,"products")),e=>{allProducts=e.docs.map(e=>({id:e.id,...e.data()})),applyFiltersAndSort()})}function applyFiltersAndSort(){let e=[...allProducts];const a=document.getElementById("search-input");if(a){const o=a.value.toLowerCase();o&&(e=e.filter(e=>e.name.toLowerCase().includes(o)))}const o=document.getElementById("category-filter");if(o){const a=o.value;"all"!==a&&(e=e.filter(e=>e.category===a))}const n=document.getElementById("sort-select");if(n)switch(n.value){case"price_asc":e.sort((e,a)=>(e.price||0)-(a.price||0));break;case"price_desc":e.sort((e,a)=>(b.price||0)-(a.price||0));break;case"popular":e.sort((e,a)=>(b.purchaseCount||0)-(a.purchaseCount||0));break;case"newest":e.sort((e,a)=>(b.createdAt?.toMillis()||0)-(a.createdAt?.toMillis()||0));break;case"order":e.sort((e,a)=>(a.order||999)-(e.order||999));break;default:e.sort((e,a)=>(a.order||999)-(e.order||999))}e.sort((e,a)=>(a.isPinned?1:0)-(e.isPinned?1:0));const s=document.getElementById("products-grid");s&&(s.innerHTML=e.length?e.map(e=>renderProductCard(e)).join(""):`<p class="col-span-full text-center">Товары не найдены.</p>`,translatePage())}function renderProductCard(e){let a;const o="На этот товар распространяется гарантия от нашего магазина.",n=`Товар выставляется на продажу сторонним лицом. Магазин выступает в роли площадки и не несет ответственности за данный товар.`;a="official"===e.productStatus?`<div class="mt-2 text-sm text-green-600 flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>
                                <span>Гарантированный товар</span>
                                <div class="tooltip">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" /></svg>
                                    <span class="tooltiptext">${o}</span>
                                </div>
                              </div>`:`<div class="mt-2 text-sm text-orange-500 flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" /></svg>
                                <span>Частное лицо</span>
                                <div class="tooltip">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" /></svg>
                                    <span class="tooltiptext">${n}</span>
                                </div>
                              </div>`;const s=e.variations&&e.variations.length>0?`<a href="#product/${e.id}" class="nav-link flex-grow btn btn-primary text-center">Выбрать опцию</a>`:`<button class="buy-now-btn flex-grow btn btn-primary" data-product-id="${e.id}" data-lang-key="buy_button"></button>`;return`<div class="card-bg rounded-lg shadow-lg flex flex-col justify-between border border-custom overflow-hidden transition-all duration-300 hover:shadow-2xl hover:-translate-y-1" data-product-id="${e.id}">
                <div class="relative">
                    <a href="#product/${e.id}" class="nav-link block">
                        <img src="${e.imageUrl||"https://placehold.co/600x400/7c3aed/ffffff?text=No+Image"}" class="w-full h-48 product-card-img">
                    </a>
                </div>
                <div class="p-4 flex-grow">
                    <h3 class="text-lg font-semibold truncate">${e.name}</h3>
                    <p class="text-gray-600 dark:text-gray-400 mt-1 text-sm h-10 overflow-hidden">${e.description}</p>
                    ${a}
                    <p class="text-2xl font-bold text-primary mt-2">${formatPrice(e.price||0)}</p>
                </div>
                <div class="p-4 pt-2 border-t border-custom flex items-center gap-2">
                     <button class="wishlist-btn p-2 rounded-md hover:bg-red-500/10 text-gray-500 hover:text-red-500" data-product-id="${e.id}" title="В избранное">
                        <svg class="w-6 h-6 pointer-events-none" fill="${userWishlist.includes(e.id)?"currentColor":"none"}" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 016.364 0L12 7.636l1.318-1.318a4.5 4.5 0 016.364 6.364L12 20.364l-7.682-7.682a4.5 4.5 0 010-6.364z"></path></svg>
                    </button>
                    <button class="add-to-cart-btn p-2 rounded-md hover:bg-primary/10 text-gray-500 hover:text-primary" data-product-id="${e.id}" title="В корзину">
                        <svg class="w-6 h-6 pointer-events-none" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                    </button>
                    ${s}
                </div>
            </div>`}async function loadProductDetailPage(e){const a=document.getElementById("product-detail-content");if(!e)return void(a.innerHTML='<p class="text-center">Товар не найден.</p>');try{const o=await getDoc(doc(db,"products",e));if(!o.exists())return void(a.innerHTML='<p class="text-center">Товар не найден.</p>');const n={id:o.id,...o.data()};let s="";n.variations&&n.variations.length>0&&(s=`
                        <div class="mt-6">
                            <h3 class="text-xl font-semibold mb-4">Выберите опцию:</h3>
                            <div class="space-y-4">
                                ${n.variations.map((e,a)=>{const o=e.isOutOfStock?"disabled":"";return`<div class="variation-option p-4 border rounded-lg cursor-pointer transition-all ${o}" data-index="${a}">
                                        <div class="flex justify-between items-center">
                                            <div class="flex items-center gap-4">
                                                ${e.imageUrl?`<img src="${e.imageUrl}" class="w-16 h-16 rounded-md object-cover">`:""}
                                                <div>
                                                    <h4 class="font-bold text-lg">${e.name}</h4>
                                                    <p class="text-sm text-gray-500">${e.description||""}</p>
                                                </div>
                                            </div>
                                            <p class="text-xl font-bold text-primary">${formatPrice(e.price)}</p>
                                        </div>
                                    </div>`}).join("")}
                            </div>
                        </div>
                    `),a.innerHTML=`
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 lg:gap-12">
                        <div>
                            <img id="main-product-image" src="${n.imageUrl||"https://placehold.co/600x600"}" class="w-full rounded-lg shadow-lg">
                        </div>
                        <div>
                            <h1 id="main-product-name" class="text-4xl font-extrabold mb-2">${n.name}</h1>
                            <p id="main-product-price" class="text-3xl font-bold text-primary mb-4">${formatPrice(n.price)}</p>
                            <p id="main-product-desc" class="text-gray-600 dark:text-gray-400 mb-6">${n.description}</p>
                            ${s}
                            <div class="mt-8">
                                <button id="detail-buy-btn" class="w-full btn btn-primary text-lg">Купить</button>
                            </div>
                        </div>
                    </div>
                `;let r=null;n.variations&&n.variations.length>0&&(document.getElementById("main-product-price").classList.add("hidden"),a.querySelectorAll(".variation-option").forEach(e=>{e.addEventListener("click",()=>{e.classList.contains("disabled")||(a.querySelectorAll(".variation-option").forEach(e=>e.classList.remove("selected")),e.classList.add("selected"),r=n.variations[parseInt(e.dataset.index)],document.getElementById("main-product-name").textContent=`${n.name} - ${r.name}`,document.getElementById("main-product-price").textContent=formatPrice(r.price),document.getElementById("main-product-price").classList.remove("hidden"),r.imageUrl&&r.updateMainImage&&(document.getElementById("main-product-image").src=r.imageUrl),r.description&&(document.getElementById("main-product-desc").textContent=r.description))})})),document.getElementById("detail-buy-btn").addEventListener("click",()=>{n.variations&&n.variations.length>0?r?showCheckoutModal([{...n,...r,name:`${n.name} - ${r.name}`,id:n.id}],r.price):showToast("Пожалуйста, выберите опцию",!0):showCheckoutModal([n],n.price)})}catch(e){console.error("Error loading product detail:",e),a.innerHTML='<p class="text-center text-red-500">Ошибка загрузки товара.</p>'}}async function showCheckoutModal(e,a){if(!currentUser)return void showModal("Вход","<p>Для покупки войдите в аккаунт.</p>",()=>signInWithGoogle(),"Войти");const o=await getDoc(doc(db,"users",currentUser.uid));if(o.exists()&&o.data().isBanned)return void showModal("Аккаунт заблокирован","<p>Ваш аккаунт заблокирован администратором. Совершение покупок невозможно.</p>");if(appState.balance<0)return void showModal("Отрицательный баланс","<p>У вас отрицательный баланс. Пожалуйста, пополните счет перед совершением покупок.</p>");if(!e.length)return void showToast("Корзина пуста",!0);let n=a,s=null;const r=n-appState.balance;let l="";appState.balance>=n?l+='<button class="payment-option w-full p-4 border rounded-lg text-left" data-method="balance"><strong>Списать с баланса</strong><br><span class="text-sm">Доступно: '+formatPrice(appState.balance)+"</span></button>":appState.balance>0&&(l+='<button class="payment-option w-full p-4 border rounded-lg text-left" data-method="topup"><strong>Комбинированная оплата</strong><br><span class="text-sm">Списать '+formatPrice(appState.balance)+" и пополнить на "+formatPrice(r)+"</span></button>"),l+='<button class="payment-option w-full p-4 border rounded-lg text-left" data-method="external"><strong>Оплатить напрямую</strong><br><span class="text-sm">Полная сумма: '+formatPrice(n)+"</span></button>",l+='<button class="payment-option w-full p-4 border rounded-lg text-left" data-method="topup_custom"><strong>Пополнить баланс и оплатить</strong><br><span class="text-sm">Вы сами выбираете сумму пополнения</span></button>';const c=async o=>{const r=o.querySelector("#promo-input").value.toUpperCase().trim();if(!r)return!1;const l=await getDoc(doc(db,"promocodes",r));return l.exists()?(()=>{const c=l.data(),i=e.map(e=>e.id),d=!c.productId||i.includes(c.productId);(c.uses||0)<c.limit&&d?(n=a*(1-c.discount/100),s={code:r,...c},o.querySelector("#total-price-display").textContent=formatPrice(n),showToast("Промокод применен!")):showToast("Промокод не действителен или не применим к этим товарам",!0)})():showToast("Неверный промокод",!0),!1},i=showModal("Оформление заказа",`<p>Товар: <strong>${e.length>1?`${e.length} товаров`:e[0].name}</strong></p><p>Сумма: <strong id="total-price-display">${formatPrice(n)}</strong></p>
                <div class="space-y-2 mt-4">${l}</div>
                <div class="mt-4 flex gap-2"><input id="promo-input" class="w-full modern-input" placeholder="Промокод..."><button id="apply-promo-btn" class="btn bg-gray-500 text-white">Применить</button></div>`,c,"Применить");i.querySelector(".save-modal-btn").classList.add("hidden"),i.querySelector("#apply-promo-btn").onclick=()=>c(i),i.querySelectorAll(".payment-option").forEach(o=>o.onclick=async()=>{const r=o.dataset.method;i.remove(),"balance"===r?await processBalancePurchase(e,n,s):"topup"===r?showBalanceTopUpPaymentModal(r,()=>showCheckoutModal(e,a)):"topup_custom"===r?showModal("Пополнить баланс",`<p>Введите сумму, на которую хотите пополнить баланс. Если сумма будет больше стоимости товара (${formatPrice(n)}), остаток будет зачислен на ваш счет.</p><input type="number" id="custom-topup-amount" class="w-full modern-input mt-2" placeholder="Сумма пополнения">`,e=>{const a=parseFloat(e.querySelector("#custom-topup-amount").value);a>0?(e.remove(),showBalanceTopUpPaymentModal(a,()=>showCheckoutModal(items,total))):showToast("Введите корректную сумму",!0)},"Далее"):await showExternalPaymentModal(e,n,s)})}async function processBalancePurchase(e,a,o){const n=writeBatch(db),s=doc(db,"users",currentUser.uid);n.update(s,{balance:increment(-a),balanceHistory:arrayUnion({type:"purchase",amount:-a,product:e[0].name,date:(new Date).toISOString()})});const r=doc(collection(db,"purchases"));n.set(r,{userId:currentUser.uid,userEmail:currentUser.email,orderId:generateCode(),items:e,productName:e.length>1?`${e.length} товаров`:e[0].name,status:"Выполнен",paymentMethod:"Баланс",finalPrice:a,promoCode:o?.code||null,createdAt:serverTimestamp(),review:null}),e.forEach(e=>{const a=doc(db,"products",e.id);n.update(a,{purchaseCount:increment(1)})}),await n.commit(),e.length>1&&(cart=[],localStorage.setItem("asonik_cart","[]"),updateCartCount()),showToast("Покупка совершена!"),window.location.hash="#purchases"}async function showExternalPaymentModal(e,a,o){const n=paymentMethods.filter(e=>e.isEnabled&&"card"===e.type),s=paymentMethods.filter(e=>e.isEnabled&&"ewallet"===e.type);if(!n.length&&!s.length)return void showModal("Ошибка","<p>Способы оплаты не настроены.</p>");const r=async n=>{const s=n.querySelector(".payment-option.selected");if(!s)return showToast("Пожалуйста, выберите способ оплаты.",!0),!1;const r=(await addDoc(collection(db,"purchases"),{userId:currentUser.uid,orderId:generateCode(),items:e,productName:e.length>1?`${e.length} товаров`:e[0].name,status:"Ожидает оплаты",paymentMethodId:s.dataset.methodId,finalPrice:a,promoCode:o?.code||null,createdAt:serverTimestamp(),review:null})).id;return e.length>1&&(cart=[],localStorage.setItem("asonik_cart","[]"),updateCartCount()),window.location.hash="#purchases",showProofUploadModal(r),!0},l=showModal("Выберите способ",`<div class="space-y-4">${n.length?`<div><h3 class="font-bold mb-2 border-b pb-1">Банковские карты</h3><div class="grid grid-cols-2 gap-4">${n.map(e=>`<button data-method-id="${e.id}" class="payment-option flex flex-col items-center p-2 border-2 rounded-lg h-24 transition-all"><img src="${e.logoUrl}" class="h-12 object-contain"><span class="text-sm">${e.name}</span></button>`).join("")}</div></div>`:""}${s.length?`<div><h3 class="font-bold mb-2 border-b pb-1">Электронные кошельки</h3><div class="grid grid-cols-2 gap-4">${s.map(e=>`<button data-method-id="${e.id}" class="payment-option flex flex-col items-center p-2 border-2 rounded-lg h-24 transition-all"><img src="${e.logoUrl}" class="h-12 object-contain"><span class="text-sm">${e.name}</span></button>`).join("")}</div></div>`:""}</div>`,r,"К оплате");l.querySelectorAll(".payment-option").forEach(e=>e.onclick=()=>{l.querySelectorAll(".payment-option").forEach(e=>e.classList.remove("selected")),e.classList.add("selected")})}function loadPurchasesPage(){const e=document.getElementById("purchases-content");currentUser&&(e.innerHTML='<h1 class="text-4xl font-bold text-center mb-8" data-lang-key="purchases_title"></h1><div id="purchases-list" class="space-y-6"></div>',onSnapshot(query(collection(db,"purchases"),where("userId","==",currentUser.uid),orderBy("createdAt","desc")),e=>{const a=document.getElementById("purchases-list");a&&(a.innerHTML=e.docs.map(e=>renderPurchaseItem(e.id,e.data())).join("")||'<p class="text-center">Здесь будут ваши покупки.</p>')}))}function renderPurchaseItem(e,a){const o={"Выполнен":{class:"completed",text:"Выполнен",icon:"M5 13l4 4L19 7"},"Завершен":{class:"finished",text:"Завершен",icon:"M5 13l4 4L19 7"},"Ожидает оплаты":{class:"pending",text:"Ожидает оплаты",icon:"M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"},"Ожидает подтверждения":{class:"pending",text:"Ожидает подтверждения",icon:"M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"},"Отклонен":{class:"rejected",text:"Отклонен",icon:"M6 18L18 6M6 6l12 12"},"Отменен":{class:"cancelled",text:"Отменен",icon:"M6 18L18 6M6 6l12 12"},"В обработке":{class:"processing",text:"В обработке",icon:"M4 4v5h5"}},n=o[a.status]||{class:"pending",text:a.status,icon:"M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"};let s="";return"Ожидает оплаты"===a.status&&(s+=`<button class="upload-proof-btn btn btn-primary text-sm" data-id="${e}">Загрузить чек</button><button class="cancel-purchase-btn btn btn-danger text-sm ml-2" data-id="${e}">Отменить</button>`),"Выполнен"===a.status&&!a.isTopUp&&(s+=`<button class="get-item-btn btn btn-primary text-sm ml-2" data-purchase-id="${e}">Получить товар</button>`),"Завершен"===a.status&&!a.isTopUp&&!a.review&&(s+=`<button class="leave-review-btn btn btn-primary text-sm ml-2" data-id="${e}" data-product-id="${a.items[0].id}">Оставить отзыв</button>`),`<div class="card-bg p-4 sm:p-6 rounded-lg border border-custom flex flex-col sm:flex-row gap-4 items-start shadow-md">
                <img src="${a.items[0].imageUrl||"https://placehold.co/128x128"}" class="w-full sm:w-32 h-32 sm:h-auto flex-shrink-0 object-cover rounded-md">
                <div class="flex-grow">
                    <div class="flex justify-between items-start">
                        <h3 class="font-bold text-lg">${a.productName}</h3>
                        <span class="status-badge ${n.class}"><svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${n.icon}"></path></svg>${n.text}</span>
                    </div>
                    <p class="text-sm text-gray-500">Код заказа: ${a.orderId}</p>
                    <p class="text-sm text-gray-500">Дата: ${a.createdAt?new Date(1e3*a.createdAt.seconds).toLocaleString():"N/A"}</p>
                    <p class="text-lg font-semibold mt-1">Сумма: ${formatPrice(a.finalPrice)}</p>
                    ${a.fulfillmentData?`<p class="mt-2 p-2 rounded-md bg-blue-500/10 text-blue-700 dark:text-blue-300 text-sm"><strong>Предоставленные данные:</strong> ${a.fulfillmentData}</p>`:""}
                    ${a.rejectionReason?`<p class="mt-2 p-2 rounded-md bg-red-500/10 text-red-700 dark:text-red-300 text-sm"><strong>Причина отказа:</strong> ${a.rejectionReason}</p>`:""}
                    <div class="mt-4 flex gap-2">${s}</div>
                </div>
            </div>`}function showContactModal(e){const a=`<p>Для получения товара, пожалуйста, свяжитесь с нами в Telegram и сообщите этот код заказа:</p>
            <div class="my-4 relative text-center font-mono p-2 bg-gray-200 dark:bg-gray-700 rounded-md text-lg">
                <span id="order-code-to-copy">${e}</span>
                <button id="copy-code-btn" class="absolute top-1/2 right-2 -translate-y-1/2 p-1 hover:bg-gray-300 dark:hover:bg-gray-600 rounded-md">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M7 3a1 1 0 000 2h6a1 1 0 100-2H7zM4 7a1 1 0 011-1h10a1 1 0 110 2H5a1 1 0 01-1-1zM5 11a1 1 0 100 2h4a1 1 0 100-2H5z"></path></svg>
                </button>
            </div>`,o=showModal("Связь с продавцом",a,()=>(window.open(`https://t.me/${TELEGRAM_USERNAME}?text=Здравствуйте, мой заказ ${e}`,"_blank"),!0),"Перейти в Telegram");o.querySelector("#copy-code-btn").onclick=()=>{navigator.clipboard.writeText(e),showToast("Код скопирован!")}}function showBalanceModal(){const e=async a=>{const o=parseFloat(a.querySelector("#topup-amount").value);return o&&o>0?o<appState.minimumTopUpAmount?(showToast(`Минимальная сумма пополнения: ${formatPrice(appState.minimumTopUpAmount)}`,!0),!1):(a.remove(),showBalanceTopUpPaymentModal(o),!1):(showToast("Введите корректную сумму",!0),!1)},a=`
                <div class="text-center mb-6">
                    <p class="text-gray-400">Текущий баланс</p>
                    <p id="modal-balance-display" class="text-4xl font-bold">${formatPrice(appState.balance)}</p>
                </div>
                <div class="flex gap-2">
                    <input id="topup-amount" type="number" class="w-full modern-input" placeholder="Сумма пополнения (UZS)">
                    <button id="topup-btn" class="btn btn-primary">Пополнить</button>
                    <button id="withdraw-btn" class="btn bg-red-600 text-white">Вывести</button>
                </div>
                <hr class="border-custom my-6">
                <div>
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-semibold text-lg">История операций</h3>
                        <input id="history-filter" class="modern-input text-sm w-1/2" placeholder="Фильтр (покупка, пополнение...)">
                    </div>
                    <ul id="balance-history-list" class="space-y-2 max-h-60 overflow-y-auto pr-2"></ul>
                </div>`,o=showModal("Баланс",a,null);document.getElementById("topup-btn").onclick=()=>e(o),document.getElementById("withdraw-btn").onclick=showWithdrawModal,document.getElementById("history-filter").oninput=e=>{const a=e.target.value.toLowerCase();balanceHistoryFiltered=appState.balanceHistory.filter(e=>getBalanceHistoryText(e).toLowerCase().includes(a)),document.getElementById("balance-history-list").innerHTML=renderBalanceHistory(balanceHistoryFiltered)},onSnapshot(doc(db,"users",currentUser.uid),e=>{const a=document.getElementById("modal-balance-display");if(a){const o=e.data();appState.balance=o.balance||0,appState.balanceHistory=(o.balanceHistory||[]).sort((e,a)=>new Date(a.date)-new Date(e.date)),a.textContent=formatPrice(appState.balance),document.getElementById("balance-history-list").innerHTML=renderBalanceHistory(appState.balanceHistory)}})}function getBalanceHistoryText(e)
{return"topup"===e.type?"Админ"===e.reason?"Начислено администрацией":`Пополнение (${e.method||"..."})`:"purchase"===e.type?`Покупка: ${e.product}`:"deduction"===e.type?"Админ"===e.reason?"Снято администрацией":"Списание":e.type}function renderBalanceHistory(e){if(!e.length)return'<p class="text-center text-gray-500">История пуста.</p>';let a="";return e.map(e=>{let o="";"purchase"===e.type&&(o=`<button class="go-to-purchase-btn text-xs text-primary underline" data-product-name="${e.product}">К покупке</button>`);const n=getBalanceHistoryText(e);return`<li class="flex justify-between items-center p-3 rounded-lg ${e.amount>0?"bg-green-500/10":"bg-red-500/10"}">
                    <div>
                        <span class="font-medium">${n}</span>
                        <div class="flex items-center gap-2">
                           <p class="text-xs text-gray-400">${new Date(e.date).toLocaleString()}</p>
                           ${o}
                        </div>
                    </div>
                    <span class="${e.amount>0?"text-green-500":"text-red-500"} font-semibold text-lg">${formatPrice(e.amount)}</span>
                </li>`}).join("")}function showWithdrawModal(){const e=async e=>(showToast("Функция вывода в разработке",!0),!1),a=`
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm">Сумма вывода (UZS)</label>
                        <input type="number" class="w-full modern-input" placeholder="0">
                    </div>
                    <div>
                        <label class="block text-sm">Номер карты</label>
                        <input type="text" class="w-full modern-input" placeholder="8600 0000 0000 0000">
                    </div>
                    <div>
                        <label class="block text-sm">Платежная система</label>
                        <select class="w-full modern-input">
                            <option>HUMO</option>
                            <option>UzCard</option>
                            <option>Visa</option>
                        </select>
                    </div>
                </div>
            `;showModal("Вывод средств",a,e,"Отправить заявку")}async function showBalanceTopUpPaymentModal(e,a){const o=paymentMethods.filter(e=>e.isEnabled);if(o.length){const n=async o=>{const n=o.querySelector(".payment-option.selected");if(!n)return showToast("Пожалуйста, выберите способ оплаты.",!0),!1;const s=(await addDoc(collection(db,"purchases"),{userId:currentUser.uid,userEmail:currentUser.email,orderId:generateCode(),items:[{name:`Пополнение на ${formatPrice(e)}`,imageUrl:""}],productName:"Пополнение баланса",status:"Ожидает оплаты",paymentMethodId:n.dataset.methodId,finalPrice:e,createdAt:serverTimestamp(),isTopUp:!0})).id;return window.location.hash="#purchases",showProofUploadModal(s),a&&a(),!0},s=showModal(`Пополнение на ${formatPrice(e)}`,`<div class="grid grid-cols-2 gap-4">${o.map(e=>`<button data-method-id="${e.id}" class="payment-option flex flex-col items-center p-2 border-2 rounded-lg h-24 transition-all"><img src="${e.logoUrl}" class="h-12 object-contain"><span class="text-sm">${e.name}</span></button>`).join("")}</div>`,n,"К оплате");s.querySelectorAll(".payment-option").forEach(e=>e.onclick=()=>{s.querySelectorAll(".payment-option").forEach(e=>e.classList.remove("selected")),e.classList.add("selected")})}}async function loadAdminPanel(e){if(isAdmin){const a=document.getElementById("admin-content"),o=[{id:"users",name:"Пользователи",icon:'<svg class="w-5 h-5" viewBox="0 0 20 20" fill="currentColor"><path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z" /></svg>'},{id:"products",name:"Товары",icon:'<svg class="w-5 h-5" viewBox="0 0 20 20" fill="currentColor"><path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v2a2 2 0 01-2 2H7a2 2 0 01-2-2V4zM5 12a2 2 0 012-2h6a2 2 0 012 2v2a2 2 0 01-2 2H7a2 2 0 01-2-2v-2z" /></svg>'},{id:"purchases",name:"Покупки",icon:'<svg class="w-5 h-5" viewBox="0 0 20 20" fill="currentColor"><path d="M3 1a1 1 0 000 2h1.22l.305 1.222a.997.997 0 00.01.042l1.358 5.43-.893.892C3.74 11.846 4.632 14 6.414 14H15a1 1 0 000-2H6.414l1-1H14a1 1 0 00.894-.553l3-6A1 1 0 0017 3H6.28l-.31-1.243A1 1 0 005 1H3zM16 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0zM6.5 18a1.5 1.5 0 100-3 1.5 1.5 0 000 3z" /></svg>'},{id:"reviews",name:"Отзывы",icon:'<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" /></svg>'},{id:"payment",name:"Оплата",icon:'<svg class="w-5 h-5" viewBox="0 0 20 20" fill="currentColor"><path d="M4 4a2 2 0 00-2 2v1h16V6a2 2 0 00-2-2H4z" /><path fill-rule="evenodd" d="M18 9H2v5a2 2 0 002 2h12a2 2 0 002-2V9zM4 13a1 1 0 011-1h1a1 1 0 110 2H5a1 1 0 01-1-1zm5-1a1 1 0 100 2h1a1 1 0 100-2H9z" clip-rule="evenodd" /></svg>'},{id:"customization",name:"Кастомизация",icon:'<svg class="w-5 h-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-1.57 1.996A1.532 1.532 0 013.17 8.51c-1.56.38-1.56 2.6 0 2.98a1.532 1.532 0 01.948 2.286c-.836 1.372.734 2.942 1.996 1.57a1.532 1.532 0 012.286.948c.38 1.56 2.6 1.56 2.98 0a1.532 1.532 0 012.286-.948c1.372.836 2.942-.734 1.57-1.996A1.532 1.532 0 0116.83 11.49c1.56-.38 1.56-2.6 0-2.98a1.532 1.532 0 01-.948-2.286c.836-1.372-.734-2.942-1.996-1.57A1.532 1.532 0 0111.49 3.17zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd" /></svg>'},{id:"faq",name:"FAQ",icon:'<svg class="w-5 h-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" /></svg>'},{id:"promocodes",name:"Промокоды",icon:'<svg class="w-5 h-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M17.707 9.293a1 1 0 010 1.414l-7 7a1 1 0 01-1.414 0l-7-7A.997.997 0 012 10V5a3 3 0 013-3h5a3 3 0 013 3v2.586l4.707 4.707zM5 6a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" /></svg>'},{id:"chats",name:"Чаты",icon:'<svg class="w-5 h-5" viewBox="0 0 20 20" fill="currentColor"><path d="M2 5a2 2 0 012-2h7a2 2 0 012 2v4a2 2 0 01-2 2H9l-3 3v-3H4a2 2 0 01-2-2V5z" /><path d="M15 7v2a4 4 0 01-4 4H9.828l-1.766 1.767c.28.149.599.233.938.233h7a2 2 0 002-2v-4a2 2 0 00-2-2h-1.172a4 4 0 01-3.535-1.464L12 4.343V7z" /></svg>'},{id:"download",name:"Приложение",icon:'<svg class="w-5 h-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg>'},{id:"announcement",name:"Объявления",icon:'<svg class="w-5 h-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10 2a6 6 0 00-6 6v3.586l-1.707 1.707A1 1 0 003 15h14a1 1 0 00.707-1.707L16 11.586V8a6 6 0 00-6-6zM10 18a3 3 0 01-3-3h6a3 3 0 01-3 3z" /></svg>'}];a.innerHTML=`<h2 class="text-3xl font-bold mb-6">Админ-панель</h2><nav class="admin-tabs flex flex-wrap border-b border-custom mb-6">${o.map(a=>`<a href="#admin/${a.id}" class="admin-tab-btn flex items-center gap-2 py-3 px-5 rounded-t-lg mr-2 mb-[-1px] bg-transparent font-semibold border border-transparent border-b-0 ${e===a.id?"active":""}" data-tab="${a.id}">${a.icon}<span>${a.name}</span></a>`).join("")}</nav><div id="admin-tab-content" class="card-bg p-6 rounded-lg min-h-[60vh] shadow-inner"></div>`,loadAdminTab(e)}}function loadAdminTab(e){const a=document.getElementById("admin-tab-content");a&&("users"===e?loadAdminUsers():"products"===e?loadAdminList("products","Товары",renderAdminProductItem,'<button id="add-product-btn" class="btn btn-primary">Добавить товар</button>'):"faq"===e?loadAdminList("faq","FAQ",renderAdminFaqItem,'<button id="add-faq-btn" class="btn btn-primary">Добавить</button>'):"purchases"===e?loadAdminPurchases():"reviews"===e?loadAdminReviews():"payment"===e?loadAdminList("paymentMethods","Способы оплаты",renderAdminPaymentItem,'<button id="add-payment-btn" class="btn btn-primary">Добавить</button>'):"promocodes"===e?loadAdminList("promocodes","Промокоды",renderAdminPromoItem,'<button id="add-promo-btn" class="btn btn-primary">Добавить</button>'):"customization"===e?loadCustomizationPage():"chats"===e?loadAdminChatsList(window.location.hash.split("/")[2]):"download"===e?loadAdminDownloadPage():"announcement"===e&&loadAdminAnnouncementPage())}function renderAdminPurchaseItem(e,a){let o="";return"Ожидает подтверждения"===a.status?o=`<button class="approve-purchase-btn bg-green-500 hover:bg-green-600 text-white px-3 py-1 text-sm rounded-md" data-id="${e}">Подтвердить</button>
                           <button class="reject-purchase-btn bg-red-500 hover:bg-red-600 text-white px-3 py-1 text-sm rounded-md ml-2" data-id="${e}">Отклонить</button>`:"Выполнен"===a.status&&!a.isTopUp?o=`<button class="finish-purchase-btn bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 text-sm rounded-md" data-id="${e}">Завершить</button>`:"В обработке"===a.status&&(o=`<button class="view-fulfillment-btn bg-indigo-500 hover:bg-indigo-600 text-white px-3 py-1 text-sm rounded-md" data-id="${e}">Посмотреть данные</button>`),`<div class="card-bg p-4 rounded-lg flex flex-col md:flex-row justify-between items-start md:items-center border border-custom gap-4">
                <img src="${a.items[0].imageUrl||"https://placehold.co/64x64"}" class="w-16 h-16 object-cover rounded-md flex-shrink-0">
                <div class="flex-grow">
                    <p class="font-bold">${a.productName}</p>
                    <p class="text-sm text-gray-400">Пользователь: ${a.userEmail||"N/A"}</p>
                    <p class="text-sm text-gray-400">Код: ${a.orderId}</p>
                </div>
                <div class="flex-shrink-0">
                    <p class="font-semibold">${formatPrice(a.finalPrice)}</p>
                    <p class="text-sm text-center">${a.status}</p>
                </div>
                <div class="flex-shrink-0 flex items-center gap-2">
                    ${a.paymentProofUrl?`<a href="${a.paymentProofUrl}" target="_blank" class="text-blue-500 hover:underline text-sm">Чек</a>`:""}
                    ${o}
                </div>
            </div>`}async function showProductForm(e){let a={name:"",description:"",price:0,imageUrl:"",productStatus:"official",isPinned:!1,variations:[],category:"другое",order:Date.now()};if(e){const o=await getDoc(doc(db,"products",e));o.exists()&&(a={...a,...o.data(),id:o.id})}const o=async o=>{showToast("Сохранение товара...");const n=o.querySelector("#p-image-file").files[0];let s=a.imageUrl;n&&(s=await uploadImage(n));const r=[];for(const e of o.querySelectorAll(".variation-item")){const a=e.querySelector(".v-image").files[0];let o=e.dataset.imgurl||"";a&&(o=await uploadImage(a)),r.push({name:e.querySelector(".v-name").value,price:parseFloat(e.querySelector(".v-price").value),description:e.querySelector(".v-desc").value,imageUrl:o,updateMainImage:e.querySelector(".v-update-main-image").checked,fulfillmentPrompt:e.querySelector(".v-fulfillment-prompt").value,isAutomationEnabled:e.querySelector(".v-automation-enabled").checked,isOutOfStock:e.querySelector(".v-out-of-stock").checked})}const l={name:o.querySelector("#p-name").value,description:o.querySelector("#p-desc").value,price:parseFloat(o.querySelector("#p-price").value)||0,imageUrl:s,productStatus:o.querySelector('input[name="product-status"]:checked').value,isPinned:o.querySelector("#p-pinned").checked,variations:r,category:o.querySelector("#p-category").value,order:parseInt(o.querySelector("#p-order").value)||Date.now(),createdAt:a.createdAt||serverTimestamp(),updatedAt:serverTimestamp()};return e?await setDoc(doc(db,"products",e),l,{merge:!0}):await addDoc(collection(db,"products"),l),showToast("Товар успешно сохранен!"),!0},n=`
                <div class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="p-name" class="block text-sm font-medium mb-1">Название товара</label>
                            <input id="p-name" value="${a.name||""}" class="w-full modern-input" placeholder="Например, 'Игровой аккаунт'">
                        </div>
                        <div>
                            <label for="p-category" class="block text-sm font-medium mb-1">Категория</label>
                            <select id="p-category" class="w-full modern-input">
                                <option value="игра" ${"игра"===a.category?"selected":""}>Игра</option>
                                <option value="приложение" ${"приложение"===a.category?"selected":""}>Приложение</option>
                                <option value="другое" ${"другое"===a.category?"selected":""}>Другое</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label for="p-desc" class="block text-sm font-medium mb-1">Описание</label>
                        <textarea id="p-desc" class="w-full modern-input" rows="4" placeholder="Подробное описание товара...">${a.description||""}</textarea>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="p-price" class="block text-sm font-medium mb-1">Базовая цена (в UZS)</label>
                            <input id="p-price" type="number" value="${a.price||0}" class="w-full modern-input" placeholder="0">
                        </div>
                        <div>
                            <label for="p-order" class="block text-sm font-medium mb-1">Порядок сортировки</label>
                            <input id="p-order" type="number" value="${a.order||""}" class="w-full modern-input" placeholder="Чем меньше, тем выше">
                        </div>
                    </div>
                    <div>
                        <label for="p-image-file" class="block text-sm font-medium mb-1">Изображение товара</label>
                        <input type="file" id="p-image-file" class="w-full text-sm file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-primary/10 file:text-primary hover:file:bg-primary/20">
                        ${a.imageUrl?`<img src="${a.imageUrl}" class="mt-2 w-24 h-24 object-cover rounded-md">`:""}
                    </div>
                     <div>
                        <label class="block text-sm font-medium mb-2">Статус товара</label>
                        <div class="flex gap-4">
                            <label class="flex items-center">
                                <input type="radio" name="product-status" value="official" ${"official"===a.productStatus?"checked":""} class="h-4 w-4 text-primary focus:ring-primary border-gray-300">
                                <span class="ml-2">Гарантированный товар</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="product-status" value="private" ${"private"===a.productStatus||!a.productStatus?"checked":""} class="h-4 w-4 text-primary focus:ring-primary border-gray-300">
                                <span class="ml-2">Частный продавец</span>
                            </label>
                        </div>
                    </div>
                    <div class="flex items-center">
                        <input type="checkbox" id="p-pinned" ${a.isPinned?"checked":""} class="h-4 w-4 rounded border-gray-300 text-primary focus:ring-primary">
                        <label for="p-pinned" class="ml-2 block text-sm">Закрепить товар (будет первым в списке)</label>
                    </div>
                    <hr class="border-custom">
                    <h4 class="font-bold">Вариации товара</h4>
                    <div id="variations-container" class="space-y-4"></div>
                    <button type="button" id="add-variation-btn" class="mt-2 btn bg-gray-500 text-white text-sm">+ Добавить вариацию</button>
                </div>`,s=showModal(e?"Редактировать товар":"Добавить товар",n,o,"Сохранить"),r=e=>{const a=document.createElement("div");a.className="variation-item border-2 p-4 rounded-lg space-y-3",a.dataset.imgurl=e.imageUrl||"",a.innerHTML=`
                    <input class="v-name w-full modern-input" value="${e.name||""}" placeholder="Название вариации (например, 50 гемов)">
                    <input type="number" class="v-price w-full modern-input" value="${e.price||0}" placeholder="Цена вариации">
                    <textarea class="v-desc w-full modern-input" placeholder="Краткое описание вариации">${e.description||""}</textarea>
                    <input type="file" class="v-image text-xs w-full file:mr-2 file:py-1 file:px-2 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-primary/10 file:text-primary hover:file:bg-primary/20">
                    ${e.imageUrl?`<img src="${e.imageUrl}" class="mt-2 w-16 h-16 object-cover rounded-md">`:""}
                    <hr class="border-custom">
                    <div class="p-2 bg-primary/10 rounded-lg space-y-2">
                         <div class="flex items-center gap-2">
                            <input type="checkbox" class="v-automation-enabled h-4 w-4 rounded border-gray-300 text-primary" ${e.isAutomationEnabled?"checked":""}>
                            <label class="text-sm font-semibold">Включить автоматизацию</label>
                        </div>
                        <input class="v-fulfillment-prompt w-full modern-input" value="${e.fulfillmentPrompt||""}" placeholder="Текст запроса (напр. Введите ваш ID)">
                    </div>
                     <hr class="border-custom">
                    <div class="flex items-center gap-2">
                        <input type="checkbox" class="v-update-main-image h-4 w-4 rounded border-gray-300 text-primary" ${e.updateMainImage?"checked":""}>
                        <label class="text-sm">Менять главное фото при выборе</label>
                    </div>
                     <div class="flex items-center gap-2">
                        <input type="checkbox" class="v-out-of-stock h-4 w-4 rounded border-gray-300 text-primary" ${e.isOutOfStock?"checked":""}>
                        <label class="text-sm">Нет в наличии</label>
                    </div>

                    <div class="text-right"><button type="button" class="remove-variation-btn btn btn-danger px-3 py-1 text-sm">Удалить</button></div>
                `,s.querySelector("#variations-container").appendChild(a)};(a.variations||[]).forEach(r),s.querySelector("#add-variation-btn").onclick=()=>r(),s.onclick=e=>{e.target.classList.contains("remove-variation-btn")&&e.target.closest(".variation-item").remove()}}async function loadCustomizationPage(){const e=document.getElementById("admin-tab-content"),a=(await getDoc(doc(db,"storeSettings","config"))).data()||{};e.innerHTML=`<div class="space-y-8">
                <div>
                    <h3 class="text-xl font-bold mb-2">Общие настройки</h3>
                    <label class="block text-sm">Название сайта</label>
                    <input id="site-name-input" class="w-full modern-input mt-1" value="${a.siteName||"Asonik | Store"}">
                    <label class="block text-sm mt-2">Минимальная сумма пополнения (в UZS)</label>
                    <input id="min-topup-input" type="number" class="w-full modern-input mt-1" value="${a.minimumTopUpAmount||1e3}">
                    <label class="block text-sm mt-2">Сообщение для гостей</label>
                    <textarea id="guest-prompt-input" class="w-full modern-input mt-1" rows="3">${a.guestPromptMessage||""}</textarea>
                    <button id="save-general-settings-btn" class="btn btn-primary mt-2">Сохранить</button>
                </div>
                <hr class="border-custom">
                <div>
                     <div class="flex justify-between items-center mb-2">
                        <h3 class="text-xl font-bold">Рекламные баннеры</h3>
                        <button id="clear-banners-btn" class="btn bg-red-600 text-white text-sm">Очистить все</button>
                    </div>
                    <div id="banners-list" class="space-y-2"></div>
                    <button id="add-banner-btn" class="btn btn-primary mt-2">Добавить баннер</button>
                </div>
                <hr class="border-custom">
                <div>
                    <h3 class="text-xl font-bold mb-2">Настройка темы</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="p-4 card-bg rounded-lg border border-custom">
                            <h4 class="font-semibold mb-2">Светлая тема</h4>
                            <label class="block text-sm">Основной цвет</label>
                            <input type="color" id="primary-light-picker" value="${a.themeColors?.primaryLight||"#673ab7"}">
                            <label class="block text-sm mt-2">Цвет фона</label>
                            <input type="color" id="bg-light-picker" value="${a.themeColors?.bgLight||"#f3e5f5"}">
                        </div>
                        <div class="p-4 card-bg rounded-lg border border-custom">
                            <h4 class="font-semibold mb-2">Темная тема</h4>
                            <label class="block text-sm">Основной цвет</label>
                            <input type="color" id="primary-dark-picker" value="${a.themeColors?.primaryDark||"#9575cd"}">
                            <label class="block text-sm mt-2">Цвет фона</label>
                            <input type="color" id="bg-dark-picker" value="${a.themeColors?.bgDark||"#1a102c"}">
                        </div>
                    </div>
                    <button id="save-theme-btn" class="btn btn-primary mt-4">Сохранить тему</button>
                    <button id="reset-theme-btn" class="btn bg-gray-500 text-white mt-4 ml-2">Сбросить</button>
                </div>
                <hr class="border-custom">
                <div>
                    <h3 class="text-xl font-bold">Логотип</h3>
                    <input type="file" id="logo-upload-input" class="mt-2"><button id="save-logo-btn" class="btn btn-primary ml-2">Сохранить лого</button>
                </div>
                <hr class="border-custom">
                <div>
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-xl font-bold">Социальные сети</h3>
                        <button id="clear-social-links-btn" class="btn bg-red-600 text-white text-sm">Очистить все</button>
                    </div>
                    <div id="social-links-admin" class="space-y-2 mt-2"></div>
                    <button id="add-social-link-btn" class="btn bg-green-500 text-white mt-2">Добавить ссылку</button>
                </div>
            </div>`,renderAdminSocialLinks(a.socialLinks),renderAdminBanners(a.adBanners)}function applyCustomTheme(e){const a=document.documentElement;e.primaryLight&&a.style.setProperty("--primary-light",e.primaryLight),e.bgLight&&a.style.setProperty("--bg-light",e.bgLight),e.primaryDark&&a.style.setProperty("--primary-dark",e.primaryDark),e.bgDark&&a.style.setProperty("--bg-dark",e.bgDark)}function initTheme(){const e=document.getElementById("theme-toggle");if(e){const a=e=>{e.innerHTML="dark"===(e=>{document.documentElement.classList.contains("dark")?document.documentElement.classList.remove("dark"):document.documentElement.classList.add("dark")})?"☀️":"🌙"};a(localStorage.getItem("color-theme")||"light"),e.onclick=()=>{const e=document.documentElement.classList.contains("dark")?"light":"dark";localStorage.setItem("color-theme",e),a(e)}}}async function updateAuthUI(){const e=document.getElementById("auth-container");if(e)if(currentUser){const a=await getDoc(doc(db,"users",currentUser.uid)),o=a.data()||{};e.innerHTML=`
                    <div class="relative">
                        <button id="profile-btn" class="flex items-center gap-2 p-1 pr-2 rounded-full hover:bg-black/10 dark:hover:bg-white/10">
                            <img src="${currentUser.photoURL||"https://placehold.co/32x32"}" class="w-8 h-8 rounded-full object-cover">
                            <span class="hidden md:inline font-semibold">${o.nickname||currentUser.displayName}</span>
                            <svg class="w-4 h-4 opacity-70" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
                        </button>
                        <div id="profile-menu" class="hidden absolute right-0 mt-2 w-60 card-bg rounded-md shadow-lg z-10 border border-custom">
                            <div class="p-4 border-b border-custom">
                                <p class="font-bold truncate">${currentUser.displayName}</p>
                            </div>
                            <a href="#profile" class="nav-link block px-4 py-2 hover:bg-primary/10">Профиль</a>
                            <a href="#settings" class="nav-link block px-4 py-2 hover:bg-primary/10">Настройки</a>
                            ${isAdmin?`<a href="#admin" class="nav-link block px-4 py-2 hover:bg-primary/10">Админ-панель</a>`:""}
                            <a href="#" id="logout-btn" class="block px-4 py-2 text-red-500 hover:bg-red-500/10">Выйти</a>
                        </div>
                    </div>`}else e.innerHTML='<button id="google-login-btn" class="btn btn-primary">Войти</button>'}function signInWithGoogle(){const e=new GoogleAuthProvider;signInWithPopup(auth,e).catch(e=>showToast("Ошибка: "+e.message,!0))}function setupEventListeners(){window.addEventListener("hashchange",handleRouting),document.body.addEventListener("click",async e=>{const{target:a}=e,o=e=>a.closest(e);"mobile-menu-btn"===a.id?(document.getElementById("mobile-menu").classList.remove("hidden"),setTimeout(()=>document.getElementById("mobile-menu").classList.remove("opacity-0"),10)):"mobile-menu-close-btn"===a.id||o("#mobile-menu-panel")||(document.getElementById("mobile-menu").classList.add("opacity-0"),setTimeout(()=>document.getElementById("mobile-menu").classList.add("hidden"),300)),o("#profile-btn")||o("#profile-menu")||document.getElementById("profile-menu")?.classList.add("hidden"),o("#notifications-btn")||o("#notifications-dropdown")||document.getElementById("notifications-dropdown")?.classList.add("hidden"),o(".nav-link")&&(e.preventDefault(),window.location.hash=(new URL(o(".nav-link").href)).hash),o(".admin-tab-btn")&&(e.preventDefault(),window.location.hash=`admin/${o(".admin-tab-btn").dataset.tab}`),"google-login-btn"===a.id||"login-redirect"===a.id?signInWithGoogle():"logout-btn"===a.id||"logout-btn-profile"===a.id?signOut(auth):"balance-btn"===a.id?showBalanceModal():o(".buy-now-btn")?(()=>{const e=allProducts.find(e=>e.id===o(".buy-now-btn").dataset.productId);e&&showCheckoutModal([e],e.price||0)})():o(".add-to-cart-btn")?addToCart(o(".add-to-cart-btn").dataset.productId):o(".remove-from-cart-btn")?(cart.splice(o(".remove-from-cart-btn").dataset.index,1),localStorage.setItem("asonik_cart",JSON.stringify(cart)),renderCartPage(),updateCartCount()):"checkout-cart-btn"===a.id?showCheckoutModal(cart,cart.reduce((e,a)=>e+(a.price||0),0)):o(".faq-question")?o(".faq-question").classList.toggle("open"):o(".get-item-btn")?(async()=>{const e=o(".get-item-btn").dataset.purchaseId,a=await getDoc(doc(db,"purchases",e));if(a.exists()){const e=a.data(),o=e.items[0];o.isAutomationEnabled&&o.fulfillmentPrompt?showFulfillmentModal(e,o.fulfillmentPrompt):showContactModal(e.orderId)}})():o(".cancel-purchase-btn")?confirmAction("Вы уверены, что хотите отменить заказ?",async()=>await updateDoc(doc(db,"purchases",o(".cancel-purchase-btn").dataset.id),{status:"Отменен"})):o(".upload-proof-btn")?showProofUploadModal(o(".upload-proof-btn").dataset.id):o("#profile-btn")?(e.stopPropagation(),document.getElementById("profile-menu")?.classList.toggle("hidden")):o(".wishlist-btn")||o(".wishlist-remove-btn-icon")?(async()=>{if(!currentUser)return void showToast("Пожалуйста, войдите, чтобы добавлять в избранное.");const e=o(".wishlist-btn")||o(".wishlist-remove-btn-icon"),a=e.dataset.productId,n=doc(db,"users",currentUser.uid);await updateDoc(n,{wishlist:userWishlist.includes(a)?arrayRemove(a):arrayUnion(a)})})():"add-product-btn"===a.id?showProductForm():"add-promo-btn"===a.id?showPromoForm():o(".edit-btn")?(()=>{const{id:e,type:a}=o(".edit-btn").dataset;"product"===a?showProductForm(e):"promocode"===a&&showPromoForm(e)})():o(".delete-btn")?confirmAction("Вы уверены, что хотите удалить этот элемент?",async()=>await deleteDoc(doc(db,o(".delete-btn").dataset.collection,o(".delete-btn").dataset.id))):o(".leave-review-btn")?showReviewForm(o(".leave-review-btn").dataset.id,o(".leave-review-btn").dataset.productId):o(".approve-purchase-btn")?(async()=>{const{id:e}=o(".approve-purchase-btn").dataset;await updateDoc(doc(db,"purchases",e),{status:"Выполнен"}),showToast("Заказ подтвержден!")})():o(".view-fulfillment-btn")?(async()=>{const e=o(".view-fulfillment-btn").dataset.id,a=await getDoc(doc(db,"purchases",e));a.exists()&&showFulfillmentDataModal(e,a.data().fulfillmentData)})():o(".finish-purchase-btn")?(async()=>{const{id:e}=o(".finish-purchase-btn").dataset;await updateDoc(doc(db,"purchases",e),{status:"Завершен"}),showToast("Заказ завершен!")})():o(".reject-purchase-btn")?(()=>{const e=o(".reject-purchase-btn").dataset.id;showModal("Укажите причину отказа (необязательно)",'<input id="rejection-reason" class="w-full modern-input" placeholder="Например, неверные данные чека">',async a=>{const o=a.querySelector("input").value;return await updateDoc(doc(db,"purchases",e),{status:"Отклонен",rejectionReason:o||"Причина не указана"}),showToast("Заказ отклонен."),!0},"Отклонить")})():o(".ban-user-btn")?(async()=>{const e=o(".ban-user-btn").dataset.uid,a=doc(db,"users",e),n=(await getDoc(a)).data().isBanned||!1;confirmAction(`Вы уверены, что хотите ${n?"разбанить":"забанить"} этого пользователя?`,async()=>{await updateDoc(a,{isBanned:!n}),showToast(`Пользователь ${n?"разбанен":"забанен"}`)})})():o(".add-balance-btn")||o(".remove-balance-btn")||o(".annul-balance-btn")?(()=>{const e=o("button"),a=e.dataset.uid,n=e.parentElement.querySelector(".user-balance-input");if(e.classList.contains("annul-balance-btn"))return void confirmAction("Вы уверены, что хотите обнулить баланс этого пользователя?",async()=>{const e=(await getDoc(doc(db,"users",a))).data().balance||0;await updateDoc(doc(db,"users",a),{balance:0,balanceHistory:arrayUnion({type:"deduction",amount:-e,date:(new Date).toISOString(),reason:"Админ (Обнуление)"})}),showToast("Баланс обнулен")});const s=e.classList.contains("add-balance-btn"),r=parseFloat(n.value);isNaN(r)||r<=0?showToast("Введите корректную сумму",!0):confirmAction(`${s?"Добавить":"Снять"} ${formatPrice(r)} с баланса пользователя?`,async()=>{await updateDoc(doc(db,"users",a),{balance:increment(s?r:-r),balanceHistory:arrayUnion({type:s?"topup":"deduction",amount:s?r:-r,date:(new Date).toISOString(),reason:"Админ"})}),showToast("Баланс изменен"),n.value=""})})():"save-theme-btn"===a.id?(async()=>{const e={primaryLight:document.getElementById("primary-light-picker").value,bgLight:document.getElementById("bg-light-picker").value,primaryDark:document.getElementById("primary-dark-picker").value,bgDark:document.getElementById("bg-dark-picker").value};await setDoc(doc(db,"storeSettings","config"),{themeColors:e},{merge:!0}),applyCustomTheme(e),showToast("Тема сохранена!")})():"reset-theme-btn"===a.id?confirmAction("Сбросить цвета темы к стандартным?",async()=>{const e={primaryLight:"#673ab7",bgLight:"#f3e5f5",primaryDark:"#9575cd",bgDark:"#1a102c"};await setDoc(doc(db,"storeSettings","config"),{themeColors:e},{merge:!0}),applyCustomTheme(e),loadCustomizationPage(),showToast("Тема сброшена!")}):"save-general-settings-btn"===a.id?(async()=>{const e=document.getElementById("site-name-input").value,a=parseFloat(document.getElementById("min-topup-input").value),o=document.getElementById("guest-prompt-input").value;e&&a>0?(await setDoc(doc(db,"storeSettings","config"),{siteName:e,minimumTopUpAmount:a,guestPromptMessage:o},{merge:!0}),showToast("Общие настройки сохранены!"),loadStoreSettings(),updateAuthUI()):showToast("Проверьте введенные данные",!0)})():"add-banner-btn"===a.id?showBannerForm():"clear-banners-btn"===a.id?confirmAction("Вы уверены, что хотите удалить все баннеры?",async()=>{await setDoc(doc(db,"storeSettings","config"),{adBanners:[]},{merge:!0}),showToast("Все баннеры удалены"),loadCustomizationPage()}):o(".delete-banner-btn")?(async()=>{const e=o(".delete-banner-btn").dataset.index,a=(await getDoc(doc(db,"storeSettings","config"))).data()||{};let n=a.adBanners||[];n.splice(e,1),await setDoc(doc(db,"storeSettings","config"),{adBanners:n},{merge:!0}),showToast("Баннер удален"),loadCustomizationPage()})():"add-social-link-btn"===a.id?showSocialLinkForm():"clear-social-links-btn"===a.id?confirmAction("Вы уверены, что хотите удалить все социальные сети?",async()=>{await setDoc(doc(db,"storeSettings","config"),{socialLinks:[]},{merge:!0}),showToast("Все социальные сети удалены"),loadCustomizationPage()}):o(".delete-social-link-btn")?(async()=>{const e=o(".delete-social-link-btn").dataset.id,a=(await getDoc(doc(db,"storeSettings","config"))).data()||{};let n=(a.socialLinks||[]).filter(a=>a.id!==e);await setDoc(doc(db,"storeSettings","config"),{socialLinks:n},{merge:!0}),showToast("Ссылка удалена"),loadCustomizationPage()})():"save-announcement-btn"===a.id&&(async()=>{const e=document.getElementById("announcement-message").value,a=document.getElementById("announcement-enabled").checked;await setDoc(doc(db,"storeSettings","config"),{announcement:{message:e,enabled:a}},{merge:!0}),showToast("Объявление сохранено!"),appState.announcement={message:e,enabled:a}})})}function showFulfillmentDataModal(e,a){const o=`<p class="mb-2">Данные, предоставленные клиентом:</p>
            <div class="p-4 bg-gray-200 dark:bg-gray-700 rounded-lg font-mono">${a}</div>`;showModal("Данные заказа",o,async()=>(await updateDoc(doc(db,"purchases",e),{status:"Завершен"}),showToast("Заказ завершен!"),!0),"Завершить заказ")}function showFulfillmentModal(e,a){const o=async a=>{const o=a.querySelector("#fulfillment-input").value;return o.trim()?(await updateDoc(doc(db,"purchases",e),{status:"В обработке",fulfillmentData:o}),showToast("Данные отправлены на обработку!"),!0):(showToast("Пожалуйста, введите данные",!0),!1)},n=`
                <p class="mb-4">${a}</p>
                <input id="fulfillment-input" class="w-full modern-input" placeholder="Ваши данные...">
            `;showModal("Получение товара",n,o,"Отправить")}async function showProofUploadModal(e){const a=doc(db,"purchases",e),o=await getDoc(a);if(!o.exists())return void showToast("Заказ не найден",!0);const n=o.data(),s=paymentMethods.find(e=>e.id===n.paymentMethodId);if(!s)return void showToast("Способ оплаты не найден",!0);let r=`<p class="my-2 p-2 bg-gray-200 dark:bg-gray-700 rounded font-mono">${s.requisites}</p>`;s.name.toLowerCase().includes("yoomoney")&&s.qrCodeUrl&&(r+=`<div class="mt-4 flex justify-center"><img src="${s.qrCodeUrl}" alt="YooMoney QR Code" class="w-48 h-48"></div>`);const l=async o=>{const s=o.querySelector("#proof-file-input"),r=s.files[0];if(!r)return showToast("Пожалуйста, выберите файл",!0),!1;showToast("Загрузка чека...");const l=await uploadImage(r);return l?(await updateDoc(a,{paymentProofUrl:l,status:"Ожидает подтверждения"}),showToast("Чек успешно загружен!"),!0):(showToast("Ошибка загрузки изображения",!0),!1)},c=`
                <div>
                    <p>Пожалуйста, переведите <strong>${formatPrice(n.finalPrice)}</strong> на следующие реквизиты:</p>
                    <p class="font-semibold">${s.name}</p>
                    ${r}
                    <p class="mt-4">После оплаты, загрузите чек (скриншот) подтверждающий перевод.</p>
                    <input type="file" id="proof-file-input" class="w-full modern-input mt-2" accept="image/*">
                </div>
            `;showModal("Загрузка чека",c,l,"Отправить чек")}function renderAdminPaymentItem(e,a){return`<div class="card-bg p-4 rounded flex justify-between items-center border border-custom"><div><img src="${a.logoUrl}" class="h-8 inline-block mr-4"><p class="inline-block">${a.name}</p></div><div class="flex items-center gap-4"><input type="checkbox" class="toggle-payment-btn" data-id="${e}" ${a.isEnabled?"checked":""}><button class="edit-btn" data-id="${e}" data-type="payment">Ред.</button><button class="delete-btn text-red-500" data-collection="paymentMethods" data-id="${e}">Удл.</button></div></div>`}function renderAdminSocialLinks(e){const a=document.getElementById("social-links-admin");a&&(a.innerHTML=(e||[]).map(e=>`<div class="flex items-center justify-between gap-2 p-2 card-bg rounded"><span>${e.name} (${e.url})</span><button class="delete-social-link-btn btn btn-danger text-sm" data-id="${e.id}">Удалить</button></div>`).join(""))}function renderAdminFaqItem(e,a){return`<div class="card-bg p-4 rounded flex justify-between items-center border border-custom"><div><p>${a.question}</p></div><div><button class="edit-btn text-blue-400 mr-4" data-id="${e}" data-type="faq">Ред.</button><button class="delete-btn text-red-500" data-collection="faq" data-id="${e}">Удл.</button></div></div>`}function renderAdminPromoItem(e,a){const o=a.productId?allProducts.find(e=>e.id===a.productId):null;return`<div class="card-bg p-4 rounded border border-custom">
                Код: <strong>${a.code}</strong>, Скидка: ${a.discount}%, Исп: ${a.uses||0}/${a.limit}, ${o?`Для: <strong>${o.name}</strong>`:"Для всех товаров"}
                <div class="float-right">
                    <button class="edit-btn text-blue-400 mr-4" data-id="${e}" data-type="promocode">Ред.</button>
                    <button class="delete-btn text-red-500" data-collection="promocodes" data-id="${e}">Удл.</button>
                </div>
            </div>`}async function loadAdminDownloadPage(){const e=document.getElementById("admin-tab-content"),a=(await getDoc(doc(db,"storeSettings","config"))).data()?.appDownload||{};e.innerHTML=`<h3>Страница "Скачать"</h3><div class="max-w-xl space-y-4"><div><label>Описание</label><textarea id="download-description" class="w-full p-2 border rounded input-bg">${a.description||""}</textarea></div><div><label>Ссылка .exe</label><input id="download-exe-link" class="w-full p-2 border rounded" value="${a.exeLink||""}"></div><div><label>Ссылка .apk</label><input id="download-apk-link" class="w-full p-2 border rounded" value="${a.apkLink||""}"></div><button id="save-download-settings-btn" class="btn btn-primary">Сохранить</button></div>`}async function loadAdminAnnouncementPage(){const e=document.getElementById("admin-tab-content"),a=(await getDoc(doc(db,"storeSettings","config"))).data()||{},o=a.announcement||{message:"",enabled:!1};e.innerHTML=`<h3 class="text-2xl font-bold mb-4">Объявление для всех</h3><div class="space-y-4 max-w-xl"><div><label for="announcement-message" class="block text-sm font-medium mb-1">Текст сообщения</label><textarea id="announcement-message" class="w-full modern-input" rows="4">${o.message}</textarea></div><div class="flex items-center"><input type="checkbox" id="announcement-enabled" ${o.enabled?"checked":""} class="h-4 w-4 rounded border-gray-300 text-primary focus:ring-primary"><label for="announcement-enabled" class="ml-2 block text-sm">Включить объявление</label></div><button id="save-announcement-btn" class="btn btn-primary">Сохранить</button></div>`}function loadFaq(){const e=document.getElementById("faq-content");if(e){e.innerHTML='<div class="max-w-4xl mx-auto"><h1 class="text-4xl font-bold text-center mb-12" data-lang-key="faq_title"></h1><div id="faq-list" class="space-y-4"></div></div>';const a=document.getElementById("faq-list");onSnapshot(collection(db,"faq"),e=>{a.innerHTML=e.docs.map(e=>{const a=e.data();return`<div class="card-bg rounded-lg shadow border border-custom"><button class="faq-question w-full text-left p-6 font-bold flex justify-between items-center text-lg"><span>${a.question}</span><svg class="faq-icon w-6 h-6 text-primary" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg></button><div class="faq-answer"><p class="p-6 pt-0">${a.answer}</p></div></div>`}).join("")})}}async function loadProfilePage(){const e=document.getElementById("profile-content");if(e&&currentUser){const a=await getDoc(doc(db,"users",currentUser.uid)),o=a.data()||{},n=await getDocs(query(collection(db,"purchases"),where("userId","==",currentUser.uid),orderBy("createdAt","desc"))),s=n.docs.map(e=>renderPurchaseItem(e.id,e.data())).join("")||'<p class="text-center text-gray-500 mt-4">У вас еще нет покупок.</p>';e.innerHTML=`
                <h1 class="text-4xl font-bold text-center mb-8" data-lang-key="profile_title"></h1>
                <div class="max-w-4xl mx-auto card-bg p-8 rounded-2xl shadow-lg space-y-8">
                    <div class="flex flex-col md:flex-row items-center gap-8">
                        <div class="flex flex-col items-center">
                            <img id="profile-avatar" src="${currentUser.photoURL||"https://placehold.co/128x128"}" class="w-32 h-32 rounded-full mb-4 shadow-md">
                            <input type="file" id="avatar-upload" class="hidden" accept="image/*">
                            <button id="change-avatar-btn" class="text-sm text-primary hover:underline">Сменить фото</button>
                        </div>
                        <div class="flex-grow w-full space-y-4">
                             <div>
                                <label for="profile-firstname" class="block text-sm font-medium text-gray-400">Имя</label>
                                <input id="profile-firstname" class="w-full p-2 border-b-2 bg-transparent focus:outline-none focus:border-primary text-xl" value="${o.firstName||""}">
                            </div>
                             <div>
                                <label for="profile-lastname" class="block text-sm font-medium text-gray-400">Фамилия</label>
                                <input id="profile-lastname" class="w-full p-2 border-b-2 bg-transparent focus:outline-none focus:border-primary text-xl" value="${o.lastName||""}">
                            </div>
                            <div>
                                <label for="profile-nickname" class="block text-sm font-medium text-gray-400">Никнейм</label>
                                <input id="profile-nickname" class="w-full p-2 border-b-2 bg-transparent focus:outline-none focus:border-primary text-xl" value="${o.nickname||""}">
                            </div>
                        </div>
                    </div>
                    <div class="mt-8 flex gap-4">
                        <button id="save-profile-btn" class="flex-grow btn btn-primary">Сохранить</button>
                        <button id="reset-profile-btn" class="btn bg-yellow-500 text-white">Сбросить</button>
                        <button id="logout-btn-profile" class="flex-grow btn btn-danger">Выйти</button>
                    </div>
                    <div>
                        <h2 class="text-2xl font-bold mt-12 mb-6 border-b pb-2">История покупок</h2>
                        <div class="space-y-6">${s}</div>
                    </div>
                </div>`,document.getElementById("change-avatar-btn").onclick=()=>document.getElementById("avatar-upload").click(),document.getElementById("avatar-upload").onchange=async e=>{const a=e.target.files[0];if(a){showToast("Загрузка фото...");const e=await uploadImage(a,`avatars/${currentUser.uid}`);e?(await updateProfile(auth.currentUser,{photoURL:e}),await updateDoc(doc(db,"users",currentUser.uid),{photoURL:e}),showToast("Аватар обновлен!"),document.getElementById("profile-avatar").src=e,await updateAuthUI()):showToast("Ошибка загрузки фото",!0)}},document.getElementById("save-profile-btn").onclick=async()=>{const e=document.getElementById("profile-firstname").value,a=document.getElementById("profile-lastname").value,o=document.getElementById("profile-nickname").value;await updateDoc(doc(db,"users",currentUser.uid),{firstName:e,lastName:a,nickname:o}),showToast("Профиль обновлен!"),updateAuthUI()},document.getElementById("reset-profile-btn").onclick=()=>{confirmAction("Вы уверены, что хотите сбросить профиль? Имя, фамилия, никнейм и фото будут удалены.",async()=>{const e=`Пользователь${currentUser.uid.substring(0,5)}`;await updateDoc(doc(db,"users",currentUser.uid),{firstName:"",lastName:"",nickname:e,photoURL:""}),await updateProfile(auth.currentUser,{photoURL:""}),showToast("Профиль сброшен!"),loadProfilePage()})}}}function loadDownloadPage(){const e=document.getElementById("download-content"),a=appState.appDownload||{};e.innerHTML=`<div class="max-w-xl mx-auto card-bg p-8 rounded-lg text-center"><h1 class="text-4xl font-bold mb-4" data-lang-key="download_title"></h1><p class="mb-6">${a.description||"Ссылки не настроены"}</p><div class="flex flex-col gap-4">${a.exeLink?`<a href="${a.exeLink}" class="w-full btn btn-primary">Windows (.exe)</a>`:""}${a.apkLink?`<a href="${a.apkLink}" class="w-full btn btn-primary">Android (.apk)</a>`:""}</div></div>`,translatePage()}async function loadChatsPage(e){const a=document.getElementById("chats-content");if(a&&currentUser){if(isAdmin)return void loadAdminChatsList(e);const o=`${currentUser.uid}_${ADMIN_UID}`,n=doc(db,"userChats",currentUser.uid);await setDoc(n,{lastActivity:serverTimestamp(),partnerId:ADMIN_UID,partnerName:"Поддержка",userName:currentUser.displayName,userId:currentUser.uid},{merge:!0}),a.innerHTML='<h1 class="text-4xl font-bold text-center mb-8" data-lang-key="nav_chats"></h1>',renderChatInterface(a,o,"Чат с поддержкой",currentUser.uid)}}function loadWishlistPage(){const e=document.getElementById("wishlist-content"),a=allProducts.filter(e=>userWishlist.includes(e.id));e.innerHTML=`<h1 class="text-4xl font-bold text-center mb-8">Избранное</h1>${a.length?`<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">${a.map(e=>`<div class="relative group">
                                ${renderProductCard(e)}
                            </div>`).join("")}</div>`:'<p class="text-center">Здесь будут товары, которые вы добавили в избранное.</p>'}`}function addToCart(e){const a=allProducts.find(a=>a.id===e);a&&(cart.push({id:a.id,name:a.name,price:a.price,imageUrl:a.imageUrl}),localStorage.setItem("asonik_cart",JSON.stringify(cart)),updateCartCount(),showToast("Добавлено в корзину"))}function updateCartCount(){const e=document.getElementById("cart-count");e&&(e.textContent=cart.length,e.classList.toggle("hidden",0===cart.length))}function renderCartPage(){const e=document.getElementById("cart-content");if(e.innerHTML='<h1 class="text-4xl font-bold text-center mb-8" data-lang-key="cart_title"></h1>',0===cart.length)return void(e.innerHTML+='<p class="text-center">Ваша корзина пуста.</p>');let a=cart.reduce((e,a)=>e+(a.price||0),0);e.innerHTML+=`<div class="space-y-4">${cart.map((e,a)=>`<div class="card-bg p-4 rounded-lg flex justify-between items-center"><div class="flex items-center gap-4"><img src="${e.imageUrl||""}" class="w-16 h-16 rounded object-cover"><p>${e.name}</p></div><div class="flex items-center gap-4"><span>${formatPrice(e.price)}</span><button class="remove-from-cart-btn text-red-500 font-bold text-xl" data-index="${a}">&times;</button></div></div>`).join("")}</div><div class="mt-6 pt-4 border-t border-custom flex justify-end items-center gap-4"><span class="text-2xl font-bold">Итого: ${formatPrice(a)}</span><button id="checkout-cart-btn" class="btn btn-primary">Оформить заказ</button></div>`}function loadAdminUsers(){const e=document.getElementById("admin-tab-content");if(e){e.innerHTML=`<h3 class="text-2xl font-bold mb-4">Пользователи</h3>
                <div class="flex justify-between items-center mb-4">
                    <input id="user-search-input" class="modern-input w-1/2" placeholder="Поиск по email или имени...">
                    <span id="user-stats" class="font-semibold"></span>
                </div>
                <div id="users-list" class="space-y-3 mt-4"></div>`;const a=document.getElementById("user-search-input");a.addEventListener("input",()=>renderUsersList(a.value)),onSnapshot(query(collection(db,"users")),e=>{allUsers=e.docs.map(e=>e.data()),renderUsersList()})}}function renderUsersList(e=""){const a=document.getElementById("users-list"),o=document.getElementById("user-stats");if(a&&o){const n=e.toLowerCase();let s=e?allUsers.filter(e=>e.displayName.toLowerCase().includes(n)||e.email.toLowerCase().includes(n)):allUsers;o.textContent=`Всего пользователей: ${allUsers.length}`,a.innerHTML=s.map(e=>renderAdminUserItem(e)).join("")||"<p>Пользователи не найдены.</p>"}}function renderAdminUserItem(e){const a=e.isBanned||!1;return`<div class="card-bg p-4 rounded flex flex-col md:flex-row justify-between items-start md:items-center border border-custom gap-4"><div><p>${e.displayName} (${e.email})</p><p class="text-xs text-gray-400">UID: ${e.uid}</p><p>Баланс: ${formatPrice(e.balance||0)}</p></div><div class="flex items-center gap-2 flex-wrap"><input type="number" class="user-balance-input w-24 p-2 rounded bg-transparent border" placeholder="Сумма"><button class="add-balance-btn bg-green-500 text-white p-2 rounded-md" data-uid="${e.uid}">➕</button><button class="remove-balance-btn bg-yellow-500 text-white p-2 rounded-md" data-uid="${e.uid}">➖</button><button class="annul-balance-btn bg-red-500 text-white p-2 rounded-md" data-uid="${e.uid}">Обнулить</button><button class="ban-user-btn ${a?"bg-blue-500":"bg-red-700"} text-white p-2 rounded-md" data-uid="${e.uid}">${a?"Разбанить":"Забанить"}</button></div></div>`}async function uploadImage(e,a="images"){const o=ref(storage,`${a}/${Date.now()}_${e.name}`);try{return await getDownloadURL((await uploadBytes(o,e)).ref)}catch(a){console.error("Firebase Storage Upload Error: ",a);const o=new FormData;o.append("image",e);try{const e=await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`,{method:"POST",body:o}),a=await e.json();if(a.success)return a.data.url;throw new Error(a.error.message)}catch(e){return alert("Ошибка загрузки изображения: "+e.message),null}}}function loadAdminList(e,a,o,n){const s=document.getElementById("admin-tab-content");s&&(s.innerHTML=`<div class="flex justify-between items-center mb-6"><h3 class="text-2xl font-bold">${a}</h3><div>${n||""}</div></div><div id="admin-list-container" class="space-y-3"></div>`,onSnapshot(query(collection(db,e)),e=>{const a=document.getElementById("admin-list-container");a&&(a.innerHTML=e.docs.map(e=>o(e.id,e.data())).join("")||"<p>Пусто</p>")}))}function loadAdminPurchases(){const e=document.getElementById("admin-tab-content");e&&(e.innerHTML='<h3 class="text-2xl font-bold">Покупки</h3><div id="admin-list-container" class="space-y-3 mt-4"></div>',onSnapshot(query(collection(db,"purchases"),orderBy("createdAt","desc")),e=>{const a=document.getElementById("admin-list-container");a&&(a.innerHTML=e.docs.map(e=>renderAdminPurchaseItem(e.id,e.data())).join(""))}))}function renderAdminProductItem(e,a){return`
            <div class="card-bg p-4 rounded flex justify-between items-center border border-custom">
                <div class="flex items-center gap-4">
                    <img src="${a.imageUrl||"https://placehold.co/64x64"}" class="w-16 h-16 object-cover rounded-md">
                    <p class="font-semibold">${a.name}</p>
                </div>
                <div class="flex items-center gap-2">
                    <button class="edit-btn btn bg-blue-500 text-white text-sm" data-id="${e}" data-type="product">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                        <span>Ред.</span>
                    </button>
                    <button class="delete-btn btn btn-danger text-sm" data-collection="products" data-id="${e}">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        <span>Удалить</span>
                    </button>
                </div>
            </div>`}async function showPromoForm(e){let a={code:"",discount:0,limit:1,uses:0,productId:""};if(e){const o=await getDoc(doc(db,"promocodes",e));o.exists()&&(a={id:o.id,...o.data()})}const o=async o=>{const n={code:o.querySelector("#promo-code").value.toUpperCase(),discount:parseFloat(o.querySelector("#promo-discount").value),limit:parseInt(o.querySelector("#promo-limit").value),uses:a.uses,productId:o.querySelector("#promo-product").value||null};return n.code&&n.discount&&n.limit?(a.id?await setDoc(doc(db,"promocodes",a.id),n,{merge:!0}):await setDoc(doc(db,"promocodes",n.code),n),showToast("Промокод сохранен!"),!0):(showToast("Заполните все обязательные поля",!0),!1)},n=allProducts.map(e=>`<option value="${e.id}" ${a.productId===e.id?"selected":""}>${e.name}</option>`).join("");showModal(a.id?"Редактировать промокод":"Добавить промокод",`<div class="space-y-4">
                <div><label>Код</label><input id="promo-code" class="w-full modern-input" value="${a.code}" ${a.id?"readonly":""}></div>
                <div><label>Скидка (%)</label><input type="number" id="promo-discount" class="w-full modern-input" value="${a.discount}"></div>
                <div><label>Лимит использований</label><input type="number" id="promo-limit" class="w-full modern-input" value="${a.limit}"></div>
                <div><label>Применить к товару (необязательно)</label><select id="promo-product" class="w-full modern-input"><option value="">Для всех товаров</option>${n}</select></div>
            </div>`,o,"Сохранить")}function showBannerForm(){const e=async e=>{const a=e.querySelector("#banner-image-url").value,o=e.querySelector("#banner-link-url").value;return a&&o?(await setDoc(doc(db,"storeSettings","config"),{adBanners:arrayUnion({imageUrl:a,linkUrl:o})},{merge:!0}),showToast("Баннер добавлен!"),loadCustomizationPage(),!0):(showToast("Заполните все поля",!0),!1)},a=`<div class="space-y-4">
                <div><label>URL изображения</label><input id="banner-image-url" class="w-full modern-input" placeholder="https://example.com/image.png"></div>
                <div><label>URL ссылки</label><input id="banner-link-url" class="w-full modern-input" placeholder="https://example.com/product"></div>
            </div>`;showModal("Добавить баннер",a,e,"Добавить")}function renderAdminBanners(e){const a=document.getElementById("banners-list");a&&(a.innerHTML=(e||[]).map((e,a)=>`<div class="flex items-center justify-between gap-2 p-2 card-bg rounded"><span>${e.linkUrl}</span><button class="delete-banner-btn btn btn-danger text-sm" data-index="${a}">Удалить</button></div>`).join(""))}function showSocialLinkForm(){const e=async e=>{const a=e.querySelector("#social-name").value,o=e.querySelector("#social-url").value,n=e.querySelector("#social-icon").value;return a&&o&&n?(await setDoc(doc(db,"storeSettings","config"),{socialLinks:arrayUnion({id:`link_${Date.now()}`,name:a,url:o,icon:n})},{merge:!0}),showToast("Ссылка добавлена!"),loadCustomizationPage(),!0):(showToast("Заполните все поля",!0),!1)},a=`<div class="space-y-4">
                <div><label>Название</label><input id="social-name" class="w-full modern-input" placeholder="Telegram"></div>
                <div><label>URL</label><input id="social-url" class="w-full modern-input" placeholder="https://t.me/username"></div>
                <div><label>SVG иконка</label><textarea id="social-icon" class="w-full modern-input" rows="3" placeholder='<path d="..."/>'></textarea></div>
            </div>`;showModal("Добавить соц.сеть",a,e,"Добавить")}function loadAdminChatsList(e){const a=document.getElementById("admin-tab-content");if(a){a.innerHTML='<div class="flex gap-4 h-[75vh]"><div id="chat-list-sidebar" class="w-1/3 border-r pr-2 overflow-y-auto"></div><div id="chat-view" class="w-2/3 flex flex-col"></div></div>';const o=document.getElementById("chat-list-sidebar");onSnapshot(query(collection(db,"userChats"),orderBy("lastActivity","desc")),a=>{o&&(o.innerHTML=a.docs.filter(e=>e.id!==ADMIN_UID).map(a=>{const o=a.data();return`<a href="#admin/chats/${a.id}" class="block p-3 rounded-lg transition-colors ${e===a.id?"bg-primary text-white":"hover:bg-primary/10"}">${o.userName||"User"}</a>`}).join(""))}),e?(()=>{const o=document.getElementById("chat-view");if(o){const a=`${e}_${ADMIN_UID}`,n=`Чат с пользователем (ID: ${e})`;renderChatInterface(o,a,n,ADMIN_UID)}})():(()=>{const e=document.getElementById("chat-view");e&&(e.innerHTML='<div class="flex-grow flex items-center justify-center text-gray-500"><p>Выберите чат для просмотра</p></div>')})()}}function renderChatInterface(e,a,o,n){e.innerHTML=`
                <div class="p-4 font-bold border-b">${o}</div>
                <div id="messages-container" class="p-4 flex-grow overflow-y-auto flex flex-col space-y-4"></div>
                <div class="p-4 border-t flex gap-2">
                    <input id="chat-message-input" class="flex-grow modern-input">
                    <button id="send-chat-message" class="btn btn-primary">Отправить</button>
                </div>`;const s=document.getElementById("messages-container"),r=document.getElementById("send-chat-message"),l=document.getElementById("chat-message-input"),c=async()=>{const e=l.value.trim();if(e){const[o,s]=a.split("_");await addDoc(collection(db,`chats/${a}/messages`),{text:e,senderId:n,createdAt:serverTimestamp()}),await setDoc(doc(db,"userChats",o),{lastActivity:serverTimestamp()},{merge:!0}),l.value=""}};r.onclick=c,l.onkeyup=e=>{"Enter"===e.key&&c()},onSnapshot(query(collection(db,`chats/${a}/messages`),orderBy("createdAt","asc")),e=>{s&&(s.innerHTML=e.docs.map(e=>`<div class="flex items-end gap-2 ${e.data().senderId===n?"self-end":"self-start"}"><div class="px-4 py-2 rounded-lg ${e.data().senderId===n?"bg-primary text-white":"bg-gray-200 dark:bg-gray-700"}">${e.data().text}</div></div>`).join(""),s.scrollTop=s.scrollHeight)})}function loadAdminReviews(){const e=document.getElementById("admin-tab-content");e&&(e.innerHTML='<div class="flex justify-between items-center mb-6"><h3 class="text-2xl font-bold">Отзывы</h3><button id="add-review-btn" class="btn btn-primary">Добавить отзыв</button></div><div id="reviews-list" class="space-y-4"></div>',document.getElementById("add-review-btn").onclick=()=>showAdminReviewForm(),onSnapshot(query(collection(db,"reviews"),orderBy("createdAt","desc")),e=>{const a=document.getElementById("reviews-list");a&&(a.innerHTML=e.docs.map(e=>renderAdminReviewItem(e.id,e.data())).join("")||"<p>Отзывов пока нет.</p>")}
))}function renderAdminReviewItem(e,a){return`<div class="card-bg p-4 rounded border border-custom">
                <div class="flex justify-between">
                    <p><strong>${a.productName}</strong> - ${"⭐".repeat(a.rating)}</p>
                    <button class="delete-btn text-red-500" data-collection="reviews" data-id="${e}">Удалить</button>
                </div>
                <p class="mt-2 italic">"${a.text}"</p>
                <p class="text-sm text-gray-400 mt-1">От: ${a.userName} (${new Date(1e3*a.createdAt.seconds).toLocaleDateString()})</p>
            </div>`}async function showAdminReviewForm(){const e=allProducts.map(e=>`<option value="${e.id}">${e.name}</option>`).join(""),a=async a=>{const o=a.querySelector("#review-product-select").value,n=a.querySelector('input[name="admin-rating"]:checked')?.value,s=a.querySelector("#review-text").value,r=a.querySelector("#review-user-name").value;if(!o||!n||!r)return showToast("Заполните все поля",!0),!1;const l=allProducts.find(e=>e.id===o);return await addDoc(collection(db,"reviews"),{productId:o,productName:l.name,rating:parseInt(n),text:s,userId:"admin",userName:r,createdAt:serverTimestamp()}),showToast("Отзыв добавлен!"),!0},o=`<div class="space-y-4">
                <div>
                    <label class="block text-sm">Товар</label>
                    <select id="review-product-select" class="w-full modern-input">${e}</select>
                </div>
                 <div>
                    <label class="block text-sm">Имя пользователя</label>
                    <input id="review-user-name" class="w-full modern-input" value="Администратор">
                </div>
                <div>
                    <label class="block text-sm">Оценка</label>
                    <div class="star-rating">
                        <input type="radio" id="admin-star5" name="admin-rating" value="5" /><label for="admin-star5" title="5 звезд">★</label>
                        <input type="radio" id="admin-star4" name="admin-rating" value="4" /><label for="admin-star4" title="4 звезды">★</label>
                        <input type="radio" id="admin-star3" name="admin-rating" value="3" /><label for="admin-star3" title="3 звезды">★</label>
                        <input type="radio" id="admin-star2" name="admin-rating" value="2" /><label for="admin-star2" title="2 звезды">★</label>
                        <input type="radio" id="admin-star1" name="admin-rating" value="1" /><label for="admin-star1" title="1 звезда">★</label>
                    </div>
                </div>
                <div>
                    <label class="block text-sm">Текст отзыва</label>
                    <textarea id="review-text" class="w-full modern-input" rows="3"></textarea>
                </div>
            </div>`;showModal("Добавить отзыв",o,a,"Добавить")}function showReviewForm(e,a){const o=async o=>{const n=o.querySelector('input[name="rating"]:checked')?.value,s=o.querySelector("#review-text").value;if(!n)return showToast("Пожалуйста, поставьте оценку",!0),!1;const r=allProducts.find(e=>e.id===a);return await addDoc(collection(db,"reviews"),{productId:a,productName:r.name,rating:parseInt(n),text:s,userId:currentUser.uid,userName:currentUser.displayName,createdAt:serverTimestamp()}),await updateDoc(doc(db,"purchases",e),{review:{rating:parseInt(n),text:s}}),showToast("Спасибо за ваш отзыв!"),!0},n=`<div class="space-y-4">
                <p>Пожалуйста, оцените вашу покупку.</p>
                <div class="star-rating">
                    <input type="radio" id="star5" name="rating" value="5" /><label for="star5" title="5 звезд">★</label>
                    <input type="radio" id="star4" name="rating" value="4" /><label for="star4" title="4 звезды">★</label>
                    <input type="radio" id="star3" name="rating" value="3" /><label for="star3" title="3 звезды">★</label>
                    <input type="radio" id="star2" name="rating" value="2" /><label for="star2" title="2 звезды">★</label>
                    <input type="radio" id="star1" name="rating" value="1" /><label for="star1" title="1 звезда">★</label>
                </div>
                <textarea id="review-text" class="w-full modern-input" rows="3" placeholder="Ваш комментарий (необязательно)"></textarea>
            </div>`;showModal("Оставить отзыв",n,o,"Отправить")}document.addEventListener("DOMContentLoaded",()=>{try{initTheme(),setupEventListeners(),updateCartCount(),onAuthStateChanged(auth,async e=>{try{await Promise.all([loadPaymentMethods(),loadStoreSettings()]),await initializeAppState(e)}catch(e){console.error("Error during auth state change handling:",e)}finally{document.getElementById("loading-overlay").style.opacity="0",setTimeout(()=>{document.getElementById("loading-overlay").style.display="none",document.body.classList.remove("opacity-0")},500)}})}catch(e){console.error("Critical error on DOMContentLoaded:",e),document.body.innerHTML='<div style="text-align: center; padding-top: 50px; font-family: sans-serif;"><h1>Произошла ошибка</h1><p>Не удалось загрузить сайт. Пожалуйста, попробуйте обновить страницу.</p></div>',document.body.classList.remove("opacity-0");const a=document.getElementById("loading-overlay");a&&(a.style.display="none")}});async function initializeAppState(e){currentUser=e,isAdmin=e?.uid===ADMIN_UID;const a=document.getElementById("balance-btn"),o=document.querySelector("#mobile-nav-links"),n=document.querySelectorAll("nav.hidden.md\\:flex a.main-nav-link");if(o.innerHTML="",n.forEach(e=>{const a=e.cloneNode(!0);a.classList.remove("px-3","py-1.5","rounded-full"),a.classList.add("p-4","text-lg"),o.appendChild(a)}),e){a?.classList.remove("hidden");const o=doc(db,"users",e.uid);onSnapshot(o,e=>{if(e.exists()){const a=e.data();appState.balance=a.balance||0,appState.balanceHistory=(a.balanceHistory||[]).sort((e,a)=>new Date(a.date)-new Date(e.date));const o=document.getElementById("balance-amount");o&&(o.textContent=formatPrice(appState.balance))}});const n=(await getDoc(o));n.exists()&&n.data().nickname||await setDoc(o,{displayName:e.displayName,email:e.email,photoURL:e.photoURL,lastSeen:serverTimestamp(),uid:e.uid,nickname:`Пользователь${e.uid.substring(0,5)}`},{merge:!0})}else{a&&a.classList.add("hidden");const e=document.getElementById("notifications-container");e&&(e.innerHTML=""),userWishlist=[],appState.balance=0}await updateAuthUI(),handleRouting()}function loadSettingsPage(){const e=document.getElementById("settings-content");e.innerHTML=`
                <div class="max-w-2xl mx-auto card-bg p-8 rounded-lg shadow-lg">
                    <h1 class="text-3xl font-bold mb-6">Настройки</h1>
                    <div class="space-y-6">
                        <div>
                            <label class="block text-lg font-medium">Язык</label>
                            <select id="language-select" class="w-full modern-input mt-2">
                                <option value="RU" ${"RU"===appState.lang?"selected":""}>Русский</option>
                                <option value="UZ" ${"UZ"===appState.lang?"selected":""}>O'zbekcha</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-lg font-medium">Валюта</label>
                            <select id="currency-select" class="w-full modern-input mt-2">
                                <option value="UZS" ${"UZS"===appState.currency?"selected":""}>Узбекский сум (UZS)</option>
                                <option value="RUB" ${"RUB"===appState.currency?"selected":""}>Российский рубль (RUB)</option>
                                <option value="USD" ${"USD"===appState.currency?"selected":""}>Доллар США (USD)</option>
                            </select>
                        </div>
                    </div>
                </div>`,document.getElementById("language-select").addEventListener("change",e=>{appState.lang=e.target.value,localStorage.setItem("asonik_lang",appState.lang),translatePage()}),document.getElementById("currency-select").addEventListener("change",e=>{appState.currency=e.target.value,localStorage.setItem("asonik_currency",appState.currency),handleRouting()})}</script>
</body>
</html>
