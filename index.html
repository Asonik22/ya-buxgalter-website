<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="site-title">Asonik | Store</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üõí</text></svg>" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Light Theme */
            --bg-light-start: #ede9fe; --bg-light-end: #f5f3ff;
            --text-light: #1e1b4b; --card-bg-light: #ffffff;
            --primary-light: #7c3aed; --primary-hover-light: #6d28d9;
            --border-light: #ddd6fe; --logo-text-light: #5b21b6;
            --nav-hover-bg-light: #e0e7ff; --nav-hover-text-light: #1e1b4b;
            --nav-active-bg-light: #7c3aed; --nav-active-text-light: #ffffff;

            /* Dark Theme */
            --bg-dark-start: #1e1b4b; --bg-dark-end: #17133a;
            --text-dark: #e0e7ff; --card-bg-dark: #282454;
            --primary-dark: #a78bfa; --primary-hover-dark: #c4b5fd;
            --border-dark: #4338ca; --logo-text-dark: #c7d2fe;
            --nav-hover-bg-dark: #312e74; --nav-hover-text-dark: #e0e7ff;
            --nav-active-bg-dark: #a78bfa; --nav-active-text-dark: #1e1b4b;
        }

        html.dark { 
            --bg-start: var(--bg-dark-start); --bg-end: var(--bg-dark-end);
            --text: var(--text-dark); --card-bg: var(--card-bg-dark);
            --primary: var(--primary-dark); --primary-hover: var(--primary-hover-dark);
            --border: var(--border-dark); --logo-text: var(--logo-text-dark);
            --nav-hover-bg: var(--nav-hover-bg-dark); --nav-hover-text: var(--nav-hover-text-dark);
            --nav-active-bg: var(--nav-active-bg-dark); --nav-active-text: var(--nav-active-text-dark);
        }
        html:not(.dark) { 
            --bg-start: var(--bg-light-start); --bg-end: var(--bg-light-end);
            --text: var(--text-light); --card-bg: var(--card-bg-light);
            --primary: var(--primary-light); --primary-hover: var(--primary-hover-light);
            --border: var(--border-light); --logo-text: var(--logo-text-light);
            --nav-hover-bg: var(--nav-hover-bg-light); --nav-hover-text: var(--nav-hover-text-light);
            --nav-active-bg: var(--nav-active-bg-light); --nav-active-text: var(--nav-active-text-light);
        }

        body { 
            font-family: 'Manrope', sans-serif; 
            background-image: linear-gradient(120deg, var(--bg-start), var(--bg-end));
            color: var(--text); 
        }
        .logo-text { color: var(--logo-text); }
        .bg-primary { background-color: var(--primary); }
        .text-primary { color: var(--primary); }
        .border-custom { border-color: var(--border); }
        .card-bg { background-color: var(--card-bg); }
        .modal-backdrop { background-color: rgba(0, 0, 0, 0.7); }
        
        [data-page] { display: none; }
        [data-page].active { display: block; }

        .main-nav-link.active { background-color: var(--nav-active-bg); color: var(--nav-active-text) !important; }

        .btn { display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; padding: 0.75rem 1.25rem; border-radius: 0.5rem; font-weight: 600; transition: all 0.2s; cursor: pointer; border: none; }
        .btn-primary { background-color: var(--primary); color: white; }
        .btn-primary:hover { background-color: var(--primary-hover); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .modern-input { background-color: var(--card-bg); border: 1px solid var(--border); border-radius: 0.5rem; padding: 0.75rem; }
        .modern-input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px color-mix(in srgb, var(--primary) 25%, transparent); }
        
        #loading-overlay { position: fixed; inset: 0; background-image: linear-gradient(120deg, var(--bg-start), var(--bg-end)); z-index: 100; display: flex; align-items: center; justify-content: center; transition: opacity 0.5s; opacity: 1; }
        .spinner { width: 56px; height: 56px; border-radius: 50%; border: 8px solid; border-color: var(--border); border-right-color: var(--primary); animation: spinner-d3wgkg 1s infinite linear; }
        @keyframes spinner-d3wgkg { to { transform: rotate(1turn); } }
        
        #mobile-menu { transition: opacity 0.3s; }
        #mobile-menu-panel { transition: transform 0.3s; }
        #mobile-menu.open { opacity: 1; pointer-events: auto; }
        #mobile-menu.open #mobile-menu-panel { transform: translateX(0); }

        #store-logo, .product-card-img, #main-product-image, #profile-avatar, .payment-option img { object-fit: cover; }
        
        .payment-option.selected { border-color: var(--primary) !important; box-shadow: 0 0 0 3px color-mix(in srgb, var(--primary) 40%, transparent); border-width: 2px; }
    
        .faq-answer {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-in-out;
        }
        .faq-question.open + .faq-answer {
            max-height: 500px; /* A large enough value to show content */
        }
        .faq-question .faq-icon {
            transition: transform 0.3s;
        }
        .faq-question.open .faq-icon {
            transform: rotate(180deg);
        }
    </style>
</head>
<body class="antialiased opacity-0 transition-opacity duration-500">

    <div id="loading-overlay"><div class="spinner"></div></div>

    <header class="sticky top-0 z-40">
      <div class="container mx-auto px-4">
        <div class="mt-4 card-bg shadow-lg rounded-xl border border-custom/50 flex justify-between items-center h-16 px-4">
            <a href="#main" class="flex items-center gap-3 text-xl font-bold nav-link">
                <img id="store-logo" src="https://placehold.co/32x32/7c3aed/ffffff?text=A" alt="logo" class="h-8 w-8 rounded-full">
                <span id="site-name-display" class="logo-text hidden sm:inline">Asonik | Store</span>
            </a>
            
            <nav id="desktop-nav" class="hidden md:flex items-center space-x-1">
                <a href="#main" class="main-nav-link nav-link px-3 py-1.5 rounded-full" data-nav-key="main">–ì–ª–∞–≤–Ω–∞—è</a>
                <a href="#chats" class="main-nav-link nav-link px-3 py-1.5 rounded-full" data-nav-key="chats">–ß–∞—Ç—ã</a>
                <a href="#faq" class="main-nav-link nav-link px-3 py-1.5 rounded-full" data-nav-key="faq">FAQ</a>
                <a href="#purchases" class="main-nav-link nav-link px-3 py-1.5 rounded-full" data-nav-key="purchases">–ú–æ–∏ –ø–æ–∫—É–ø–∫–∏</a>
            </nav>

            <div class="flex items-center space-x-2">
                <button id="balance-btn" class="hidden btn p-2"><span id="balance-amount" class="font-semibold text-sm">0</span></button>
                <button id="theme-toggle" class="p-2 rounded-full"></button>
                <div id="auth-container" class="relative"></div>
                <button id="mobile-menu-btn" class="md:hidden p-2"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg></button>
            </div>
        </div>
      </div>
    </header>

    <div id="mobile-menu" class="fixed inset-0 bg-black bg-opacity-50 z-50 opacity-0 pointer-events-none">
        <div id="mobile-menu-panel" class="fixed top-0 right-0 h-full w-64 card-bg shadow-lg p-6 transform translate-x-full">
            <button id="mobile-menu-close-btn" class="absolute top-4 right-4 p-2 text-2xl">&times;</button>
            <nav id="mobile-nav-links" class="flex flex-col space-y-4 text-lg mt-12"></nav>
        </div>
    </div>

    <main class="container mx-auto px-4 py-8">
        <div data-page="main" class="active"><div id="main-page-content-wrapper"></div></div>
        <div data-page="product"><div id="product-detail-content"></div></div>
        <div data-page="chats"><div id="chats-content"></div></div>
        <div data-page="faq"><div id="faq-content"></div></div>
        <div data-page="purchases"><div id="purchases-content"></div></div>
        <div data-page="admin"><div id="admin-content"></div></div>
        <div data-page="profile"><div id="profile-content"></div></div>
    </main>
    
    <footer class="container mx-auto px-4 py-6 mt-8 border-t border-custom"><div id="social-links-container" class="flex justify-center items-center gap-6"></div></footer>
    <div class="text-center text-sm text-gray-500 py-4">¬© <span id="footer-site-name">Asonik | Store</span> 2025</div>
    
    <div id="modals-container"></div>

    <script type="module">
        // Firebase and App Initialization
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, addDoc, collection, getDocs, onSnapshot, updateDoc, deleteDoc, query, where, serverTimestamp, orderBy, increment, writeBatch, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIGURATION ---
        const firebaseConfig = { apiKey: "AIzaSyDim7T4GqxZK4zM9tBDLkcGTSveVOaUbMY", authDomain: "asonikstore-v3.firebaseapp.com", projectId: "asonikstore-v3", storageBucket: "asonikstore-v3.appspot.com", messagingSenderId: "1018442222532", appId: "1:1018442222532:web:9b78f7be6c5c02bb327291" };
        const IMGBB_API_KEY = '96bf3f29606f1989bb5a450ad3770cce'; 
        const ADMIN_UID = 'MrjXzJnZYbb6jb65B4f4aYDTVBt2';

        // --- FIREBASE SETUP ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- GLOBAL STATE ---
        let currentUser = null, isAdmin = false, allProducts = [], paymentMethods = [];
        const appState = { balance: 0, balanceHistory: [] };

        // --- CORE FUNCTIONS ---
        const formatPrice = (price) => new Intl.NumberFormat('ru-RU', { style: 'currency', currency: 'UZS', minimumFractionDigits: 0 }).format(price || 0);
        const showToast = (message, isError = false) => { const el = document.createElement('div'); el.className = `fixed bottom-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg z-50 ${isError ? 'bg-red-500' : 'bg-green-500'}`; el.textContent = message; document.body.appendChild(el); setTimeout(() => el.remove(), 3000); };
        const showModal = (title, content, onSave, btnText = '–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å') => { const modal = document.createElement('div'); modal.className = 'fixed inset-0 z-50 flex items-center justify-center modal-backdrop'; modal.innerHTML = `<div class="card-bg rounded-lg shadow-xl w-11/12 md:w-1/2 p-6 max-h-[90vh] overflow-y-auto"><div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-bold">${title}</h2><button class="close-modal-btn text-2xl">&times;</button></div><div>${content}</div>${onSave ? `<div class="mt-6 flex justify-end gap-4"><button class="close-modal-btn btn">–û—Ç–º–µ–Ω–∞</button><button class="save-modal-btn btn btn-primary">${btnText}</button></div>` : ''}</div>`; document.getElementById('modals-container').appendChild(modal); modal.querySelectorAll('.close-modal-btn').forEach(b => b.onclick = () => modal.remove()); if (onSave) modal.querySelector('.save-modal-btn').onclick = async () => { if (await onSave(modal) !== false) modal.remove(); }; return modal; };
        const confirmAction = (msg, onConfirm) => showModal('–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ', `<p>${msg}</p>`, () => { onConfirm(); return true; }, '–î–∞, —É–≤–µ—Ä–µ–Ω');
        
        // --- IMAGE UPLOAD ---
        async function uploadImage(file) {
            const formData = new FormData();
            formData.append('image', file);
            showToast('–ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è...');
            try {
                const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, {
                    method: 'POST',
                    body: formData,
                });
                const result = await response.json();
                if (result.success) {
                    showToast('–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ!');
                    return result.data.url;
                } else {
                    throw new Error(result.error.message);
                }
            } catch (error) {
                showToast(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${error.message}`, true);
                return null;
            }
        }

        // --- DATA LOADING & ROUTING ---
        async function loadStoreSettings() { 
            try { 
                const settingsDoc = await getDoc(doc(db, "storeSettings", "config")); 
                if (settingsDoc.exists()) { 
                    const data = settingsDoc.data();
                    const { logoUrl, socialLinks, siteName, adBanners, announcement } = data;
                    if (logoUrl) document.getElementById('store-logo').src = logoUrl;
                    if (siteName) {
                        document.title = siteName;
                        ['site-name-display', 'footer-site-name'].forEach(id => document.getElementById(id).textContent = siteName);
                    }
                    if (socialLinks) document.getElementById('social-links-container').innerHTML = socialLinks.map(link => `<a href="${link.url}" target="_blank" class="text-gray-400 hover:text-primary"><svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">${link.icon}</svg></a>`).join(''); 
                    appState.adBanners = adBanners || [];
                    appState.announcement = announcement || {};
                } 
            } catch (e) { console.error("Error loading store settings:", e); } 
        }
        
        function handleRouting() {
            const hash = window.location.hash || '#main';
            let [page, subpage] = (hash.substring(1) || 'main').split('/');
            document.querySelectorAll('[data-page]').forEach(p => p.classList.toggle('active', p.dataset.page === page));
            loadPageContent(page, subpage); 
            document.querySelectorAll('.main-nav-link').forEach(link => link.classList.toggle('active', link.dataset.navKey === page));
        }

        function loadPageContent(page, subpage) {
            const protectedPages = ['purchases', 'chats', 'profile', 'admin'];
            const contentContainer = document.querySelector(`[data-page="${page}"] > div`);
            if (!contentContainer) return;

            if (protectedPages.includes(page) && !currentUser) { 
                contentContainer.innerHTML = `<p class="text-center">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç. <a href="#" id="login-redirect" class="text-primary underline">–í–æ–π—Ç–∏</a></p>`; 
                return; 
            }

            const pages = {
                main: loadMainPage,
                product: () => loadProductDetailPage(subpage),
                faq: loadFaq,
                admin: () => { if (isAdmin) loadAdminPanel(subpage || 'products'); },
                chats: () => loadChatsPage(subpage),
                purchases: loadPurchasesPage,
                profile: loadProfilePage,
            };
            (pages[page] || pages.main)();
        }
        
        function loadMainPage() { 
            const el = document.getElementById('main-page-content-wrapper'); 
            if (!el) return;
            const bannerHTML = (appState.adBanners || []).map(b => (b && b.imageUrl && b.linkUrl) ? `<a href="${b.linkUrl}" target="_blank" class="block mb-8 rounded-lg shadow-lg overflow-hidden"><img src="${b.imageUrl}" class="w-full object-cover"></a>` : '').join('');
            const announcementHTML = (appState.announcement?.enabled && appState.announcement?.message) ? `<div class="p-4 mb-8 rounded-lg bg-primary/10 border border-primary text-primary">${appState.announcement.message}</div>` : '';
            el.innerHTML = `${announcementHTML}${bannerHTML}<h1 class="text-4xl font-bold text-center mb-8">–ö–∞—Ç–∞–ª–æ–≥ —Ç–æ–≤–∞—Ä–æ–≤</h1><div id="products-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>`; 
            loadProducts(); 
        };
        function loadProducts() { onSnapshot(query(collection(db, "products")), s => { allProducts = s.docs.map(d => ({ id: d.id, ...d.data() })); renderProducts(); }); }
        function renderProducts() { 
            const grid = document.getElementById('products-grid'); 
            if (grid) grid.innerHTML = allProducts.length ? allProducts.map(renderProductCard).join('') : `<p class="col-span-full text-center">–¢–æ–≤–∞—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.</p>`; 
        };
        
        function renderProductCard(p) {
            return `<div class="card-bg rounded-lg shadow-lg flex flex-col justify-between border border-custom overflow-hidden transition-all duration-300 hover:shadow-2xl hover:-translate-y-1">
                <a href="#product/${p.id}" class="nav-link block">
                    <img src="${p.imageUrl || 'https://placehold.co/600x400/7c3aed/ffffff?text=No+Image'}" class="w-full h-48 product-card-img">
                </a>
                <div class="p-4 flex-grow">
                    <h3 class="text-lg font-semibold truncate">${p.name}</h3>
                    <p class="text-2xl font-bold text-primary mt-2">${formatPrice(p.price)}</p>
                </div>
                <div class="p-4 border-t border-custom"><button class="buy-now-btn w-full btn btn-primary" data-product-id="${p.id}">–ö—É–ø–∏—Ç—å</button></div>
            </div>`;
        };
        
        async function loadProductDetailPage(productId) {
            const contentContainer = document.getElementById('product-detail-content');
            if (!productId) { contentContainer.innerHTML = `<p class="text-center">–¢–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω.</p>`; return; }
            const productDoc = await getDoc(doc(db, "products", productId));
            if (!productDoc.exists()) { contentContainer.innerHTML = `<p class="text-center">–¢–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω.</p>`; return; }
            const product = { id: productDoc.id, ...productDoc.data() };
            
            contentContainer.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-12">
                    <div><img id="main-product-image" src="${product.imageUrl || 'https://placehold.co/600x600'}" class="w-full rounded-lg shadow-lg"></div>
                    <div>
                        <h1 class="text-4xl font-extrabold mb-2">${product.name}</h1>
                        <p class="text-3xl font-bold text-primary mb-4">${formatPrice(product.price)}</p>
                        <p class="text-gray-600 dark:text-gray-400 mb-6">${product.description}</p>
                        <div class="mt-8"><button id="detail-buy-btn" class="w-full btn btn-primary text-lg">–ö—É–ø–∏—Ç—å</button></div>
                    </div>
                </div>`;
            document.getElementById('detail-buy-btn').addEventListener('click', () => showCheckoutModal([product], product.price));
        };

        async function showCheckoutModal(items, total) {
            if (!currentUser) { showModal('–í—Ö–æ–¥', '<p>–î–ª—è –ø–æ–∫—É–ø–∫–∏ –≤–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç.</p>', () => signInWithGoogle(), '–í–æ–π—Ç–∏'); return; }
            
            const onSave = async m => { 
                const selected = m.querySelector('.payment-option.selected');
                if (!selected) { showToast('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã.', true); return false; }
                const paymentMethodId = selected.dataset.methodId;

                const purchaseRef = await addDoc(collection(db, "purchases"), { 
                    userId: currentUser.uid, 
                    userEmail: currentUser.email,
                    orderId: 'A' + Math.random().toString(36).substring(2, 9).toUpperCase(), 
                    items, 
                    status: '–û–∂–∏–¥–∞–µ—Ç –æ–ø–ª–∞—Ç—ã', 
                    paymentMethodId,
                    finalPrice: total, 
                    createdAt: serverTimestamp()
                });
                m.remove();
                showProofUploadModal(purchaseRef.id, total, paymentMethodId);
            };

            const methods = paymentMethods.filter(p => p.isEnabled);
            const methodsHTML = methods.length ? `<div class="grid grid-cols-2 gap-4">${methods.map(p => `<button data-method-id="${p.id}" class="payment-option flex flex-col items-center p-2 border-2 rounded-lg h-24 transition-all"><img src="${p.logoUrl}" class="h-12 object-contain"><span class="text-sm">${p.name}</span></button>`).join('')}</div>` : '<p>–°–ø–æ—Å–æ–±—ã –æ–ø–ª–∞—Ç—ã –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã.</p>';

            const modal = showModal('–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞', `<p>–°—É–º–º–∞: <strong>${formatPrice(total)}</strong></p><div class="mt-4">${methodsHTML}</div>`, onSave, '–ö –æ–ø–ª–∞—Ç–µ');
            modal.querySelectorAll('.payment-option').forEach(btn => btn.onclick = () => { modal.querySelectorAll('.payment-option').forEach(b => b.classList.remove('selected')); btn.classList.add('selected'); });
        }
        
        async function showProofUploadModal(purchaseId, total, paymentMethodId) {
            const paymentMethod = paymentMethods.find(m => m.id === paymentMethodId);
            if (!paymentMethod) { showToast("–°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω", true); return; }

            const onSave = async (modal) => {
                const file = modal.querySelector('#proof-file-input').files[0];
                if (!file) { showToast("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª", true); return false; }
                const imageUrl = await uploadImage(file);
                if (imageUrl) {
                    await updateDoc(doc(db, "purchases", purchaseId), { paymentProofUrl: imageUrl, status: '–û–∂–∏–¥–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è' });
                    showToast("–ß–µ–∫ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω!");
                    window.location.hash = '#purchases';
                    return true;
                }
                return false;
            };

            const modalContent = `
                <div>
                    <p>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–µ—Ä–µ–≤–µ–¥–∏—Ç–µ <strong>${formatPrice(total)}</strong> –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–µ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã:</p>
                    <p class="font-semibold">${paymentMethod.name}</p>
                    <p class="my-2 p-2 bg-gray-200 dark:bg-gray-700 rounded font-mono">${paymentMethod.requisites}</p>
                    <p class="mt-4">–ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã, –∑–∞–≥—Ä—É–∑–∏—Ç–µ —á–µ–∫ (—Å–∫—Ä–∏–Ω—à–æ—Ç).</p>
                    <input type="file" id="proof-file-input" class="w-full modern-input mt-2" accept="image/*">
                </div>`;
            showModal("–ó–∞–≥—Ä—É–∑–∫–∞ —á–µ–∫–∞", modalContent, onSave, "–û—Ç–ø—Ä–∞–≤–∏—Ç—å —á–µ–∫");
        };


        function loadPurchasesPage() { 
            const el = document.getElementById('purchases-content'); 
            if (!currentUser || !el) return; 
            el.innerHTML = `<h1 class="text-4xl font-bold text-center mb-8">–ú–æ–∏ –ø–æ–∫—É–ø–∫–∏</h1><div id="purchases-list" class="space-y-6"></div>`; 
            onSnapshot(query(collection(db, "purchases"), where("userId", "==", currentUser.uid), orderBy("createdAt", "desc")), s => { 
                const container = document.getElementById('purchases-list'); 
                if (container) container.innerHTML = s.docs.map(d => renderPurchaseItem(d.id, d.data())).join('') || '<p class="text-center">–ó–¥–µ—Å—å –±—É–¥—É—Ç –≤–∞—à–∏ –ø–æ–∫—É–ø–∫–∏.</p>'; 
            }); 
        };

        function renderPurchaseItem(id, p) {
            const item = p.items[0];
            return `<div class="card-bg p-6 rounded-lg border border-custom flex flex-col sm:flex-row gap-4 items-start shadow-md">
                <img src="${item.imageUrl || 'https://placehold.co/128x128'}" class="w-full sm:w-32 h-32 object-cover rounded-md">
                <div class="flex-grow">
                    <h3 class="font-bold text-lg">${item.name}</h3>
                    <p class="text-sm text-gray-500 mt-2">–ö–æ–¥ –∑–∞–∫–∞–∑–∞:</p>
                    <p class="font-mono text-lg p-2 bg-primary/10 rounded-md my-1">${p.orderId}</p>
                    <p class="text-sm">–°—Ç–∞—Ç—É—Å: <strong>${p.status}</strong></p>
                    <p class="text-lg font-semibold mt-1">–°—É–º–º–∞: ${formatPrice(p.finalPrice)}</p>
                </div>
            </div>`
        };

        async function loadProfilePage() { 
            const el = document.getElementById('profile-content'); 
            if (!el || !currentUser) return; 
            el.innerHTML = `
                <h1 class="text-4xl font-bold text-center mb-8">–ü—Ä–æ—Ñ–∏–ª—å</h1>
                <div class="max-w-md mx-auto card-bg p-8 rounded-2xl shadow-lg text-center">
                    <img id="profile-avatar" src="${currentUser.photoURL || 'https://placehold.co/128x128/7c3aed/ffffff?text=A'}" class="w-32 h-32 rounded-full mb-4 shadow-md mx-auto">
                    <input type="file" id="avatar-upload" class="hidden" accept="image/*">
                    <button id="change-avatar-btn" class="text-sm text-primary hover:underline">–°–º–µ–Ω–∏—Ç—å —Ñ–æ—Ç–æ</button>
                    <h2 class="text-2xl font-bold mt-4">${currentUser.displayName}</h2>
                    <p class="text-gray-400">${currentUser.email}</p>
                    <button id="logout-btn-profile" class="mt-6 btn btn-danger">–í—ã–π—Ç–∏</button>
                </div>`;
            
            document.getElementById('change-avatar-btn').onclick = () => document.getElementById('avatar-upload').click();
            document.getElementById('avatar-upload').onchange = async (e) => {
                const file = e.target.files[0];
                if (file) {
                    const photoURL = await uploadImage(file);
                    if (photoURL) {
                        await updateProfile(auth.currentUser, { photoURL });
                        await updateDoc(doc(db, "users", currentUser.uid), { photoURL }, { merge: true });
                        showToast('–ê–≤–∞—Ç–∞—Ä –æ–±–Ω–æ–≤–ª–µ–Ω!');
                        document.getElementById('profile-avatar').src = photoURL;
                        updateAuthUI();
                    }
                }
            };
        };

        async function loadChatsPage() { 
            const el = document.getElementById('chats-content'); 
            if (!el || !currentUser) return; 
            
            const chatId = `${currentUser.uid}_${ADMIN_UID}`;
            el.innerHTML = `<h1 class="text-4xl font-bold text-center mb-8">–ß–∞—Ç —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π</h1>`;
            renderChatInterface(el, chatId, currentUser.uid);
        };

        function renderChatInterface(cont, chatId, currentId) { 
            cont.innerHTML += `
                <div class="card-bg p-4 rounded-lg shadow-lg max-w-2xl mx-auto">
                    <div id="messages-container" class="h-96 p-4 overflow-y-auto flex flex-col space-y-4"></div>
                    <div class="p-4 border-t border-custom flex gap-2">
                        <input id="chat-message-input" class="flex-grow modern-input">
                        <button id="send-chat-message" class="btn btn-primary">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                    </div>
                </div>`; 
            
            const msgCont = document.getElementById('messages-container'); 
            const sendBtn = document.getElementById('send-chat-message');
            const msgInput = document.getElementById('chat-message-input');
            
            const sendMessage = async () => {
                const text = msgInput.value.trim();
                if (text) {
                    await addDoc(collection(db, `chats/${chatId}/messages`), { text, senderId: currentId, createdAt: serverTimestamp() });
                    msgInput.value = '';
                }
            };

            sendBtn.onclick = sendMessage;
            msgInput.onkeyup = (e) => { if (e.key === 'Enter') sendMessage(); };

            onSnapshot(query(collection(db, `chats/${chatId}/messages`), orderBy("createdAt", "asc")), s => { 
                if(msgCont) { 
                    msgCont.innerHTML = s.docs.map(d => `<div class="flex items-end gap-2 ${d.data().senderId === currentId ? 'self-end' : ''}"><div class="px-4 py-2 rounded-lg ${d.data().senderId === currentId ? 'bg-primary text-white' : 'card-bg'}">${d.data().text}</div></div>`).join(''); 
                    msgCont.scrollTop = msgCont.scrollHeight; 
                } 
            }); 
        };

        function loadFaq() {
            const cont = document.getElementById('faq-content');
            if (!cont) return;
            cont.innerHTML = `<div class="max-w-4xl mx-auto">
                <h1 class="text-4xl font-bold text-center mb-12">–ß–∞—Å—Ç–æ –∑–∞–¥–∞–≤–∞–µ–º—ã–µ –≤–æ–ø—Ä–æ—Å—ã</h1>
                <div id="faq-list" class="space-y-4"></div>
            </div>`;
            const list = document.getElementById('faq-list');
            onSnapshot(query(collection(db, "faq"), orderBy("order", "asc")), s => {
                if(list) {
                    list.innerHTML = s.docs.map(d => {
                        const i = d.data();
                        return `<div class="card-bg rounded-lg shadow border border-custom">
                            <button class="faq-question w-full text-left p-6 font-bold flex justify-between items-center text-lg">
                                <span>${i.question}</span>
                                <svg class="faq-icon w-6 h-6 text-primary" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                            </button>
                            <div class="faq-answer">
                                <p class="p-6 pt-0 text-gray-600 dark:text-gray-400">${i.answer}</p>
                            </div>
                        </div>`
                    }).join('');
                }
            });
        }
        
        // --- UI & THEME ---
        function initMobileMenu() {
            const menu = document.getElementById('mobile-menu');
            const openBtn = document.getElementById('mobile-menu-btn');
            const closeBtn = document.getElementById('mobile-menu-close-btn');
            const linksContainer = document.getElementById('mobile-nav-links');

            linksContainer.innerHTML = document.getElementById('desktop-nav').innerHTML;
            const toggleMenu = (isOpen) => menu.classList.toggle('open', isOpen);
            
            openBtn.addEventListener('click', (e) => { e.stopPropagation(); toggleMenu(true); });
            closeBtn.addEventListener('click', () => toggleMenu(false));
            menu.addEventListener('click', (e) => { if (e.target === menu) toggleMenu(false); });
            linksContainer.addEventListener('click', (e) => { if (e.target.tagName === 'A') toggleMenu(false); });
        }

        function initTheme() { 
            const btn = document.getElementById('theme-toggle'); 
            const apply = t => { 
                document.documentElement.classList.toggle('dark', t === 'dark');
                btn.innerHTML = t === 'dark' ? '‚òÄÔ∏è' : 'ÔøΩ';
            }; 
            const currentTheme = localStorage.getItem('color-theme') || 'light';
            apply(currentTheme); 
            btn.onclick=() => {
                const newTheme = document.documentElement.classList.contains('dark') ? 'light' : 'dark'; 
                localStorage.setItem('color-theme', newTheme); 
                apply(newTheme);
            };
        };

        async function updateAuthUI() { 
            const c = document.getElementById('auth-container'); 
            if(!c) return; 
            if (currentUser) { 
                c.innerHTML = `
                    <div class="relative">
                        <button id="profile-btn" class="flex items-center gap-2 p-1 rounded-full"><img src="${currentUser.photoURL||'https://placehold.co/32x32/7c3aed/ffffff?text=A'}" class="w-8 h-8 rounded-full object-cover"></button>
                        <div id="profile-menu" class="hidden absolute right-0 mt-2 w-48 card-bg rounded-md shadow-lg z-10 border border-custom">
                            <a href="#profile" class="nav-link block px-4 py-2 hover:bg-primary/10">–ü—Ä–æ—Ñ–∏–ª—å</a>
                            ${isAdmin ? `<a href="#admin" class="nav-link block px-4 py-2 hover:bg-primary/10">–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</a>` : ''}
                            <a href="#" id="logout-btn" class="block px-4 py-2 text-red-500 hover:bg-red-500/10">–í—ã–π—Ç–∏</a>
                        </div>
                    </div>`;
            } else { 
                c.innerHTML = `<button id="google-login-btn" class="btn btn-primary">–í–æ–π—Ç–∏</button>`; 
            } 
        };
        
        function showBalanceModal() {
            const modalHTML = `
                <div class="text-center mb-6">
                    <p class="text-gray-400">–¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å</p>
                    <p id="modal-balance-display" class="text-4xl font-bold">${formatPrice(appState.balance)}</p>
                </div>
                <hr class="border-custom my-6">
                <div>
                    <h3 class="font-semibold text-lg mb-4">–ò—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π</h3>
                    <ul id="balance-history-list" class="space-y-2 max-h-60 overflow-y-auto pr-2"></ul>
                </div>`;
            
            const modal = showModal('–ë–∞–ª–∞–Ω—Å', modalHTML, null);
            
            const listEl = modal.querySelector('#balance-history-list');
            const sortedHistory = (appState.balanceHistory || []).sort((a,b) => new Date(b.date) - new Date(a.date));

            if(sortedHistory.length > 0) {
                listEl.innerHTML = sortedHistory.map(i => `
                    <li class="flex justify-between items-center p-3 rounded-lg ${i.amount > 0 ? 'bg-green-500/10' : 'bg-red-500/10'}">
                        <div>
                            <span class="font-medium">${i.type === 'purchase' ? `–ü–æ–∫—É–ø–∫–∞: ${i.product}` : '–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ'}</span>
                            <p class="text-xs text-gray-400">${new Date(i.date).toLocaleString()}</p>
                        </div>
                        <span class="${i.amount > 0 ? 'text-green-500' : 'text-red-500'} font-semibold">${formatPrice(i.amount)}</span>
                    </li>
                `).join('');
            } else {
                listEl.innerHTML = '<p class="text-center text-gray-500">–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞.</p>';
            }
        }

        // --- EVENT LISTENERS & INITIALIZATION ---
        function setupEventListeners() {
            window.addEventListener('hashchange', handleRouting);
            document.body.addEventListener('click', e => {
                const { target } = e;
                const closest = sel => target.closest(sel);

                if (!closest('#profile-btn') && !closest('#profile-menu')) document.getElementById('profile-menu')?.classList.add('hidden');
                if (closest('.nav-link')) { e.preventDefault(); window.location.hash = new URL(closest('.nav-link').href).hash; }
                if (target.id === 'google-login-btn' || target.id === 'login-redirect') signInWithPopup(auth, new GoogleAuthProvider()).catch(e => showToast("–û—à–∏–±–∫–∞: " + e.message, true));
                if (target.id === 'logout-btn' || target.id === 'logout-btn-profile') signOut(auth);
                if (target.id === 'balance-btn') showBalanceModal();
                if (closest('.buy-now-btn')) { const p = allProducts.find(p => p.id === closest('.buy-now-btn').dataset.productId); if (p) showCheckoutModal([p], p.price); }
                if (closest('#profile-btn')) document.getElementById('profile-menu')?.classList.toggle('hidden');
                if (closest('.faq-question')) {
                    const question = closest('.faq-question');
                    question.classList.toggle('open');
                }
            });
        }
        
        document.addEventListener('DOMContentLoaded', () => { 
            initTheme(); 
            initMobileMenu();
            setupEventListeners(); 
            onAuthStateChanged(auth, async user => { 
                currentUser = user;
                isAdmin = user?.uid === ADMIN_UID;
                if (user) {
                    const userRef = doc(db, "users", user.uid);
                    const userDoc = await getDoc(userRef);
                    if (!userDoc.exists()) await setDoc(userRef, { displayName: user.displayName, email: user.email, photoURL: user.photoURL, uid: user.uid, balance: 0, balanceHistory: [] }, { merge: true });
                    onSnapshot(userRef, docSnap => { 
                        if (docSnap.exists()) {
                            const data = docSnap.data();
                            appState.balance = data.balance || 0; 
                            appState.balanceHistory = data.balanceHistory || [];
                            document.getElementById('balance-amount').textContent = formatPrice(appState.balance);
                        }
                    });
                    document.getElementById('balance-btn')?.classList.remove('hidden');
                } else {
                    document.getElementById('balance-btn')?.classList.add('hidden');
                }
                await Promise.all([loadStoreSettings(), onSnapshot(query(collection(db, "paymentMethods")), s => { paymentMethods = s.docs.map(d => ({ id: d.id, ...d.data() })) })]); 
                await updateAuthUI();
                handleRouting();
                document.getElementById('loading-overlay').style.opacity = '0';
                setTimeout(() => document.getElementById('loading-overlay').style.display = 'none', 500);
                document.body.classList.remove('opacity-0');
            }); 
        });

        // --- ADMIN PANEL ---
        function loadAdminPanel(subpage) {
            const el = document.getElementById('admin-content');
            const tabs = [
                { id: 'products', name: '–¢–æ–≤–∞—Ä—ã' }, { id: 'customization', name: '–ù–∞—Å—Ç—Ä–æ–π–∫–∏' },
                { id: 'purchases', name: '–ü–æ–∫—É–ø–∫–∏'}, { id: 'chats', name: '–ß–∞—Ç—ã'}
            ];
            el.innerHTML = `<h2 class="text-3xl font-bold mb-6">–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h2><nav class="flex border-b border-custom mb-6">${tabs.map(t => `<a href="#admin/${t.id}" class="admin-tab-btn py-3 px-5 ${subpage === t.id ? 'border-b-2 border-primary text-primary' : ''}">${t.name}</a>`).join('')}</nav><div id="admin-tab-content"></div>`;
            const contentEl = document.getElementById('admin-tab-content');
            switch (subpage) {
                case 'products':
                    contentEl.innerHTML = `<button id="add-product-btn" class="btn btn-primary mb-4">–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä</button><div id="admin-products-list" class="space-y-3"></div>`;
                    document.getElementById('add-product-btn').onclick = () => showProductForm();
                    onSnapshot(collection(db, 'products'), s => {
                        document.getElementById('admin-products-list').innerHTML = s.docs.map(d => `
                            <div class="card-bg p-4 rounded flex justify-between items-center border border-custom">
                                <span>${d.data().name}</span>
                                <div>
                                    <button class="edit-product-btn text-blue-400 mr-4" data-id="${d.id}">–†–µ–¥.</button>
                                    <button class="delete-product-btn text-red-500" data-id="${d.id}">–£–¥–∞–ª–∏—Ç—å</button>
                                </div>
                            </div>`).join('');
                    });
                    break;
                case 'customization':
                    loadCustomizationPage();
                    break;
                 case 'purchases':
                    contentEl.innerHTML = `<div id="admin-purchases-list" class="space-y-3"></div>`;
                    onSnapshot(query(collection(db, "purchases"), orderBy("createdAt", "desc")), s => {
                        document.getElementById('admin-purchases-list').innerHTML = s.docs.map(d => {
                            const p = d.data();
                            let actions = '';
                            if (p.status === '–û–∂–∏–¥–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è') {
                                actions = `<button class="approve-purchase-btn bg-green-500 text-white px-3 py-1 text-sm rounded" data-id="${d.id}">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>`;
                            }
                            return `<div class="card-bg p-4 rounded border border-custom">
                                <p><strong>${p.userEmail}</strong> - ${p.items[0].name} (${formatPrice(p.finalPrice)})</p>
                                <p>–°—Ç–∞—Ç—É—Å: ${p.status}</p>
                                ${p.paymentProofUrl ? `<a href="${p.paymentProofUrl}" target="_blank" class="text-blue-500">–ß–µ–∫</a>` : ''}
                                <div class="mt-2">${actions}</div>
                            </div>`;
                        }).join('');
                    });
                    break;
                case 'chats':
                    contentEl.innerHTML = `<div id="admin-chats-list" class="space-y-3"></div>`;
                     onSnapshot(query(collection(db, "userChats"), orderBy("lastActivity", "desc")), s => {
                        document.getElementById('admin-chats-list').innerHTML = s.docs.map(d => `
                            <a href="#" class="open-chat-btn block card-bg p-4 rounded border border-custom" data-uid="${d.data().userId}" data-name="${d.data().userName}">
                                –ß–∞—Ç —Å ${d.data().userName} (ID: ${d.data().userId})
                            </a>`).join('');
                     });
                    break;
            }
        }
        
        async function showProductForm(productId = null) {
            let p = {};
            if (productId) {
                const docSnap = await getDoc(doc(db, 'products', productId));
                if (docSnap.exists()) p = docSnap.data();
            }
            const onSave = async (modal) => {
                const file = modal.querySelector('#p-image-file').files[0];
                let imageUrl = p.imageUrl || '';
                if (file) imageUrl = await uploadImage(file);
                
                const data = {
                    name: modal.querySelector('#p-name').value,
                    description: modal.querySelector('#p-desc').value,
                    price: parseFloat(modal.querySelector('#p-price').value),
                    imageUrl
                };
                
                if (productId) await setDoc(doc(db, 'products', productId), data);
                else await addDoc(collection(db, 'products'), data);
                return true;
            };
            showModal(productId ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–≤–∞—Ä' : '–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä', `
                <div class="space-y-4">
                    <div><label>–ù–∞–∑–≤–∞–Ω–∏–µ</label><input id="p-name" value="${p.name || ''}" class="w-full modern-input"></div>
                    <div><label>–û–ø–∏—Å–∞–Ω–∏–µ</label><textarea id="p-desc" class="w-full modern-input">${p.description || ''}</textarea></div>
                    <div><label>–¶–µ–Ω–∞ (UZS)</label><input id="p-price" type="number" value="${p.price || 0}" class="w-full modern-input"></div>
                    <div><label>–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</label><input type="file" id="p-image-file" class="w-full"></div>
                </div>`, onSave, '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å');
        }

        async function loadCustomizationPage() {
            const el = document.getElementById('admin-tab-content');
            const settings = (await getDoc(doc(db, "storeSettings", "config"))).data() || {};
            
            const renderBanners = (banners = []) => banners.map((b, i) => `<div class="flex items-center justify-between p-2 card-bg rounded"><span>${b.linkUrl}</span><button class="delete-banner-btn text-red-500" data-index="${i}">&times;</button></div>`).join('');
            const renderSocials = (links = []) => links.map((l, i) => `<div class="flex items-center justify-between p-2 card-bg rounded"><span>${l.name}</span><button class="delete-social-btn text-red-500" data-index="${i}">&times;</button></div>`).join('');

            el.innerHTML = `<div class="space-y-6">
                <div><h3 class="text-xl font-bold mb-2">–û–±—ä—è–≤–ª–µ–Ω–∏–µ –¥–ª—è –≤—Å–µ—Ö</h3>
                    <textarea id="announcement-message" class="w-full modern-input" rows="3">${settings.announcement?.message || ''}</textarea>
                    <label class="flex items-center mt-2"><input type="checkbox" id="announcement-enabled" ${settings.announcement?.enabled ? 'checked' : ''}>–í–∫–ª—é—á–∏—Ç—å</label>
                </div>
                <div><h3 class="text-xl font-bold mb-2">–†–µ–∫–ª–∞–º–Ω—ã–µ –±–∞–Ω–Ω–µ—Ä—ã</h3>
                    <div id="banners-list" class="space-y-2">${renderBanners(settings.adBanners)}</div>
                    <button id="add-banner-btn" class="btn mt-2">–î–æ–±–∞–≤–∏—Ç—å –±–∞–Ω–Ω–µ—Ä</button>
                    <button id="clear-banners-btn" class="btn mt-2 bg-red-600 text-white">–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ</button>
                </div>
                <div><h3 class="text-xl font-bold mb-2">–°–æ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–µ—Ç–∏</h3>
                    <div id="socials-list" class="space-y-2">${renderSocials(settings.socialLinks)}</div>
                    <button id="add-social-btn" class="btn mt-2">–î–æ–±–∞–≤–∏—Ç—å —Å—Å—ã–ª–∫—É</button>
                    <button id="clear-socials-btn" class="btn mt-2 bg-red-600 text-white">–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ</button>
                </div>
                <button id="save-customization-btn" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
            </div>`;

            document.getElementById('add-banner-btn').onclick = () => {
                const url = prompt('URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –±–∞–Ω–Ω–µ—Ä–∞:');
                const link = prompt('URL —Å—Å—ã–ª–∫–∏ –±–∞–Ω–Ω–µ—Ä–∞:');
                if(url && link) {
                    settings.adBanners = settings.adBanners || [];
                    settings.adBanners.push({ imageUrl: url, linkUrl: link });
                    document.getElementById('banners-list').innerHTML = renderBanners(settings.adBanners);
                }
            };
             document.getElementById('add-social-btn').onclick = () => {
                const name = prompt('–ù–∞–∑–≤–∞–Ω–∏–µ (–Ω–∞–ø—Ä. Telegram):');
                const url = prompt('URL —Å—Å—ã–ª–∫–∏:');
                const icon = prompt('SVG –∏–∫–æ–Ω–∫–∞ (<path...>):');
                if(name && url && icon) {
                    settings.socialLinks = settings.socialLinks || [];
                    settings.socialLinks.push({ name, url, icon });
                    document.getElementById('socials-list').innerHTML = renderSocials(settings.socialLinks);
                }
            };
            
            el.addEventListener('click', e => {
                if(e.target.matches('.delete-banner-btn')) {
                    settings.adBanners.splice(e.target.dataset.index, 1);
                    document.getElementById('banners-list').innerHTML = renderBanners(settings.adBanners);
                }
                if(e.target.matches('.delete-social-btn')) {
                    settings.socialLinks.splice(e.target.dataset.index, 1);
                    document.getElementById('socials-list').innerHTML = renderSocials(settings.socialLinks);
                }
                if(e.target.matches('#clear-banners-btn')) {
                    settings.adBanners = [];
                    document.getElementById('banners-list').innerHTML = '';
                }
                if(e.target.matches('#clear-socials-btn')) {
                    settings.socialLinks = [];
                    document.getElementById('socials-list').innerHTML = '';
                }
            });

            document.getElementById('save-customization-btn').onclick = async () => {
                const dataToSave = {
                    adBanners: settings.adBanners || [],
                    socialLinks: settings.socialLinks || [],
                    announcement: {
                        message: document.getElementById('announcement-message').value,
                        enabled: document.getElementById('announcement-enabled').checked
                    }
                };
                await setDoc(doc(db, "storeSettings", "config"), dataToSave, { merge: true });
                showToast('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!');
                loadStoreSettings();
            };
        }

        document.body.addEventListener('click', e => {
            if (e.target.matches('.edit-product-btn')) showProductForm(e.target.dataset.id);
            if (e.target.matches('.delete-product-btn')) confirmAction('–£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä?', () => deleteDoc(doc(db, 'products', e.target.dataset.id)));
            if (e.target.matches('.approve-purchase-btn')) updateDoc(doc(db, 'purchases', e.target.dataset.id), { status: '–í—ã–ø–æ–ª–Ω–µ–Ω' });
            if (e.target.matches('.open-chat-btn')) {
                const { uid, name } = e.target.dataset;
                const chatId = `${uid}_${ADMIN_UID}`;
                const modalContent = `<div id="modal-chat-container"></div>`;
                const modal = showModal(`–ß–∞—Ç —Å ${name}`, modalContent, null);
                renderChatInterface(modal.querySelector('#modal-chat-container'), chatId, ADMIN_UID);
            }
        });

    </script>
</body>
</html>
ÔøΩ
