<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asonik Store</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script type="module">
        // Импорт необходимых модулей Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, doc, deleteDoc, setDoc, serverTimestamp, query, where, orderBy, updateDoc, getDocs, increment, getDoc } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-storage.js";
        
        // Предоставление доступа к Firebase через глобальный объект window для использования в Babel
        window.firebase = {
            initializeApp, getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut, updateProfile,
            getFirestore, collection, onSnapshot, addDoc, doc, deleteDoc, setDoc, serverTimestamp, query, where, orderBy, updateDoc, getDocs, increment, getDoc,
            getStorage, ref, uploadBytes, getDownloadURL, deleteObject
        };
    </script>
    <style>
        /* Основные стили для body и шрифта */
        body { font-family: 'Inter', sans-serif; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; transition: background-color 0.3s, color 0.3s; }
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        
        /* CSS переменные для темной темы по умолчанию */
        :root {
            --bg-primary: #111827;
            --bg-secondary: #1f2937;
            --bg-tertiary: #374151;
            --text-primary: #f9fafb;
            --text-secondary: #d1d5db;
            --accent-primary: #8b5cf6;
            --accent-secondary: #a78bfa;
            --border-color: #374151;
        }
        /* CSS переменные для светлой темы */
        body.light {
            --bg-primary: #f9fafb;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f3f4f6;
            --text-primary: #111827;
            --text-secondary: #4b5563;
            --border-color: #e5e7eb;
        }
        /* CSS переменные для фирменной темы */
        body.asonik {
            --bg-primary: linear-gradient(to bottom right, #f3e8ff, #ffffff);
            --bg-secondary: #ffffff;
            --bg-tertiary: #f3f4f6;
            --text-primary: #4c1d95;
            --text-secondary: #6d28d9;
            --accent-primary: #8b5cf6;
            --accent-secondary: #a78bfa;
            --border-color: #e5e7eb;
        }
        /* Стили для мобильного меню */
        .mobile-menu-container {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--bg-primary);
            z-index: 50;
            display: flex;
            flex-direction: column;
            padding: 1rem;
            transform: translateX(100%);
            transition: transform 0.3s ease-out;
        }
        .mobile-menu-container.open {
            transform: translateX(0%);
        }
        .mobile-menu-item {
            padding: 0.75rem 1rem;
            margin-bottom: 0.5rem;
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            cursor: pointer;
            border-radius: 0.5rem;
            transition: background-color 0.2s;
        }
        .mobile-menu-item:hover {
            background-color: var(--bg-secondary);
        }
    </style>
</head>
<body class="bg-primary text-primary">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useRef, useMemo, Component } = React;
        const { 
            initializeApp, getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut, updateProfile,
            getFirestore, collection, onSnapshot, addDoc, doc, deleteDoc, setDoc, serverTimestamp, query, where, orderBy, updateDoc, getDocs, increment, getDoc,
            getStorage, ref, uploadBytes, getDownloadURL, deleteObject
        } = window.firebase;

        // --- Конфигурация приложения ---
        const firebaseConfig = {
            apiKey: "AIzaSyC7smDYoy-LT58xCwjJsc9uZU9CgHQv5dM",
            authDomain: "ya-buxgalter.firebaseapp.com",
            projectId: "ya-buxgalter",
            storageBucket: "ya-buxgalter.appspot.com",
            messagingSenderId: "640345805387",
            appId: "1:640345805387:web:a1adade77f809af84cb3ce",
            measurementId: "G-0TKE25JVXG"
        };
        
        const ADMIN_UID = 'vhmtXZxkZnOWviNQ39R1W3GE8mw2';
        const ADMIN_PIN = '300414';
        const IMGBB_API_KEY = '96bf3f29606f1989bb5a450ad3770cce';

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);
        const provider = new GoogleAuthProvider();
        
        const logoBase64 = "data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/2wBDAAYEBQYFBAYGBQYHBwYIChAKCgkJChQODwwQFxQYGBcUFhYaHSUfGhsjHBYWICwgIyYnKSopGR8tMC0oMCUoKSj/2wBDAQcHBwoIChMKChMoGhYaKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCj/wAARCAAgACADASIAAhEBARAf/8QAGQAAAgMBAAAAAAAAAAAAAAAAAAYDBAUH/8QAIxAAAQQCAgICAwAAAAAAAAAAAQIDBAUGEQASITFBURMUYf/EABQBAQAAAAAAAAAAAAAAAAAAAAD/xAAUEQEAAAAAAAAAAAAAAAAAAAAA/9oADAMBAAIRAxEAPwD2ERkACK5uX1WzYtprKqKxckO2E5sNqS0lxLbqFpWlQBSoAgjYI9j39cZkABEV7OpaO6xYlXl0V6bYSHENNR2klS1qUoJSkAekkkgD+8YkABGczL6bT1kuyupLMNhhJWtbywkgD6Gz1J+g98ZkAB//2Q==";
        
        // --- Вспомогательные компоненты и функции ---
        const generatePurchaseCode = () => {
            const chars = 'ABCDEFGHIJKLMNPQRSTUVWXYZ13456789';
            let result = '';
            for (let i = 0; i < 6; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result.match(/.{1,3}/g).join('-');
        };
        
        const Logo = () => ( <div className="flex items-center space-x-2 cursor-pointer"> <img src={logoBase64} alt="Asonik Store Logo" className="h-12 w-12 object-contain"/> <span className="text-2xl md:text-3xl font-bold tracking-wider" style={{color: 'var(--text-primary)'}}> Asonik <span style={{color: 'var(--accent-primary)'}}>Store</span> </span> </div> );
        const LoadingSpinner = () => ( <div style={{background: 'var(--bg-primary)'}} className="min-h-screen flex items-center justify-center"><div className="animate-spin rounded-full h-32 w-32 border-t-4 border-b-4" style={{borderColor: 'var(--accent-primary)'}}></div></div> );
        
        const Modal = ({ children, onClose, size = 'max-w-md' }) => ( <div className="fixed inset-0 bg-black bg-opacity-75 z-50 flex justify-center items-center p-4 transition-opacity duration-300"> <div className={`rounded-2xl shadow-2xl p-6 md:p-8 w-full ${size} relative border transform transition-transform duration-300 scale-95 animate-scale-in`} style={{backgroundColor: 'var(--bg-secondary)', borderColor: 'var(--border-color)'}}> <button onClick={onClose} className="absolute top-4 right-4 transition-colors z-10" style={{color: 'var(--text-secondary)'}}> <svg xmlns="http://www.w3.org/2000/svg" className="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg> </button> {children} </div> <style>{` @keyframes scale-in { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } } .animate-scale-in { animation: scale-in 0.3s ease-out forwards; } `}</style> </div> );
        
        const AlertModal = ({ message, onConfirm, onCancel, t }) => ( <Modal onClose={onCancel}> <div className="text-center"> <h2 className="text-2xl font-bold mb-4" style={{color: 'var(--text-primary)'}}>{t.confirmation}</h2> <p className="mb-6 whitespace-pre-wrap" style={{color: 'var(--text-secondary)'}}>{message}</p> <div className={`flex ${onConfirm ? 'justify-between' : 'justify-center'} space-x-4`}> <button onClick={onCancel} className="font-bold py-2 px-6 rounded-lg transition-colors" style={{backgroundColor: 'var(--bg-tertiary)', color: 'var(--text-primary)'}}>{onConfirm ? t.cancel : t.ok}</button> {onConfirm && ( <button onClick={onConfirm} className="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg transition-colors">{t.confirm}</button> )} </div> </div> </Modal> );
        
        const ProfileModal = ({ user, onClose, t, setAlertInfo, onLogout }) => {
            const [isUploading, setIsUploading] = useState(false);
            const [color, setColor] = useState('#8b5cf6');
            const fileInputRef = useRef(null);
            const [firstName, setFirstName] = useState('');
            const [lastName, setLastName] = useState('');
            const [nickname, setNickname] = useState('');

            useEffect(() => {
                const currentDisplayName = user.displayName || '';
                const parts = currentDisplayName.split(' ');
                setFirstName(parts[0] || '');
                setLastName(parts.slice(1).join(' ') || '');
                setNickname(user.nickname || ''); 
            }, [user]);

            const handleUpdateProfile = async (e) => {
                e.preventDefault();
                setIsUploading(true);
                try {
                    const newDisplayName = `${firstName} ${lastName}`.trim();
                    await updateProfile(auth.currentUser, { displayName: newDisplayName });
                    setAlertInfo({ message: t.profileUpdated || 'Профиль обновлен!' });
                    setTimeout(() => { auth.updateCurrentUser(auth.currentUser); }, 500); 
                } catch (error) {
                    console.error("Error updating profile:", error);
                    setAlertInfo({ message: `${t.errorOccurred}: ${error.message}` });
                } finally {
                    setIsUploading(false);
                    onClose();
                }
            };

            const handleImageUpload = async (file) => {
                if (!file) return;
                if (!IMGBB_API_KEY) { setAlertInfo({ message: t.noApiKey }); return; }
                setIsUploading(true);
                const formData = new FormData();
                formData.append('image', file);

                try {
                    const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, { method: 'POST', body: formData });
                    const result = await response.json();
                    if (result.success) {
                        await updateProfile(auth.currentUser, { photoURL: result.data.url });
                        setAlertInfo({ message: t.avatarUpdated });
                        setTimeout(() => { auth.updateCurrentUser(auth.currentUser); }, 500);
                    } else { throw new Error(result.error.message); }
                } catch (error) { console.error("Error uploading avatar:", error); setAlertInfo({ message: `${t.errorOccurred}: ${error.message}` }); } 
                finally { setIsUploading(false); onClose(); }
            };
            
            const handleColorAvatar = async () => {
                const colorHex = color.substring(1);
                const photoURL = `https://placehold.co/128x128/${colorHex}/FFFFFF?text=${user.displayName ? user.displayName.charAt(0) : '?'}`;
                try {
                    await updateProfile(auth.currentUser, { photoURL });
                    setAlertInfo({ message: t.avatarUpdated });
                    setTimeout(() => { auth.updateCurrentUser(auth.currentUser); }, 500);
                } catch(error) { console.error("Error setting color avatar:", error); setAlertInfo({ message: t.errorOccurred }); }
                finally { onClose(); }
            };

            const handleRevertAvatar = async () => {
                const originalPhotoURL = auth.currentUser.providerData[0]?.photoURL;
                if (originalPhotoURL) {
                    try {
                        await updateProfile(auth.currentUser, { photoURL: originalPhotoURL });
                        setAlertInfo({ message: t.avatarReverted });
                        setTimeout(() => { auth.updateCurrentUser(auth.currentUser); }, 500);
                    } catch (error) { console.error("Error reverting avatar:", error); setAlertInfo({ message: t.errorOccurred }); } 
                    finally { onClose(); }
                }
            };

            return (
                <Modal onClose={onClose}>
                    <div className="text-center" style={{color: 'var(--text-primary)'}}>
                        <h2 className="text-3xl font-bold mb-4">{t.profile}</h2>
                        <div className="relative mx-auto mb-4 w-24 h-24">
                             <img src={user.photoURL} alt={user.displayName} className={`w-full h-full rounded-full mx-auto border-4 object-cover`} style={{ borderColor: user.photoURL && user.photoURL.includes('placehold.co') ? color : 'var(--accent-primary)' }}/>
                             <button onClick={() => fileInputRef.current.click()} className="absolute bottom-0 right-0 bg-gray-700 p-2 rounded-full border" style={{borderColor: 'var(--border-color)'}}>
                                 <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 text-white" viewBox="0 0 20 20" fill="currentColor"><path d="M13.586 3.586a2 2 0 112.828 2.828l-7.293 7.293A1 1 0 018.657 14H5a1 1 0 01-1-1v-3.657a1 1 0 01.293-.707l7.293-7.293zM10 2a1 1 0 00-1 1v2a1 1 0 102 0V3a1 1 0 00-1-1z" /></svg>
                             </button>
                        </div>
                        <p className="text-xl mb-2">{user.displayName}</p>
                        <p className="mb-6" style={{color: 'var(--text-secondary)'}}>{user.email}</p>
                        
                        <form onSubmit={handleUpdateProfile} className="space-y-4 mb-6">
                            <div>
                                <label className="block text-sm font-bold mb-1" style={{color: 'var(--text-secondary)'}}>{t.firstName || 'Имя'}</label>
                                <input type="text" value={firstName} onChange={e => setFirstName(e.target.value)} className="w-full p-2 rounded-lg border" style={{backgroundColor: 'var(--bg-tertiary)', borderColor: 'var(--border-color)', color: 'var(--text-primary)'}}/>
                            </div>
                            <div>
                                <label className="block text-sm font-bold mb-1" style={{color: 'var(--text-secondary)'}}>{t.lastName || 'Фамилия'}</label>
                                <input type="text" value={lastName} onChange={e => setLastName(e.target.value)} className="w-full p-2 rounded-lg border" style={{backgroundColor: 'var(--bg-tertiary)', borderColor: 'var(--border-color)', color: 'var(--text-primary)'}}/>
                            </div>
                            <div>
                                <label className="block text-sm font-bold mb-1" style={{color: 'var(--text-secondary)'}}>{t.nickname || 'Никнейм'}</label>
                                <input type="text" value={nickname} onChange={e => setNickname(e.target.value)} className="w-full p-2 rounded-lg border" style={{backgroundColor: 'var(--bg-tertiary)', borderColor: 'var(--border-color)', color: 'var(--text-primary)'}}/>
                            </div>
                            <button type="submit" className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-colors" disabled={isUploading}>
                                {isUploading ? t.sending : t.updateProfile || 'Обновить профиль'}
                            </button>
                        </form>

                        <div className="space-y-3">
                            <div className="flex items-center space-x-2">
                                <button onClick={handleColorAvatar} className="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">{t.setColorAvatar || 'Установить цвет рамки'}</button>
                                <input type="color" value={color} onChange={e => setColor(e.target.value)} className="p-1 h-10 w-14 block border cursor-pointer rounded-lg" style={{backgroundColor: 'var(--bg-tertiary)', borderColor: 'var(--border-color)'}}/>
                            </div>
                            <button onClick={handleRevertAvatar} className="w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">{t.revertAvatar}</button>
                        </div>
                        <input type="file" ref={fileInputRef} onChange={(e) => handleImageUpload(e.target.files[0])} accept="image/*" className="hidden"/>
                    </div>
                </Modal>
            );
        };
        
        const CustomSelector = ({ value, onChange, options }) => {
            const [isOpen, setIsOpen] = useState(false);
            const wrapperRef = useRef(null);

            useEffect(() => {
                function handleClickOutside(event) {
                    if (wrapperRef.current && !wrapperRef.current.contains(event.target)) { setIsOpen(false); }
                }
                document.addEventListener("mousedown", handleClickOutside);
                return () => document.removeEventListener("mousedown", handleClickOutside);
            }, [wrapperRef]);

            const handleSelect = (newValue) => {
                onChange({ target: { value: newValue } });
                setIsOpen(false);
            };

            return (
                <div className="relative" ref={wrapperRef}>
                    <button onClick={() => setIsOpen(!isOpen)} className="flex items-center justify-between w-full font-semibold py-2 px-4 rounded-lg transition-colors" style={{backgroundColor: 'var(--bg-tertiary)', color: 'var(--text-primary)'}}>
                        <span>{options.find(o => o.value === value)?.label || ''}</span>
                        <svg className={`w-4 h-4 transition-transform ${isOpen ? 'transform rotate-180' : ''}`} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    {isOpen && (
                        <div className="absolute right-0 mt-2 w-full rounded-md shadow-lg py-1 z-50 border" style={{backgroundColor: 'var(--bg-tertiary)', borderColor: 'var(--border-color)'}}>
                            {options.map(opt => (
                                <a href="#" key={opt.value} onClick={(e) => { e.preventDefault(); handleSelect(opt.value); }}
                                    className={`block px-4 py-2 text-sm hover:text-text-primary ${value === opt.value ? 'text-white' : ''}`}
                                    style={value === opt.value ? {backgroundColor: 'var(--accent-primary)', color: '#fff'} : {color: 'var(--text-secondary)'}}>
                                    {opt.label}
                                </a>
                            ))}
                        </div>
                    )}
                </div>
            );
        };

        const PinModal = ({ onSubmit, onClose, error, t, setRememberMe }) => {
            const [pin, setPin] = useState('');
            const [attempts, setAttempts] = useState(0);
            const [isLocked, setIsLocked] = useState(false);
            const [countdown, setCountdown] = useState(0);
            const [rememberMeChecked, setRememberMeChecked] = useState(false);

            useEffect(() => {
                let timer;
                if (isLocked) {
                    setCountdown(15);
                    timer = setInterval(() => {
                        setCountdown(prev => {
                            if (prev <= 1) {
                                clearInterval(timer);
                                setIsLocked(false);
                                setAttempts(0);
                                return 0;
                            }
                            return prev - 1;
                        });
                    }, 1000);
                }
                return () => clearInterval(timer);
            }, [isLocked]);

            const handleSubmit = (e) => {
                e.preventDefault();
                if (isLocked) return;

                const success = onSubmit(pin, rememberMeChecked);
                if (!success) {
                    const newAttempts = attempts + 1;
                    setAttempts(newAttempts);
                    if (newAttempts >= 5) {
                        setIsLocked(true);
                    }
                }
            };

            return (
                <Modal onClose={onClose} size="max-w-sm">
                    <form onSubmit={handleSubmit} className="text-center">
                        <h2 className="text-2xl font-bold mb-4" style={{color: 'var(--text-primary)'}}>{t.adminAccess}</h2>
                        <p className="mb-6" style={{color: 'var(--text-secondary)'}}>{t.enterPin}</p>
                        <input
                            type="password"
                            value={pin}
                            onChange={(e) => setPin(e.target.value)}
                            className="w-full p-3 rounded-lg border text-center text-2xl tracking-[.5em] disabled:opacity-50"
                            style={{backgroundColor: 'var(--bg-tertiary)', borderColor: 'var(--border-color)', color: 'var(--text-primary)'}}
                            maxLength="6"
                            autoFocus
                            disabled={isLocked}
                        />
                        {error && !isLocked && <p className="text-red-500 text-sm mt-2">{error}</p>}
                        {isLocked && <p className="text-yellow-500 text-sm mt-2">Слишком много попыток. Попробуйте через {countdown} секунд.</p>}
                        
                        <div className="flex items-center justify-center mt-4">
                            <input
                                type="checkbox"
                                id="rememberMe"
                                checked={rememberMeChecked}
                                onChange={(e) => setRememberMeChecked(e.target.checked)}
                                className="form-checkbox h-4 w-4 text-purple-600 rounded"
                            />
                            <label htmlFor="rememberMe" className="ml-2 text-sm" style={{color: 'var(--text-secondary)'}}>{t.rememberMe || 'Запомнить меня (10 минут)'}</label>
                        </div>

                        <button type="submit" className="w-full mt-6 bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-4 rounded-lg transition-colors disabled:bg-gray-500" disabled={isLocked}>
                            {isLocked ? `Заблокировано (${countdown})` : t.enter}
                        </button>
                    </form>
                </Modal>
            );
        };

        // --- Основные компоненты ---
        function Header({ user, onLogin, onLogout, setPage, isAdmin, t, currency, setCurrency, language, setLanguage, setProfileVisible, theme, setTheme, onAdminClick }) {
            const [userDropdownOpen, setUserDropdownOpen] = useState(false);
            const [mobileMenuOpen, setMobileMenuOpen] = useState(false);
            const userDropdownRef = useRef(null);

            const langOptions = [{value: 'ru', label: t.russian}, {value: 'en', label: t.english}, {value: 'uz', label: t.uzbek}];
            const currencyOptions = [{value: 'RUB', label: t.ruble}, {value: 'USD', label: t.dollar}, {value: 'UZS', label: t.sum}];
            
            const themeOptions = [
                {value: 'asonik', label: t.asonikTheme},
                {value: 'dark', label: t.darkTheme}, 
                {value: 'light', label: t.lightTheme}, 
            ];

            useEffect(() => {
                function handleClickOutside(event) {
                    if (userDropdownRef.current && !userDropdownRef.current.contains(event.target)) { setUserDropdownOpen(false); }
                }
                document.addEventListener("mousedown", handleClickOutside);
                return () => document.removeEventListener("mousedown", handleClickOutside);
            }, [userDropdownRef]);
            
            const handleMenuItemClick = (pageName) => {
                setPage(pageName);
                setMobileMenuOpen(false);
            };

            return (
                <header className="p-4 shadow-lg sticky top-0 z-40 border-b" style={{backgroundColor: 'var(--bg-secondary)', borderColor: 'var(--border-color)'}}>
                    <div className="container mx-auto flex justify-between items-center">
                        <div onClick={() => handleMenuItemClick('home')}><Logo /></div>
                        <nav className="hidden md:flex items-center space-x-6">
                            <button onClick={() => handleMenuItemClick('home')} className="font-medium transition-colors hover:text-text-primary" style={{color: 'var(--text-secondary)'}}>{t.home}</button>
                            {user && <button onClick={() => handleMenuItemClick('purchases')} className="font-medium transition-colors hover:text-text-primary" style={{color: 'var(--text-secondary)'}}>{t.myPurchases}</button>}
                            <button onClick={() => handleMenuItemClick('faq')} className="font-medium transition-colors hover:text-text-primary" style={{color: 'var(--text-secondary)'}}>{t.faq}</button>
                            {user && <button onClick={() => handleMenuItemClick('chats')} className="font-medium transition-colors hover:text-text-primary" style={{color: 'var(--text-secondary)'}}>{t.chats}</button>}
                        </nav>
                        <div className="flex items-center space-x-2 sm:space-x-4">
                            <div className="hidden md:block w-36"><CustomSelector value={language} onChange={e => setLanguage(e.target.value)} options={langOptions} /></div>
                            <div className="hidden md:block w-28"><CustomSelector value={currency} onChange={e => setCurrency(e.target.value)} options={currencyOptions} /></div>
                            <div className="hidden md:block w-48"><CustomSelector value={theme} onChange={e => setTheme(e.target.value)} options={themeOptions} /></div>
                            
                            {user ? (
                                <div className="relative" ref={userDropdownRef}>
                                    <button onClick={() => setUserDropdownOpen(!userDropdownOpen)} className="flex items-center space-x-2">
                                        <img src={user.photoURL} alt={user.displayName} className="h-10 w-10 rounded-full border-2 object-cover" style={{borderColor: 'var(--accent-primary)'}}/>
                                        <svg className={`w-4 h-4 transition-transform ${userDropdownOpen ? 'transform rotate-180' : ''}`} style={{color: 'var(--text-primary)'}} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 9l-7 7-7-7"></path></svg>
                                    </button>
                                    {userDropdownOpen && (
                                        <div className={`absolute right-0 mt-2 w-48 rounded-md shadow-lg py-1 z-50 border`} style={{backgroundColor: 'var(--bg-secondary)', borderColor: 'var(--border-color)'}}>
                                            <a href="#" onClick={(e) => { e.preventDefault(); setProfileVisible(true); setUserDropdownOpen(false); }} className="block px-4 py-2 text-sm hover:text-text-primary" style={{color: 'var(--text-secondary)'}}>{t.profile}</a>
                                            {isAdmin && <a href="#" onClick={(e) => { e.preventDefault(); onAdminClick(); setUserDropdownOpen(false); }} className="block px-4 py-2 text-sm text-red-500 hover:text-red-400">{t.adminPanelTitle}</a>}
                                            <a href="#" onClick={(e) => { e.preventDefault(); onLogout(); setUserDropdownOpen(false); }} className="block px-4 py-2 text-sm hover:text-text-primary" style={{color: 'var(--text-secondary)'}}>{t.logout}</a>
                                        </div>
                                    )}
                                </div>
                            ) : (
                                <button onClick={onLogin} className="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg transition-transform transform hover:scale-105 flex items-center space-x-2">
                                    <span>{t.login}</span>
                                </button>
                            )}
                            <button className="md:hidden p-2 rounded-md hover:bg-tertiary" style={{color: 'var(--text-primary)'}} onClick={() => setMobileMenuOpen(!mobileMenuOpen)}>
                                <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6h16M4 12h16M4 18h16" /></svg>
                            </button>
                        </div>
                    </div>

                    <div className={`mobile-menu-container ${mobileMenuOpen ? 'open' : ''}`}>
                        <div className="flex justify-end mb-4">
                            <button className="p-2 rounded-md hover:bg-secondary" style={{color: 'var(--text-primary)'}} onClick={() => setMobileMenuOpen(false)}>
                                <svg xmlns="http://www.w3.org/2000/svg" className="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg>
                            </button>
                        </div>
                        <button onClick={() => handleMenuItemClick('home')} className="mobile-menu-item">{t.home}</button>
                        {user && <button onClick={() => handleMenuItemClick('purchases')} className="mobile-menu-item">{t.myPurchases}</button>}
                        <button onClick={() => handleMenuItemClick('faq')} className="mobile-menu-item">{t.faq}</button>
                        {user && <button onClick={() => handleMenuItemClick('chats')} className="mobile-menu-item">{t.chats}</button>}
                        {user ? (
                            <>
                                <button onClick={() => { setProfileVisible(true); setMobileMenuOpen(false); }} className="mobile-menu-item">{t.profile}</button>
                                {isAdmin && <button onClick={() => { onAdminClick(); setMobileMenuOpen(false); }} className="mobile-menu-item text-red-500">{t.adminPanelTitle}</button>}
                                <button onClick={() => { onLogout(); setMobileMenuOpen(false); }} className="mobile-menu-item">{t.logout}</button>
                            </>
                        ) : (
                            <button onClick={() => { onLogin(); setMobileMenuOpen(false); }} className="mobile-menu-item">{t.login}</button>
                        )}
                         <div className="mt-auto pt-4 border-t flex flex-col items-center" style={{borderColor: 'var(--border-color)'}}>
                            <div className="w-full mb-2"><CustomSelector value={language} onChange={e => setLanguage(e.target.value)} options={langOptions} /></div>
                            <div className="w-full mb-2"><CustomSelector value={currency} onChange={e => setCurrency(e.target.value)} options={currencyOptions} /></div>
                            <div className="w-full"><CustomSelector value={theme} onChange={e => setTheme(e.target.value)} options={themeOptions} /></div>
                        </div>
                    </div>
                </header>
            );
        }
        
        const SkeletonCard = () => (
            <div className="rounded-2xl overflow-hidden shadow-lg animate-pulse" style={{backgroundColor: 'var(--bg-secondary)', borderColor: 'var(--border-color)'}}>
                <div className="w-full h-56" style={{backgroundColor: 'var(--bg-tertiary)'}}></div>
                <div className="p-6">
                    <div className="h-8 rounded w-3/4 mb-2" style={{backgroundColor: 'var(--bg-tertiary)'}}></div>
                    <div className="h-6 rounded w-1/2 mb-4" style={{backgroundColor: 'var(--bg-tertiary)'}}></div>
                    <div className="h-10 rounded w-1/3" style={{backgroundColor: 'var(--bg-tertiary)'}}></div>
                </div>
            </div>
        );

        function HomePage({ products, onProductClick, t, currency, convertPrice, loading }) {
            const [searchTerm, setSearchTerm] = useState('');
            const [filterCategory, setFilterCategory] = useState('all');
            const [sortBy, setSortBy] = useState('new');

            const filteredAndSortedProducts = useMemo(() => {
                return products
                    .filter(p => p.isOnSale === undefined || p.isOnSale !== false)
                    .filter(p => p.name.toLowerCase().includes(searchTerm.toLowerCase()))
                    .filter(p => filterCategory === 'all' || p.category === filterCategory)
                    .sort((a, b) => {
                        if (a.pinned && !b.pinned) return -1;
                        if (!a.pinned && b.pinned) return 1;
                        if (sortBy === 'popular') return (b.popularity || 0) - (a.popularity || 0);
                        return (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0);
                    });
            }, [products, searchTerm, filterCategory, sortBy]);

            const FilterButton = ({ value, state, setState, children }) => (
                <button onClick={() => setState(value)} className={`px-4 py-2 rounded-lg text-sm transition-colors ${state === value ? 'bg-purple-600 text-white' : 'hover:bg-gray-600'}`} style={state !== value ? {backgroundColor: 'var(--bg-tertiary)', color: 'var(--text-primary)'} : {}}>
                    {children}
                </button>
            );

            const categories = useMemo(() => {
                const cats = { all: t.all };
                products.forEach(p => { if (p.category) cats[p.category] = p.category; });
                return Object.keys(cats).map(key => ({ value: key, label: t[key.toLowerCase()] || key }));
            }, [products, t]);

            return (
                <main className="container mx-auto p-4 md:p-8">
                    <h1 className="text-4xl md:text-5xl font-black text-center mb-4 tracking-wide" style={{color: 'var(--text-primary)'}}>{t.catalogTitle}</h1>
                    <p className="text-center mb-8 text-lg" style={{color: 'var(--accent-primary)'}}>{t.catalogSubtitle}</p>
                    
                    <div className="p-4 rounded-xl mb-8 flex flex-col md:flex-row gap-4 items-center" style={{backgroundColor: 'var(--bg-secondary)'}}>
                        <input type="text" placeholder={t.searchPlaceholder} value={searchTerm} onChange={e => setSearchTerm(e.target.value)} className="w-full md:w-1/3 p-3 rounded-lg border focus:outline-none focus:ring-2" style={{backgroundColor: 'var(--bg-tertiary)', borderColor: 'var(--border-color)', color: 'var(--text-primary)', '--tw-ring-color': 'var(--accent-primary)'}} />
                        <div className="flex items-center gap-2">
                            <span className="font-semibold" style={{color: 'var(--text-secondary)'}}>{t.category}:</span>
                            <div className="w-40"><CustomSelector value={filterCategory} onChange={e => setFilterCategory(e.target.value)} options={categories} /></div>
                        </div>
                        <div className="flex items-center gap-2 ml-auto">
                            <span className="font-semibold" style={{color: 'var(--text-secondary)'}}>{t.sortBy}:</span>
                            <FilterButton value="new" state={sortBy} setState={setSortBy}>{t.newSort}</FilterButton>
                            <FilterButton value="popular" state={sortBy} setState={setSortBy}>{t.popularSort}</FilterButton>
                        </div>
                    </div>
                    
                    {loading ? (
                         <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                            {[...Array(6)].map((_, i) => <SkeletonCard key={i} />)}
                        </div>
                    ) : filteredAndSortedProducts.length === 0 ? (
                         <p className="text-center text-xl mt-12" style={{color: 'var(--text-secondary)'}}>{t.productsNotFound}</p>
                    ) : (
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                            {filteredAndSortedProducts.map(product => (
                                <ProductCard key={product.id} {...{product, onProductClick, t, currency, convertPrice}} />
                            ))}
                        </div>
                    )}
                </main>
            );
        }

        function ProductCard({ product, onProductClick, t, currency, convertPrice }) {
            const imageUrl = (product.imageUrls && product.imageUrls.length > 0) ? product.imageUrls[0] : (product.imageUrl || '');
            const displayPrice = useMemo(() => {
                if (product.variants && product.variants.length > 0) {
                    const minPrice = Math.min(...product.variants.map(v => v.price));
                    return convertPrice(minPrice, currency);
                }
                return convertPrice(product.price || 0, currency);
            }, [product.variants, product.price, currency]);
            
            const displayNominal = useMemo(() => {
                if (product.variants && product.variants.length > 0) {
                    return product.variants[0].nominal;
                }
                return product.nominal;
            }, [product.variants, product.nominal]);

            const displayStock = useMemo(() => {
                if (product.variants && product.variants.length > 0) {
                    const totalStock = product.variants.reduce((sum, v) => sum + (parseInt(v.stockQuantity) || 0), 0);
                    return totalStock;
                }
                return (product.stockQuantity !== undefined ? product.stockQuantity : -1);
            }, [product.variants, product.stockQuantity]);

            return (
                <div onClick={() => onProductClick(product)} className="rounded-2xl overflow-hidden shadow-lg border transform hover:-translate-y-2 transition-transform duration-300 flex flex-col cursor-pointer relative" style={{backgroundColor: 'var(--bg-secondary)', borderColor: 'var(--border-color)'}}>
                    {product.pinned && <div className="absolute top-0 right-0 bg-yellow-400 text-black text-xs font-bold px-3 py-1 rounded-bl-lg z-10">{t.pinned}</div>}
                    {product.isOnSale === false && <span className="absolute top-2 left-2 bg-gray-500 text-white text-xs font-bold px-2 py-1 rounded-full">{t.removedFromSale || 'Снято с продажи'}</span>}
                    <img className="w-full h-56 object-cover" src={imageUrl} alt={product.name} onError={(e) => { e.target.onerror = null; e.target.src=`https://placehold.co/600x400/1f2937/374151?text=${encodeURIComponent(t.imageNotFound)}`; }}/>
                    <div className="p-6 flex flex-col flex-grow">
                        {product.isVerified && (
                            <div className="flex items-center text-green-400 text-sm mb-2">
                                <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clipRule="evenodd" /></svg>
                                {t.verifiedByStore}
                            </div>
                        )}
                        <h3 className="text-2xl font-bold mb-1" style={{color: 'var(--text-primary)'}}>{product.name}</h3>
                        {displayNominal && <p className="font-semibold mb-2" style={{color: 'var(--accent-primary)'}}>{displayNominal}</p>}
                        
                        {product.variants && product.variants.length > 1 && (
                            <p className="text-sm mb-2" style={{color: 'var(--text-secondary)'}}>
                                {t.priceFrom}: {displayPrice} {product.variants.length > 1 && `+ ${product.variants.length - 1} ${t.moreOptions || 'варианта'}`}
                            </p>
                        )}
                        
                        <div className="flex-grow"></div>
                        <div className="flex justify-between items-center mt-4">
                            <span className="text-3xl font-bold" style={{color: 'var(--accent-primary)'}}>{displayPrice}</span>
                            {displayStock !== -1 && displayStock <= 0 && (
                                <span className="bg-red-500 text-white text-xs font-bold px-2 py-1 rounded-full">{t.outOfStock || 'Нет в наличии'}</span>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        function ProductModal({ product, user, onClose, onBuy, setAlertInfo, t, currency, convertPrice }) {
            const [currentImageIndex, setCurrentImageIndex] = useState(0);
            const imageUrls = (product.imageUrls && product.imageUrls.length > 0) ? product.imageUrls : [product.imageUrl || ''];
            const [selectedVariantIndex, setSelectedVariantIndex] = useState(0);

            useEffect(() => {
                setSelectedVariantIndex(0);
            }, [product]);

            const currentVariant = product.variants && product.variants.length > 0
                ? product.variants[selectedVariantIndex]
                : { nominal: product.nominal, price: product.price, stockQuantity: product.stockQuantity };

            const nextImage = () => setCurrentImageIndex((prev) => (prev + 1) % imageUrls.length);
            const prevImage = () => setCurrentImageIndex((prev) => (prev - 1 + imageUrls.length) % imageUrls.length);

             const handleShare = () => {
                const productUrl = `${window.location.origin}${window.location.pathname}?product=${product.id}`;
                navigator.clipboard.writeText(productUrl).then(() => {
                    setAlertInfo({ message: t.linkCopied });
                }, () => {
                    try {
                        const dummy = document.createElement('textarea');
                        document.body.appendChild(dummy);
                        dummy.value = productUrl;
                        dummy.select();
                        document.execCommand('copy');
                        document.body.removeChild(dummy);
                        setAlertInfo({ message: t.linkCopied });
                    } catch (err) {
                        setAlertInfo({ message: t.errorOccurred });
                    }
                });
            };

            const handleBuyClick = () => {
                if (user) {
                    if (currentVariant.stockQuantity !== undefined && currentVariant.stockQuantity <= 0) {
                        setAlertInfo({ message: t.outOfStockMessage || 'Этот товар временно отсутствует на складе.' });
                        return;
                    }
                    onBuy({ ...product, selectedVariant: currentVariant, selectedVariantIndex: selectedVariantIndex });
                } else {
                    setAlertInfo({ message: t.loginToBuy });
                }
            };

            return (
                <Modal onClose={onClose} size="max-w-4xl">
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div className="relative">
                            <img src={imageUrls[currentImageIndex]} alt={product.name} className="w-full h-auto object-cover rounded-lg"/>
                            {imageUrls.length > 1 && (
                                <>
                                    <button onClick={prevImage} className="absolute left-2 top-1/2 -translate-y-1/2 bg-black bg-opacity-50 text-white p-2 rounded-full">‹</button>
                                    <button onClick={nextImage} className="absolute right-2 top-1/2 -translate-y-1/2 bg-black bg-opacity-50 text-white p-2 rounded-full">›</button>
                                </>
                            )}
                        </div>
                        <div className="flex flex-col">
                            {product.isVerified && (
                                <div className="flex items-center text-green-400 text-sm mb-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clipRule="evenodd" /></svg>
                                    {t.verifiedByStore}
                                </div>
                            )}
                            <h2 className="text-4xl font-bold mb-2" style={{color: 'var(--text-primary)'}}>{product.name}</h2>
                            
                            {product.variants && product.variants.length > 0 && (
                                <div className="my-4 space-y-2">
                                    <p className="text-lg font-semibold" style={{color: 'var(--text-primary)'}}>{t.chooseOption || 'Выберите вариант:'}</p>
                                    <div className="flex flex-wrap gap-2">
                                        {product.variants.map((variant, index) => (
                                            <button
                                                key={index}
                                                onClick={() => setSelectedVariantIndex(index)}
                                                className={`px-4 py-2 rounded-lg text-sm font-semibold transition-colors ${selectedVariantIndex === index ? 'bg-purple-600 text-white' : 'hover:bg-gray-600'}`}
                                                style={selectedVariantIndex !== index ? {backgroundColor: 'var(--bg-tertiary)', color: 'var(--text-primary)'} : {}}
                                            >
                                                {variant.nominal} - {convertPrice(variant.price, currency)}
                                            </button>
                                        ))}
                                    </div>
                                    {currentVariant.stockQuantity !== undefined && currentVariant.stockQuantity <= 0 && (
                                        <p className="text-red-500 text-sm mt-2">{t.outOfStockMessage}</p>
                                    )}
                                </div>
                            )}
                            
                            {(currentVariant.nominal || product.nominal) && <p className="text-xl font-semibold mb-4" style={{color: 'var(--accent-primary)'}}>{currentVariant.nominal || product.nominal}</p>}
                            <p className="mb-6 flex-grow" style={{color: 'var(--text-secondary)'}}>{product.description}</p>
                            
                            <div className="mt-auto pt-6">
                                <div className="flex flex-col sm:flex-row justify-between sm:items-center gap-4">
                                    <span className="text-4xl lg:text-5xl font-bold flex-shrink-0 text-center sm:text-left" style={{color: 'var(--accent-primary)'}}>
                                        {convertPrice(currentVariant.price || product.price, currency)}
                                    </span>
                                    <div className="flex items-center justify-center sm:justify-end gap-2 w-full">
                                        <button onClick={handleShare} className="p-3 rounded-lg transition-colors" style={{backgroundColor: 'var(--bg-tertiary)'}}>
                                            <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" style={{color: 'var(--text-primary)'}} viewBox="0 0 20 20" fill="currentColor"><path d="M15 8a3 3 0 10-2.977-2.63l-4.94 2.47a3 3 0 100 4.319l4.94 2.47a3 3 0 10.895-1.789l-4.94-2.47a3.027 3.027 0 000-.74l4.94-2.47C13.456 7.68 14.19 8 15 8z" /></svg>
                                        </button>
                                        <button onClick={handleBuyClick} className="flex-grow sm:flex-grow-0 bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-lg text-lg" disabled={currentVariant.stockQuantity !== undefined && currentVariant.stockQuantity <= 0}>
                                            {currentVariant.stockQuantity !== undefined && currentVariant.stockQuantity <= 0 ? t.outOfStock : t.buy}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </Modal>
            );
        }

        // NEW: Компонент для внутреннего чата
        function InternalChat({ user, db, t, chatId }) {
            const [messages, setMessages] = useState([]);
            const [newMessage, setNewMessage] = useState('');
            const chatContainerRef = useRef(null);
            const a_uid = user.uid;

            const targetChatId = chatId || a_uid;

            useEffect(() => {
                const messagesRef = collection(db, 'chats', targetChatId, 'messages');
                const q = query(messagesRef, orderBy('timestamp'));

                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const msgs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setMessages(msgs);
                });

                return () => unsubscribe();
            }, [db, targetChatId]);

            useEffect(() => {
                if (chatContainerRef.current) {
                    chatContainerRef.current.scrollTop = chatContainerRef.current.scrollHeight;
                }
            }, [messages]);

            const handleSendMessage = async (e) => {
                e.preventDefault();
                if (newMessage.trim() === '') return;

                const messagesRef = collection(db, 'chats', targetChatId, 'messages');
                await addDoc(messagesRef, {
                    text: newMessage,
                    senderId: a_uid,
                    senderName: user.displayName,
                    photoURL: user.photoURL,
                    timestamp: serverTimestamp()
                });

                // Также создаем или обновляем документ чата для списка у админа
                await setDoc(doc(db, 'chats', targetChatId), {
                    lastMessage: newMessage,
                    timestamp: serverTimestamp(),
                    userName: user.displayName,
                    userPhoto: user.photoURL,
                    userId: a_uid
                }, { merge: true });

                setNewMessage('');
            };

            return (
                <div className="flex flex-col h-[60vh] p-4 rounded-lg shadow-lg" style={{backgroundColor: 'var(--bg-secondary)'}}>
                    <div ref={chatContainerRef} className="flex-grow overflow-y-auto mb-4 space-y-4 p-2">
                        {messages.map(msg => (
                            <div key={msg.id} className={`flex items-end gap-2 ${msg.senderId === a_uid ? 'justify-end' : 'justify-start'}`}>
                                {msg.senderId !== a_uid && <img src={msg.photoURL} className="h-8 w-8 rounded-full"/>}
                                <div className={`max-w-xs lg:max-w-md px-4 py-2 rounded-2xl ${msg.senderId === a_uid ? 'bg-purple-600 text-white rounded-br-none' : 'rounded-bl-none'}`} style={msg.senderId !== a_uid ? {backgroundColor: 'var(--bg-tertiary)', color: 'var(--text-primary)'} : {}}>
                                    <p className="text-sm">{msg.text}</p>
                                </div>
                                {msg.senderId === a_uid && <img src={msg.photoURL} className="h-8 w-8 rounded-full"/>}
                            </div>
                        ))}
                    </div>
                    <form onSubmit={handleSendMessage} className="flex gap-2">
                        <input
                            type="text"
                            value={newMessage}
                            onChange={(e) => setNewMessage(e.target.value)}
                            placeholder={t.enterMessagePlaceholder}
                            className="flex-grow p-3 rounded-lg border focus:outline-none focus:ring-2"
                            style={{backgroundColor: 'var(--bg-tertiary)', borderColor: 'var(--border-color)', color: 'var(--text-primary)', '--tw-ring-color': 'var(--accent-primary)'}}
                        />
                        <button type="submit" className="bg-purple-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-purple-700 transition-colors">
                            {t.send}
                        </button>
                    </form>
                </div>
            );
        }

        // UPDATE: Страница чатов с выбором
        function ChatsPage({ t, user, setAlertInfo, db }) {
            const [chatMode, setChatMode] = useState('telegram'); // 'telegram' or 'internal'

            return (
                <div className="container mx-auto p-4 md:p-8 text-center">
                    <h1 className="text-4xl font-bold mb-4" style={{color: 'var(--text-primary)'}}>{t.chats}</h1>
                    <div className="max-w-2xl mx-auto p-8 rounded-lg shadow-lg" style={{backgroundColor: 'var(--bg-secondary)'}}>
                        
                        <div className="flex justify-center mb-6 border-b" style={{borderColor: 'var(--border-color)'}}>
                            <button onClick={() => setChatMode('internal')} className={`px-6 py-2 text-lg font-semibold border-b-2 ${chatMode === 'internal' ? 'border-purple-500 text-purple-500' : 'border-transparent'}`} style={chatMode !== 'internal' ? {color: 'var(--text-secondary)'} : {}}>{t.onSiteChat}</button>
                            <button onClick={() => setChatMode('telegram')} className={`px-6 py-2 text-lg font-semibold border-b-2 ${chatMode === 'telegram' ? 'border-purple-500 text-purple-500' : 'border-transparent'}`} style={chatMode !== 'telegram' ? {color: 'var(--text-secondary)'} : {}}>{t.telegramChat}</button>
                        </div>

                        {user ? (
                            chatMode === 'telegram' ? (
                                <div>
                                    <p className="mb-6" style={{color: 'var(--text-secondary)'}}>{t.supportSubtitle}</p>
                                    <a href="https://t.me/asonikofficial" target="_blank" rel="noopener noreferrer" className="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-lg text-lg transition-transform transform hover:scale-105 inline-block">
                                        {t.chatWithAdmin}
                                    </a>
                                </div>
                            ) : (
                                <InternalChat user={user} db={db} t={t} />
                            )
                        ) : (
                            <p style={{color: 'var(--text-secondary)'}}>{t.loginForSupport}</p>
                        )}
                    </div>
                </div>
            );
        }

        // NEW: Страница для админа для просмотра всех чатов
        function AdminChatsPage({ db, t, user }) {
            const [chatList, setChatList] = useState([]);
            const [selectedChatId, setSelectedChatId] = useState(null);

            useEffect(() => {
                const q = query(collection(db, 'chats'), orderBy('timestamp', 'desc'));
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const chats = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setChatList(chats);
                });
                return () => unsubscribe();
            }, [db]);

            if (selectedChatId) {
                const selectedChat = chatList.find(c => c.id === selectedChatId);
                return (
                    <div className="container mx-auto p-4 md:p-8">
                        <button onClick={() => setSelectedChatId(null)} className="bg-purple-600 text-white py-2 px-4 rounded-lg mb-4">&larr; {t.backToChats}</button>
                        <h2 className="text-2xl font-bold mb-4" style={{color: 'var(--text-primary)'}}>{t.chatWith} {selectedChat.userName}</h2>
                        <InternalChat user={user} db={db} t={t} chatId={selectedChatId} />
                    </div>
                );
            }

            return (
                <div className="container mx-auto p-4 md:p-8">
                    <h1 className="text-4xl font-bold text-center mb-8" style={{color: 'var(--text-primary)'}}>{t.userChats}</h1>
                    <div className="space-y-4 max-w-3xl mx-auto">
                        {chatList.length > 0 ? chatList.map(chat => (
                            <div key={chat.id} onClick={() => setSelectedChatId(chat.id)} className="p-4 rounded-lg flex items-center gap-4 cursor-pointer hover:bg-tertiary" style={{backgroundColor: 'var(--bg-secondary)'}}>
                                <img src={chat.userPhoto} alt={chat.userName} className="h-12 w-12 rounded-full"/>
                                <div className="flex-grow">
                                    <p className="font-bold" style={{color: 'var(--text-primary)'}}>{chat.userName}</p>
                                    <p className="text-sm truncate" style={{color: 'var(--text-secondary)'}}>{chat.lastMessage}</p>
                                </div>
                                <span className="text-xs" style={{color: 'var(--text-secondary)'}}>{chat.timestamp?.toDate().toLocaleTimeString()}</span>
                            </div>
                        )) : <p className="text-center" style={{color: 'var(--text-secondary)'}}>{t.noChatsYet}</p>}
                    </div>
                </div>
            );
        }
        
        function Footer({t}) {
            return (
                <footer className="p-6 mt-12 border-t" style={{backgroundColor: 'var(--bg-secondary)', color: 'var(--text-secondary)', borderColor: 'var(--border-color)'}}>
                    <div className="container mx-auto text-center">
                        <p>&copy; {new Date().getFullYear()} Asonik Store. {t.rightsReserved}</p>
                        <p className="text-sm mt-2">{t.developedWithLove}</p>
                    </div>
                </footer>
            );
        };

        function App() {
            const [user, setUser] = useState(undefined);
            const [products, setProducts] = useState([]);
            const [faqs, setFaqs] = useState([]);
            const [page, setPage] = useState('home');
            const [alertInfo, setAlertInfo] = useState(null);
            const [language, setLanguage] = useState('ru');
            const [currency, setCurrency] = useState('UZS');
            const [profileVisible, setProfileVisible] = useState(false);
            const [isPinModalVisible, setIsPinModalVisible] = useState(false);
            const [pinError, setPinError] = useState('');
            const [selectedProduct, setSelectedProduct] = useState(null);
            const [purchasingProduct, setPurchasingProduct] = useState(null);
            const [yooMoneyData, setYooMoneyData] = useState(null);
            const [theme, setTheme] = useState('asonik'); // 'dark', 'light' или 'asonik'

            useEffect(() => { 
                document.body.className = theme; 
            }, [theme]);

            useEffect(() => {
                 const params = new URLSearchParams(window.location.search);
                const productId = params.get('product');
                if (productId && products.length > 0) {
                    const productToShow = products.find(p => p.id === productId);
                    if (productToShow) setSelectedProduct(productToShow);
                    window.history.replaceState({}, document.title, window.location.pathname);
                }
            }, [products]);
            
            const isAdmin = user && user.uid === ADMIN_UID;
            const t = translations[language] || translations.ru;
            
            useEffect(() => {
                const unsubscribe = onAuthStateChanged(auth, (currentUser) => {
                    setUser(currentUser);
                });
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                const q = query(collection(db, "products"), orderBy('createdAt', 'desc'));
                const unsubProducts = onSnapshot(q, (snapshot) => setProducts(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))));
                const unsubFaqs = onSnapshot(collection(db, "faq"), (snapshot) => setFaqs(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))));
                return () => { unsubProducts(); unsubFaqs(); };
            }, []);

            const handleLogin = async () => { try { await signInWithPopup(auth, provider); } catch (error) { setAlertInfo({ message: "Login failed: " + error.message }); } };
            const handleLogout = async () => { try { await signOut(auth); setPage('home'); } catch (error) { console.error("Logout Error:", error); } };
            
            const handleAdminClick = () => {
                setIsPinModalVisible(true);
            };

            const handlePinSubmit = (pin) => {
                if (pin === ADMIN_PIN) {
                    setPage('admin');
                    setIsPinModalVisible(false);
                    setPinError('');
                    return true;
                } else {
                    setPinError('Неверный ПИН-код');
                    return false;
                }
            };

            const handleBuy = (product) => {
                if (user) {
                    setSelectedProduct(null);
                    // Логика покупки (открытие модального окна покупки) была здесь, но для краткости убрана
                } else {
                    setAlertInfo({ message: t.loginToBuy });
                }
            };
            
            const handleAlertConfirm = () => { if (alertInfo && alertInfo.onConfirm) alertInfo.onConfirm(); setAlertInfo(null); };

            const renderContent = () => {
                switch (page) {
                    case 'admin': return isAdmin ? <div className="text-center p-10" style={{color: 'var(--text-primary)'}}>
                        <h1 className="text-2xl mb-4">Админ-панель</h1>
                        {/* Добавлена кнопка для перехода к чатам */}
                        <button onClick={() => setPage('admin-chats')} className="bg-purple-600 text-white py-2 px-4 rounded-lg">{t.userChats}</button>
                    </div> : <HomePage {...{products, onProductClick: setSelectedProduct, t, currency, convertPrice, loading: products.length === 0}} />;
                    case 'admin-chats': return isAdmin ? <AdminChatsPage db={db} t={t} user={user} /> : <HomePage {...{products, onProductClick: setSelectedProduct, t, currency, convertPrice, loading: products.length === 0}} />;
                    case 'purchases': return user ? <div className="text-center p-10" style={{color: 'var(--text-primary)'}}>{t.myPurchases}</div> : <div className="text-center p-10" style={{color: 'var(--text-primary)'}}>{t.loginToView}</div>;
                    case 'faq': return <FAQPage faqs={faqs} t={t} />;
                    case 'chats': return user ? <ChatsPage {...{t, user, setAlertInfo, db}} /> : <div className="text-center p-10" style={{color: 'var(--text-primary)'}}>{t.loginToView}</div>;
                    default: return <HomePage {...{products, onProductClick: setSelectedProduct, t, currency, convertPrice, loading: products.length === 0 && products.length === 0}} />;
                }
            };
            
            if (user === undefined) {
                return <LoadingSpinner />;
            }
            
            return (
                <div style={{background: 'var(--bg-primary)'}} className="min-h-screen font-sans flex flex-col">
                    <Header {...{user, onLogin: handleLogin, onLogout: handleLogout, setPage, isAdmin, t, currency, setCurrency, language, setLanguage, setProfileVisible, theme, setTheme, onAdminClick: handleAdminClick}} />
                    <div className="flex-grow">
                        {renderContent()}
                    </div>
                    
                    {selectedProduct && <ProductModal product={selectedProduct} user={user} onClose={() => setSelectedProduct(null)} onBuy={handleBuy} setAlertInfo={setAlertInfo} t={t} currency={currency} convertPrice={convertPrice} />}
                    {alertInfo && <AlertModal message={alertInfo.message} onConfirm={alertInfo.onConfirm ? handleAlertConfirm : null} onCancel={() => setAlertInfo(null)} t={t} />}
                    {profileVisible && user && <ProfileModal user={user} onClose={() => setProfileVisible(false)} t={t} setAlertInfo={setAlertInfo} onLogout={handleLogout} />}
                    {isPinModalVisible && <PinModal onSubmit={handlePinSubmit} error={pinError} onClose={() => setIsPinModalVisible(false)} t={t} />}
                    <Footer t={t}/>
                </div>
            );
        }
        
        const translations = {
            ru: {
                home: 'Главная', support: 'Поддержка', faq: 'FAQ', adminPanelTitle: 'Админ-панель', profile: 'Профиль', logout: 'Выйти', login: 'Войти',
                buy: 'Купить', confirmation: 'Подтверждение', cancel: 'Отмена', ok: 'OK', confirm: 'Подтвердить',
                loginToView: 'Пожалуйста, войдите, чтобы просмотреть.',
                loginToBuy: 'Пожалуйста, войдите, чтобы совершить покупку.',
                imageNotFound: 'Изображение не найдено',
                catalogTitle: 'КАТАЛОГ ТОВАРОВ', catalogSubtitle: 'Лучшие предложения только для вас',
                rightsReserved: 'Все права защищены.', developedWithLove: 'Дизайн и разработка с ❤️',
                russian: 'Русский', english: 'English', uzbek: 'O\'zbekcha',
                ruble: 'Рубль', dollar: 'Доллар', sum: "So'm",
                all: 'Все', today: 'За сегодня', last3days: 'За 3 дня', product: 'Товар', date: 'Дата',
                searchPlaceholder: 'Поиск по названию...', category: 'Категория', games: 'Игры', apps: 'Приложения', sortBy: 'Сортировка', newSort: 'Новые', popularSort: 'Популярные', productsNotFound: 'Товары не найдены',
                chatWithAdmin: 'Чат с администрацией', supportSubtitle: 'Если у вас есть вопросы, свяжитесь с нами в Telegram.',
                darkTheme: 'Тёмная', lightTheme: 'Светлая', asonikTheme: 'Фирменная',
                faqTitle: 'Часто задаваемые вопросы',
                myPurchases: 'Мои покупки',
                chats: 'Чаты',
                yourId: 'Ваш уникальный ID для связи',
                loginForSupport: 'Пожалуйста, войдите в аккаунт, чтобы написать в поддержку.',
                enterMessagePlaceholder: 'Введите ваше сообщение...',
                send: 'Отпр.',
                onSiteChat: 'Чат на сайте',
                telegramChat: 'Telegram',
                userChats: 'Чаты с пользователями',
                noChatsYet: 'Пока нет активных чатов.',
                backToChats: 'Назад к чатам',
                chatWith: 'Чат с',
                // ... другие переводы
            },
            en: {
                // ... английские переводы
                darkTheme: 'Dark', lightTheme: 'Light', asonikTheme: 'Branded',
                onSiteChat: 'On-site Chat', telegramChat: 'Telegram',
                userChats: 'User Chats', noChatsYet: 'No active chats yet.',
                backToChats: 'Back to chats', chatWith: 'Chat with',
            },
            uz: {
                // ... узбекские переводы
                darkTheme: 'Qorong\'u', lightTheme: 'Yorug\'', asonikTheme: 'Firmali',
                onSiteChat: 'Saytdagi chat', telegramChat: 'Telegram',
                userChats: 'Foydalanuvchilar bilan suhbatlar', noChatsYet: 'Hozircha faol suhbatlar yo\'q.',
                backToChats: 'Suhbatlarga qaytish', chatWith: 'Suhbat',
            },
        };

        const currencyRates = { RUB: 1, USD: 0.011, UZS: 140 };
        const currencySymbols = { RUB: '₽', USD: '$', UZS: "so'm" };
        const convertPrice = (priceInRub, targetCurrency) => {
            const rate = currencyRates[targetCurrency];
            const symbol = currencySymbols[targetCurrency];
            if (!rate || !priceInRub) return `0 ${symbol}`;
            const convertedPrice = priceInRub * rate;
            return `${convertedPrice.toLocaleString('ru-RU', { maximumFractionDigits: 2 })} ${symbol}`;
        };

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
