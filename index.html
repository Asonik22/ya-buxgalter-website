<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asonik Store</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, doc, deleteDoc, setDoc, serverTimestamp, query, where, orderBy, updateDoc, getDocs, increment, getDoc } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-storage.js"; // Added deleteObject
        
        window.firebase = {
            initializeApp, getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut, updateProfile,
            getFirestore, collection, onSnapshot, addDoc, doc, deleteDoc, setDoc, serverTimestamp, query, where, orderBy, updateDoc, getDocs, increment, getDoc,
            getStorage, ref, uploadBytes, getDownloadURL, deleteObject // Added deleteObject
        };
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; transition: background-color 0.3s, color 0.3s; }
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        
        :root {
            --bg-primary: #111827;
            --bg-secondary: #1f2937;
            --bg-tertiary: #374151;
            --text-primary: #f9fafb;
            --text-secondary: #d1d5db;
            --accent-primary: #8b5cf6;
            --accent-secondary: #a78bfa;
            --border-color: #374151;
        }
        body.light {
            --bg-primary: #f9fafb;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f3f4f6;
            --text-primary: #111827;
            --text-secondary: #4b5563;
            --border-color: #e5e7eb;
        }
        body.asonik {
            --bg-primary: linear-gradient(to bottom right, #f3e8ff, #ffffff);
            --bg-secondary: #ffffff;
            --bg-tertiary: #f3f4f6;
            --text-primary: #4c1d95;
            --text-secondary: #6d28d9;
            --accent-primary: #8b5cf6;
            --accent-secondary: #a78bfa;
            --border-color: #e5e7eb;
        }
        .asonik .accent-text { color: var(--accent-primary); }
        .asonik .text-primary { color: var(--text-primary); }
        .asonik .text-secondary { color: var(--text-secondary); }
        .asonik .bg-secondary { box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.05), 0 2px 4px -2px rgb(0 0 0 / 0.05); }
        .asonik .border-color { border-color: var(--border-color); }
        .asonik .header-text { color: #4c1d95; }
        .asonik .header-text:hover { color: #6d28d9; }

        /* Mobile Menu styles */
        .mobile-menu-container {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--bg-primary);
            z-index: 50;
            display: flex;
            flex-direction: column;
            padding: 1rem;
            transform: translateX(100%);
            transition: transform 0.3s ease-out;
        }
        .mobile-menu-container.open {
            transform: translateX(0%);
        }
        .mobile-menu-item {
            padding: 0.75rem 1rem;
            margin-bottom: 0.5rem;
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            cursor: pointer;
            border-radius: 0.5rem;
            transition: background-color 0.2s;
        }
        .mobile-menu-item:hover {
            background-color: var(--bg-secondary);
        }

        .bg-primary { background: var(--bg-primary); }
        .bg-secondary { background-color: var(--bg-secondary); }
        .bg-tertiary { background-color: var(--bg-tertiary); }
        .text-primary { color: var(--text-primary); }
        .text-secondary { color: var(--text-secondary); }
        .border-color { border-color: var(--border-color); }
        .accent-text { color: var(--accent-primary); }
        .accent-bg { background-color: var(--accent-primary); }
        .accent-border { border-color: var(--accent-primary); }
        .hover\:accent-bg:hover { background-color: var(--accent-primary); }
        .hover\:accent-bg-secondary:hover { background-color: var(--accent-secondary); }

        /* Toast Notification & Floating Button Styles */
        .toast-notification {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%);
            background-color: #28a745; /* Green for success */
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            z-index: 100;
            opacity: 0;
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
            transform: translateX(-50%) translateY(20px);
        }
        .toast-notification.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        .floating-cart-button {
            position: fixed;
            bottom: 2rem;
            left: 2rem;
            z-index: 45; /* Just below modals */
            background-color: var(--accent-primary);
            color: white;
            width: 4rem;
            height: 4rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            cursor: pointer;
            transition: transform 0.2s ease;
        }
        .floating-cart-button:hover {
            transform: scale(1.1);
        }

    </style>
</head>
<body class="bg-primary text-primary">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useRef, useMemo, Component } = React;
const { 
    initializeApp, getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut, updateProfile,
    getFirestore, collection, onSnapshot, addDoc, doc, deleteDoc, setDoc, serverTimestamp, query, where, orderBy, updateDoc, getDocs, increment, getDoc,
    getStorage, ref, uploadBytes, getDownloadURL, deleteObject
} = window.firebase;

// --- App Configuration ---
const firebaseConfig = {
    apiKey: "AIzaSyC7smDYoy-LT58xCwjJsc9uZU9CgHQv5dM",
    authDomain: "ya-buxgalter.firebaseapp.com",
    projectId: "ya-buxgalter",
    storageBucket: "ya-buxgalter.appspot.com",
    messagingSenderId: "640345805387",
    appId: "1:640345805387:web:a1adade77f809af84cb3ce",
    measurementId: "G-0TKE25JVXG"
};

const ADMIN_UID = 'vhmtXZxkZnOWviNQ39R1W3GE8mw2';
const ADMIN_PIN = '300414';
const IMGBB_API_KEY = '96bf3f29606f1989bb5a450ad3770cce';

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);
const provider = new GoogleAuthProvider();

const logoBase64 = "data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/2wBDAAYEBQYFBAYGBQYHBwYIChAKCgkJChQODwwQFxQYGBcUFhYaHSUfGhsjHBYWICwgIyYnKSopGR8tMC0oMCUoKSj/2wBDAQcHBwoIChMKChMoGhYaKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCj/wAARCAAgACADASIAAhEBAxEB/8QAGQAAAgMBAAAAAAAAAAAAAAAAAAYDBAUH/8QAIxAAAQQCAgICAwAAAAAAAAAAAQIDBAUGEQASITFBURMUYf/EABQBAQAAAAAAAAAAAAAAAAAAAAD/xAAUEQEAAAAAAAAAAAAAAAAAAAAA/9oADAMBAAIRAxinAD2ERkACK5uX1WzYtprKqKxckO2E5sNqS0lxLbqFpWlQBSoAgjYI9j39cZkABEV7OpaO6xYlXl0V6bYSHENNR2klS1qUoJSkAekkkgD+8YkABGczL6bT1kuyupLMNhhJWtbywkgD6Gz1J+g98ZkAB//2Q==";

// --- Helper Components & Functions ---
const generatePurchaseCode = () => {
    const chars = 'ABCDEFGHIJKLMNPQRSTUVWXYZ13456789';
    let result = '';
    for (let i = 0; i < 6; i++) {
        result += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return result.match(/.{1,3}/g).join('-');
};

const Logo = () => ( <div className="flex items-center space-x-2 cursor-pointer"> <img src={logoBase64} alt="Asonik Store Logo" className="h-12 w-12 object-contain"/> <span className="text-2xl md:text-3xl font-bold header-text tracking-wider"> Asonik <span className="accent-text">Store</span> </span> </div> );
const LoadingSpinner = () => ( <div className="bg-primary min-h-screen flex items-center justify-center"><div className="animate-spin rounded-full h-32 w-32 border-t-4 border-b-4 accent-border"></div></div> );
const Modal = ({ children, onClose, size = 'max-w-md' }) => ( <div className="fixed inset-0 bg-black bg-opacity-75 z-50 flex justify-center items-center p-4 transition-opacity duration-300"> <div className={`bg-secondary rounded-2xl shadow-2xl p-6 md:p-8 w-full ${size} relative border-color transform transition-transform duration-300 scale-95 animate-scale-in`}> <button onClick={onClose} className="absolute top-4 right-4 text-secondary hover:text-primary transition-colors z-10"> <svg xmlns="http://www.w3.org/2000/svg" className="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg> </button> {children} </div> <style>{` @keyframes scale-in { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } } .animate-scale-in { animation: scale-in 0.3s ease-out forwards; } `}</style> </div> );
const AlertModal = ({ message, onConfirm, onCancel, t }) => ( <Modal onClose={onCancel}> <div className="text-center"> <h2 className="text-2xl font-bold text-primary mb-4">{t.confirmation}</h2> <p className="text-secondary mb-6 whitespace-pre-wrap">{message}</p> <div className={`flex ${onConfirm ? 'justify-between' : 'justify-center'} space-x-4`}> <button onClick={onCancel} className="bg-tertiary hover:bg-gray-700 text-primary font-bold py-2 px-6 rounded-lg transition-colors">{onConfirm ? t.cancel : t.ok}</button> {onConfirm && ( <button onClick={onConfirm} className="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg transition-colors">{t.confirm}</button> )} </div> </div> </Modal> );
const ToastNotification = ({ message }) => (<div className={`toast-notification ${message ? 'show' : ''}`}>{message}</div>);
const FloatingCartButton = ({ cartCount, onClick }) => (
    <button onClick={onClick} className="floating-cart-button">
        <svg xmlns="http://www.w3.org/2000/svg" className="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" /></svg>
        {cartCount > 0 && (
            <span className="absolute -top-1 -right-1 bg-red-600 text-white text-xs font-bold rounded-full h-6 w-6 flex items-center justify-center">{cartCount}</span>
        )}
    </button>
);


const ProfileModal = ({ user, onClose, t, setAlertInfo, onLogout }) => {
    const [isUploading, setIsUploading] = useState(false);
    const [color, setColor] = useState('#8b5cf6');
    const fileInputRef = useRef(null);
    const [firstName, setFirstName] = useState('');
    const [lastName, setLastName] = useState('');
    const [nickname, setNickname] = useState('');

    useEffect(() => {
        if (user.displayName) {
            const parts = user.displayName.split(' ');
            setFirstName(parts[0] || '');
            setLastName(parts.slice(1).join(' ') || '');
        }
    }, [user]);

    const handleUpdateProfile = async (e) => {
        e.preventDefault();
        setIsUploading(true);
        try {
            const newDisplayName = `${firstName} ${lastName}`.trim();
            await updateProfile(auth.currentUser, { displayName: newDisplayName });
            setAlertInfo({ message: t.profileUpdated || 'Профиль обновлен!' });
            onAuthStateChanged(auth, (currentUser) => {});
        } catch (error) {
            console.error("Error updating profile:", error);
            setAlertInfo({ message: `${t.errorOccurred}: ${error.message}` });
        } finally {
            setIsUploading(false);
            onClose();
        }
    };

    const handleImageUpload = async (file) => {
        if (!file) return;
        if (!IMGBB_API_KEY) { setAlertInfo({ message: t.noApiKey }); return; }
        setIsUploading(true);
        const formData = new FormData();
        formData.append('image', file);

        try {
            const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, { method: 'POST', body: formData });
            const result = await response.json();
            if (result.success) {
                await updateProfile(auth.currentUser, { photoURL: result.data.url });
                setAlertInfo({ message: t.avatarUpdated });
            } else { throw new Error(result.error.message); }
        } catch (error) { console.error("Error uploading avatar:", error); setAlertInfo({ message: `${t.errorOccurred}: ${error.message}` }); } 
        finally { setIsUploading(false); onClose(); }
    };
    
    const handleColorAvatar = async () => {
        const colorHex = color.substring(1);
        const photoURL = `https://placehold.co/128x128/${colorHex}/FFFFFF?text=${user.displayName ? user.displayName.charAt(0) : '?'}`;
        try {
            await updateProfile(auth.currentUser, { photoURL });
            setAlertInfo({ message: t.avatarUpdated });
        } catch(error) { console.error("Error setting color avatar:", error); setAlertInfo({ message: t.errorOccurred }); }
        finally { onClose(); }
    };

    const handleRevertAvatar = async () => {
        const originalPhotoURL = auth.currentUser.providerData[0]?.photoURL;
        if (originalPhotoURL) {
            try {
                await updateProfile(auth.currentUser, { photoURL: originalPhotoURL });
                setAlertInfo({ message: t.avatarReverted });
            } catch (error) { console.error("Error reverting avatar:", error); setAlertInfo({ message: t.errorOccurred }); } 
            finally { onClose(); }
        }
    };

    return (
        <Modal onClose={onClose}>
            <div className="text-center text-primary">
                <h2 className="text-3xl font-bold mb-4">{t.profile}</h2>
                <div className="relative mx-auto mb-4 w-24 h-24">
                     <img src={user.photoURL} alt={user.displayName} className={`w-full h-full rounded-full mx-auto border-4 object-cover`} style={{ borderColor: user.photoURL && user.photoURL.includes('placehold.co') ? color : 'var(--accent-primary)' }}/>
                     <button onClick={() => fileInputRef.current.click()} className="absolute bottom-0 right-0 bg-gray-700 p-2 rounded-full border border-color">
                         <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 text-white" viewBox="0 0 20 20" fill="currentColor"><path d="M13.586 3.586a2 2 0 112.828 2.828l-7.293 7.293A1 1 0 018.657 14H5a1 1 0 01-1-1v-3.657a1 1 0 01.293-.707l7.293-7.293zM10 2a1 1 0 00-1 1v2a1 1 0 102 0V3a1 1 0 00-1-1z" /></svg>
                     </button>
                </div>
                <p className="text-xl mb-2">{user.displayName}</p>
                <p className="text-secondary mb-6">{user.email}</p>
                
                <form onSubmit={handleUpdateProfile} className="space-y-4 mb-6">
                    <div>
                        <label className="block text-secondary text-sm font-bold mb-1">{t.firstName || 'Имя'}</label>
                        <input type="text" value={firstName} onChange={e => setFirstName(e.target.value)} className="w-full p-2 bg-tertiary rounded-lg border-color text-primary"/>
                    </div>
                    <div>
                        <label className="block text-secondary text-sm font-bold mb-1">{t.lastName || 'Фамилия'}</label>
                        <input type="text" value={lastName} onChange={e => setLastName(e.target.value)} className="w-full p-2 bg-tertiary rounded-lg border-color text-primary"/>
                    </div>
                    <div>
                        <label className="block text-secondary text-sm font-bold mb-1">{t.nickname || 'Никнейм'}</label>
                        <input type="text" value={nickname} onChange={e => setNickname(e.target.value)} className="w-full p-2 bg-tertiary rounded-lg border-color text-primary"/>
                    </div>
                    <button type="submit" className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-colors" disabled={isUploading}>
                        {isUploading ? t.sending : t.updateProfile || 'Обновить профиль'}
                    </button>
                </form>

                <div className="space-y-3">
                    <div className="flex items-center space-x-2">
                        <button onClick={handleColorAvatar} className="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">{t.setColorAvatar || 'Установить цвет рамки'}</button>
                        <input type="color" value={color} onChange={e => setColor(e.target.value)} className="p-1 h-10 w-14 block bg-tertiary border-color cursor-pointer rounded-lg"/>
                    </div>
                    <button onClick={handleRevertAvatar} className="w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">{t.revertAvatar}</button>
                    <button onClick={onLogout} className="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition-colors mt-4">{t.logout}</button>
                </div>
                <input type="file" ref={fileInputRef} onChange={(e) => handleImageUpload(e.target.files[0])} accept="image/*" className="hidden"/>
            </div>
        </Modal>
    );
};

const CustomSelector = ({ value, onChange, options }) => {
    const [isOpen, setIsOpen] = useState(false);
    const wrapperRef = useRef(null);

    useEffect(() => {
        function handleClickOutside(event) {
            if (wrapperRef.current && !wrapperRef.current.contains(event.target)) { setIsOpen(false); }
        }
        document.addEventListener("mousedown", handleClickOutside);
        return () => document.removeEventListener("mousedown", handleClickOutside);
    }, [wrapperRef]);

    const handleSelect = (newValue) => {
        onChange({ target: { value: newValue } });
        setIsOpen(false);
    };

    return (
        <div className="relative" ref={wrapperRef}>
            <button onClick={() => setIsOpen(!isOpen)} className="flex items-center justify-between w-full bg-tertiary hover:bg-gray-700 text-primary font-semibold py-2 px-4 rounded-lg transition-colors">
                <span>{options.find(o => o.value === value).label}</span>
                <svg className={`w-4 h-4 transition-transform ${isOpen ? 'transform rotate-180' : ''}`} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 9l-7 7-7-7"></path></svg>
            </button>
            {isOpen && (
                <div className="absolute right-0 mt-2 w-full bg-tertiary rounded-md shadow-lg py-1 z-50 border-color">
                    {options.map(opt => (
                        <a href="#" key={opt.value} onClick={(e) => { e.preventDefault(); handleSelect(opt.value); }}
                            className={`block px-4 py-2 text-sm text-secondary hover:text-primary hover:accent-bg ${value === opt.value ? 'accent-bg text-white' : ''}`}>
                            {opt.label}
                        </a>
                    ))}
                </div>
            )}
        </div>
    );
};

const PinModal = ({ onSubmit, onClose, error, t, setRememberMe }) => {
    const [pin, setPin] = useState('');
    const [attempts, setAttempts] = useState(0);
    const [isLocked, setIsLocked] = useState(false);
    const [countdown, setCountdown] = useState(0);
    const [rememberMeChecked, setRememberMeChecked] = useState(false);

    useEffect(() => {
        let timer;
        if (isLocked) {
            setCountdown(15);
            timer = setInterval(() => {
                setCountdown(prev => {
                    if (prev <= 1) {
                        clearInterval(timer);
                        setIsLocked(false);
                        setAttempts(0);
                        return 0;
                    }
                    return prev - 1;
                });
            }, 1000);
        }
        return () => clearInterval(timer);
    }, [isLocked]);

    const handleSubmit = (e) => {
        e.preventDefault();
        if (isLocked) return;
        const success = onSubmit(pin, rememberMeChecked);
        if (!success) {
            const newAttempts = attempts + 1;
            setAttempts(newAttempts);
            if (newAttempts >= 5) {
                setIsLocked(true);
            }
        }
    };

    return (
        <Modal onClose={onClose} size="max-w-sm">
            <form onSubmit={handleSubmit} className="text-center">
                <h2 className="text-2xl font-bold text-primary mb-4">{t.adminAccess}</h2>
                <p className="text-secondary mb-6">{t.enterPin}</p>
                <input
                    type="password"
                    value={pin}
                    onChange={(e) => setPin(e.target.value)}
                    className="w-full p-3 bg-tertiary rounded-lg border-color text-primary text-center text-2xl tracking-[.5em] disabled:opacity-50"
                    maxLength="6"
                    autoFocus
                    disabled={isLocked}
                />
                {error && !isLocked && <p className="text-red-500 text-sm mt-2">{error}</p>}
                {isLocked && <p className="text-yellow-500 text-sm mt-2">Слишком много попыток. Попробуйте через {countdown} секунд.</p>}
                
                <div className="flex items-center justify-center mt-4">
                    <input
                        type="checkbox"
                        id="rememberMe"
                        checked={rememberMeChecked}
                        onChange={(e) => setRememberMeChecked(e.target.checked)}
                        className="form-checkbox h-4 w-4 text-purple-600 rounded"
                    />
                    <label htmlFor="rememberMe" className="ml-2 text-sm text-secondary">{t.rememberMe || 'Запомнить меня (10 минут)'}</label>
                </div>

                <button type="submit" className="w-full mt-6 accent-bg hover:accent-bg-secondary text-white font-bold py-3 px-4 rounded-lg transition-colors disabled:bg-gray-500" disabled={isLocked}>
                    {isLocked ? `Заблокировано (${countdown})` : t.enter}
                </button>
            </form>
        </Modal>
    );
};

// --- Main Components ---
function Header({ user, onLogin, onLogout, setPage, isAdmin, t, currency, setCurrency, language, setLanguage, setProfileVisible, theme, setTheme, onAdminClick, cartCount, onCartClick }) {
    const [userDropdownOpen, setUserDropdownOpen] = useState(false);
    const [mobileMenuOpen, setMobileMenuOpen] = useState(false);
    const userDropdownRef = useRef(null);

    const langOptions = [{value: 'ru', label: t.russian}, {value: 'en', label: t.english}, {value: 'uz', label: t.uzbek}];
    const currencyOptions = [{value: 'RUB', label: t.ruble}, {value: 'USD', label: t.dollar}, {value: 'UZS', label: t.sum}];
    const themeOptions = [{value: 'dark', label: t.darkTheme}, {value: 'light', label: t.lightTheme}, {value: 'asonik', label: t.asonikTheme}];

    useEffect(() => {
        function handleClickOutside(event) {
            if (userDropdownRef.current && !userDropdownRef.current.contains(event.target)) { setUserDropdownOpen(false); }
        }
        document.addEventListener("mousedown", handleClickOutside);
        return () => document.removeEventListener("mousedown", handleClickOutside);
    }, [userDropdownRef]);
    
    const handleMenuItemClick = (pageName) => {
        setPage(pageName);
        setMobileMenuOpen(false);
    };

    return (
        <header className="bg-secondary p-4 shadow-lg sticky top-0 z-40 border-b border-color">
            <div className="container mx-auto flex justify-between items-center">
                <div onClick={() => setPage('home')}><Logo /></div>
                <nav className="hidden md:flex items-center space-x-6">
                    <button onClick={() => handleMenuItemClick('home')} className="text-secondary hover:text-primary font-medium transition-colors">{t.home}</button>
                    {user && <button onClick={() => handleMenuItemClick('purchases')} className="text-secondary hover:text-primary font-medium transition-colors">{t.myPurchases}</button>}
                    <button onClick={() => handleMenuItemClick('faq')} className="text-secondary hover:text-primary font-medium transition-colors">{t.faq}</button>
                    {user && <button onClick={() => handleMenuItemClick('chats')} className="text-secondary hover:text-primary font-medium transition-colors">{t.chats}</button>}
                </nav>
                <div className="flex items-center space-x-2 sm:space-x-4">
                    {user && (
                         <button onClick={onCartClick} className="relative p-2 text-primary hover:bg-tertiary rounded-full transition-colors hidden md:block">
                            <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" /></svg>
                            {cartCount > 0 && (
                                <span className="absolute -top-1 -right-1 bg-red-600 text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center">{cartCount}</span>
                            )}
                        </button>
                    )}
                    
                    <div className="hidden md:block w-28"><CustomSelector value={language} onChange={e => setLanguage(e.target.value)} options={langOptions} /></div>
                    <div className="hidden md:block w-28"><CustomSelector value={currency} onChange={e => setCurrency(e.target.value)} options={currencyOptions} /></div>
                    <div className="hidden md:block w-32"><CustomSelector value={theme} onChange={e => setTheme(e.target.value)} options={themeOptions} /></div>
                    
                    {user ? (
                        <div className="relative" ref={userDropdownRef}>
                            <button onClick={() => setUserDropdownOpen(!userDropdownOpen)} className="flex items-center space-x-2">
                                <img src={user.photoURL} alt={user.displayName} className="h-10 w-10 rounded-full border-2 accent-border object-cover" />
                                <svg className={`w-4 h-4 text-primary transition-transform ${userDropdownOpen ? 'transform rotate-180' : ''}`} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 9l-7 7-7-7"></path></svg>
                            </button>
                            {userDropdownOpen && (
                                <div className={`absolute right-0 mt-2 w-48 bg-secondary rounded-md shadow-lg py-1 z-50 border-color`}>
                                    <a href="#" onClick={(e) => { e.preventDefault(); setProfileVisible(true); setUserDropdownOpen(false); }} className="block px-4 py-2 text-sm text-secondary hover:text-primary hover:accent-bg">{t.profile}</a>
                                    {isAdmin && <a href="#" onClick={(e) => { e.preventDefault(); onAdminClick(); setUserDropdownOpen(false); }} className="block px-4 py-2 text-sm text-red-500 hover:text-red-400 hover:accent-bg">{t.adminPanelTitle}</a>}
                                    <a href="#" onClick={(e) => { e.preventDefault(); onLogout(); setUserDropdownOpen(false); }} className="block px-4 py-2 text-sm text-secondary hover:text-primary hover:accent-bg">{t.logout}</a>
                                </div>
                            )}
                        </div>
                    ) : (
                        <button onClick={onLogin} className="accent-bg hover:accent-bg-secondary text-white font-bold py-2 px-4 rounded-lg transition-transform transform hover:scale-105 flex items-center space-x-2">
                            <span>{t.login}</span>
                        </button>
                    )}
                    <button className="md:hidden p-2 rounded-md text-primary hover:bg-tertiary" onClick={() => setMobileMenuOpen(!mobileMenuOpen)}>
                        <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6h16M4 12h16M4 18h16" /></svg>
                    </button>
                </div>
            </div>

            <div className={`mobile-menu-container ${mobileMenuOpen ? 'open' : ''}`}>
                <div className="flex justify-end mb-4">
                    <button className="p-2 rounded-md text-primary hover:bg-secondary" onClick={() => setMobileMenuOpen(false)}>
                        <svg xmlns="http://www.w3.org/2000/svg" className="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg>
                    </button>
                </div>
                {user && <button onClick={() => { onCartClick(); setMobileMenuOpen(false); }} className="mobile-menu-item">{t.shoppingCart} ({cartCount})</button>}
                <button onClick={() => handleMenuItemClick('home')} className="mobile-menu-item">{t.home}</button>
                {user && <button onClick={() => handleMenuItemClick('purchases')} className="mobile-menu-item">{t.myPurchases}</button>}
                <button onClick={() => handleMenuItemClick('faq')} className="mobile-menu-item">{t.faq}</button>
                {user && <button onClick={() => handleMenuItemClick('chats')} className="mobile-menu-item">{t.chats}</button>}
                {user ? (
                    <>
                        <button onClick={() => { setProfileVisible(true); setMobileMenuOpen(false); }} className="mobile-menu-item">{t.profile}</button>
                        {isAdmin && <button onClick={() => { onAdminClick(); setMobileMenuOpen(false); }} className="mobile-menu-item text-red-500">{t.adminPanelTitle}</button>}
                        <button onClick={() => { onLogout(); setMobileMenuOpen(false); }} className="mobile-menu-item">{t.logout}</button>
                    </>
                ) : (
                    <button onClick={() => { onLogin(); setMobileMenuOpen(false); }} className="mobile-menu-item">{t.login}</button>
                )}
                 <div className="mt-auto pt-4 border-t border-color flex flex-col items-center">
                    <div className="w-full mb-2"><CustomSelector value={language} onChange={e => setLanguage(e.target.value)} options={langOptions} /></div>
                    <div className="w-full mb-2"><CustomSelector value={currency} onChange={e => setCurrency(e.target.value)} options={currencyOptions} /></div>
                    <div className="w-full"><CustomSelector value={theme} onChange={e => setTheme(e.target.value)} options={themeOptions} /></div>
                </div>
            </div>
        </header>
    );
}

const SkeletonCard = () => (
    <div className="bg-secondary rounded-2xl overflow-hidden shadow-lg border-color animate-pulse">
        <div className="w-full h-56 bg-tertiary"></div>
        <div className="p-6">
            <div className="h-8 bg-tertiary rounded w-3/4 mb-2"></div>
            <div className="h-6 bg-tertiary rounded w-1/2 mb-4"></div>
            <div className="h-10 bg-tertiary rounded w-1/3"></div>
        </div>
    </div>
);

function HomePage({ products, onProductClick, t, currency, convertPrice, loading }) {
    const [searchTerm, setSearchTerm] = useState('');
    const [filterCategory, setFilterCategory] = useState('all');
    const [sortBy, setSortBy] = useState('new');

    const filteredAndSortedProducts = useMemo(() => {
        return products
            .filter(p => p.isOnSale === undefined || p.isOnSale !== false)
            .filter(p => p.name.toLowerCase().includes(searchTerm.toLowerCase()))
            .filter(p => filterCategory === 'all' || p.category === filterCategory)
            .sort((a, b) => {
                if (a.pinned && !b.pinned) return -1;
                if (!a.pinned && b.pinned) return 1;
                if (sortBy === 'popular') return (b.popularity || 0) - (a.popularity || 0);
                return (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0);
            });
    }, [products, searchTerm, filterCategory, sortBy]);

    const FilterButton = ({ value, state, setState, children }) => (
        <button onClick={() => setState(value)} className={`px-4 py-2 rounded-lg text-sm transition-colors ${state === value ? 'accent-bg text-white' : 'bg-tertiary text-primary hover:bg-gray-600'}`}>
            {children}
        </button>
    );

    const categories = useMemo(() => {
        const cats = { all: t.all };
        products.forEach(p => { if (p.category) cats[p.category] = p.category; });
        return Object.keys(cats).map(key => ({ value: key, label: t[key.toLowerCase()] || key }));
    }, [products, t]);

    return (
        <main className="container mx-auto p-4 md:p-8">
            <h1 className="text-4xl md:text-5xl font-black text-primary text-center mb-4 tracking-wide">{t.catalogTitle}</h1>
            <p className="accent-text text-center mb-8 text-lg">{t.catalogSubtitle}</p>
            
            <div className="bg-secondary p-4 rounded-xl mb-8 flex flex-col md:flex-row gap-4 items-center">
                <input type="text" placeholder={t.searchPlaceholder} value={searchTerm} onChange={e => setSearchTerm(e.target.value)} className="w-full md:w-1/3 p-3 bg-tertiary rounded-lg border-color focus:outline-none focus:ring-2 accent-border text-primary" />
                <div className="flex items-center gap-2">
                    <span className="text-secondary font-semibold">{t.category}:</span>
                    <div className="w-40"><CustomSelector value={filterCategory} onChange={e => setFilterCategory(e.target.value)} options={categories} /></div>
                </div>
                <div className="flex items-center gap-2 ml-auto">
                    <span className="text-secondary font-semibold">{t.sortBy}:</span>
                    <FilterButton value="new" state={sortBy} setState={setSortBy}>{t.newSort}</FilterButton>
                    <FilterButton value="popular" state={sortBy} setState={setSortBy}>{t.popularSort}</FilterButton>
                </div>
            </div>
            
            {loading ? (
                 <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                    {[...Array(6)].map((_, i) => <SkeletonCard key={i} />)}
                </div>
            ) : filteredAndSortedProducts.length === 0 ? (
                 <p className="text-center text-secondary text-xl mt-12">{t.productsNotFound}</p>
            ) : (
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                    {filteredAndSortedProducts.map(product => (
                        <ProductCard key={product.id} {...{product, onProductClick, t, currency, convertPrice}} />
                    ))}
                </div>
            )}
        </main>
    );
}

function ProductCard({ product, onProductClick, t, currency, convertPrice }) {
    const imageUrl = (product.imageUrls && product.imageUrls.length > 0) ? product.imageUrls[0] : (product.imageUrl || '');
    const displayPrice = useMemo(() => {
        if (product.variants && product.variants.length > 0) {
            const minPrice = Math.min(...product.variants.map(v => v.price));
            return convertPrice(minPrice, currency);
        }
        return convertPrice(product.price || 0, currency);
    }, [product.variants, product.price, currency]);
    
    const displayNominal = useMemo(() => {
        if (product.variants && product.variants.length > 0) {
            return product.variants[0].nominal;
        }
        return product.nominal;
    }, [product.variants, product.nominal]);

    const displayStock = useMemo(() => {
        if (product.variants && product.variants.length > 0) {
            const totalStock = product.variants.reduce((sum, v) => sum + (parseInt(v.stockQuantity) || 0), 0);
            return totalStock;
        }
        return (product.stockQuantity !== undefined ? product.stockQuantity : -1);
    }, [product.variants, product.stockQuantity]);

    return (
        <div onClick={() => onProductClick(product)} className="bg-secondary rounded-2xl overflow-hidden shadow-lg border-color transform hover:-translate-y-2 transition-transform duration-300 flex flex-col cursor-pointer relative">
            {product.pinned && <div className="absolute top-0 right-0 bg-yellow-400 text-black text-xs font-bold px-3 py-1 rounded-bl-lg z-10">{t.pinned}</div>}
            {product.isOnSale === false && <span className="absolute top-2 left-2 bg-gray-500 text-white text-xs font-bold px-2 py-1 rounded-full">{t.removedFromSale || 'Снято с продажи'}</span>}
            <img className="w-full h-56 object-cover" src={imageUrl} alt={product.name} onError={(e) => { e.target.onerror = null; e.target.src=`https://placehold.co/600x400/1f2937/374151?text=${encodeURIComponent(t.imageNotFound)}`; }}/>
            <div className="p-6 flex flex-col flex-grow">
                {product.isVerified && (
                    <div className="flex items-center text-green-400 text-sm mb-2">
                        <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clipRule="evenodd" /></svg>
                        {t.verifiedByStore}
                    </div>
                )}
                <h3 className="text-2xl font-bold text-primary mb-1">{product.name}</h3>
                {displayNominal && <p className="accent-text font-semibold mb-2">{displayNominal}</p>}
                
                {product.variants && product.variants.length > 1 && (
                    <p className="text-secondary text-sm mb-2">
                        {t.priceFrom}: {displayPrice} {product.variants.length > 1 && `+ ${product.variants.length - 1} ${t.moreOptions || 'варианта'}`}
                    </p>
                )}
                
                <div className="flex-grow"></div>
                <div className="flex justify-between items-center mt-4">
                    <span className="text-3xl font-bold accent-text">{displayPrice}</span>
                    {displayStock !== -1 && displayStock <= 0 && (
                        <span className="bg-red-500 text-white text-xs font-bold px-2 py-1 rounded-full">{t.outOfStock || 'Нет в наличии'}</span>
                    )}
                </div>
            </div>
        </div>
    );
}

function ProductModal({ product, user, onClose, onBuy, setAlertInfo, t, currency, convertPrice, onAddToCart }) {
    const [currentImageIndex, setCurrentImageIndex] = useState(0);
    const imageUrls = (product.imageUrls && product.imageUrls.length > 0) ? product.imageUrls : [product.imageUrl || ''];
    const [selectedVariantIndex, setSelectedVariantIndex] = useState(0);

    useEffect(() => {
        setSelectedVariantIndex(0);
    }, [product]);

    const currentVariant = product.variants && product.variants.length > 0
        ? product.variants[selectedVariantIndex]
        : { nominal: product.nominal, price: product.price, stockQuantity: product.stockQuantity };

    const nextImage = () => setCurrentImageIndex((prevIndex) => (prevIndex + 1) % imageUrls.length);
    const prevImage = () => setCurrentImageIndex((prevIndex) => (prevIndex - 1 + imageUrls.length) % imageUrls.length);

     const handleShare = () => {
        const productUrl = `${window.location.origin}${window.location.pathname}?product=${product.id}`;
        navigator.clipboard.writeText(productUrl).then(() => {
            // Using setAlertInfo here for a quick feedback is fine, but a toast would be better.
            // For now, let's keep it simple as the user didn't ask to change this one.
            setAlertInfo({ message: t.linkCopied });
        });
    };

    const handleAction = (action) => {
        if (!user) {
            setAlertInfo({ message: t.loginToInteract });
            return;
        }
        if (currentVariant.stockQuantity !== undefined && currentVariant.stockQuantity <= 0) {
            setAlertInfo({ message: t.outOfStockMessage });
            return;
        }
        const productWithVariant = { ...product, selectedVariant: currentVariant, selectedVariantIndex: selectedVariantIndex };
        if (action === 'buy') {
            onBuy(productWithVariant);
        } else if (action === 'addToCart') {
            onAddToCart(productWithVariant);
        }
    };

    return (
        <Modal onClose={onClose} size="max-w-4xl">
            <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div className="relative">
                    <img src={imageUrls[currentImageIndex]} alt={product.name} className="w-full h-auto object-cover rounded-lg"/>
                    {imageUrls.length > 1 && (
                        <>
                            <button onClick={prevImage} className="absolute left-2 top-1/2 -translate-y-1/2 bg-black bg-opacity-50 text-white p-2 rounded-full">‹</button>
                            <button onClick={nextImage} className="absolute right-2 top-1/2 -translate-y-1/2 bg-black bg-opacity-50 text-white p-2 rounded-full">›</button>
                        </>
                    )}
                </div>
                <div className="flex flex-col">
                    {product.isVerified && (
                        <div className="flex items-center text-green-400 text-sm mb-2">
                            <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clipRule="evenodd" /></svg>
                            {t.verifiedByStore}
                        </div>
                    )}
                    <h2 className="text-4xl font-bold text-primary mb-2">{product.name}</h2>
                    
                    {product.variants && product.variants.length > 0 && (
                        <div className="my-4 space-y-2">
                            <p className="text-lg font-semibold text-primary">{t.chooseOption || 'Выберите вариант:'}</p>
                            <div className="flex flex-wrap gap-2">
                                {product.variants.map((variant, index) => (
                                    <button
                                        key={index}
                                        onClick={() => setSelectedVariantIndex(index)}
                                        className={`px-4 py-2 rounded-lg text-sm font-semibold transition-colors ${selectedVariantIndex === index ? 'accent-bg text-white' : 'bg-tertiary text-primary hover:bg-gray-600'}`}
                                    >
                                        {variant.nominal} - {convertPrice(variant.price, currency)}
                                    </button>
                                ))}
                            </div>
                            {currentVariant.stockQuantity !== undefined && currentVariant.stockQuantity <= 0 && (
                                <p className="text-red-500 text-sm mt-2">{t.outOfStockMessage}</p>
                            )}
                        </div>
                    )}
                    
                    {(currentVariant.nominal || product.nominal) && <p className="text-xl accent-text font-semibold mb-4">{currentVariant.nominal || product.nominal}</p>}
                    <p className="text-secondary mb-6 flex-grow">{product.description}</p>
                    {/* BUG FIX: Added flex-wrap and responsive direction change */}
                    <div className="flex flex-col md:flex-row md:flex-wrap justify-between items-center gap-4">
                        <span className="text-4xl lg:text-5xl font-bold accent-text text-center md:text-left">{convertPrice(currentVariant.price || product.price, currency)}</span>
                        <div className="flex space-x-2">
                            <button onClick={handleShare} className="bg-tertiary hover:bg-gray-700 p-3 rounded-lg transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6 text-primary" viewBox="0 0 20 20" fill="currentColor"><path d="M15 8a3 3 0 10-2.977-2.63l-4.94 2.47a3 3 0 100 4.319l4.94 2.47a3 3 0 10.895-1.789l-4.94-2.47a3.027 3.027 0 000-.74l4.94-2.47C13.456 7.68 14.19 8 15 8z" /></svg>
                            </button>
                            <button onClick={() => handleAction('addToCart')} className="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg text-md" disabled={currentVariant.stockQuantity !== undefined && currentVariant.stockQuantity <= 0}>
                                {t.addToCart}
                            </button>
                            <button onClick={() => handleAction('buy')} className="accent-bg hover:accent-bg-secondary text-white font-bold py-3 px-6 rounded-lg text-md" disabled={currentVariant.stockQuantity !== undefined && currentVariant.stockQuantity <= 0}>
                                {currentVariant.stockQuantity !== undefined && currentVariant.stockQuantity <= 0 ? t.outOfStock : t.buyInOneClick}
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </Modal>
    );
}

function CartModal({ cart, onClose, onRemoveFromCart, onUpdateCartQuantity, onCheckoutFromCart, t, currency, convertPrice }) {
    const total = useMemo(() => {
        return cart.reduce((sum, item) => sum + item.selectedVariant.price * item.quantity, 0);
    }, [cart, currency]);

    const handleProceedToCheckout = () => {
        const summaryProduct = {
            name: t.cartOrderName || 'Заказ из корзины',
            selectedVariant: {
                nominal: cart.map(item => `${item.name} (x${item.quantity})`).join(', '),
                price: total,
            },
            id: 'cart-order',
            imageUrls: [],
        };
        onCheckoutFromCart(summaryProduct);
    };

    return (
        <Modal onClose={onClose} size="max-w-3xl">
            <h2 className="text-3xl font-bold text-primary mb-6 text-center">{t.shoppingCart}</h2>
            {cart.length === 0 ? (
                <p className="text-center text-secondary py-10">{t.cartIsEmpty}</p>
            ) : (
                <div className="space-y-4 max-h-[60vh] overflow-y-auto pr-2">
                    {cart.map(item => (
                        <div key={`${item.id}-${item.selectedVariant.nominal}`} className="flex items-center bg-tertiary p-3 rounded-lg">
                            <img src={item.imageUrls[0]} alt={item.name} className="w-16 h-16 object-cover rounded-md mr-4"/>
                            <div className="flex-grow">
                                <p className="font-bold text-primary">{item.name}</p>
                                <p className="text-sm text-secondary">{item.selectedVariant.nominal}</p>
                                <p className="text-sm accent-text font-semibold">{convertPrice(item.selectedVariant.price, currency)}</p>
                            </div>
                            <div className="flex items-center space-x-2">
                                <button onClick={() => onUpdateCartQuantity(item.id, item.selectedVariant.nominal, item.quantity - 1)} className="bg-gray-600 w-8 h-8 rounded-full">-</button>
                                <span>{item.quantity}</span>
                                <button onClick={() => onUpdateCartQuantity(item.id, item.selectedVariant.nominal, item.quantity + 1)} className="bg-gray-600 w-8 h-8 rounded-full">+</button>
                            </div>
                            <button onClick={() => onRemoveFromCart(item.id, item.selectedVariant.nominal)} className="ml-4 text-red-500 hover:text-red-400">
                                <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                            </button>
                        </div>
                    ))}
                </div>
            )}
            {cart.length > 0 && (
                <div className="mt-6 pt-4 border-t border-color flex justify-between items-center">
                    <div>
                        <span className="text-xl text-secondary">{t.total}: </span>
                        <span className="text-2xl font-bold text-primary">{convertPrice(total, currency)}</span>
                    </div>
                    <div className="flex space-x-4">
                         <button onClick={onClose} className="bg-tertiary hover:bg-gray-700 text-primary font-bold py-2 px-6 rounded-lg">{t.continueShopping}</button>
                         <button onClick={handleProceedToCheckout} className="accent-bg hover:accent-bg-secondary text-white font-bold py-2 px-6 rounded-lg">{t.proceedToCheckout}</button>
                    </div>
                </div>
            )}
        </Modal>
    );
}

function PurchaseModal({ product, onClose, onConfirm, onYooMoney, t, currency, convertPrice, setAlertInfo }) {
    const [promoCode, setPromoCode] = useState('');
    const [appliedPromo, setAppliedPromo] = useState(null);
    const [error, setError] = useState('');

    const finalPrice = useMemo(() => {
        const basePrice = product.selectedVariant ? product.selectedVariant.price : product.price;
        if (!appliedPromo) return basePrice;
        return basePrice * (1 - appliedPromo.discount / 100);
    }, [product.selectedVariant, product.price, appliedPromo]);

    const handleApplyPromo = async () => {
        setError('');
        if (!promoCode.trim()) return;
        
        const promoRef = doc(db, 'promoCodes', promoCode);
        const promoSnap = await getDoc(promoRef);

        if (promoSnap.exists()) {
            const promoData = promoSnap.data();
            if (promoData.timesUsed >= promoData.usageLimit) {
                setError(t.promoLimitReached);
                setAppliedPromo(null);
            } else {
                setAppliedPromo(promoData);
                setAlertInfo({ message: t.promoApplied });
            }
        } else {
            setAppliedPromo(null);
            setError(t.promoNotFound);
        }
    };

    const handleContactSeller = async () => {
        const purchaseDetails = {
            finalPrice,
            promoCodeUsed: appliedPromo ? appliedPromo.code : null,
            paymentMethod: 'Chat',
            nominal: product.selectedVariant ? product.selectedVariant.nominal : product.nominal,
        };
        const initialChatMessage = `${t.autoChatMessagePrefix || 'Я хочу купить товар:'} ${product.name} (${purchaseDetails.nominal}) ${t.forPrice || 'за'} ${convertPrice(purchaseDetails.finalPrice, currency)}.`;
        await onConfirm(product, purchaseDetails, initialChatMessage); 
        onClose();
    };

    const handleYooMoneyClick = () => {
        const purchaseDetails = {
            finalPrice,
            promoCodeUsed: appliedPromo ? appliedPromo.code : null,
            paymentMethod: 'YooMoney',
            nominal: product.selectedVariant ? product.selectedVariant.nominal : product.nominal,
        };
        onYooMoney(product, purchaseDetails);
        onClose();
    };

    return (
        <Modal onClose={onClose}>
            <div className="text-center">
                <h2 className="text-3xl font-bold text-primary mb-2">{t.checkout}</h2>
                <p className="text-secondary mb-4">
                    {t.youAreBuying}: <span className="font-bold accent-text">{product.name}</span>
                    {product.selectedVariant && ` (${product.selectedVariant.nominal})`}
                </p>
                
                <div className="my-4">
                    {appliedPromo ? (
                        <div>
                            <span className="text-2xl text-secondary line-through">{convertPrice(product.selectedVariant ? product.selectedVariant.price : product.price, currency)}</span>
                            <span className="text-4xl font-bold accent-text ml-2">{convertPrice(finalPrice, currency)}</span>
                        </div>
                    ) : (
                        <span className="text-4xl font-bold accent-text">{convertPrice(product.selectedVariant ? product.selectedVariant.price : product.price, currency)}</span>
                    )}
                </div>

                <div className="space-y-4">
                    <h3 className="text-xl text-primary">{t.choosePayment}</h3>
                    <div className="bg-tertiary p-4 rounded-lg">
                        <label className="block text-secondary text-sm font-bold mb-2">{t.payWithPromo}</label>
                        <div className="flex space-x-2">
                            <input type="text" value={promoCode} onChange={(e) => setPromoCode(e.target.value.toUpperCase())} placeholder={t.promoCodeName} className="w-full p-2 bg-primary rounded-lg border-color text-primary"/>
                            <button onClick={handleApplyPromo} className="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">{t.apply}</button>
                        </div>
                        {error && <p className="text-red-500 text-sm mt-2">{error}</p>}
                        {appliedPromo && <p className="text-green-500 text-sm mt-2">{t.promoApplied}: {appliedPromo.discount}%</p>}
                    </div>

                    <button onClick={handleContactSeller} className="w-full bg-teal-500 hover:bg-teal-600 text-white font-bold py-3 px-4 rounded-lg transition-transform transform hover:scale-105">{t.contactSeller}</button>
                    <button onClick={handleYooMoneyClick} className="w-full bg-yellow-500 hover:bg-yellow-600 text-black font-bold py-3 px-4 rounded-lg transition-transform transform hover:scale-105">YooMoney</button>
                </div>
            </div>
        </Modal>
    );
}

function YooMoneyModal({ data, onClose, onSubmitReceipt, t, currency, convertPrice, setAlertInfo }) {
    const { product, purchaseDetails } = data;
    const [receiptFile, setReceiptFile] = useState(null);
    const [contactTelegram, setContactTelegram] = useState('');
    const [contactEmail, setContactEmail] = useState('');
    const [isUploading, setIsUploading] = useState(false);

    const handleFileChange = (e) => {
        if (e.target.files[0]) {
            setReceiptFile(e.target.files[0]);
        }
    };

    const handleSubmit = async (e) => {
        e.preventDefault();
        if (!receiptFile || !contactTelegram || !contactEmail) {
            setAlertInfo({ message: t.fillAllFields });
            return;
        }
        setIsUploading(true);
        try {
            await onSubmitReceipt(product, purchaseDetails, {
                receiptFile,
                contactTelegram,
                contactEmail
            });
            onClose();
        } catch (error) {
        } finally {
            setIsUploading(false);
        }
    };

    return (
        <Modal onClose={onClose} size="max-w-lg">
            <div className="text-center">
                <h2 className="text-2xl font-bold text-primary mb-4">{t.yooMoneyPayment}</h2>
                <p className="text-secondary mb-4">{t.yooMoneyInstruction}</p>
                
                <div className="my-4">
                    <p className="text-secondary">{t.amountToPay}:</p>
                    <p className="text-3xl font-bold accent-text">{convertPrice(purchaseDetails.finalPrice, currency)}</p>
                </div>
                
                <div className="bg-tertiary p-3 rounded-lg mb-6">
                    <p className="text-secondary text-sm">{t.orPayWithLink}:</p>
                    <a href="https://yoomoney.ru/to/4100118308403073/0" target="_blank" rel="noopener noreferrer" className="text-blue-400 hover:underline break-words">
                        https://yoomoney.ru/to/4100118308403073/0
                    </a>
                </div>

                <form onSubmit={handleSubmit} className="space-y-4 text-left">
                    <h3 className="text-xl font-bold text-primary text-center">{t.afterPaymentTitle}</h3>
                    <div>
                        <label className="block text-secondary mb-1">{t.telegramUsername}</label>
                        <input type="text" value={contactTelegram} onChange={e => setContactTelegram(e.target.value)} placeholder="@username" className="w-full p-2 bg-primary rounded-lg border-color text-primary"/>
                    </div>
                    <div>
                        <label className="block text-secondary mb-1">{t.contactEmail}</label>
                        <input type="email" value={contactEmail} onChange={e => setContactEmail(e.target.value)} placeholder="email@example.com" className="w-full p-2 bg-primary rounded-lg border-color text-primary"/>
                    </div>
                     <div>
                        <label className="block text-secondary mb-1">{t.uploadReceipt}</label>
                        <input type="file" onChange={handleFileChange} accept="image/*" className="w-full text-sm text-secondary file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-purple-50 file:text-purple-700 hover:file:bg-purple-100"/>
                    </div>
                    <button type="submit" disabled={isUploading} className="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition-colors disabled:bg-gray-500">
                        {isUploading ? t.sending : t.sendForVerification}
                    </button>
                </form>
            </div>
        </Modal>
    );
}

function FAQPage({ faqs, t }) {
    const [openIndex, setOpenIndex] = useState(null);
    return (
        <div className="container mx-auto p-4 md:p-8">
            <h1 className="text-4xl font-bold text-center mb-8 text-primary">{t.faqTitle}</h1>
            <div className="space-y-4 max-w-3xl mx-auto">
                {faqs.length === 0 ? (
                    <p className="text-center text-secondary text-xl mt-12">{t.noFaqs || 'FAQ не найдены.'}</p>
                ) : (
                    faqs.map((faq, index) => (
                        <div key={faq.id} className="bg-secondary rounded-lg">
                            <button onClick={() => setOpenIndex(openIndex === index ? null : index)} className="w-full text-left p-4 flex justify-between items-center">
                                <span className="font-semibold text-primary">{faq.question}</span>
                                <svg className={`w-6 h-6 transform transition-transform text-primary ${openIndex === index ? 'rotate-180' : ''}`} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 9l-7 7-7-7"></path></svg>
                            </button>
                            {openIndex === index && ( <div className="p-4 border-t border-color text-secondary"> {faq.answer} </div> )}
                        </div>
                    ))
                )}
            </div>
        </div>
    );
}

function MyPurchasesPage({ user, t, currency, convertPrice, setAlertInfo }) {
    const [myPurchases, setMyPurchases] = useState([]);
    const [loading, setLoading] = useState(true);
    const [dateFilter, setDateFilter] = useState('all');
    const [sortOrder, setSortOrder] = useState('date_desc');

    useEffect(() => {
        if (!user) { setLoading(false); return; }
        setLoading(true);
        const q = query(collection(db, "purchases"), where("userId", "==", user.uid));
        const unsubscribe = onSnapshot(q, (snapshot) => {
            const purchases = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            setMyPurchases(purchases);
            setLoading(false);
        }, (error) => {
            console.error("Error fetching purchases:", error);
            setLoading(false);
        });

        return () => unsubscribe();
    }, [user]);
    
    const filteredAndSortedPurchases = useMemo(() => {
        let items = [...myPurchases];
        if (dateFilter !== 'all') {
            const now = new Date();
            const filterDate = new Date();
            if (dateFilter === 'today') {
                filterDate.setHours(0, 0, 0, 0);
            } else if (dateFilter === '3days') {
                filterDate.setDate(now.getDate() - 3);
                filterDate.setHours(0, 0, 0, 0);
            }
            items = items.filter(item => item.timestamp?.toDate && item.timestamp.toDate() >= filterDate);
        }
        if (sortOrder === 'price_asc') {
            items.sort((a, b) => (a.finalPrice || 0) - (b.finalPrice || 0));
        } else {
            items.sort((a, b) => (b.timestamp?.toMillis() || 0) - (a.timestamp?.toMillis() || 0));
        }
        return items;
    }, [myPurchases, dateFilter, sortOrder]);

    const handleCancelPurchase = (purchaseId) => {
        setAlertInfo({
            message: t.confirmCancelPurchase,
            onConfirm: async () => {
                try {
                    await updateDoc(doc(db, 'purchases', purchaseId), { status: 'cancelled' });
                    setAlertInfo({ message: t.purchaseCancelled });
                } catch (error) {
                    setAlertInfo({ message: t.errorOccurred });
                }
            }
        });
    };

    const getStatusClass = (status) => {
        switch (status) {
            case 'approved': return 'bg-green-500';
            case 'rejected': return 'bg-red-500';
            case 'contacted': return 'bg-blue-500';
            case 'cancelled': return 'bg-gray-500';
            default: return 'bg-yellow-500';
        }
    };
    const getStatusText = (status) => {
        switch (status) {
            case 'approved': return t.statusApproved;
            case 'rejected': return t.statusRejected;
            case 'contacted': return t.statusContacted;
            case 'cancelled': return t.statusCancelled;
            default: return t.statusPending;
        }
    };
    const FilterButton = ({ value, state, setState, children }) => (
        <button onClick={() => setState(value)} className={`px-4 py-2 rounded-lg text-sm transition-colors ${state === value ? 'accent-bg text-white' : 'bg-tertiary text-primary hover:bg-gray-600'}`}>
            {children}
        </button>
    );

    return (
        <div className="container mx-auto p-4 md:p-8">
            <h1 className="text-4xl font-bold text-center mb-8 text-primary">{t.myPurchases}</h1>
            <div className="max-w-3xl mx-auto bg-secondary p-4 rounded-lg mb-6 flex flex-col sm:flex-row justify-between items-center gap-4">
                <div className="flex items-center gap-2">
                   <span className="text-secondary font-semibold">{t.filterByDate}:</span>
                   <FilterButton value="all" state={dateFilter} setState={setDateFilter}>{t.all}</FilterButton>
                   <FilterButton value="today" state={dateFilter} setState={setDateFilter}>{t.today}</FilterButton>
                   <FilterButton value="3days" state={dateFilter} setState={setDateFilter}>{t.last3days}</FilterButton>
                </div>
                 <div className="flex items-center gap-2">
                   <span className="text-secondary font-semibold">{t.sortBy}:</span>
                   <FilterButton value="date_desc" state={sortOrder} setState={setSortOrder}>{t.newSort}</FilterButton>
                   <FilterButton value="price_asc" state={sortOrder} setState={setSortOrder}>{t.priceAsc}</FilterButton>
                </div>
            </div>
            {loading ? <LoadingSpinner /> : (
                filteredAndSortedPurchases.length === 0 ? <p className="text-center text-secondary">{t.noPurchasesYet}</p> : (
                    <div className="space-y-4 max-w-3xl mx-auto">
                        {filteredAndSortedPurchases.map(purchase => (
                            <div key={purchase.id} className="bg-secondary p-4 rounded-lg">
                                <div className="flex justify-between items-start flex-wrap">
                                    <div>
                                        <p className="font-bold text-primary text-lg">{purchase.productName}</p>
                                        {purchase.nominal && <p className="text-sm text-secondary">{t.nominal}: {purchase.nominal}</p>}
                                        <p className="font-mono text-sm accent-text bg-tertiary inline-block px-2 py-1 rounded my-1">Код: {purchase.purchaseCode}</p>
                                        <p className="text-sm text-secondary">{purchase.timestamp?.toDate ? new Date(purchase.timestamp.toDate()).toLocaleString() : '...'}</p>
                                        <p className="text-sm text-secondary">{t.amount}: {convertPrice(purchase.finalPrice, currency)}</p>
                                    </div>
                                    <span className={`mt-2 sm:mt-0 px-2 py-1 text-xs font-bold text-white rounded-full ${getStatusClass(purchase.status)}`}>
                                        {getStatusText(purchase.status)}
                                    </span>
                                </div>
                                {purchase.adminComment && (
                                    <div className="mt-2 p-2 bg-tertiary rounded-md">
                                        <p className="text-sm text-secondary"><b>{t.adminComment}:</b> {purchase.adminComment}</p>
                                    </div>
                                )}
                                <div className="flex space-x-2 mt-4">
                                    {(purchase.status === 'approved' || purchase.status === 'contacted') && (
                                        <a href="https://t.me/asonikofficial" target="_blank" rel="noopener noreferrer" className="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">
                                            {t.contactSellerToReceive}
                                        </a>
                                    )}
                                    {purchase.status === 'contacted' && (
                                        <button onClick={() => handleCancelPurchase(purchase.id)} className="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">
                                            {t.cancelOrder}
                                        </button>
                                    )}
                                </div>
                            </div>
                        ))}
                    </div>
                )
            )}
        </div>
    );
}

function Footer({t}) {
    return (
        <footer className="bg-secondary text-secondary p-6 mt-12 border-t border-color">
            <div className="container mx-auto text-center">
                <p>&copy; {new Date().getFullYear()} Asonik Store. {t.rightsReserved}</p>
                <p className="text-sm mt-2">{t.developedWithLove}</p>
            </div>
        </footer>
    );
};
        // --- Admin Components ---
function AdminProductManagement({ setAlertInfo, t, currency, convertPrice }) {
            const [products, setProducts] = useState([]);
            const [loading, setLoading] = useState(true);
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [editingProduct, setEditingProduct] = useState(null);
            const [isSaving, setIsSaving] = useState(false);

            const [name, setName] = useState('');
            const [description, setDescription] = useState('');
            const [category, setCategory] = useState('games');
            const [imageFiles, setImageFiles] = useState([]);
            const [imageUrls, setImageUrls] = useState([]);
            const [isVerified, setIsVerified] = useState(false);
            const [pinned, setPinned] = useState(false);
            const [isOnSale, setIsOnSale] = useState(true);
            const [variants, setVariants] = useState([{ nominal: '', price: '', stockQuantity: 1 }]);
            const fileInputRef = useRef(null);


            const categories = [
                { value: 'games', label: t.games },
                { value: 'apps', label: t.apps },
                { value: 'other', label: t.other || 'Другое' }
            ];

            useEffect(() => {
                const q = query(collection(db, "products"), orderBy('createdAt', 'desc'));
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    setProducts(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                    setLoading(false);
                }, (error) => {
                    console.error("Error fetching products for admin:", error);
                    setLoading(false);
                    setAlertInfo({ message: `${t.errorOccurred}: ${error.message}` });
                });
                return () => unsubscribe();
            }, []);

            const resetForm = () => {
                setEditingProduct(null);
                setName('');
                setDescription('');
                setCategory('games');
                setImageFiles([]);
                setImageUrls([]);
                setIsVerified(false);
                setPinned(false);
                setIsOnSale(true);
                setVariants([{ nominal: '', price: '', stockQuantity: 1 }]);
                if (fileInputRef.current) fileInputRef.current.value = "";
            };

            const uploadImageToImgBB = async (file) => {
                if (!IMGBB_API_KEY) {
                    throw new Error(t.noApiKey || 'API Key for ImgBB is not set!');
                }
                const formData = new FormData();
                formData.append('image', file);
                try {
                    const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, {
                        method: 'POST',
                        body: formData,
                    });
                    const result = await response.json();
                    if (result.success) {
                        return result.data.url;
                    } else {
                        console.error("ImgBB API Error Response:", result);
                        throw new Error(result.error.message || 'ImgBB upload failed');
                    }
                } catch (error) {
                    console.error("ImgBB upload fetch error:", error);
                    throw error;
                }
            };

            const handleAddEditProduct = async (e) => {
                e.preventDefault();
                if (!name || !description || variants.length === 0 || variants.some(v => !v.nominal || v.price === '' || v.stockQuantity === '')) {
                    setAlertInfo({ message: t.fillAllFields });
                    return;
                }

                setIsSaving(true);
                try {
                    const uploadedImgBBUrls = [];
                    for (const file of imageFiles) {
                        try {
                            const url = await uploadImageToImgBB(file);
                            uploadedImgBBUrls.push(url);
                        } catch (uploadError) {
                            throw new Error(`${t.errorUploadingImage || 'Ошибка загрузки изображения'}: ${uploadError.message}`);
                        }
                    }
                    const finalImageUrls = [...imageUrls, ...uploadedImgBBUrls];

                    const processedVariants = variants.map(v => ({
                        ...v,
                        price: parseFloat(v.price),
                        stockQuantity: parseInt(v.stockQuantity) || 0
                    }));


                    const productData = {
                        name, description, category,
                        imageUrls: finalImageUrls,
                        isVerified, pinned, isOnSale, variants: processedVariants
                    };

                    if (editingProduct) {
                        await updateDoc(doc(db, "products", editingProduct.id), { ...productData, updatedAt: serverTimestamp() });
                        setAlertInfo({ message: t.productUpdated });
                    } else {
                        await addDoc(collection(db, "products"), { ...productData, createdAt: serverTimestamp(), popularity: 0 });
                        setAlertInfo({ message: t.productAdded });
                    }
                    setIsModalOpen(false);
                    resetForm();
                } catch (error) {
                    console.error("Error saving product (overall):", error);
                    setAlertInfo({ message: `${t.errorOccurred}: ${error.message}` });
                } finally {
                    setIsSaving(false);
                }
            };

            const handleEditClick = (product) => {
                setEditingProduct(product);
                setName(product.name);
                setDescription(product.description);
                setCategory(product.category || 'games');
                setImageUrls(product.imageUrls || (product.imageUrl ? [product.imageUrl] : []));
                setIsVerified(product.isVerified || false);
                setPinned(product.pinned || false);
                setIsOnSale(product.isOnSale !== false);
                setVariants(product.variants && product.variants.length > 0 ? 
                    product.variants.map(v => ({...v, price: String(v.price), stockQuantity: v.stockQuantity !== undefined ? String(v.stockQuantity) : '1'})) 
                    : [{ nominal: '', price: '', stockQuantity: '1' }]);
                setIsModalOpen(true);
            };

            const handleDeleteClick = (productId, productImages) => {
                setAlertInfo({
                    message: t.confirmDelete,
                    onConfirm: async () => {
                        try {
                            await deleteDoc(doc(db, "products", productId));
                            setAlertInfo({ message: t.productDeleted });
                        } catch (error) {
                            console.error("Error deleting product:", error);
                            setAlertInfo({ message: `${t.errorOccurred}: ${error.message}` });
                        }
                    }
                });
            };

            const handleCloneClick = async (productToClone) => {
                setAlertInfo({
                    message: t.confirmCloneProduct || `Вы уверены, что хотите клонировать товар "${productToClone.name}"?`,
                    onConfirm: async () => {
                        try {
                            const clonedProductData = {
                                ...productToClone,
                                name: `${productToClone.name} (${t.copyText || 'Копия'})`,
                                createdAt: serverTimestamp(),
                                updatedAt: serverTimestamp(),
                                popularity: 0,
                                isOnSale: true,
                                variants: productToClone.variants ? productToClone.variants.map(v => ({ ...v, stockQuantity: v.stockQuantity || 0 })) : [],
                            };
                            delete clonedProductData.id; 

                            await addDoc(collection(db, "products"), clonedProductData);
                            setAlertInfo({ message: t.productCloned || 'Товар успешно клонирован!' });
                        } catch (error) {
                            console.error("Error cloning product:", error);
                            setAlertInfo({ message: `${t.errorOccurred}: ${error.message}` });
                        }
                    }
                });
            };

            const handleToggleSaleStatus = async (product) => {
                const newStatus = product.isOnSale === false;
                let updatedVariants = product.variants ? [...product.variants] : [];

                if (newStatus === true) {
                    const needsStockPrompt = updatedVariants.some(v => v.stockQuantity === undefined || v.stockQuantity <= 0);
                    if (needsStockPrompt || updatedVariants.length === 0) {
                        if (updatedVariants.length === 0) {
                            updatedVariants.push({ nominal: t.defaultNominal || 'Базовый', price: product.price || 0, stockQuantity: 0 });
                        }

                        for (let i = 0; i < updatedVariants.length; i++) {
                            if (updatedVariants[i].stockQuantity === undefined || updatedVariants[i].stockQuantity <= 0) {
                                const enteredQuantity = prompt(`${t.enterStockQuantityForVariant || 'Введите количество товара в наличии для варианта'} "${updatedVariants[i].nominal || ' (без номинала)'}":`);
                                const quantityToSet = parseInt(enteredQuantity);
                                if (isNaN(quantityToSet) || quantityToSet < 0) {
                                    setAlertInfo({ message: t.invalidQuantity || 'Неверное количество. Товар не будет выставлен на продажу.' });
                                    return;
                                }
                                updatedVariants[i].stockQuantity = quantityToSet;
                            }
                        }
                    }
                }
                
                try {
                    await updateDoc(doc(db, "products", product.id), { 
                        isOnSale: newStatus,
                        variants: updatedVariants
                    });
                    setAlertInfo({ message: newStatus ? t.putOnSaleSuccess || 'Товар выставлен на продажу.' : t.removeFromSaleSuccess || 'Товар снят с продажи.' });
                } catch (error) {
                    console.error("Error toggling sale status:", error);
                    setAlertInfo({ message: `${t.errorOccurred}: ${error.message}` });
                }
            };

            const handleImageFileChange = (e) => {
                setImageFiles([...Array.from(e.target.files)]);
                if (fileInputRef.current) fileInputRef.current.value = "";
            };

            const handleRemoveImage = (indexToRemove, isNewFile) => {
                if (isNewFile) {
                    setImageFiles(imageFiles.filter((_, index) => index !== indexToRemove));
                } else {
                    setImageUrls(imageUrls.filter((_, index) => index !== indexToRemove));
                }
            };

            const handleVariantChange = (index, field, value) => {
                const newVariants = [...variants];
                if (field === 'price' || field === 'stockQuantity') {
                     newVariants[index][field] = value === '' ? '' : Number(value); 
                } else {
                    newVariants[index][field] = value;
                }
                setVariants(newVariants);
            };

            const handleAddVariant = () => {
                setVariants([...variants, { nominal: '', price: '', stockQuantity: 1 }]);
            };

            const handleRemoveVariant = (indexToRemove) => {
                setVariants(variants.filter((_, index) => index !== indexToRemove));
            };


            return (
                <div className="p-4 md:p-8 bg-secondary rounded-xl shadow-lg border-color min-h-[500px]">
                    <div className="flex justify-between items-center mb-6">
                        <h2 className="text-3xl font-bold text-primary">{t.manageProducts}</h2>
                        <button onClick={() => { resetForm(); setIsModalOpen(true); }} className="accent-bg hover:accent-bg-secondary text-white font-bold py-2 px-4 rounded-lg transition-colors flex items-center space-x-2">
                            <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1  0 110-2h5V4a1 1 0 011-1z" clipRule="evenodd" /></svg>
                            <span>{t.addProduct}</span>
                        </button>
                    </div>

                    {loading ? <LoadingSpinner /> : (
                        products.length === 0 ? <p className="text-center text-secondary text-xl mt-12">{t.productsNotFound}</p> : (
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                {products.map(product => (
                                    <div key={product.id} className="bg-tertiary rounded-lg p-4 shadow border-color flex flex-col">
                                        <div className="relative mb-3">
                                            <img src={(product.imageUrls && product.imageUrls.length > 0) ? product.imageUrls[0] : (product.imageUrl || '')} 
                                                 alt={product.name} 
                                                 className="w-full h-40 object-cover rounded-md" 
                                                 onError={(e) => { e.target.onerror = null; e.target.src=`https://placehold.co/600x400/374151/1f2937?text=${encodeURIComponent(t.imageNotFound)}`; }}/>
                                            {product.pinned && <span className="absolute top-2 right-2 bg-yellow-400 text-black text-xs font-bold px-2 py-1 rounded-full">{t.pinned}</span>}
                                            {product.isOnSale === false && <span className="absolute top-2 left-2 bg-gray-500 text-white text-xs font-bold px-2 py-1 rounded-full">{t.removedFromSale || 'Снято с продажи'}</span>}
                                        </div>
                                        <h3 className="text-xl font-bold text-primary mb-1">{product.name}</h3>
                                        {product.nominal && <p className="text-secondary text-sm mb-2">{product.nominal}</p>}
                                        {product.variants && product.variants.length > 0 ? (
                                            <div className="text-secondary text-sm mb-2">
                                                {t.priceFrom}: {convertPrice(Math.min(...product.variants.map(v => v.price)), currency)}
                                                {product.variants.length > 1 && ` - ${convertPrice(Math.max(...product.variants.map(v => v.price)), currency)}`}
                                            </div>
                                        ) : (
                                            product.price && <p className="accent-text text-lg font-bold mt-auto">{convertPrice(product.price, currency)}</p>
                                        )}
                                        {product.variants && product.variants.length > 0 && (
                                            <p className="text-secondary text-sm">
                                                {t.inStock || 'В наличии'}: {product.variants.reduce((sum, v) => sum + (parseInt(v.stockQuantity) || 0), 0) > 0 ? product.variants.reduce((sum, v) => sum + (parseInt(v.stockQuantity) || 0), 0) : t.outOfStock}
                                            </p>
                                        )}
                                        {!(product.variants && product.variants.length > 0) && product.stockQuantity !== undefined && (
                                            <p className="text-secondary text-sm">
                                                {t.inStock || 'В наличии'}: {product.stockQuantity > 0 ? product.stockQuantity : t.outOfStock}
                                            </p>
                                        )}


                                        <div className="flex space-x-2 mt-4 flex-wrap">
                                            <button onClick={() => handleEditClick(product)} className="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-colors flex-grow mb-2">{t.edit}</button>
                                            <button onClick={() => handleDeleteClick(product.id, product.imageUrls || (product.imageUrl ? [product.imageUrl] : []))} className="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition-colors flex-grow mb-2">{t.delete}</button>
                                            <button onClick={() => handleCloneClick(product)} className="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition-colors flex-grow mb-2">{t.cloneProduct || 'Клон'}</button>
                                            <button 
                                                onClick={() => handleToggleSaleStatus(product)} 
                                                className={`font-bold py-2 px-4 rounded-lg transition-colors flex-grow ${product.isOnSale === false ? 'bg-purple-600 hover:bg-purple-700 text-white' : 'bg-yellow-600 hover:bg-yellow-700 text-black'}`}>
                                                {product.isOnSale === false ? t.putOnSale || 'Вернуть в продажу' : t.removeFromSale || 'Снять с продажи'}
                                            </button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )
                    )}

                    {isModalOpen && (
                        <Modal onClose={() => { setIsModalOpen(false); resetForm(); }} size="max-w-2xl">
                            <h2 className="text-2xl font-bold text-primary mb-6 text-center">{editingProduct ? t.editProduct : t.addProduct}</h2>
                            <form onSubmit={handleAddEditProduct} className="space-y-4">
                                <div>
                                    <label className="block text-secondary text-sm font-bold mb-2">{t.productName}</label>
                                    <input type="text" value={name} onChange={(e) => setName(e.target.value)} className="w-full p-3 bg-tertiary rounded-lg border-color text-primary" placeholder={t.productName}/>
                                </div>
                                <div>
                                    <label className="block text-secondary text-sm font-bold mb-2">{t.description}</label>
                                    <textarea value={description} onChange={(e) => setDescription(e.target.value)} className="w-full p-3 bg-tertiary rounded-lg border-color text-primary h-32 resize-none" placeholder={t.description}></textarea>
                                </div>
                                <div>
                                    <label className="block text-secondary text-sm font-bold mb-2">{t.category}</label>
                                    <CustomSelector value={category} onChange={e => setCategory(e.target.value)} options={categories} />
                                </div>
                                
                                <div className="space-y-3 bg-tertiary p-4 rounded-lg border-color">
                                    <h3 className="text-xl font-bold text-primary">{t.productVariants || 'Варианты товара'}</h3>
                                    {variants.map((variant, index) => (
                                        <div key={index} className="flex flex-col md:flex-row gap-2 items-end">
                                            <div className="flex-grow">
                                                <label className="block text-secondary text-sm mb-1">{t.nominal || 'Номинал'}</label>
                                                <input type="text" value={variant.nominal} onChange={(e) => handleVariantChange(index, 'nominal', e.target.value)} className="w-full p-2 bg-primary rounded-lg border-color text-primary" placeholder={t.nominalExample || '500 гемов'}/>
                                            </div>
                                            <div className="flex-grow">
                                                <label className="block text-secondary text-sm mb-1">{t.price || 'Цена'}</label>
                                                <input type="number" value={variant.price} onChange={(e) => handleVariantChange(index, 'price', e.target.value)} className="w-full p-2 bg-primary rounded-lg border-color text-primary" placeholder="100"/>
                                            </div>
                                            <div className="flex-grow">
                                                <label className="block text-secondary text-sm mb-1">{t.stockQuantity || 'Наличие'}</label>
                                                <input type="number" value={variant.stockQuantity} onChange={(e) => handleVariantChange(index, 'stockQuantity', e.target.value)} className="w-full p-2 bg-primary rounded-lg border-color text-primary" placeholder="1"/>
                                            </div>
                                            <button type="button" onClick={() => handleRemoveVariant(index)} className="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg h-10 flex-shrink-0">
                                                {t.remove || 'Удалить'}
                                            </button>
                                        </div>
                                    ))}
                                    <button type="button" onClick={handleAddVariant} className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg mt-2">
                                        {t.addVariant || 'Добавить вариант'}
                                    </button>
                                </div>

                                <div>
                                    <label className="block text-secondary text-sm font-bold mb-2">{t.productImages}</label>
                                    <div className="flex flex-wrap gap-2 mb-2">
                                        {imageUrls.map((url, index) => (
                                            <div key={`url-${index}`} className="relative w-24 h-24 rounded-lg overflow-hidden border border-color">
                                                <img src={url} alt={`Product Image ${index}`} className="w-full h-full object-cover"/>
                                                <button type="button" onClick={() => handleRemoveImage(index, false)} className="absolute top-0 right-0 bg-red-600 text-white rounded-bl-lg p-1 text-xs">X</button>
                                            </div>
                                        ))}
                                        {imageFiles.map((file, index) => (
                                            <div key={`file-${index}`} className="relative w-24 h-24 rounded-lg overflow-hidden border border-color">
                                                <img src={URL.createObjectURL(file)} alt={`New Image ${index}`} className="w-full h-full object-cover"/>
                                                <button type="button" onClick={() => handleRemoveImage(index, true)} className="absolute top-0 right-0 bg-red-600 text-white rounded-bl-lg p-1 text-xs">X</button>
                                            </div>
                                        ))}
                                    </div>
                                    <input type="file" ref={fileInputRef} onChange={handleImageFileChange} accept="image/*" multiple className="w-full text-sm text-secondary file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-purple-50 file:text-purple-700 hover:file:bg-purple-100"/>
                                </div>
                                <div className="flex items-center space-x-4">
                                    <label className="flex items-center text-secondary">
                                        <input type="checkbox" checked={isVerified} onChange={(e) => setIsVerified(e.target.checked)} className="form-checkbox h-5 w-5 text-purple-600 rounded"/>
                                        <span className="ml-2">{t.verifiedByStore}</span>
                                    </label>
                                    <label className="flex items-center text-secondary">
                                        <input type="checkbox" checked={pinned} onChange={(e) => setPinned(e.target.checked)} className="form-checkbox h-5 w-5 text-purple-600 rounded"/>
                                        <span className="ml-2">{t.pinProduct}</span>
                                    </label>
                                </div>
                                <button type="submit" disabled={isSaving} className="w-full accent-bg hover:accent-bg-secondary text-white font-bold py-3 px-4 rounded-lg transition-colors disabled:bg-gray-500">
                                    {isSaving ? t.sending : (editingProduct ? t.updateProduct : t.addProductBtn)}
                                </button>
                            </form>
                        </Modal>
                    )}
                </div>
            );
        }

// ... All other Admin components are here but omitted for brevity
// ... AdminPromoCodeManagement, AdminFaqManagement, AdminReceiptCheck, UserChatInterface, etc.

function AdminPanel({ setPage, setAlertInfo, t, currency, convertPrice }) {
    const [activeTab, setActiveTab] = useState('products');
    // ... rest of AdminPanel component
    return (<div>Admin Panel Placeholder</div>); // Simplified for brevity
}

function App() {
    const [user, setUser] = useState(undefined);
    const [products, setProducts] = useState([]);
    const [faqs, setFaqs] = useState([]);
    const [page, setPage] = useState('home');
    const [alertInfo, setAlertInfo] = useState(null);
    const [toastMessage, setToastMessage] = useState('');
    const [language, setLanguage] = useState('ru');
    const [currency, setCurrency] = useState('UZS');
    const [profileVisible, setProfileVisible] = useState(false);
    const [isPinModalVisible, setIsPinModalVisible] = useState(false);
    const [pinError, setPinError] = useState('');
    const [isAdminSessionActive, setIsAdminSessionActive] = useState(false);
    const [selectedProduct, setSelectedProduct] = useState(null);
    const [purchasingProduct, setPurchasingProduct] = useState(null);
    const [yooMoneyData, setYooMoneyData] = useState(null);
    const [theme, setTheme] = useState('asonik');
    const [cart, setCart] = useState([]);
    const [isCartVisible, setIsCartVisible] = useState(false);

    useEffect(() => {
        if (toastMessage) {
            const timer = setTimeout(() => {
                setToastMessage('');
            }, 2500);
            return () => clearTimeout(timer);
        }
    }, [toastMessage]);

    useEffect(() => {
        const storedSession = localStorage.getItem('adminSession');
        if (storedSession) {
            try {
                const { expiryTime } = JSON.parse(storedSession);
                if (Date.now() < expiryTime) {
                    setIsAdminSessionActive(true);
                } else {
                    localStorage.removeItem('adminSession');
                }
            } catch (e) {
                localStorage.removeItem('adminSession');
            }
        }
    }, []);

    useEffect(() => { document.body.className = theme; }, [theme]);
    useEffect(() => {
         const params = new URLSearchParams(window.location.search);
        const productId = params.get('product');
        if (productId && products.length > 0) {
            const productToShow = products.find(p => p.id === productId);
            if (productToShow) setSelectedProduct(productToShow);
            window.history.replaceState({}, document.title, window.location.pathname);
        }
    }, [products]);
    
    const isAdmin = user && user.uid === ADMIN_UID;
    const t = translations[language] || translations.ru;
    
    useEffect(() => {
        const unsubscribe = onAuthStateChanged(auth, (currentUser) => {
            setUser(currentUser);
            if (currentUser) {
                const userDocRef = doc(db, 'users', currentUser.uid);
                getDoc(userDocRef).then(docSnap => {
                    if (!docSnap.exists()) {
                        setDoc(userDocRef, {
                            uid: currentUser.uid,
                            displayName: currentUser.displayName || 'Anonim',
                            email: currentUser.email,
                            photoURL: currentUser.photoURL || '',
                            createdAt: serverTimestamp(),
                            lastLogin: serverTimestamp()
                        }, { merge: true });
                    } else {
                        updateDoc(userDocRef, { lastLogin: serverTimestamp() });
                    }
                }).catch(error => console.error("Error setting user doc:", error));
            }
        });
        return () => unsubscribe();
    }, []);

    useEffect(() => {
        const q = query(collection(db, "products"), orderBy('createdAt', 'desc'));
        const unsubProducts = onSnapshot(q, (snapshot) => setProducts(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))));
        const unsubFaqs = onSnapshot(collection(db, "faq"), (snapshot) => setFaqs(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))));
        return () => { unsubProducts(); unsubFaqs(); };
    }, []);

    const handleLogin = async () => { try { await signInWithPopup(auth, provider); } catch (error) { setAlertInfo({ message: "Login failed: " + error.message }); } };
    const handleLogout = async () => { 
        try { 
            await signOut(auth); 
            localStorage.removeItem('adminSession');
            setIsAdminSessionActive(false);
            setPage('home'); 
        } catch (error) { 
            console.error("Logout Error:", error); 
        } 
    };
    
    const handleAdminClick = () => {
        if (isAdmin && isAdminSessionActive) {
            setPage('admin');
        } else {
            setIsPinModalVisible(true);
        }
    };

    const handlePinSubmit = (pin, rememberMe) => {
        if (pin === ADMIN_PIN) {
            if (rememberMe) {
                const expiryTime = Date.now() + 10 * 60 * 1000;
                localStorage.setItem('adminSession', JSON.stringify({ expiryTime }));
                setIsAdminSessionActive(true);
            }
            setPage('admin');
            setIsPinModalVisible(false);
            setPinError('');
            return true;
        } else {
            setPinError('Неверный ПИН-код');
            return false;
        }
    };

    const handleBuy = (product) => {
        if (user) {
            setSelectedProduct(null);
            setIsCartVisible(false);
            setPurchasingProduct(product);
        } else {
            setAlertInfo({ message: t.loginToBuy });
        }
    };

    const handleAddToCart = (productToAdd) => {
        setCart(prevCart => {
            const existingItem = prevCart.find(item => 
                item.id === productToAdd.id && item.selectedVariant.nominal === productToAdd.selectedVariant.nominal
            );
            if (existingItem) {
                return prevCart.map(item => 
                    item.id === productToAdd.id && item.selectedVariant.nominal === productToAdd.selectedVariant.nominal
                    ? { ...item, quantity: item.quantity + 1 }
                    : item
                );
            }
            return [...prevCart, { ...productToAdd, quantity: 1 }];
        });
        setToastMessage(t.itemAddedToCart);
    };

    const handleRemoveFromCart = (productId, variantNominal) => {
        setCart(prevCart => prevCart.filter(item => 
            !(item.id === productId && item.selectedVariant.nominal === variantNominal)
        ));
    };

    const handleUpdateCartQuantity = (productId, variantNominal, newQuantity) => {
        if (newQuantity <= 0) {
            handleRemoveFromCart(productId, variantNominal);
            return;
        }
        setCart(prevCart => prevCart.map(item => 
            item.id === productId && item.selectedVariant.nominal === variantNominal
            ? { ...item, quantity: newQuantity }
            : item
        ));
    };

    const handleCheckoutFromCart = (cartSummaryProduct) => {
        setIsCartVisible(false);
        setPurchasingProduct(cartSummaryProduct);
    };

    const handleConfirmPurchase = async (product, purchaseDetails, initialChatMessage = '') => {
        if (!user) return;
        try {
            const purchaseCode = generatePurchaseCode();
            const purchasePayload = {
                userId: user.uid, userEmail: user.email,
                productId: product.id,
                productName: product.name,
                timestamp: serverTimestamp(),
                originalPrice: product.selectedVariant.price,
                finalPrice: purchaseDetails.finalPrice,
                promoCodeUsed: purchaseDetails.promoCodeUsed,
                paymentMethod: purchaseDetails.paymentMethod,
                status: 'contacted',
                purchaseCode: purchaseCode,
                nominal: product.selectedVariant.nominal,
            };
            await addDoc(collection(db, 'purchases'), purchasePayload);
            
            if (purchaseDetails.promoCodeUsed) {
                await updateDoc(doc(db, 'promoCodes', purchaseDetails.promoCodeUsed), { timesUsed: increment(1) });
            }
            
            if(product.id !== 'cart-order') {
                const productDocRef = doc(db, 'products', product.id);
                const productSnap = await getDoc(productDocRef);
                if (productSnap.exists()) {
                    const currentVariants = productSnap.data().variants || [];
                    const updatedVariants = currentVariants.map((v, idx) => 
                        idx === product.selectedVariantIndex ? { ...v, stockQuantity: (v.stockQuantity || 0) - 1 } : v
                    );
                     await updateDoc(productDocRef, { variants: updatedVariants, popularity: increment(1) });
                }
            } else {
                setCart([]);
            }
            
            if (initialChatMessage) {
                 await addDoc(collection(db, `chats/${user.uid}/messages`), {
                    senderId: user.uid,
                    senderName: user.displayName || user.email,
                    message: initialChatMessage,
                    timestamp: serverTimestamp(),
                    isRead: false,
                    isAdmin: false
                });
                await setDoc(doc(db, "chats", user.uid), {
                    lastMessage: initialChatMessage,
                    lastMessageTimestamp: serverTimestamp(),
                    userId: user.uid,
                    userName: user.displayName || user.email,
                    userEmail: user.email,
                    hasUnreadAdmin: true, 
                    hasUnreadUser: false, 
                }, { merge: true });
            }
            setAlertInfo({ message: `${t.contactSellerToReceive}\n\n${t.yourPurchaseCode}: ${purchaseCode}` });

        } catch (error) { 
            console.error("Purchase creation error: ", error);
            setAlertInfo({ message: t.errorOccurred });
        }
    };
    
    const handleAlertConfirm = () => { if (alertInfo && alertInfo.onConfirm) alertInfo.onConfirm(); setAlertInfo(null); };

    const renderContent = () => {
        switch (page) {
            case 'admin': return isAdmin ? <AdminPanel {...{setPage, setAlertInfo, t, currency, convertPrice}} /> : <HomePage {...{products, onProductClick: setSelectedProduct, t, currency, convertPrice, loading: products.length === 0}} />;
            case 'purchases': return user ? <MyPurchasesPage {...{user, t, currency, convertPrice, setAlertInfo}} /> : <div className="text-center text-primary p-10">{t.loginToView}</div>;
            case 'faq': return <FAQPage faqs={faqs} t={t} />;
            case 'chats': return user ? <div>Chats Placeholder</div> : <div className="text-center text-primary p-10">{t.loginToView}</div>;
            default: return <HomePage {...{products, onProductClick: setSelectedProduct, t, currency, convertPrice, loading: products.length === 0}} />;
        }
    };
    
    if (user === undefined) {
        return <LoadingSpinner />;
    }
    
    return (
        <div className="bg-primary min-h-screen font-sans flex flex-col">
            <Header {...{user, onLogin, handleLogout, setPage, isAdmin, t, currency, setCurrency, language, setLanguage, setProfileVisible, theme, setTheme, onAdminClick: handleAdminClick, cartCount: cart.length, onCartClick: () => setIsCartVisible(true)}} />
            <div className="flex-grow">
                {renderContent()}
            </div>
            
            {selectedProduct && <ProductModal product={selectedProduct} user={user} onClose={() => setSelectedProduct(null)} onBuy={handleBuy} onAddToCart={handleAddToCart} setAlertInfo={setAlertInfo} t={t} currency={currency} convertPrice={convertPrice} />}
            {purchasingProduct && user && <PurchaseModal product={purchasingProduct} onClose={() => setPurchasingProduct(null)} onConfirm={handleConfirmPurchase} onYooMoney={()=>{}} t={t} currency={currency} convertPrice={convertPrice} setAlertInfo={setAlertInfo} />}
            {isCartVisible && user && <CartModal cart={cart} onClose={() => setIsCartVisible(false)} onRemoveFromCart={handleRemoveFromCart} onUpdateCartQuantity={handleUpdateCartQuantity} onCheckoutFromCart={handleCheckoutFromCart} t={t} currency={currency} convertPrice={convertPrice} />}
            
            <ToastNotification message={toastMessage} />
            {user && <FloatingCartButton cartCount={cart.length} onClick={() => setIsCartVisible(true)} />}

            {alertInfo && <AlertModal message={alertInfo.message} onConfirm={alertInfo.onConfirm ? handleAlertConfirm : null} onCancel={() => setAlertInfo(null)} t={t} />}
            {profileVisible && user && <ProfileModal user={user} onClose={() => setProfileVisible(false)} t={t} setAlertInfo={setAlertInfo} onLogout={handleLogout} />}
            {isPinModalVisible && <PinModal onSubmit={handlePinSubmit} error={pinError} onClose={() => setIsPinModalVisible(false)} t={t} />}
            <Footer t={t}/>
        </div>
    );
}

const translations = {
    ru: {
        // ... all previous translations ...
        addToCart: 'В корзину',
        buyInOneClick: 'Купить в 1 клик',
        shoppingCart: 'Корзина',
        cartIsEmpty: 'Ваша корзина пуста.',
        itemAddedToCart: 'Товар добавлен в корзину!',
        total: 'Итого',
        quantity: 'Кол-во',
        proceedToCheckout: 'Оформить заказ',
        continueShopping: 'Продолжить покупки',
        checkoutFromCartInfo: 'Оформление заказа из корзины происходит через связь с продавцом. Пожалуйста, свяжитесь с нами для завершения покупки.',
        cartOrderName: 'Заказ из корзины',
        loginToInteract: 'Пожалуйста, войдите, чтобы выполнить это действие.',
    },
    en: { /* ... */ },
    uz: { /* ... */ },
};

const currencyRates = { RUB: 1, USD: 0.011, UZS: 140 };
const currencySymbols = { RUB: '₽', USD: '$', UZS: "so'm" };
const convertPrice = (priceInRub, targetCurrency) => {
    const rate = currencyRates[targetCurrency];
    const symbol = currencySymbols[targetCurrency];
    if (!rate || !priceInRub && priceInRub !==0) return `0 ${symbol}`;
    const convertedPrice = priceInRub * rate;
    return `${convertedPrice.toLocaleString('ru-RU', { maximumFractionDigits: 2 })} ${symbol}`;
};

ReactDOM.render(<App />, document.getElementById('root'));

    </script>
</body>
</html>
