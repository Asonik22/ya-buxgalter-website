<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asonik AI</title>
    <!-- Подключение шрифта Inter из Google Fonts для современного внешнего вида -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* Общие стили для тела страницы */
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: #000; /* Черный фон */
            color: #e0e0e0;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            position: relative;
            overflow: hidden;
        }

        /* Звездный фон и анимация */
        @keyframes move-stars {
            from { background-position: 0 0; }
            to { background-position: -10000px -5000px; }
        }

        /* Анимация комет */
        @keyframes move-comet-1 {
            0% { transform: translateX(200vw) translateY(-100vh); opacity: 0; }
            1% { opacity: 1; }
            100% { transform: translateX(-100vw) translateY(50vh); opacity: 0; }
        }
        
        @keyframes move-comet-2 {
            0% { transform: translateX(-100vw) translateY(200vh); opacity: 0; }
            10% { opacity: 0; }
            11% { opacity: 1; }
            100% { transform: translateX(200vw) translateY(-100vh); opacity: 0; }
        }

        @keyframes move-comet-3 {
            0% { transform: translateX(200vw) translateY(200vh); opacity: 0; }
            20% { opacity: 0; }
            21% { opacity: 1; }
            100% { transform: translateX(-100vw) translateY(-100vh); opacity: 0; }
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image:
                radial-gradient(4px 4px at 20px 30px, #fff, rgba(0,0,0,0)),
                radial-gradient(3px 3px at 40px 70px, #fff, rgba(0,0,0,0)),
                radial-gradient(2px 2px at 150px 10px, #ddd, rgba(0,0,0,0)),
                radial-gradient(4px 4px at 100px 20px, #fff, rgba(0,0,0,0)),
                radial-gradient(2px 2px at 130px 50px, #ddd, rgba(0,0,0,0)),
                radial-gradient(5px 5px at 300px 500px, #fff, rgba(0,0,0,0)),
                radial-gradient(3px 3px at 200px 40px, #fff, rgba(0,0,0,0)),
                radial-gradient(2px 2px at 350px 80px, #ddd, rgba(0,0,0,0)),
                radial-gradient(4px 4px at 400px 120px, #fff, rgba(0,0,0,0)),
                radial-gradient(3px 3px at 600px 200px, #ddd, rgba(0,0,0,0)),
                radial-gradient(2px 2px at 700px 400px, #fff, rgba(0,0,0,0));
            background-repeat: repeat;
            background-size: 500px 500px;
            opacity: 0.7;
            animation: move-stars 100s linear infinite;
            z-index: -1;
        }

        .comet {
            position: fixed;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.8), transparent);
            border-radius: 50%;
            width: 200px;
            height: 2px;
            transform-origin: left center;
            opacity: 0;
            z-index: 0;
        }

        #comet-1 {
            top: 10%; left: 0;
            animation: move-comet-1 20s linear infinite;
            animation-delay: 5s;
        }
        
        #comet-2 {
            top: 80%; right: 0;
            animation: move-comet-2 25s linear infinite;
            animation-delay: 15s;
        }
        
        #comet-3 {
            bottom: 20%; left: 0;
            animation: move-comet-3 30s linear infinite;
            animation-delay: 10s;
        }

        /* Хедер (шапка) сайта */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 40px;
            background-color: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            z-index: 10;
        }

        .logo {
            font-size: 2rem;
            font-weight: 700;
            color: #fff;
            text-shadow: 0 0 15px rgba(0, 191, 255, 0.7);
        }

        /* Кнопки аутентификации */
        .auth-buttons-container {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        .auth-btn, .profile-btn-wrapper, .modal-auth-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        .auth-btn:hover, .profile-btn-wrapper:hover, .modal-auth-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.3);
        }
        
        .main-auth-btn {
            background-color: #007bff;
            color: white;
        }
        
        /* Кнопка истории чатов */
        #chat-history-btn, #clear-chat-btn {
            background-color: #333;
            color: #fff;
        }

        /* Кнопка профиля с выпадающим меню */
        .profile-btn-wrapper {
            position: relative;
            background: none;
            padding: 0;
            border-radius: 50%;
        }

        .profile-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #555;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            cursor: pointer;
        }

        .profile-btn img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .profile-menu {
            position: absolute;
            top: 50px;
            right: 0;
            background-color: #2c2f33;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
            padding: 10px;
            display: none;
            flex-direction: column;
            gap: 5px;
            z-index: 15;
            min-width: 150px;
        }

        .profile-menu.show {
            display: flex;
        }

        .profile-menu-item {
            padding: 10px;
            cursor: pointer;
            text-align: left;
            border-radius: 6px;
            transition: background-color 0.2s ease;
            color: white;
            text-decoration: none;
        }

        .profile-menu-item:hover {
            background-color: #3e4247;
        }
        
        /* Модальные окна */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 20;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease;
        }

        .modal.open {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background-color: #1a1a1a;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.5);
            max-width: 400px;
            width: 90%;
        }

        .modal-content h2 {
            margin-top: 0;
            font-size: 1.5rem;
            color: white;
            margin-bottom: 20px;
        }
        
        .modal-content p {
            font-size: 1rem;
            color: #e0e0e0;
            margin-bottom: 20px;
        }

        .modal-buttons {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .modal-auth-btn {
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .modal-auth-btn.google-btn {
            background-color: #4285F4;
            color: white;
        }
        
        .modal-auth-btn.apple-btn {
            background-color: #000;
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        /* Модальное окно истории чатов */
        #chat-history-modal {
            display: none;
            flex-direction: column;
        }
        
        #chat-history-modal.open {
            display: flex;
        }

        #history-list {
            max-height: 500px;
            overflow-y: auto;
            text-align: left;
            width: 100%;
        }

        .history-item {
            padding: 10px;
            border-radius: 8px;
            background-color: #2c2f33;
            margin-bottom: 10px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            word-wrap: break-word;
        }

        .history-item:hover {
            background-color: #3e4247;
        }
        
        /* Основной контейнер чата */
        .chat-container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            box-sizing: border-box;
            position: relative;
            z-index: 5;
        }
        
        #ai-chat {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            gap: 10px;
            padding-bottom: 20px;
        }

        .message {
            padding: 12px 18px;
            border-radius: 18px;
            max-width: 85%;
            word-wrap: break-word;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .user-message {
            background-color: #007bff;
            align-self: flex-end;
            color: white;
            border-bottom-right-radius: 4px;
        }

        .ai-message {
            background-color: #2c2f33;
            align-self: flex-start;
            color: #e0e0e0;
            border-bottom-left-radius: 4px;
        }

        /* Плавающая панель ввода */
        .chat-input-wrapper {
            position: sticky;
            bottom: 20px;
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 10px;
            border-radius: 15px;
            background-color: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            box-sizing: border-box;
        }
        
        .input-group {
            display: flex;
            gap: 10px;
            width: 100%;
            align-items: center;
        }

        .ai-selection-container {
            width: 100%;
            text-align: left;
            margin-bottom: 0;
        }

        #ai-selector {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background-color: rgba(255, 255, 255, 0.1);
            color: #e0e0e0;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            cursor: pointer;
        }
        
        #ai-selector:focus {
            outline: none;
            box-shadow: 0 0 0 2px #00bfff;
        }

        #user-message-input {
            flex-grow: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            background-color: #1a1a1a;
            color: white;
            font-size: 1rem;
            outline: none;
        }
        
        #send-message-btn, #file-upload-btn {
            width: 50px;
            height: 50px;
            background-color: #00bfff;
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        #send-message-btn:hover, #file-upload-btn:hover {
            background-color: #0099e6;
            transform: scale(1.05);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.3);
        }

        #clear-chat-btn {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background-color 0.3s;
        }
        
        #clear-chat-btn:hover {
            background-color: #c82333;
        }
        
        .loader {
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            border-top: 4px solid #3498db;
            width: 20px;
            height: 20px;
            -webkit-animation: spin 2s linear infinite;
            animation: spin 2s linear infinite;
        }

        @-webkit-keyframes spin {
            0% { -webkit-transform: rotate(0deg); }
            100% { -webkit-transform: rotate(360deg); }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Футер (подвал) сайта */
        .footer {
            text-align: center;
            padding: 20px;
            color: #aaa;
            font-size: 0.8rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 10;
        }
    </style>
</head>
<body>

    <!-- Звезды и кометы на фоне -->
    <div class="comet" id="comet-1"></div>
    <div class="comet" id="comet-2"></div>
    <div class="comet" id="comet-3"></div>

    <!-- Заголовок и кнопки аутентификации -->
    <header class="header">
        <div class="logo">Asonik AI</div>
        <div class="auth-buttons-container">
            <!-- Кнопка истории чатов -->
            <button class="auth-btn" id="chat-history-btn">История чатов</button>
            <!-- Кнопка для входа/регистрации -->
            <button class="auth-btn main-auth-btn" id="auth-btn">Войти / Регистрация</button>
            <!-- Обёртка для кнопки профиля -->
            <div class="profile-btn-wrapper" id="profile-btn-wrapper" style="display: none;">
                <div class="profile-btn">
                    <img id="profile-img" src="https://placehold.co/40x40/2c2f33/white?text=User" alt="Профиль">
                </div>
                <!-- Меню профиля -->
                <div class="profile-menu" id="profile-menu">
                    <span class="profile-menu-item" id="user-info"></span>
                    <a href="#" class="profile-menu-item">Настройки</a>
                    <a href="#" class="profile-menu-item">Помощь</a>
                    <a href="#" class="profile-menu-item" id="logout-btn">Выйти</a>
                </div>
            </div>
        </div>
    </header>

    <!-- Основной контейнер чата -->
    <main class="chat-container">
        <div id="ai-chat">
            <!-- Сообщения будут добавляться сюда через JavaScript -->
        </div>

        <!-- Плавающая панель ввода сообщения -->
        <div class="chat-input-wrapper">
            <div style="display: flex; justify-content: space-between; align-items: center; width: 100%; gap: 10px;">
                <div class="ai-selection-container" style="flex-grow: 1;">
                    <!-- Dropdown для выбора AI модели -->
                    <select id="ai-selector">
                        <option value="gemini-2.5-flash-preview-05-20">Gemini 2.5 Flash</option>
                        <option value="gpt-3.5-turbo">GPT-3.5</option>
                        <option value="gpt-4">GPT-4</option>
                        <option value="gpt-4o-mini" selected>GPT-4o Mini</option>
                    </select>
                </div>
                <button id="clear-chat-btn">Очистить чат</button>
            </div>
            
            <div class="input-group">
                <!-- Кнопка для загрузки файлов -->
                <button id="file-upload-btn">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-upload">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="17 8 12 3 7 8"></polyline>
                        <line x1="12" y1="3" x2="12" y2="15"></line>
                    </svg>
                </button>
                <input type="file" id="file-input" style="display: none;">
                
                <input type="text" id="user-message-input" placeholder="Введите ваше сообщение...">
                <button id="send-message-btn">
                    <svg width="24" height="24" viewBox="0 0 0 0" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="22" y1="2" x2="11" y2="13"></line>
                        <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                    </svg>
                </button>
            </div>
        </div>
    </main>
    
    <!-- Футер -->
    <footer class="footer">
        © 2024 Asonik AI. Все права защищены.
    </footer>
    
    <!-- Модальное окно для аутентификации -->
    <div id="auth-modal" class="modal">
        <div class="modal-content">
            <h2>Войдите в Asonik AI</h2>
            <div class="modal-buttons">
                <button class="modal-auth-btn google-btn">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M19.9 10.22c0-.65-.06-1.28-.18-1.9H10.15v3.58h5.4c-.23 1.18-.8 2.18-1.68 2.9l3.07 2.37c1.87-1.74 2.97-4.2 2.97-7.05z" fill="#4285F4"/>
                        <path d="M10.15 20c2.73 0 5.03-.9 6.7-2.43l-3.07-2.37c-.85.57-1.92.9-3.63.9-2.79 0-5.17-1.88-6.04-4.42H.99v2.44A9.985 9.985 0 0010.15 20z" fill="#34A853"/>
                        <path d="M4.11 11.22c-.2-.57-.31-1.18-.31-1.82s.11-1.25.31-1.82V5.14H.99a9.96 9.96 0 000 9.72L4.11 11.22z" fill="#FBBC05"/>
                        <path d="M10.15 3.97c1.49 0 2.82.51 3.87 1.48l2.7-2.7C15.2 1.1 12.87 0 10.15 0a9.985 9.985 0 00-9.16 5.14l3.12 2.44c.87-2.54 3.25-4.42 6.04-4.42z" fill="#EA4335"/>
                    </svg>
                    Войти с Google
                </button>
                <button class="modal-auth-btn apple-btn">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M10 0C4.477 0 0 4.477 0 10c0 4.192 2.454 7.79 6.015 9.497A9.96 9.96 0 0010 20c5.523 0 10-4.477 10-10S15.523 0 10 0z" fill="white"/>
                        <path d="M10 1c4.97 0 9 4.03 9 9s-4.03 9-9 9-9-4.03-9-9 4.03-9 9-9z" fill="#1a1a1a"/>
                        <path d="M13.62 9.07a2.53 2.53 0 00-1.87-1.19c-.31.06-.61.16-.9.3a1.43 1.43 0 01-1.07-.34c-.16-.14-.33-.27-.51-.4a2.23 2.23 0 00-1.18-.45c-.48.06-.95.22-1.39.48a4.93 4.93 0 00-1.92 1.68c-.62.86-.96 1.83-.96 2.86 0 1.03.34 2.01.96 2.86a4.93 4.93 0 001.92 1.68c.44.26.91.42 1.39.48.56-.1 1.08-.28 1.57-.54.38.16.78.29 1.18.39.29.07.59.1.9.11a2.53 2.53 0 001.87-1.19c.16-.14.33-.27.51-.4a2.23 2.23 0 001.18-.45c.48.06.95.22 1.39.48a4.93 4.93 0 001.92 1.68c.62.86.96 1.83.96 2.86 0 1.03-.34 2.01-.96 2.86a4.93 4.93 0 00-1.92 1.68c-.44.26-.91.42-1.39.48-.56-.1-1.08-.28-1.57-.54-.38.16-.78.29-1.18.39-.29.07-.59.1-.9.11-1.04-.01-1.9-.3-2.61-.83-.73-.55-1.25-1.3-.9-2.02.35-.74.96-1.15 1.69-1.57.73-.42 1.33-.8 1.69-1.54.35-.74-.06-1.5-.78-2.03-.73-.54-1.6-.83-2.61-.83-.29 0-.59.03-.9.1A2.53 2.53 0 0013.62 9.07z" fill="#fff"/>
                    </svg>
                    Войти с Google
                </button>
                <button class="modal-auth-btn apple-btn">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M10 0C4.477 0 0 4.477 0 10c0 4.192 2.454 7.79 6.015 9.497A9.96 9.96 0 0010 20c5.523 0 10-4.477 10-10S15.523 0 10 0z" fill="white"/>
                        <path d="M10 1c4.97 0 9 4.03 9 9s-4.03 9-9 9-9-4.03-9-9 4.03-9 9-9z" fill="#1a1a1a"/>
                        <path d="M13.62 9.07a2.53 2.53 0 00-1.87-1.19c-.31.06-.61.16-.9.3a1.43 1.43 0 01-1.07-.34c-.16-.14-.33-.27-.51-.4a2.23 2.23 0 00-1.18-.45c-.48.06-.95.22-1.39.48a4.93 4.93 0 00-1.92 1.68c-.62.86-.96 1.83-.96 2.86 0 1.03.34 2.01.96 2.86a4.93 4.93 0 001.92 1.68c.44.26.91.42 1.39.48.56-.1 1.08-.28 1.57-.54.38.16.78.29 1.18.39.29.07.59.1.9.11a2.53 2.53 0 001.87-1.19c.16-.14.33-.27.51-.4a2.23 2.23 0 001.18-.45c.48.06.95.22 1.39.48a4.93 4.93 0 001.92 1.68c.62.86.96 1.83.96 2.86 0 1.03-.34 2.01-.96 2.86a4.93 4.93 0 00-1.92 1.68c-.44.26-.91.42-1.39.48-.56-.1-1.08-.28-1.57-.54-.38.16-.78.29-1.18.39-.29.07-.59.1-.9.11-1.04-.01-1.9-.3-2.61-.83-.73-.55-1.25-1.3-.9-2.02.35-.74.96-1.15 1.69-1.57.73-.42 1.33-.8 1.69-1.54.35-.74-.06-1.5-.78-2.03-.73-.54-1.6-.83-2.61-.83-.29 0-.59.03-.9.1A2.53 2.53 0 0013.62 9.07z" fill="#fff"/>
                    </svg>
                    Войти с Apple
                </button>
            </div>
        </div>
    </div>
    
    <!-- Модальное окно истории чатов -->
    <div id="chat-history-modal" class="modal">
        <div class="modal-content">
            <h2>История чатов</h2>
            <div id="history-list">
                <!-- Сюда будет загружаться история чатов -->
            </div>
        </div>
    </div>
    
    <!-- Модальное окно для смены модели -->
    <div id="model-change-modal" class="modal">
        <div class="modal-content">
            <h2 id="model-change-modal-title">Смена модели AI</h2>
            <p id="model-change-modal-text"></p>
            <div class="modal-buttons">
                <button class="modal-auth-btn" id="new-chat-btn">Да, начать новый чат</button>
                <button class="modal-auth-btn" id="continue-chat-btn" style="background-color: #333;">Нет, продолжить в этом чате</button>
            </div>
        </div>
    </div>

    <!-- Подключение Firebase для аутентификации и базы данных -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, onSnapshot, collection, query, where, getDocs, orderBy, limit, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Глобальные переменные, предоставленные средой Canvas
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Инициализация Firebase
        let app, db, auth, userId;
        let isAuthReady = false;

        // Модальные окна и элементы UI
        const authModal = document.getElementById('auth-modal');
        const authBtn = document.getElementById('auth-btn');
        const profileBtnWrapper = document.getElementById('profile-btn-wrapper');
        const profileMenu = document.getElementById('profile-menu');
        const logoutBtn = document.getElementById('logout-btn');
        const chatHistoryBtn = document.getElementById('chat-history-btn');
        const chatHistoryModal = document.getElementById('chat-history-modal');
        const historyList = document.getElementById('history-list');
        const modelChangeModal = document.getElementById('model-change-modal');
        const newChatBtn = document.getElementById('new-chat-btn');
        const continueChatBtn = document.getElementById('continue-chat-btn');

        // Элементы чата
        const aiChatContainer = document.getElementById('ai-chat');
        const userMessageInput = document.getElementById('user-message-input');
        const sendMessageBtn = document.getElementById('send-message-btn');
        const aiSelector = document.getElementById('ai-selector');
        const clearChatBtn = document.getElementById('clear-chat-btn');
        const fileUploadBtn = document.getElementById('file-upload-btn');
        const fileInput = document.getElementById('file-input');

        // Модальное окно для сообщений
        const messageModal = document.createElement('div');
        messageModal.className = 'modal';
        messageModal.innerHTML = `
            <div class="modal-content">
                <h2 id="message-modal-title"></h2>
                <p id="message-modal-text"></p>
                <button class="auth-btn" onclick="closeMessageModal()">OK</button>
            </div>
        `;
        document.body.appendChild(messageModal);

        // Функция для показа модального окна с сообщением
        function showMessageModal(title, text) {
            document.getElementById('message-modal-title').textContent = title;
            document.getElementById('message-modal-text').textContent = text;
            messageModal.classList.add('open');
        }

        // Функция для закрытия модального окна с сообщением
        window.closeMessageModal = function() {
            messageModal.classList.remove('open');
        };

        // API Keys для разных моделей
        const openAIApiKey = "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";
        const geminiApiKey = "AIzaSyBc6cQReJOWWmbuCdsAyj17szuO9fEF5Lc";

        const geminiUrl = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent";
        const openAiUrl = "https://api.openai.com/v1/chat/completions";

        // История чата, которая будет сохраняться в Firestore
        let chatHistory = [];
        let isSendingMessage = false;

        // Открытие и закрытие модальных окон
        authBtn.addEventListener('click', () => authModal.classList.add('open'));
        chatHistoryBtn.addEventListener('click', async () => {
            await loadChatHistoryFromFirestore();
            chatHistoryModal.classList.add('open');
        });
        
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target.classList.contains('modal')) {
                    modal.classList.remove('open');
                }
            });
        });
        
        // Управление меню профиля
        profileBtnWrapper.addEventListener('click', () => {
            profileMenu.classList.toggle('show');
        });

        window.addEventListener('click', (e) => {
            if (!profileBtnWrapper.contains(e.target) && profileMenu.classList.contains('show')) {
                profileMenu.classList.remove('show');
            }
        });

        // Функция для очистки чата
        function clearChat() {
            aiChatContainer.innerHTML = '';
            chatHistory = [];
        }
        
        clearChatBtn.addEventListener('click', clearChat);

        // Функция для добавления сообщения в чат
        function addMessageToChat(text, sender) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message');
            messageDiv.classList.add(sender === 'user' ? 'user-message' : 'ai-message');
            messageDiv.innerHTML = text.replace(/\n/g, '<br>'); // Замена переносов строк на <br> для правильного отображения
            aiChatContainer.appendChild(messageDiv);
            aiChatContainer.scrollTop = aiChatContainer.scrollHeight; // Автоматическая прокрутка вниз
        }

        // =================================
        // Функции для работы с API
        // =================================
        
        // Функция для отправки сообщения в Gemini API
        async function sendMessageToGemini(message) {
            if (!geminiApiKey) {
                showMessageModal("Ошибка API-ключа", "Пожалуйста, вставьте ваш API-ключ от Gemini в код.");
                return;
            }

            chatHistory.push({ role: "user", parts: [{ text: message }] });

            try {
                const payload = {
                    contents: chatHistory,
                    tools: [{ "google_search": {} }],
                    systemInstruction: {
                        parts: [{ text: "You are a helpful and friendly AI assistant." }]
                    },
                    generationConfig: {
                        temperature: 0.7,
                        maxOutputTokens: 1500,
                    },
                };
                
                const response = await fetch(`${geminiUrl}?key=${geminiApiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error("Gemini API Error:", errorData);
                    throw new Error(`API request failed with status: ${response.status}`);
                }

                const data = await response.json();
                const aiResponse = data?.candidates?.[0]?.content?.parts?.[0]?.text;

                if (!aiResponse) {
                     throw new Error("Не удалось получить ответ от Gemini.");
                }
                
                // Добавляем ответ AI в историю
                chatHistory.push({ role: "model", parts: [{ text: aiResponse }] });

                return aiResponse;

            } catch (error) {
                console.error("Error calling Gemini API:", error);
                throw new Error("Извини, произошла ошибка при получении ответа от Gemini. Пожалуйста, проверь свой API-ключ.");
            }
        }
        
        // Функция для отправки сообщения в GPT API
        async function sendMessageToOpenAI(message, modelName) {
            if (!openAIApiKey) {
                showMessageModal("Ошибка API-ключа", "Пожалуйста, вставьте ваш API-ключ от GPT в код.");
                return;
            }

            // Формируем историю для OpenAI. GPT использует формат "role: user/assistant"
            const gptHistory = chatHistory.map(entry => {
                const role = entry.role === 'model' ? 'assistant' : 'user';
                return {
                    role: role,
                    content: entry.parts?.[0]?.text || entry.content
                };
            });
            // Добавляем текущее сообщение пользователя
            gptHistory.push({ role: "user", content: message });
            
            try {
                const payload = {
                    model: modelName,
                    messages: gptHistory
                };
                
                const response = await fetch(openAiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${openAIApiKey}`
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error("OpenAI API Error:", errorData);
                    let errorMessage = `API request failed with status: ${response.status}.`;
                    if (errorData.error && errorData.error.message) {
                        errorMessage += ` Details: ${errorData.error.message}`;
                    }
                    throw new Error(errorMessage);
                }

                const data = await response.json();
                const aiResponse = data?.choices?.[0]?.message?.content;

                if (!aiResponse) {
                    throw new Error("Не удалось получить ответ от GPT.");
                }

                // Добавляем ответ AI в историю в формате, понятном обоим API
                chatHistory.push({ role: "model", parts: [{ text: aiResponse }] });

                return aiResponse;

            } catch (error) {
                console.error("Error calling OpenAI API:", error);
                throw new Error("Извини, произошла ошибка при получении ответа от GPT. Пожалуйста, проверь свой API-ключ. " + error.message);
            }
        }

        // Обработчик события для кнопки загрузки файла (пока заглушка)
        fileUploadBtn.addEventListener('click', () => {
            showMessageModal("Функция загрузки", "Извините, эта функция пока не реализована. Мы работаем над ней!");
        });

        // Функция для обработки отправки сообщения
        async function handleSendMessage() {
            const message = userMessageInput.value.trim();
            if (message === "" || isSendingMessage) {
                return;
            }

            // Проверяем, не является ли вопрос о модели
            const modelKeywords = ["модель", "какой ты", "какая ты", "кто ты", "ты кто", "ты какая модель"];
            const selectedModelName = aiSelector.options[aiSelector.selectedIndex].text;
            const isModelQuestion = modelKeywords.some(keyword => message.toLowerCase().includes(keyword));

            if (isModelQuestion) {
                const aiResponse = `Я — языковая модель ${selectedModelName}.`;
                addMessageToChat(message, 'user');
                addMessageToChat(aiResponse, 'ai');
                userMessageInput.value = "";
                return;
            }

            isSendingMessage = true;
            userMessageInput.value = "";
            
            addMessageToChat(message, 'user');
            
            const loaderDiv = document.createElement('div');
            loaderDiv.className = 'ai-message';
            loaderDiv.innerHTML = `<div class="loader"></div>`;
            aiChatContainer.appendChild(loaderDiv);
            aiChatContainer.scrollTop = aiChatContainer.scrollHeight;

            const selectedModel = aiSelector.value;

            try {
                let aiResponse;
                if (selectedModel === "gemini-2.5-flash-preview-05-20") {
                    aiResponse = await sendMessageToGemini(message);
                } else if (selectedModel.startsWith("gpt-")) {
                    aiResponse = await sendMessageToOpenAI(message, selectedModel);
                } else {
                    aiChatContainer.removeChild(loaderDiv);
                    throw new Error("Неизвестная модель AI.");
                }

                aiChatContainer.removeChild(loaderDiv);
                addMessageToChat(aiResponse, 'ai');

                // Сохраняем историю в Firestore
                await saveChatHistoryToFirestore();

            } catch (error) {
                aiChatContainer.removeChild(loaderDiv);
                addMessageToChat(error.message, 'ai');
            } finally {
                isSendingMessage = false;
            }
        }

        // Обработчики событий
        sendMessageBtn.addEventListener('click', handleSendMessage);
        userMessageInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                handleSendMessage();
            }
        });
        
        // Переменная для хранения предыдущей выбранной модели
        let lastSelectedModel = aiSelector.value;

        // Обработка смены модели
        aiSelector.addEventListener('change', () => {
            if (chatHistory.length > 0) {
                const newModelName = aiSelector.options[aiSelector.selectedIndex].text;
                const oldModelName = aiSelector.options.namedItem(lastSelectedModel)?.text || 'предыдущей';

                document.getElementById('model-change-modal-text').innerHTML = `Вы переключились на модель <b>${newModelName}</b>. Вы хотите начать новый чат или продолжить текущий разговор?`;
                modelChangeModal.classList.add('open');
            }
            lastSelectedModel = aiSelector.value;
        });

        newChatBtn.addEventListener('click', () => {
            clearChat();
            modelChangeModal.classList.remove('open');
        });

        continueChatBtn.addEventListener('click', () => {
            modelChangeModal.classList.remove('open');
        });


        // =================================
        // Функции для работы с Firestore
        // =================================

        // Сохранение истории чата в Firestore
        async function saveChatHistoryToFirestore() {
            if (!isAuthReady || !userId) {
                console.error("Authentication not ready. Cannot save chat history.");
                return;
            }

            try {
                const chatsCollection = collection(db, `artifacts/${appId}/users/${userId}/chats`);
                
                // Сериализуем историю чата в JSON-строку, чтобы сохранить в один документ
                const chatData = {
                    history: JSON.stringify(chatHistory),
                    timestamp: serverTimestamp(),
                };
                
                await addDoc(chatsCollection, chatData);
                console.log("Chat history saved to Firestore.");
            } catch (error) {
                console.error("Error saving chat history to Firestore:", error);
            }
        }

        // Загрузка истории чатов из Firestore
        async function loadChatHistoryFromFirestore() {
            if (!isAuthReady || !userId) {
                console.error("Authentication not ready. Cannot load chat history.");
                return;
            }

            try {
                const chatsCollection = collection(db, `artifacts/${appId}/users/${userId}/chats`);
                const q = query(chatsCollection, orderBy("timestamp", "desc"));
                
                const querySnapshot = await getDocs(q);
                
                if (querySnapshot.empty) {
                    historyList.innerHTML = `<p style="text-align:center;">История чатов пуста.</p>`;
                    return;
                }
                
                historyList.innerHTML = '';
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    const history = JSON.parse(data.history);
                    const firstMessage = history[0]?.parts?.[0]?.text || history[0]?.content || "Пустой чат";
                    
                    const historyItem = document.createElement('div');
                    historyItem.classList.add('history-item');
                    historyItem.textContent = firstMessage.substring(0, 50) + "..."; // Показываем только часть сообщения
                    
                    historyItem.addEventListener('click', () => {
                        // Загружаем полную историю в текущий чат
                        chatHistory = history;
                        aiChatContainer.innerHTML = '';
                        chatHistory.forEach(msg => {
                            const text = msg.parts ? msg.parts[0].text : msg.content;
                            const role = msg.role === 'model' || msg.role === 'assistant' ? 'ai' : 'user';
                            if (text) {
                                addMessageToChat(text, role);
                            }
                        });
                        chatHistoryModal.classList.remove('open');
                    });
                    
                    historyList.appendChild(historyItem);
                });
            } catch (error) {
                console.error("Error loading chat history from Firestore:", error);
                historyList.innerHTML = `<p style="color:red;">Ошибка загрузки истории.</p>`;
            }
        }

        // =================================
        // Функции для аутентификации
        // =================================
        
        // Обработка состояния аутентификации
        async function setupAuth() {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);

            onAuthStateChanged(auth, async (user) => {
                isAuthReady = true;
                if (user) {
                    userId = user.uid;
                    authBtn.style.display = 'none';
                    profileBtnWrapper.style.display = 'flex';
                    document.getElementById('user-info').textContent = `ID: ${userId}`;
                    console.log("User is authenticated:", userId);
                    // Загрузка истории чатов при входе пользователя
                    await loadChatHistoryFromFirestore();
                } else {
                    userId = null;
                    authBtn.style.display = 'block';
                    profileBtnWrapper.style.display = 'none';
                    console.log("User is not authenticated. Using anonymous sign-in.");
                    // Автоматическая анонимная аутентификация, если пользователь не вошел в систему
                    if (!initialAuthToken) {
                        try {
                            await signInAnonymously(auth);
                        } catch(error) {
                            console.error("Anonymous sign-in failed:", error);
                        }
                    }
                }
            });

            // Вход с предоставленным токеном
            if (initialAuthToken) {
                try {
                    await signInWithCustomToken(auth, initialAuthToken);
                } catch (error) {
                    console.error("Error signing in with custom token:", error);
                    // Если токен не сработал, попробуем анонимный вход
                    try {
                        await signInAnonymously(auth);
                    } catch(anonError) {
                        console.error("Anonymous sign-in failed:", anonError);
                    }
                }
            }
        }

        // Выход из аккаунта
        logoutBtn.addEventListener('click', async () => {
            try {
                await signOut(auth);
                profileMenu.classList.remove('show');
                authModal.classList.remove('open');
                // Очистка чата при выходе
                aiChatContainer.innerHTML = '';
                chatHistory = [];
                console.log("User signed out.");
            } catch (error) {
                console.error("Error signing out:", error);
            }
        });

        // Запуск
        setupAuth();
    </script>
</body>
</html>
