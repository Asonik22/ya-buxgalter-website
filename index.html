<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Мой Сайт</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome для иконок -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: "Inter", sans-serif;
            background-color: #f3f4f6;
            display: flex;
            flex-direction: column;
            min-height: 100vh; /* Минимальная высота для футера */
        }
        /* Стили для скроллбара */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* Стили для модального окна */
        .modal {
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }
        .modal.hidden {
            opacity: 0;
            visibility: hidden;
        }
        .modal.visible {
            opacity: 1;
            visibility: visible;
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">
    <!-- Верхняя панель (Header) -->
    <header class="bg-gray-800 text-white p-4 shadow-lg flex items-center justify-between z-10">
        <div class="flex items-center">
            <a href="#" class="text-2xl font-bold text-white hover:text-gray-300 transition-colors duration-200">Мой Сайт</a>
            <nav class="ml-8 hidden md:flex space-x-6">
                <a href="#products" class="text-gray-300 hover:text-white transition-colors duration-200">Товары</a>
                <a href="#my-purchases" class="text-gray-300 hover:text-white transition-colors duration-200">Мои покупки</a>
                <a href="#promocodes" class="text-gray-300 hover:text-white transition-colors duration-200">Промокоды</a>
                <a href="#chat" class="text-gray-300 hover:text-white transition-colors duration-200">Чат</a>
                <a href="#social-media" class="text-gray-300 hover:text-white transition-colors duration-200">Социальные сети</a>
                <a href="#ads" class="text-gray-300 hover:text-white transition-colors duration-200">Рекламные баннеры</a>
                <a href="#reviews" class="text-gray-300 hover:text-white transition-colors duration-200">Отзывы</a>
                <a href="#admin-panel" class="text-gray-300 hover:text-white transition-colors duration-200">Админ-панель</a>
            </nav>
        </div>
        <!-- Контейнер для кнопки уведомлений -->
        <div id="notification-bell-container" class="relative">
            <!-- Здесь будет кнопка уведомлений -->
        </div>
    </header>

    <!-- Основное содержимое -->
    <main class="flex-1 p-6 overflow-auto bg-gray-100">
        <div class="bg-white p-8 rounded-lg shadow-md min-h-full">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">Добро пожаловать на наш сайт!</h2>
            <p class="text-gray-700 leading-relaxed mb-6">
                Этот код является **шаблоном и отправной точкой** для вашего сайта. Для полной функциональности необходимо интегрировать его с базой данных (Firestore) и добавить логику для каждой секции.
            </p>

            <!-- Секция "Товары" -->
            <section id="products" class="mb-10">
                <h3 class="text-2xl font-semibold text-gray-700 mb-4">Наши товары</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Пример карточки товара. Для реальных данных:
                         1. Создайте коллекцию 'products' в Firestore.
                         2. Добавьте документы с полями: name, game, nominal, imageUrl.
                         3. Раскомментируйте и реализуйте функцию setupProducts() в JavaScript, чтобы загружать данные из Firestore и динамически создавать эти карточки.
                    -->
                    <div class="bg-blue-50 p-6 rounded-lg shadow-sm border border-blue-100">
                        <img src="https://placehold.co/300x200/e0f2fe/000?text=Игровой+предмет+1" alt="Игровой предмет 1" class="rounded-md mb-4 w-full h-40 object-cover">
                        <h4 class="text-xl font-bold text-gray-800 mb-2">Название товара 1</h4>
                        <p class="text-gray-600 text-sm mb-3">Игра: Dota 2</p>
                        <p class="text-gray-700 font-semibold mb-4">Номинал: $100</p>
                        <button class="w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors duration-200">Купить</button>
                    </div>
                    <div class="bg-green-50 p-6 rounded-lg shadow-sm border border-green-100">
                        <img src="https://placehold.co/300x200/e8f5e9/000?text=Игровой+предмет+2" alt="Игровой предмет 2" class="rounded-md mb-4 w-full h-40 object-cover">
                        <h4 class="text-xl font-bold text-gray-800 mb-2">Название товара 2</h4>
                        <p class="text-gray-600 text-sm mb-3">Игра: CS:GO</p>
                        <p class="text-gray-700 font-semibold mb-4">Номинал: $50</p>
                        <button class="w-full bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 transition-colors duration-200">Купить</button>
                    </div>
                    <div class="bg-purple-50 p-6 rounded-lg shadow-sm border border-purple-100">
                        <img src="https://placehold.co/300x200/f3e5f5/000?text=Игровой+предмет+3" alt="Игровой предмет 3" class="rounded-md mb-4 w-full h-40 object-cover">
                        <h4 class="text-xl font-bold text-gray-800 mb-2">Название товара 3</h4>
                        <p class="text-gray-600 text-sm mb-3">Игра: League of Legends</p>
                        <p class="text-gray-700 font-semibold mb-4">Номинал: $25</p>
                        <button class="w-full bg-purple-600 text-white py-2 px-4 rounded-lg hover:bg-purple-700 transition-colors duration-200">Купить</button>
                    </div>
                </div>
            </section>

            <!-- Секция "Мои покупки" -->
            <section id="my-purchases" class="mb-10">
                <h3 class="text-2xl font-semibold text-gray-700 mb-4">Мои покупки</h3>
                <div class="overflow-x-auto rounded-lg shadow-sm border border-gray-200">
                    <table class="min-w-full bg-white">
                        <thead class="bg-gray-50 border-b border-gray-200">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider rounded-tl-lg">Товар</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Игра</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Номинал</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider rounded-tr-lg">Дата покупки</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200" id="my-purchases-table-body">
                            <!-- Пример строки покупки. Для реальных данных:
                                 1. Создайте коллекцию 'purchases' в Firestore, связанную с userId.
                                 2. Добавьте документы с полями: productName, gameName, nominal, purchaseDate.
                                 3. Раскомментируйте и реализуйте функцию setupMyPurchases() в JavaScript, чтобы загружать данные из Firestore и динамически создавать эти строки.
                            -->
                            <tr class="hover:bg-gray-50">
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">Скин "Легенда"</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">Fortnite</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">$25.00</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">2025-07-20</td>
                            </tr>
                            <tr class="hover:bg-gray-50">
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">Набор кристаллов</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">Genshin Impact</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">$50.00</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">2025-07-18</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Секция "Оплата" -->
            <section id="payment" class="mb-10">
                <h3 class="text-2xl font-semibold text-gray-700 mb-4">Оплата</h3>
                <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                    <p class="text-gray-700 mb-4">
                        Здесь будет форма для выбора способа оплаты. Если вы забудете выбрать способ, поля не должны стираться.
                        Для этого необходимо реализовать валидацию формы и сохранение данных в состоянии или локальном хранилище.
                    </p>
                    <form id="payment-form">
                        <div class="mb-4">
                            <label for="payment-method" class="block text-gray-700 text-sm font-bold mb-2">Выберите способ оплаты:</label>
                            <select id="payment-method" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                                <option value="">-- Выберите --</option>
                                <option value="card">Банковская карта</option>
                                <option value="paypal">PayPal</option>
                                <option value="crypto">Криптовалюта</option>
                            </select>
                        </div>
                        <div class="mb-4">
                            <label for="card-number" class="block text-gray-700 text-sm font-bold mb-2">Номер карты:</label>
                            <input type="text" id="card-number" placeholder="XXXX XXXX XXXX XXXX" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                        </div>
                        <button type="submit" class="bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors duration-200">Подтвердить и перейти к оплате</button>
                    </form>
                </div>
            </section>

            <!-- Секция "Уведомления" (для демонстрации) -->
            <section id="user-notifications" class="mb-10">
                <h3 class="text-2xl font-semibold text-gray-700 mb-4">Мои уведомления</h3>
                <div id="notifications-list" class="space-y-4">
                    <!-- Уведомления будут добавляться здесь динамически -->
                </div>
            </section>

            <!-- Секция "Рекламные баннеры" -->
            <section id="ads" class="mb-10">
                <h3 class="text-2xl font-semibold text-gray-700 mb-4">Наши акции</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6" id="ad-banners-container">
                    <!-- Пример рекламного баннера. Для реальных данных:
                         1. Создайте коллекцию 'adBanners' в Firestore.
                         2. Добавьте документы с полями: imageUrl, title, description, linkUrl.
                         3. Раскомментируйте и реализуйте функцию setupAdBanners() в JavaScript, чтобы загружать данные из Firestore и динамически создавать эти баннеры.
                    -->
                    <div class="bg-yellow-50 p-6 rounded-lg shadow-sm border border-yellow-100">
                        <img src="https://placehold.co/600x200/fff3e0/000?text=Рекламный+баннер+1" alt="Рекламный баннер 1" class="rounded-md mb-4 w-full object-cover">
                        <h4 class="text-xl font-bold text-gray-800 mb-2">Скидка 20% на все товары!</h4>
                        <p class="text-gray-600">Не упустите шанс сэкономить на любимых игровых предметах. Акция действует до конца месяца.</p>
                        <button class="mt-4 bg-yellow-600 text-white py-2 px-4 rounded-lg hover:bg-yellow-700 transition-colors duration-200">Подробнее</button>
                    </div>
                    <div class="bg-red-50 p-6 rounded-lg shadow-sm border border-red-100">
                        <img src="https://placehold.co/600x200/ffebee/000?text=Рекламный+баннер+2" alt="Рекламный баннер 2" class="rounded-md mb-4 w-full object-cover">
                        <h4 class="text-xl font-bold text-gray-800 mb-2">Новая игра уже здесь!</h4>
                        <p class="text-gray-600">Погрузитесь в захватывающий мир приключений с нашей новой игрой. Доступно для предзаказа.</p>
                        <button class="mt-4 bg-red-600 text-white py-2 px-4 rounded-lg hover:bg-red-700 transition-colors duration-200">Подробнее</button>
                    </div>
                </div>
            </section>

            <!-- Секция "Отзывы" -->
            <section id="reviews" class="mb-10">
                <h3 class="text-2xl font-semibold text-gray-700 mb-4">Отзывы наших клиентов</h3>
                <div class="space-y-4" id="reviews-container">
                    <!-- Пример отзыва. Для реальных данных:
                         1. Создайте коллекцию 'reviews' в Firestore.
                         2. Добавьте документы с полями: author, rating (число 1-5), text, timestamp, isFake (boolean).
                         3. Раскомментируйте и реализуйте функцию setupReviews() в JavaScript, чтобы загружать данные из Firestore и динамически создавать эти отзывы.
                    -->
                    <div class="bg-gray-50 p-6 rounded-lg shadow-sm border border-gray-200">
                        <div class="flex items-center mb-2">
                            <span class="text-yellow-400 mr-2"><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i></span>
                            <span class="font-semibold text-gray-800">Иван К.</span>
                        </div>
                        <p class="text-gray-700">"Отличный сайт! Быстрая доставка, товары соответствуют описанию. Очень доволен покупкой."</p>
                    </div>
                    <div class="bg-gray-50 p-6 rounded-lg shadow-sm border border-gray-200">
                        <div class="flex items-center mb-2">
                            <span class="text-yellow-400 mr-2"><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i></span>
                            <span class="font-semibold text-gray-800">Мария С.</span>
                        </div>
                        <p class="text-gray-700">"Удобный интерфейс, легко найти нужный товар. Буду заказывать еще!"</p>
                    </div>
                </div>
            </section>

            <!-- Секция "Экспорт данных" (для админ-панели или пользователя) -->
            <section id="export-data" class="mb-10">
                <h3 class="text-2xl font-semibold text-gray-700 mb-4">Экспорт данных</h3>
                <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                    <p class="text-gray-700 mb-4">
                        Для экспорта данных в Excel необходимо использовать JavaScript-библиотеки, такие как SheetJS (xlsx).
                        Вы можете экспортировать данные из любой коллекции Firestore.
                    </p>
                    <button id="export-button" class="bg-purple-600 text-white py-2 px-4 rounded-lg hover:bg-purple-700 transition-colors duration-200">Экспортировать покупки в Excel</button>
                    <p class="text-sm text-gray-500 mt-2">
                        Примечание: Для работы этой функции необходимо подключить библиотеку SheetJS.
                        Пример подключения: `import * as XLSX from 'https://cdn.sheetjs.com/xlsx-0.20.2/package/xlsx.mjs';`
                    </p>
                </div>
            </section>

        </div>
    </main>

    <!-- Футер -->
    <footer class="bg-gray-800 text-white p-6 text-center rounded-tl-lg rounded-tr-lg shadow-inner">
        <div class="container mx-auto">
            <p>&copy; 2025 Мой Сайт. Все права защищены.</p>
            <div class="mt-4 flex justify-center space-x-6" id="social-media-links">
                <!-- Ссылки на соцсети будут здесь. Для реальных данных:
                     1. Создайте коллекцию 'socialMedia' в Firestore.
                     2. Добавьте документы с полями: url, iconClass (например, 'fab fa-vk').
                     3. Раскомментируйте и реализуйте функцию setupSocialMediaLinks() в JavaScript, чтобы загружать данные из Firestore и динамически создавать эти ссылки.
                -->
                <a href="https://vk.com" target="_blank" class="text-gray-400 hover:text-white transition-colors duration-200"><i class="fab fa-vk text-2xl"></i></a>
                <a href="https://telegram.org" target="_blank" class="text-gray-400 hover:text-white transition-colors duration-200"><i class="fab fa-telegram-plane text-2xl"></i></a>
                <a href="https://discord.com" target="_blank" class="text-gray-400 hover:text-white transition-colors duration-200"><i class="fab fa-discord text-2xl"></i></a>
            </div>
        </div>
    </footer>

    <!-- Payment Modal -->
    <div id="payment-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-8 rounded-lg shadow-xl max-w-sm w-full relative">
            <button id="close-payment-modal" class="absolute top-3 right-3 text-gray-500 hover:text-gray-700 text-2xl font-bold">&times;</button>
            <h3 id="modal-title" class="text-xl font-bold mb-4 text-gray-800"></h3>
            <p id="modal-message" class="text-gray-700 mb-6"></p>
            <button id="modal-confirm-button" class="bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors duration-200 w-full">ОК</button>
        </div>
    </div>


    <script type="module">
        // Инициализация Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, updateDoc, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        // Для экспорта в Excel - раскомментируйте эту строку и добавьте в HTML <script type="module" src="https://cdn.sheetjs.com/xlsx-0.20.2/package/xlsx.mjs"></script>
        // import * as XLSX from 'https://cdn.sheetjs.com/xlsx-0.20.2/package/xlsx.mjs';


        // Глобальные переменные Firebase, предоставленные средой Canvas
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');

        let app;
        let db;
        let auth;
        let userId;
        let isAuthReady = false;

        // Инициализация Firebase и аутентификация
        async function initializeFirebaseAndAuth() {
            try {
                if (Object.keys(firebaseConfig).length === 0) {
                    console.error("Firebase config is empty. Please ensure __firebase_config is properly set.");
                    return;
                }
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Слушаем изменения состояния аутентификации
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("User authenticated:", userId);
                    } else {
                        // Если пользователь не аутентифицирован, используем анонимный вход
                        try {
                            if (typeof __initial_auth_token !== 'undefined') {
                                await signInWithCustomToken(auth, __initial_auth_token);
                                userId = auth.currentUser.uid;
                                console.log("Signed in with custom token:", userId);
                            } else {
                                await signInAnonymously(auth);
                                userId = auth.currentUser.uid;
                                console.log("Signed in anonymously:", userId);
                            }
                        } catch (error) {
                            console.error("Error during anonymous sign-in or custom token sign-in:", error);
                            userId = crypto.randomUUID(); // Fallback to random ID if auth fails
                            console.log("Using random userId as fallback:", userId);
                        }
                    }
                    isAuthReady = true;
                    // После успешной аутентификации и инициализации Firebase, настраиваем слушателей данных
                    setupNotifications();
                    // setupProducts(); // Загрузка и отображение товаров
                    // setupMyPurchases(); // Загрузка и отображение моих покупок
                    // setupSocialMediaLinks(); // Настройка ссылок на соцсети
                    // setupAdBanners(); // Настройка рекламных баннеров
                    // setupReviews(); // Настройка отзывов
                });
            } catch (error) {
                console.error("Error initializing Firebase:", error);
            }
        }

        // --- Уведомления ---
        let notifications = [];
        let unreadCount = 0;
        const notificationBellContainer = document.getElementById('notification-bell-container');
        const notificationsListElement = document.getElementById('notifications-list'); // Для отображения уведомлений на странице

        function renderNotificationBell() {
            notificationBellContainer.innerHTML = `
                <button id="notification-bell" class="relative p-3 rounded-full bg-blue-500 text-white hover:bg-blue-600 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-opacity-75">
                    <i class="fas fa-bell text-xl"></i>
                    ${unreadCount > 0 ? `<span class="absolute top-0 right-0 inline-flex items-center justify-center px-2 py-1 text-xs font-bold leading-none text-red-100 bg-red-600 rounded-full transform translate-x-1/2 -translate-y-1/2">${unreadCount}</span>` : ''}
                </button>
                <div id="notification-dropdown" class="absolute right-0 mt-2 w-80 bg-white rounded-lg shadow-xl z-20 hidden overflow-hidden">
                    <div class="py-2">
                        <h3 class="text-lg font-semibold px-4 py-2 border-b border-gray-200 text-gray-800">Уведомления</h3>
                        <div id="dropdown-notifications-list" class="max-h-60 overflow-y-auto">
                            ${notifications.length === 0 ? '<p class="text-gray-500 text-center py-4">Нет новых уведомлений.</p>' : ''}
                        </div>
                    </div>
                </div>
            `;

            const bellButton = document.getElementById('notification-bell');
            const dropdown = document.getElementById('notification-dropdown');

            bellButton.addEventListener('click', (event) => {
                event.stopPropagation(); // Предотвращаем закрытие при клике на саму кнопку
                dropdown.classList.toggle('hidden');
                if (!dropdown.classList.contains('hidden')) {
                    renderDropdownNotifications();
                }
            });

            // Закрытие дропдауна при клике вне его
            document.addEventListener('click', (event) => {
                if (!notificationBellContainer.contains(event.target) && !dropdown.classList.contains('hidden')) {
                    dropdown.classList.add('hidden');
                }
            });
        }

        function renderDropdownNotifications() {
            const dropdownNotificationsList = document.getElementById('dropdown-notifications-list');
            dropdownNotificationsList.innerHTML = '';
            if (notifications.length === 0) {
                dropdownNotificationsList.innerHTML = '<p class="text-gray-500 text-center py-4">Нет новых уведомлений.</p>';
                return;
            }
            notifications.forEach(notification => {
                const notificationItem = document.createElement('div');
                notificationItem.className = `flex items-start justify-between p-4 border-b border-gray-100 ${notification.read ? 'bg-gray-50' : 'bg-white'}`;
                notificationItem.innerHTML = `
                    <div class="flex-1">
                        <p class="text-sm font-medium text-gray-900">${notification.message}</p>
                        <p class="text-xs text-gray-500 mt-1">${new Date(notification.timestamp).toLocaleString()}</p>
                    </div>
                    ${!notification.read ? `
                    <button data-id="${notification.id}" class="mark-as-read-btn ml-4 px-3 py-1 text-xs font-semibold text-white bg-green-500 rounded-full hover:bg-green-600 transition-colors duration-200">
                        Прочитано
                    </button>
                    ` : ''}
                `;
                dropdownNotificationsList.appendChild(notificationItem);
            });

            document.querySelectorAll('.mark-as-read-btn').forEach(button => {
                button.addEventListener('click', async (event) => {
                    event.stopPropagation(); // Предотвращаем закрытие дропдауна при клике на кнопку "Прочитано"
                    const notificationId = event.target.dataset.id;
                    await markNotificationAsRead(notificationId);
                });
            });
        }

        async function markNotificationAsRead(id) {
            if (!isAuthReady || !db || !userId) {
                console.error("Firebase not initialized or user not authenticated.");
                return;
            }
            try {
                // Путь к коллекции публичных данных для уведомлений
                const notificationDocRef = doc(db, `artifacts/${appId}/public/data/notifications`, id);
                await updateDoc(notificationDocRef, {
                    read: true
                });
                console.log("Notification marked as read:", id);
            } catch (error) {
                console.error("Error marking notification as read:", error);
            }
        }

        function setupNotifications() {
            if (!isAuthReady || !db || !userId) {
                console.error("Firebase not initialized or user not authenticated for notifications.");
                return;
            }

            // Слушаем изменения в коллекции уведомлений
            // Используем публичную коллекцию, чтобы все могли видеть уведомления
            const notificationsColRef = collection(db, `artifacts/${appId}/public/data/notifications`);

            // ВАЖНО: Если вы столкнетесь с ошибкой "The query requires an index",
            // это означает, что вам нужно создать соответствующий индекс в консоли Firebase.
            // Например, для сортировки по timestamp, вам может понадобиться составной индекс.
            onSnapshot(notificationsColRef, (snapshot) => {
                const newNotifications = [];
                let newUnreadCount = 0;
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const notification = {
                        id: doc.id,
                        message: data.message,
                        timestamp: data.timestamp ? data.timestamp.toDate().getTime() : Date.now(), // Преобразуем Timestamp в число
                        read: data.read || false
                    };
                    newNotifications.push(notification);
                    if (!notification.read) {
                        newUnreadCount++;
                    }
                });
                // Сортируем уведомления по времени (новые сверху)
                notifications = newNotifications.sort((a, b) => b.timestamp - a.timestamp);
                unreadCount = newUnreadCount;
                renderNotificationBell();
                renderDropdownNotifications(); // Обновляем список в дропдауне

                // Также отображаем уведомления в основной секции "Мои уведомления"
                renderPageNotifications();
            }, (error) => {
                console.error("Error fetching notifications:", error);
            });
        }

        function renderPageNotifications() {
            notificationsListElement.innerHTML = ''; // Очищаем список на странице
            if (notifications.length === 0) {
                notificationsListElement.innerHTML = '<p class="text-gray-500">У вас пока нет уведомлений.</p>';
                return;
            }
            notifications.forEach(notification => {
                const notificationItem = document.createElement('div');
                notificationItem.className = `flex items-start justify-between p-4 rounded-lg shadow-sm border ${notification.read ? 'bg-gray-50 border-gray-200' : 'bg-blue-50 border-blue-200'}`;
                notificationItem.innerHTML = `
                    <div class="flex-1">
                        <p class="text-base font-medium text-gray-900">${notification.message}</p>
                        <p class="text-sm text-gray-500 mt-1">${new Date(notification.timestamp).toLocaleString()}</p>
                    </div>
                    ${!notification.read ? `
                    <button data-id="${notification.id}" class="mark-as-read-btn ml-4 px-4 py-2 text-sm font-semibold text-white bg-green-500 rounded-lg hover:bg-green-600 transition-colors duration-200">
                        Прочитано
                    </button>
                    ` : ''}
                `;
                notificationsListElement.appendChild(notificationItem);
            });

            // Переназначаем слушателей для кнопок "Прочитано" в секции страницы
            document.querySelectorAll('#notifications-list .mark-as-read-btn').forEach(button => {
                button.addEventListener('click', async (event) => {
                    const notificationId = event.target.dataset.id;
                    await markNotificationAsRead(notificationId);
                });
            });
        }

        // --- Функции для модального окна ---
        const paymentModal = document.getElementById('payment-modal');
        const closeModalButton = document.getElementById('close-payment-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalConfirmButton = document.getElementById('modal-confirm-button');

        function showModal(title, message, buttonText = 'ОК', callback = null) {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            modalConfirmButton.textContent = buttonText;
            modalConfirmButton.onclick = () => {
                paymentModal.classList.add('hidden');
                paymentModal.classList.remove('visible');
                if (callback) callback();
            };
            closeModalButton.onclick = () => {
                paymentModal.classList.add('hidden');
                paymentModal.classList.remove('visible');
            };
            paymentModal.classList.remove('hidden');
            paymentModal.classList.add('visible');
        }

        // --- Обработка формы оплаты (Пункт 2: сохранение полей) ---
        const paymentForm = document.getElementById('payment-form');
        const paymentMethodSelect = document.getElementById('payment-method');
        const cardNumberInput = document.getElementById('card-number');

        // Загрузка сохраненных данных при загрузке страницы
        document.addEventListener('DOMContentLoaded', () => {
            const savedFormData = localStorage.getItem('paymentFormData');
            if (savedFormData) {
                const data = JSON.parse(savedFormData);
                if (data.paymentMethod) paymentMethodSelect.value = data.paymentMethod;
                if (data.cardNumber) cardNumberInput.value = data.cardNumber;
            }
        });

        paymentForm.addEventListener('submit', function(event) {
            event.preventDefault(); // Предотвращаем стандартную отправку формы

            const paymentMethod = paymentMethodSelect.value;
            const cardNumber = cardNumberInput.value;

            // Сохраняем данные полей в локальное хранилище, чтобы они не стирались
            localStorage.setItem('paymentFormData', JSON.stringify({
                paymentMethod: paymentMethod,
                cardNumber: cardNumber
            }));

            if (!paymentMethod) {
                showModal('Ошибка оплаты', 'Пожалуйста, выберите способ оплаты, прежде чем продолжить.');
                return;
            }

            // Здесь будет реальная логика перехода к оплате
            showModal('Оплата', 'Переход к оплате...', 'Продолжить', () => {
                console.log('Переход к платежной системе для:', paymentMethod, cardNumber);
                // В реальном приложении здесь будет перенаправление на платежный шлюз
            });
        });


        // --- Инициализация экспорта в Excel (Пункт 4) ---
        // Для работы этой функции необходимо:
        // 1. Подключить библиотеку SheetJS (xlsx) в HTML:
        //    <script type="module" src="https://cdn.sheetjs.com/xlsx-0.20.2/package/xlsx.mjs"></script>
        // 2. Раскомментировать строку `import * as XLSX from 'https://cdn.sheetjs.com/xlsx-0.20.2/package/xlsx.mjs';` выше.
        // 3. Убедиться, что у вас есть данные для экспорта (например, из Firestore).
        // const exportButton = document.getElementById('export-button');
        // if (exportButton) {
        //     exportButton.addEventListener('click', async () => {
        //         if (!isAuthReady || !db || !userId) {
        //             showModal('Ошибка', 'Firebase не инициализирован или пользователь не аутентифицирован для экспорта данных.');
        //             return;
        //         }
        //         try {
        //             // Пример: получение данных о покупках
        //             const purchasesColRef = collection(db, `artifacts/${appId}/users/${userId}/purchases`);
        //             const querySnapshot = await getDocs(purchasesColRef);
        //             const dataToExport = [];
        //             querySnapshot.forEach((doc) => {
        //                 dataToExport.push(doc.data());
        //             });
        //
        //             if (dataToExport.length === 0) {
        //                 showModal('Экспорт', 'Нет данных для экспорта.');
        //                 return;
        //             }
        //
        //             const ws = XLSX.utils.json_to_sheet(dataToExport);
        //             const wb = XLSX.utils.book_new();
        //             XLSX.utils.book_append_sheet(wb, ws, "Мои_Покупки");
        //             XLSX.writeFile(wb, "мои_покупки.xlsx");
        //             showModal('Экспорт', 'Данные успешно экспортированы в Excel!');
        //         } catch (error) {
        //             console.error("Ошибка при экспорте данных:", error);
        //             showModal('Ошибка экспорта', 'Произошла ошибка при экспорте данных.');
        //         }
        //     });
        // }


        // --- Управление ссылками на социальные сети (Пункт 4) ---
        // Для работы этой функции необходимо:
        // 1. Создать коллекцию 'socialMedia' в Firestore в пути `artifacts/{appId}/public/data/socialMedia`.
        // 2. Добавить документы с полями: `url` (ссылка), `iconClass` (класс Font Awesome, например, 'fab fa-vk').
        // 3. Раскомментировать вызов `setupSocialMediaLinks()` в `initializeFirebaseAndAuth()`.
        // function setupSocialMediaLinks() {
        //     if (!isAuthReady || !db) return;
        //     const socialLinksRef = collection(db, `artifacts/${appId}/public/data/socialMedia`);
        //     onSnapshot(socialLinksRef, (snapshot) => {
        //         const linksContainer = document.getElementById('social-media-links');
        //         linksContainer.innerHTML = ''; // Очищаем текущие ссылки
        //         snapshot.forEach(doc => {
        //             const data = doc.data();
        //             const linkElement = document.createElement('a');
        //             linkElement.href = data.url;
        //             linkElement.target = "_blank";
        //             linkElement.className = "text-gray-400 hover:text-white transition-colors duration-200";
        //             linkElement.innerHTML = `<i class="${data.iconClass} text-2xl"></i>`;
        //             linksContainer.appendChild(linkElement);
        //         });
        //     }, (error) => {
        //         console.error("Error fetching social media links:", error);
        //     });
        // }

        // --- Управление рекламными баннерами (Пункт 4) ---
        // Для работы этой функции необходимо:
        // 1. Создать коллекцию 'adBanners' в Firestore в пути `artifacts/{appId}/public/data/adBanners`.
        // 2. Добавить документы с полями: `imageUrl`, `title`, `description`, `linkUrl`.
        // 3. Раскомментировать вызов `setupAdBanners()` в `initializeFirebaseAndAuth()`.
        // function setupAdBanners() {
        //     if (!isAuthReady || !db) return;
        //     const adBannersRef = collection(db, `artifacts/${appId}/public/data/adBanners`);
        //     onSnapshot(adBannersRef, (snapshot) => {
        //         const adsContainer = document.getElementById('ad-banners-container');
        //         adsContainer.innerHTML = ''; // Очищаем текущие баннеры
        //         snapshot.forEach(doc => {
        //             const data = doc.data();
        //             const bannerElement = document.createElement('div');
        //             bannerElement.className = "bg-white p-6 rounded-lg shadow-sm border border-gray-200"; // Можно использовать bg-yellow-50 и border-yellow-100 для разных стилей
        //             bannerElement.innerHTML = `
        //                 <img src="${data.imageUrl}" alt="${data.title}" class="rounded-md mb-4 w-full h-40 object-cover">
        //                 <h4 class="text-xl font-bold text-gray-800 mb-2">${data.title}</h4>
        //                 <p class="text-gray-600">${data.description}</p>
        //                 <a href="${data.linkUrl}" target="_blank" class="mt-4 inline-block bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors duration-200">Подробнее</a>
        //             `;
        //             adsContainer.appendChild(bannerElement);
        //         });
        //     }, (error) => {
        //         console.error("Error fetching ad banners:", error);
        //     });
        // }

        // --- Добавление фейковых отзывов (Пункт 6) и их отображение ---
        // Для работы этой функции необходимо:
        // 1. Создать коллекцию 'reviews' в Firestore в пути `artifacts/{appId}/public/data/reviews`.
        // 2. Добавить документы с полями: `author`, `rating` (число 1-5), `text`, `timestamp`, `isFake` (boolean).
        // 3. Раскомментировать вызов `setupReviews()` в `initializeFirebaseAndAuth()`.
        // 4. Для добавления фейкового отзыва из админ-панели (которую мы будем делать позже), вы будете вызывать `addFakeReview()`.
        // function addFakeReview(author, rating, text) {
        //     if (!isAuthReady || !db) {
        //         showModal('Ошибка', 'Firebase не инициализирован или пользователь не аутентифицирован для добавления отзыва.');
        //         return;
        //     }
        //     try {
        //         addDoc(collection(db, `artifacts/${appId}/public/data/reviews`), {
        //             author: author,
        //             rating: rating, // 1-5
        //             text: text,
        //             timestamp: new Date(),
        //             isFake: true // Помечаем как фейковый
        //         });
        //         showModal('Успех', 'Фейковый отзыв успешно добавлен!');
        //         console.log("Fake review added successfully!");
        //     } catch (e) {
        //         console.error("Error adding fake review: ", e);
        //         showModal('Ошибка', 'Произошла ошибка при добавлении фейкового отзыва.');
        //     }
        // }

        // function setupReviews() {
        //     if (!isAuthReady || !db) return;
        //     const reviewsRef = collection(db, `artifacts/${appId}/public/data/reviews`);
        //     onSnapshot(reviewsRef, (snapshot) => {
        //         const reviewsContainer = document.getElementById('reviews-container');
        //         reviewsContainer.innerHTML = ''; // Очищаем текущие отзывы
        //         if (snapshot.empty) {
        //             reviewsContainer.innerHTML = '<p class="text-gray-500">Пока нет отзывов.</p>';
        //             return;
        //         }
        //         snapshot.forEach(doc => {
        //             const data = doc.data();
        //             const reviewElement = document.createElement('div');
        //             reviewElement.className = "bg-gray-50 p-6 rounded-lg shadow-sm border border-gray-200";
        //             let starsHtml = '';
        //             for (let i = 0; i < 5; i++) {
        //                 starsHtml += `<i class="fas fa-star${i < data.rating ? '' : ' text-gray-300'}"></i>`;
        //             }
        //             reviewElement.innerHTML = `
        //                 <div class="flex items-center mb-2">
        //                     <span class="text-yellow-400 mr-2">${starsHtml}</span>
        //                     <span class="font-semibold text-gray-800">${data.author}</span>
        //                 </div>
        //                 <p class="text-gray-700">"${data.text}"</p>
        //                 <p class="text-xs text-gray-500 mt-2">Дата: ${new Date(data.timestamp.toDate()).toLocaleDateString()}</p>
        //             `;
        //             reviewsContainer.appendChild(reviewElement);
        //         });
        //     }, (error) => {
        //         console.error("Error fetching reviews:", error);
        //     });
        // }

        // --- Загрузка и отображение товаров (Пункт 3) ---
        // Для работы этой функции необходимо:
        // 1. Создать коллекцию 'products' в Firestore в пути `artifacts/{appId}/public/data/products`.
        // 2. Добавить документы с полями: `name`, `game`, `nominal`, `imageUrl`.
        // 3. Раскомментировать вызов `setupProducts()` в `initializeFirebaseAndAuth()`.
        // function setupProducts() {
        //     if (!isAuthReady || !db) return;
        //     const productsRef = collection(db, `artifacts/${appId}/public/data/products`);
        //     onSnapshot(productsRef, (snapshot) => {
        //         const productsContainer = document.querySelector('#products .grid');
        //         productsContainer.innerHTML = ''; // Очищаем текущие товары
        //         if (snapshot.empty) {
        //             productsContainer.innerHTML = '<p class="text-gray-500">Пока нет товаров.</p>';
        //             return;
        //         }
        //         snapshot.forEach(doc => {
        //             const data = doc.data();
        //             const productElement = document.createElement('div');
        //             productElement.className = "bg-white p-6 rounded-lg shadow-sm border border-gray-200";
        //             productElement.innerHTML = `
        //                 <img src="${data.imageUrl || 'https://placehold.co/300x200/e0f2fe/000?text=Нет+изображения'}" alt="${data.name}" class="rounded-md mb-4 w-full h-40 object-cover">
        //                 <h4 class="text-xl font-bold text-gray-800 mb-2">${data.name}</h4>
        //                 <p class="text-gray-600 text-sm mb-3">Игра: ${data.game}</p>
        //                 <p class="text-gray-700 font-semibold mb-4">Номинал: $${data.nominal}</p>
        //                 <button class="w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors duration-200">Купить</button>
        //             `;
        //             productsContainer.appendChild(productElement);
        //         });
        //     }, (error) => {
        //         console.error("Error fetching products:", error);
        //     });
        // }

        // --- Загрузка и отображение моих покупок (Пункт 3) ---
        // Для работы этой функции необходимо:
        // 1. Создать коллекцию 'purchases' в Firestore в пути `artifacts/{appId}/users/{userId}/purchases`.
        // 2. Добавить документы с полями: `productName`, `gameName`, `nominal`, `purchaseDate` (Timestamp).
        // 3. Раскомментировать вызов `setupMyPurchases()` в `initializeFirebaseAndAuth()`.
        // function setupMyPurchases() {
        //     if (!isAuthReady || !db || !userId) return;
        //     const purchasesRef = collection(db, `artifacts/${appId}/users/${userId}/purchases`);
        //     onSnapshot(purchasesRef, (snapshot) => {
        //         const tableBody = document.getElementById('my-purchases-table-body');
        //         tableBody.innerHTML = ''; // Очищаем текущие покупки
        //         if (snapshot.empty) {
        //             tableBody.innerHTML = '<tr><td colspan="4" class="px-6 py-4 text-center text-gray-500">У вас пока нет покупок.</td></tr>';
        //             return;
        //         }
        //         snapshot.forEach(doc => {
        //             const data = doc.data();
        //             const row = document.createElement('tr');
        //             row.className = "hover:bg-gray-50";
        //             row.innerHTML = `
        //                 <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${data.productName}</td>
        //                 <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${data.gameName}</td>
        //                 <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">$${data.nominal.toFixed(2)}</td>
        //                 <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${data.purchaseDate ? new Date(data.purchaseDate.toDate()).toLocaleDateString() : 'N/A'}</td>
        //             `;
        //             tableBody.appendChild(row);
        //         });
        //     }, (error) => {
        //         console.error("Error fetching my purchases:", error);
        //     });
        // }


        // Вызываем инициализацию Firebase при загрузке DOM
        document.addEventListener('DOMContentLoaded', initializeFirebaseAndAuth);

        // Пример добавления тестового уведомления (можно удалить после реализации реальных уведомлений)
        // setTimeout(async () => {
        //     if (db && userId) {
        //         try {
        //             await addDoc(collection(db, `artifacts/${appId}/public/data/notifications`), {
        //                 message: "Новое уведомление для пользователя о скидках!",
        //                 timestamp: new Date(),
        //                 read: false
        //             });
        //             console.log("Test user notification added.");
        //         } catch (e) {
        //             console.error("Error adding test document: ", e);
        //         }
        //     }
        // }, 5000); // Добавить через 5 секунд после загрузки
    </script>
</body>
</html>
